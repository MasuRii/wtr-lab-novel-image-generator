// ==UserScript==
// @name WTR LAB Novel Image Generator
// @description A powerful userscript to enhance web novel reading on WTR-LAB.COM. Select text to generate AI-powered images using multiple providers (Pollinations, AI Horde, Google Imagen, OpenAI). Features Gemini-enhanced prompts, 100+ art styles, a modern UI, history, and robust configuration options. Built with Webpack for modularity and maintainability.
// @version 6.0.5
// @author MasuRii
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect *
// @downloadURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_xmlhttpRequest
// @grant GM_registerMenuCommand
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @updateURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.meta.js
// ==/UserScript==

(()=>{"use strict";var e={56:(e,n,t)=>{e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72:e=>{var n=[];function t(e){for(var t=-1,i=0;i<n.length;i++)if(n[i].identifier===e){t=i;break}return t}function i(e,i){for(var o={},r=[],s=0;s<e.length;s++){var l=e[s],c=i.base?l[0]+i.base:l[0],d=o[c]||0,p="".concat(c," ").concat(d);o[c]=d+1;var m=t(p),g={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)n[m].references++,n[m].updater(g);else{var u=a(g,i);i.byIndex=s,n.splice(s,0,{identifier:p,updater:u,references:1})}r.push(p)}return r}function a(e,n){var t=n.domAPI(n);return t.update(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,a){var o=i(e=e||[],a=a||{});return function(e){e=e||[];for(var r=0;r<o.length;r++){var s=t(o[r]);n[s].references--}for(var l=i(e,a),c=0;c<o.length;c++){var d=t(o[c]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}o=l}}},92:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"/* === Modern Utilities Tab === */\n.nig-utilities-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-utility-card {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-utility-card:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-md);\n    transform: translateY(-2px);\n}\n\n.nig-utility-card h4 {\n    margin: 0 0 var(--nig-space-md) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-utility-card p {\n    margin: 0 0 var(--nig-space-lg) 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-utility-card .nig-save-btn {\n    width: 100%;\n    justify-content: center;\n}\n\n/* === Enhanced Utility Card Structure === */\n.nig-card-header {\n    display: flex;\n    align-items: flex-start;\n    gap: var(--nig-space-md);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-title {\n    flex: 1;\n    min-width: 0;\n}\n\n.nig-card-title h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    line-height: 1.3;\n}\n\n.nig-card-title p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-card-actions {\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-secondary-actions {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-footer {\n    padding-top: var(--nig-space-md);\n     border-top: 1px solid var(--nig-color-border);\n    margin-top: auto;\n}\n\n/* === Modern Button Variants === */\n.nig-btn-primary {\n    width: 100%;\n     background: var(--nig-color-accent-warning);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n}\n\n.nig-btn-primary:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-primary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-xs);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    min-height: 36px;\n}\n\n.nig-btn-secondary:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary.nig-btn-error {\n    background: var(--nig-color-accent-error);\n    color: white;\n}\n\n.nig-btn-secondary.nig-btn-error:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary .material-symbols-outlined {\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-btn-primary .material-symbols-outlined {\n    font-size: var(--nig-font-size-sm);\n}\n\n/* === Status Widget === */\n.nig-status-widget {\n    position: fixed;\n    bottom: var(--nig-space-xl);\n    left: var(--nig-space-xl);\n    z-index: 1020;\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    border-radius: var(--nig-radius-lg);\n    box-shadow: var(--nig-shadow-xl);\n    display: none;\n    align-items: center;\n    gap: var(--nig-space-md);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    border: 1px solid var(--nig-color-border);\n    backdrop-filter: blur(10px);\n}\n\n.nig-status-icon {\n    width: 20px;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nig-status-widget.loading .nig-status-icon {\n    box-sizing: border-box;\n    border: 2px solid var(--nig-color-text-muted);\n    border-top-color: var(--nig-color-accent-primary);\n    border-radius: 50%;\n    animation: nig-spin 1s linear infinite;\n}\n\n.nig-status-widget.success {\n    background: var(--nig-color-accent-success);\n    color: white;\n    cursor: pointer;\n    border-color: var(--nig-color-accent-success);\n}\n\n.nig-status-widget.success:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-2px);\n    box-shadow: var(--nig-shadow-lg);\n}\n\n.nig-status-widget.error {\n    background: var(--nig-color-accent-error);\n    border-color: var(--nig-color-accent-error);\n}\n\n@keyframes nig-spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n/* === Loading Animations === */\n.nig-image-loading {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(2px);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10;\n}\n\n.nig-spinner {\n    width: 32px;\n    height: 32px;\n    border: 3px solid rgba(255, 255, 255, 0.3);\n    border-top: 3px solid white;\n    border-radius: 50%;\n    animation: nig-spin 1s linear infinite;\n}\n\n/* === Enhancement Status & Priority Utilities === */\n.nig-enhancement-status {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    margin-left: var(--nig-space-md);\n}\n\n.nig-enhancement-status.provider-priority {\n    background: var(--nig-color-accent-warning);\n    color: white;\n}\n\n.nig-enhancement-status.external-ai {\n    background: var(--nig-color-accent-primary);\n    color: white;\n}\n\n.nig-enhancement-status.disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n}\n\n.nig-status-indicator {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    background: #4af028;\n    opacity: 0.8;\n}\n\n/* === Enhancement Settings States === */\n.nig-enhancement-settings {\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-enhancement-settings.disabled {\n    opacity: 0.5;\n    pointer-events: none;\n}\n\n.nig-enhancement-settings.disabled .nig-form-group input,\n.nig-enhancement-settings.disabled .nig-form-group select,\n.nig-enhancement-settings.disabled .nig-form-group textarea {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n/* === Modal Overlay Z-Index Hierarchy === */\n/* Config Panel - Lower z-index */\n#nig-config-panel.nig-modal-overlay {\n    z-index: 99998;\n}\n\n/* Image Viewer - Higher z-index than config panel */\n#nig-image-viewer.nig-modal-overlay {\n    z-index: 99999;\n}\n\n/* Navigation Tabs - Higher than status widget, lower than modals */\n.nig-tabs {\n    z-index: 1000;\n    position: relative;\n}",""]);const s=r},103:(e,n,t)=>{t.d(n,{$f:()=>g,JE:()=>d,MD:()=>c,RJ:()=>r,Rm:()=>s,X:()=>u,fH:()=>l,vV:()=>p,xx:()=>m});var i=t(715);let a=!1,o=[];async function r(){a=await(0,i.Ct)("loggingEnabled")}function s(e,n,t,i=null){if(!a)return;const r={timestamp:(new Date).toISOString(),level:e,category:n,message:t,data:i},s=`[NIG-${e.toUpperCase()}]`,l=`[${n}]`,c={error:"color: #ef4444",warn:"color: #f59e0b",debug:"color: #8b5cf6",info:"color: #6366f1"}[e];i?console.log(`%c${s}`,c,l,t,i):console.log(`%c${s}`,c,l,t),"ENHANCEMENT"===n&&(o.unshift(r),o.length>50&&(o=o.slice(0,50)),GM_setValue("enhancementLogHistory",JSON.stringify(o.slice(0,20))))}const l=(e,n,t)=>s("info",e,n,t),c=(e,n,t)=>s("debug",e,n,t),d=(e,n,t)=>s("warn",e,n,t),p=(e,n,t)=>s("error",e,n,t);async function m(){try{const e=await GM_getValue("enhancementLogHistory","[]");o="string"==typeof e&&e.trim()?JSON.parse(e):Array.isArray(e)?e:[],c("LOG",`Loaded ${o.length} enhancement log entries from storage`)}catch(e){p("LOG","Failed to load enhancement log history",e),o=[];try{await GM_setValue("enhancementLogHistory","[]")}catch(e){p("LOG","Failed to clear corrupted enhancement log history",e)}}}async function g(){return await m(),o}function u(){o=[],GM_setValue("enhancementLogHistory","[]"),l("LOG","Enhancement logs cleared by user")}},113:e=>{e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},168:(e,n,t)=>{t.d(n,{Bh:()=>c,Hg:()=>r,WN:()=>s,bu:()=>o,tb:()=>l});var i=t(103);async function a(){try{const e=await GM_getValue("cachedModels","{}");return"string"==typeof e&&e.trim()?JSON.parse(e):"object"==typeof e&&null!==e?e:{}}catch(e){return(0,i.Rm)("error","CACHE","Failed to parse cached models data, resetting cache",{error:e.message}),await GM_setValue("cachedModels","{}"),{}}}async function o(e){try{return(await a())[e]||null}catch(n){return(0,i.Rm)("error","CACHE",`Failed to get cached models for ${e}`,{error:n.message}),null}}async function r(e,n){try{const t=await a();t[e]=n,await GM_setValue("cachedModels",JSON.stringify(t)),(0,i.Rm)("info","CACHE",`Cached models for ${e}`)}catch(t){(0,i.Rm)("error","CACHE","Failed to cache models",{provider:e,error:t.message}),await GM_setValue("cachedModels","{}");try{cache[e]=n,await GM_setValue("cachedModels",JSON.stringify(cache)),(0,i.Rm)("info","CACHE",`Cached models for ${e} after cache reset`)}catch(n){(0,i.Rm)("error","CACHE","Failed to cache models even after reset",{provider:e,error:n.message})}}}async function s(e=null){try{if(e){const n=await a();delete n[e],await GM_setValue("cachedModels",JSON.stringify(n)),(0,i.fH)("CACHE",`Cleared cached models for ${e}.`)}else await async function(){try{let e={};try{const n=await GM_getValue("openAICompatProfiles","{}");"string"==typeof n&&n.trim()?e=JSON.parse(n):"object"==typeof n&&null!==n&&(e=n)}catch(e){return void(0,i.Rm)("error","CACHE","Failed to get OpenAI profiles for cache clearing",{error:e.message})}for(const n of Object.keys(e)){const e=`openAICompatModels_${n}`;await GM_setValue(e,"[]")}(0,i.fH)("CACHE","Cleared cached models for all OpenAI compatible providers.")}catch(e){(0,i.Rm)("error","CACHE","Failed to clear OpenAI compatible model caches",{error:e.message})}}(),await GM_setValue("cachedModels","{}"),(0,i.fH)("CACHE","Cleared all cached models and reset OpenAI Compatible model selections."),alert("All cached models have been cleared. They will be re-fetched when you next open the settings.")}catch(n){(0,i.Rm)("error","CACHE","Failed to clear cached models",{provider:e,error:n.message});try{await GM_setValue("cachedModels","{}"),(0,i.Rm)("info","CACHE","Force reset cache data as fallback")}catch(e){(0,i.Rm)("error","CACHE","Failed to force reset cache",{error:e.message})}}}async function l(e){try{const n=`openAICompatModels_${e}`,t=await GM_getValue(n,"[]");return"string"==typeof t&&t.trim()?JSON.parse(t):Array.isArray(t)?t:[]}catch(n){return(0,i.Rm)("error","CACHE","Failed to parse OpenAI compatible models cache",{profileUrl:e,error:n.message}),[]}}async function c(e,n){try{const t=`openAICompatModels_${e}`;await GM_setValue(t,JSON.stringify(n)),(0,i.Rm)("info","CACHE",`Cached models for OpenAI compatible provider: ${e}`)}catch(n){(0,i.Rm)("error","CACHE","Failed to cache OpenAI compatible models",{profileUrl:e,error:n.message})}}},189:(e,n,t)=>{t.d(n,{CB:()=>u,VM:()=>p,tH:()=>g,populateProviderForms:()=>y,Yl:()=>h});const i=[{name:"Deliberate",desc:"Versatile, high-quality realism and detail."},{name:"Anything Diffusion",desc:"Anime-style specialist."},{name:"ICBINP - I Can't Believe It's Not Photography",desc:"Photorealistic focus; excels in lifelike portraits."},{name:"stable_diffusion",desc:"The classic base model; reliable all-rounder."},{name:"AlbedoBase XL (SDXL)",desc:"SDXL variant; strong for high-res, detailed scenes."},{name:"Nova Anime XL",desc:"Anime and illustration; vibrant, dynamic characters."},{name:"Dreamshaper",desc:"Creative and dreamy outputs; good for artistic concepts."},{name:"Hentai Diffusion",desc:"NSFW/anime erotica specialist."},{name:"CyberRealistic Pony",desc:"Realistic with a cyberpunk twist."},{name:"Flux.1-Schnell fp8 (Compact)",desc:"Newer, fast-generation model for quick results."}];var a=t(168),o=t(715),r=t(103);function s(e,n,t){e.innerHTML="",n.forEach(n=>{const t=document.createElement("option");t.value=n;let i=n;"gptimage"===n?i+=" (Recommended: Quality)":"flux"===n&&(i+=" (Default: Speed)"),t.textContent=i,e.appendChild(t)}),n.includes(t)?e.value=t:e.value="flux"}function l(e,n,t){e.innerHTML="";const a=new Map(n.map(e=>[e.name,e])),o=new Set(i.map(e=>e.name)),r=document.createElement("optgroup");r.label="Top 10 Popular Models";const s=document.createElement("optgroup");s.label="Other Models",i.forEach(e=>{if(a.has(e.name)){const n=a.get(e.name),t=document.createElement("option");t.value=e.name,t.textContent=`${e.name} - ${e.desc} (${n.count} workers)`,r.appendChild(t)}}),n.filter(e=>!o.has(e.name)).sort((e,n)=>n.count-e.count).forEach(e=>{const n=document.createElement("option");n.value=e.name,n.textContent=`${e.name} (${e.count} workers)`,s.appendChild(n)}),e.appendChild(r),e.appendChild(s),Array.from(e.options).some(e=>e.value===t)?e.value=t:e.value=n[0]?.name||"Stable Diffusion"}function c(e){return"boolean"==typeof e.is_free?e.is_free:"boolean"==typeof e.premium_model?!e.premium_model:!(!Array.isArray(e.tiers)||!e.tiers.includes("Free"))}function d(e,n,t){e.innerHTML="";const i=document.createElement("optgroup");i.label="Free Models";const a=document.createElement("optgroup");a.label="Paid Models",n.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.id,c(e)?i.appendChild(n):a.appendChild(n)}),i.childElementCount>0&&e.appendChild(i),a.childElementCount>0&&e.appendChild(a),n.some(e=>e.id===t)&&(e.value=t)}async function p(){const e=document.getElementById("nig-openai-compat-base-url").value.trim(),n=document.getElementById("nig-openai-compat-api-key").value.trim();if(!e)return void alert("Please enter a Base URL first.");const t=document.getElementById("nig-openai-compat-model");t.innerHTML="<option>Fetching models...</option>",r.fH("NETWORK",`Fetching OpenAI compatible models from ${e}`),GM_xmlhttpRequest({method:"GET",url:`${e}/models`,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},onload:async n=>{try{const i=JSON.parse(n.responseText);if(!i.data||!Array.isArray(i.data))throw new Error("Invalid model list format received.");let o=[];if(o=i.data.some(e=>e.endpoint||e.endpoints)?i.data.filter(e=>"/v1/images/generations"===e.endpoint||e.endpoints?.includes("/v1/images/generations")):i.data.some(e=>"images.generations"===e.type)?i.data.filter(e=>"images.generations"===e.type):i.data.filter(e=>{const n=e.id.toLowerCase();return n.includes("dall-e")||n.includes("dalle")||n.includes("image")||n.includes("midjourney")||n.includes("stable diffusion")||n.includes("flux")||n.includes("imagen")}),o.sort((e,n)=>{const t=c(e),i=c(n);return t&&!i?-1:!t&&i?1:e.id.localeCompare(n.id)}),0===o.length)throw new Error("No image generation models found. This provider may not support image generation.");d(t,o),await a.Bh(e,o),r.fH("NETWORK",`Successfully fetched and cached ${o.length} models for ${e}`)}catch(e){r.vV("NETWORK","Failed to parse OpenAI compatible models",{error:e.message}),t.innerHTML="<option>Failed to fetch models</option>",alert(`Failed to fetch models. Check the Base URL and API Key. You can enter the model name manually. Error: ${e.message}`),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}},onerror:e=>{r.vV("NETWORK","Failed to fetch OpenAI compatible models",{error:e}),t.innerHTML="<option>Failed to fetch models</option>",alert("Failed to fetch models. Check your network connection and the Base URL. Switching to manual input."),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}})}async function m(){const e=document.getElementById("nig-openai-compat-profile-select"),n=await o.zj(),t=n.openAICompatProfiles||{},i=n.openAICompatActiveProfileUrl;e.innerHTML="",Object.keys(t).forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)});const a=document.createElement("option");a.value="__new__",a.textContent="— Add or Edit Profile —",e.appendChild(a),i&&t[i]?e.value=i:e.value="__new__",g()}async function g(){const e=document.getElementById("nig-openai-compat-profile-select"),n=await o.zj(),t=n.openAICompatProfiles||{},i=e.value;if(i&&t[i]){const e=t[i];document.getElementById("nig-openai-compat-base-url").value=i,document.getElementById("nig-openai-compat-api-key").value=e.apiKey,n.openAICompatModelManualInput?document.getElementById("nig-openai-compat-model-manual").value=e.model:(document.getElementById("nig-openai-compat-model").value=e.model,async function(e,n){const t=document.getElementById("nig-openai-compat-model"),i=await a.tb(e);i&&i.length>0?d(t,i,n):t.innerHTML="<option>No cached models. Click Fetch to get models.</option>"}(i,e.model))}else document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>"}async function u(){const e=document.getElementById("nig-openai-compat-profile-select").value;if("__new__"!==e){if(confirm(`Delete profile for "${e}"?`)){const n=(await o.zj()).openAICompatProfiles||{};delete n[e],await o.yJ("openAICompatProfiles",n),document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>",document.getElementById("nig-openai-compat-model-manual").value="",await m()}}else alert("You can't delete the 'Add New' option.")}async function h(){await o.yJ("pollinationsModel",document.getElementById("nig-pollinations-model").value),await o.yJ("pollinationsWidth",document.getElementById("nig-pollinations-width").value),await o.yJ("pollinationsHeight",document.getElementById("nig-pollinations-height").value),await o.yJ("pollinationsSeed",document.getElementById("nig-pollinations-seed").value.trim()),await o.yJ("pollinationsEnhance",document.getElementById("nig-pollinations-enhance").checked),await o.yJ("pollinationsSafe",document.getElementById("nig-pollinations-safe").checked),await o.yJ("pollinationsNologo",document.getElementById("nig-pollinations-nologo").checked),await o.yJ("pollinationsPrivate",document.getElementById("nig-pollinations-private").checked),await o.yJ("pollinationsToken",document.getElementById("nig-pollinations-token").value.trim()),await o.yJ("aiHordeApiKey",document.getElementById("nig-horde-api-key").value.trim()||"0000000000"),await o.yJ("aiHordeModel",document.getElementById("nig-horde-model").value),await o.yJ("aiHordeSampler",document.getElementById("nig-horde-sampler").value),await o.yJ("aiHordeSteps",document.getElementById("nig-horde-steps").value),await o.yJ("aiHordeCfgScale",document.getElementById("nig-horde-cfg").value),await o.yJ("aiHordeWidth",document.getElementById("nig-horde-width").value),await o.yJ("aiHordeHeight",document.getElementById("nig-horde-height").value),await o.yJ("aiHordeSeed",document.getElementById("nig-horde-seed").value.trim());const e=Array.from(document.querySelectorAll('input[name="nig-horde-post"]:checked')).map(e=>e.value);await o.yJ("aiHordePostProcessing",e),await o.yJ("googleApiKey",document.getElementById("nig-google-api-key").value.trim()),await o.yJ("model",document.getElementById("nig-model").value),await o.yJ("numberOfImages",document.getElementById("nig-num-images").value),await o.yJ("imageSize",document.getElementById("nig-image-size").value),await o.yJ("aspectRatio",document.getElementById("nig-aspect-ratio").value),await o.yJ("personGeneration",document.getElementById("nig-person-gen").value);const n=document.getElementById("nig-openai-compat-base-url").value.trim();if(n){const e=await o.Ct("openAICompatProfiles"),t="none"!==document.getElementById("nig-openai-model-container-manual").style.display,i=t?document.getElementById("nig-openai-compat-model-manual").value.trim():document.getElementById("nig-openai-compat-model").value;e[n]={apiKey:document.getElementById("nig-openai-compat-api-key").value.trim(),model:i},await o.yJ("openAICompatProfiles",e),await o.yJ("openAICompatActiveProfileUrl",n),await o.yJ("openAICompatModelManualInput",t),await m()}}async function y(e){document.getElementById("nig-pollinations-width").value=e.pollinationsWidth,document.getElementById("nig-pollinations-height").value=e.pollinationsHeight,document.getElementById("nig-pollinations-seed").value=e.pollinationsSeed,document.getElementById("nig-pollinations-enhance").checked=e.pollinationsEnhance,document.getElementById("nig-pollinations-safe").checked=e.pollinationsSafe,document.getElementById("nig-pollinations-nologo").checked=e.pollinationsNologo,document.getElementById("nig-pollinations-private").checked=e.pollinationsPrivate,document.getElementById("nig-pollinations-token").value=e.pollinationsToken,async function(e){const n=document.getElementById("nig-pollinations-model");n.innerHTML="<option>Loading models...</option>";try{const t=await a.bu("pollinations");if(t&&t.length>0)return r.fH("CACHE","Loading Pollinations models from cache"),void s(n,t,e)}catch(e){r.vV("CACHE","Failed to get cached Pollinations models",{error:e.message})}r.fH("NETWORK","Fetching Pollinations models from API"),GM_xmlhttpRequest({method:"GET",url:"https://image.pollinations.ai/models",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async t=>{try{const i=JSON.parse(t.responseText);await a.Hg("pollinations",i),r.fH("NETWORK","Fetched and cached Pollinations models",{count:i.length}),s(n,i,e)}catch(e){r.vV("NETWORK","Failed to parse Pollinations models",{error:e.message}),n.innerHTML="<option>flux</option>",n.value="flux"}},onerror:e=>{r.vV("NETWORK","Failed to fetch Pollinations models",{error:e}),n.innerHTML="<option>flux</option>",n.value="flux"}})}(e.pollinationsModel),document.getElementById("nig-horde-api-key").value=e.aiHordeApiKey,document.getElementById("nig-horde-sampler").value=e.aiHordeSampler,document.getElementById("nig-horde-steps").value=e.aiHordeSteps,document.getElementById("nig-horde-cfg").value=e.aiHordeCfgScale,document.getElementById("nig-horde-width").value=e.aiHordeWidth,document.getElementById("nig-horde-height").value=e.aiHordeHeight,document.getElementById("nig-horde-seed").value=e.aiHordeSeed,document.querySelectorAll('input[name="nig-horde-post"]').forEach(n=>{n.checked=e.aiHordePostProcessing.includes(n.value)}),async function(e){const n=document.getElementById("nig-horde-model");n.innerHTML="<option>Loading models...</option>";try{const t=await a.bu("aiHorde");if(t&&t.length>0)return r.fH("CACHE","Loading AI Horde models from cache"),void l(n,t,e)}catch(e){r.vV("CACHE","Failed to get cached AI Horde models",{error:e.message})}r.fH("NETWORK","Fetching AI Horde models from API"),GM_xmlhttpRequest({method:"GET",url:"https://aihorde.net/api/v2/status/models?type=image",onload:async t=>{try{const i=JSON.parse(t.responseText);await a.Hg("aiHorde",i),r.fH("NETWORK","Fetched and cached AI Horde models",{count:i.length}),l(n,i,e)}catch(e){r.vV("NETWORK","Failed to parse AI Horde models",{error:e.message}),n.innerHTML="<option>Stable Diffusion</option>",n.value="Stable Diffusion"}},onerror:e=>{r.vV("NETWORK","Failed to fetch AI Horde models",{error:e}),n.innerHTML="<option>Stable Diffusion</option>",n.value="Stable Diffusion"}})}(e.aiHordeModel),document.getElementById("nig-google-api-key").value=e.googleApiKey,document.getElementById("nig-model").value=e.model,document.getElementById("nig-num-images").value=e.numberOfImages,document.getElementById("nig-image-size").value=e.imageSize,document.getElementById("nig-aspect-ratio").value=e.aspectRatio,document.getElementById("nig-person-gen").value=e.personGeneration,await m(),e.openAICompatModelManualInput?(document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"):(document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none")}},249:(e,n,t)=>{t.d(n,{A:()=>g});var i=t(601),a=t.n(i),o=t(314),r=t.n(o),s=t(565),l=t(754),c=t(92),d=t(784),p=t(484),m=r()(a());m.i(s.A),m.i(l.A),m.i(c.A),m.i(d.A),m.i(p.A),m.push([e.id,"/* === Novel Image Generator - Main CSS Module ===\n * This file imports all CSS modules to maintain functionality\n * while providing better organization and maintainability.\n */\n\n/* Import all CSS modules in proper order for cascade and specificity */\n\n/* CSS Modules Structure:\n * - base.css: CSS custom properties, typography, fonts, and base styles\n * - components.css: UI components like buttons, modals, forms, and interactive elements\n * - utilities.css: Utility classes, status widgets, and helper functions\n * - layout.css: Layout systems, grids, tabs, image gallery, and responsive grids\n * - themes.css: Responsive design, media queries, and theme-specific styles\n */",""]);const g=m},314:e=>{e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var t="",i=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),i&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),i&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t}).join("")},n.i=function(e,t,i,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);i&&r[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),n.push(d))}},n}},322:(e,n,t)=>{function i(e,n,t){const i=new Blob([n],{type:t}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function a(){return"WTR LAB Novel Image Generator".replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}t.d(n,{P:()=>i,t:()=>a})},484:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"/* === Responsive Design === */\n\n/* Mobile First Base (up to 767px) */\n@media (max-width: 767px) {\n    .nig-modal-content {\n        margin: var(--nig-space-md);\n        padding: var(--nig-space-xl);\n        max-height: 95vh;\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-modal-overlay {\n        padding: var(--nig-space-sm);\n    }\n\n    .nig-button {\n        position: fixed;\n        bottom: var(--nig-space-3xl);\n        left: 50% !important;\n        transform: translateX(-50%);\n        top: auto !important;\n        padding: var(--nig-space-sm) var(--nig-space-lg);\n        font-size: var(--nig-font-size-sm);\n        z-index: 100001;\n        min-height: 44px; /* Touch target */\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-button:hover {\n        /* Prevent hover movement on mobile - maintain centering */\n        transform: translateX(-50%);\n        background: var(--nig-color-hover-primary);\n    }\n\n    .nig-tabs {\n        margin: 0 calc(-1 * var(--nig-space-xl)) var(--nig-space-xl) calc(-1 * var(--nig-space-xl));\n        padding: 0 var(--nig-space-xl);\n    }\n\n    .nig-tab {\n        padding: var(--nig-space-md) var(--nig-space-lg);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-checkbox-group {\n        flex-direction: column;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-checkbox-group label {\n        justify-content: flex-start;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-utility-card {\n        padding: var(--nig-space-lg);\n    }\n\n    .nig-card-header {\n        flex-direction: column;\n        align-items: center;\n        text-align: center;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-card-secondary-actions {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-card-footer {\n        text-align: center;\n    }\n\n    .nig-history-cleanup {\n        flex-direction: column;\n        align-items: stretch;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-history-cleanup input[type=\"number\"] {\n        width: 100%;\n    }\n\n    .nig-status-widget {\n        bottom: var(--nig-space-lg);\n        left: var(--nig-space-md);\n        padding: var(--nig-space-md);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-modal-content h2 {\n        font-size: var(--nig-font-size-xl);\n        padding-right: 48px; /* Space for close button */\n    }\n\n    /* Mobile Enhancement Styles */\n    .nig-preview-container {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-preview-arrow {\n        transform: rotate(90deg);\n        justify-self: center;\n    }\n\n    .nig-enhancement-status {\n        margin-left: 0;\n        margin-top: var(--nig-space-sm);\n        align-self: flex-start;\n    }\n}\n\n/* Tablet (768px to 1023px) */\n@media (min-width: 768px) and (max-width: 1023px) {\n    .nig-modal-content {\n        max-width: 700px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-cleanup-controls {\n        justify-content: flex-start;\n    }\n}\n\n/* Desktop (1024px and up) */\n@media (min-width: 1024px) {\n    .nig-modal-content {\n        max-width: 1000px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    }\n\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-settings:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--nig-shadow-md);\n    }\n\n    /* Enhanced hover states for desktop */\n    .nig-tab:hover {\n        background: var(--nig-color-bg-tertiary);\n    }\n\n    .nig-history-item:hover {\n        transform: translateY(-1px);\n    }\n}\n\n/* Large Desktop (1280px and up) */\n@media (min-width: 1280px) {\n    .nig-modal-content {\n        max-width: 1200px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));\n    }\n\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-styling-container {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* === Error Modal === */\n#nig-error-reason {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-sm);\n    max-height: 150px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    white-space: pre-wrap;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-prompt {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-lg);\n    max-height: 200px;\n    overflow-y: auto;\n    word-break: break-word;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    width: 100%;\n    resize: vertical;\n    min-height: 80px;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-actions {\n    margin-top: var(--nig-space-xl);\n}",""]);const s=r},540:e=>{e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},565:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"@import url(https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap);"]),r.push([e.id,"@import url(https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap);"]),r.push([e.id,"/* === CSS Custom Properties (Design Tokens) === */\n:root {\n    /* Color Palette - Modern Dark Theme */\n    --nig-color-bg-primary: #1a1a1e;\n    --nig-color-bg-secondary: #2d2d32;\n    --nig-color-bg-tertiary: #3a3a40;\n    --nig-color-bg-elevated: #404046;\n    --nig-color-text-primary: #f0f0f0;\n    --nig-color-text-secondary: #b4b4b8;\n    --nig-color-text-muted: #8a8a8e;\n    --nig-color-border: #55555a;\n    --nig-color-border-light: #6a6a6e;\n\n    /* Accent Colors */\n    --nig-color-accent-primary: #6366f1;\n    --nig-color-accent-secondary: #8b5cf6;\n    --nig-color-accent-success: #10b981;\n    --nig-color-accent-warning: #f59e0b;\n    --nig-color-accent-error: #ef4444;\n\n    /* Interactive States */\n    --nig-color-hover-primary: #5855eb;\n    --nig-color-hover-secondary: #7c3aed;\n    --nig-color-hover-success: #059669;\n    --nig-color-hover-error: #dc2626;\n\n    /* Spacing Scale */\n    --nig-space-xs: 0.25rem;\n    --nig-space-sm: 0.5rem;\n    --nig-space-md: 0.75rem;\n    --nig-space-lg: 1rem;\n    --nig-space-xl: 1.5rem;\n    --nig-space-2xl: 2rem;\n    --nig-space-3xl: 3rem;\n\n    /* Typography Scale */\n    --nig-font-size-xs: 0.75rem;\n    --nig-font-size-sm: 0.875rem;\n    --nig-font-size-base: 1rem;\n    --nig-font-size-lg: 1.125rem;\n    --nig-font-size-xl: 1.25rem;\n    --nig-font-size-2xl: 1.5rem;\n    --nig-font-size-3xl: 1.875rem;\n\n    /* Border Radius */\n    --nig-radius-sm: 0.375rem;\n    --nig-radius-md: 0.5rem;\n    --nig-radius-lg: 0.75rem;\n    --nig-radius-xl: 1rem;\n\n    /* Shadows */\n    --nig-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);\n    --nig-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);\n    --nig-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);\n    --nig-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);\n\n    /* Transitions */\n    --nig-transition-fast: 0.15s ease-out;\n    --nig-transition-normal: 0.2s ease-out;\n    --nig-transition-slow: 0.3s ease-out;\n\n    /* Breakpoints */\n    --nig-breakpoint-sm: 640px;\n    --nig-breakpoint-md: 768px;\n    --nig-breakpoint-lg: 1024px;\n    --nig-breakpoint-xl: 1280px;\n}\n\n/* === Base Typography and Font Loading === */\n\n/* === Print Styles === */\n@media print {\n    .nig-modal-overlay,\n    .nig-status-widget,\n    .nig-button {\n        display: none !important;\n    }\n\n    .nig-modal-content {\n        box-shadow: none;\n        border: 1px solid #000;\n        background: white;\n        color: black;\n    }\n}\n\n/* === High Contrast Mode Support === */\n@media (prefers-contrast: high) {\n    :root {\n        --nig-color-bg-primary: #000000;\n        --nig-color-bg-secondary: #1a1a1a;\n        --nig-color-bg-tertiary: #2a2a2a;\n        --nig-color-text-primary: #ffffff;\n        --nig-color-border: #666666;\n    }\n}\n\n/* === Reduced Motion Support === */\n@media (prefers-reduced-motion: reduce) {\n    *,\n    *::before,\n    *::after {\n        animation-duration: 0.01ms !important;\n        animation-iteration-count: 1 !important;\n        transition-duration: 0.01ms !important;\n    }\n}\n\n/* === Material Symbols Import === */\n.material-symbols-outlined {\n    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n    font-size: 18px;\n}\n\n/* === File Input Styling === */\ninput[type=\"file\"] {\n    border: 2px dashed var(--nig-color-border);\n    background: var(--nig-color-bg-primary);\n    padding: var(--nig-space-xl);\n    border-radius: var(--nig-radius-lg);\n    color: var(--nig-color-text-secondary);\n    transition: all var(--nig-transition-normal);\n    cursor: pointer;\n}\n\ninput[type=\"file\"]:hover {\n    border-color: var(--nig-color-accent-primary);\n    background: var(--nig-color-bg-elevated);\n}\n\ninput[type=\"file\"]:focus {\n    outline: none;\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n}",""]);const s=r},601:e=>{e.exports=function(e){return e[1]}},642:(e,n,t)=>{t.d(n,{show:()=>r,v:()=>o});var i=t(322);function a(e){return e.startsWith("data:")}function o(){if(document.getElementById("nig-image-viewer"))return;const e=document.createElement("div");e.id="nig-image-viewer",e.className="nig-modal-overlay",e.style.display="none",e.innerHTML='\n\t\t<div class="nig-modal-content">\n\t\t\t<span class="nig-close-btn">&times;</span>\n\t\t\t<div id="nig-prompt-container" class="nig-prompt-container">\n\t\t\t\t<div class="nig-prompt-header"><span>Generated Image Prompt</span></div>\n\t\t\t\t<p id="nig-prompt-text" class="nig-prompt-text"></p>\n\t\t\t</div>\n\t\t\t<div id="nig-image-gallery" class="nig-image-gallery"></div>\n\t\t</div>',document.body.appendChild(e),e.querySelector(".nig-close-btn").addEventListener("click",()=>{e.style.display="none",Promise.resolve().then(t.bind(t,867)).then(e=>{e.updateSystemStatus})});const n=e.querySelector("#nig-prompt-container");n.addEventListener("click",()=>{n.classList.toggle("expanded")})}function r(e,n,t,r="Unknown"){document.getElementById("nig-image-viewer")||o();const s=document.getElementById("nig-image-viewer"),l=s.querySelector("#nig-image-gallery");l.innerHTML="";const c=s.querySelector("#nig-prompt-container");s.querySelector("#nig-prompt-text").textContent=n,c.classList.remove("expanded");const d="Pollinations"===t||"OpenAICompat"===t?"jpg":"png";e.forEach((e,o)=>{const s=document.createElement("div");s.className="nig-image-container";const c=document.createElement("img");if(c.src=e,!a(e)){c.loading="lazy",c.alt="Generated image",c.onerror=()=>{c.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+",c.alt="Image not available"};const e=document.createElement("div");e.className="nig-image-loading",e.innerHTML='<div class="nig-spinner"></div>',s.appendChild(e),c.onload=()=>{e.remove()}}const p=document.createElement("div");p.className="nig-image-actions";const m=document.createElement("button");m.innerHTML='<span class="material-symbols-outlined">download</span>',m.title="Download Image",m.onclick=()=>{const a=document.createElement("a");a.href=e;const s=(0,i.t)(),l=t.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_"),c=r.replace(/[^\w\s-]/g,"").replace(/\s+/g,"_"),p=n.substring(0,15).replace(/\s/g,"_").replace(/[^\w_]/g,"");a.download=`${s}_${l}_${c}_${p}_${o+1}.${d}`,a.click()};const g=document.createElement("button");g.innerHTML='<span class="material-symbols-outlined">fullscreen</span>',g.title="View Fullscreen",g.onclick=()=>{c.requestFullscreen&&c.requestFullscreen()};const u=document.createElement("button");!a(e)&&function(e){try{return new URL(e),!0}catch{return!1}}(e)&&(u.innerHTML='<span class="material-symbols-outlined">link</span>',u.title="Open Image URL",u.onclick=()=>{window.open(e,"_blank")},p.appendChild(u)),p.appendChild(m),p.appendChild(g),s.appendChild(c),s.appendChild(p),l.appendChild(s)}),s.style.display="flex"}},659:e=>{var n={};e.exports=function(e,t){var i=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(t)}},715:(e,n,t)=>{t.d(n,{Pc:()=>c,qg:()=>u,j5:()=>g,zj:()=>r,Ct:()=>o,A5:()=>m,Iy:()=>d,yJ:()=>s,qH:()=>p});var i=t(753);async function a(e,n=5e3){if(e.startsWith("data:"))return{isAccessible:!0,status:"valid",error:null,method:"data-url"};if(e.startsWith("blob:"))return{isAccessible:!0,status:"valid",error:null,method:"blob-url"};try{const t=new AbortController,i=setTimeout(()=>t.abort(),n),a=await fetch(e,{method:"HEAD",mode:"cors",signal:t.signal,cache:"no-cache"});if(clearTimeout(i),a.ok)return{isAccessible:!0,status:a.status,statusText:a.statusText,error:null,method:"head"};if(405===a.status||501===a.status){const t=new AbortController,i=setTimeout(()=>t.abort(),n),a=await fetch(e,{method:"GET",mode:"cors",signal:t.signal,cache:"no-cache"});return clearTimeout(i),{isAccessible:a.ok,status:a.status,statusText:a.statusText,error:a.ok?null:new Error(`HTTP ${a.status}: ${a.statusText}`),method:"get"}}return{isAccessible:!1,status:a.status,statusText:a.statusText,error:new Error(`HTTP ${a.status}: ${a.statusText}`),method:"head"}}catch(e){return"AbortError"===e.name?{isAccessible:!1,status:"timeout",statusText:"Request timeout",error:new Error("Request timeout"),method:"timeout"}:e.message.includes("Failed to fetch")||e.message.includes("NetworkError")?{isAccessible:!1,status:"network-error",statusText:"Network error or CORS blocked",error:new Error("Network error or CORS blocked"),method:"network-error"}:{isAccessible:!1,status:"unknown-error",statusText:"Unknown error",error:e,method:"error"}}}async function o(e){return await GM_getValue(e,i.z[e])}async function r(){const e={};for(const n in i.z)e[n]=await GM_getValue(n,i.z[n]);return e}async function s(e,n){await GM_setValue(e,n)}async function l(){try{const e=await GM_getValue("history","[]");return"string"==typeof e&&e.trim()?JSON.parse(e):Array.isArray(e)?e:[]}catch(e){return console.error("Failed to parse history data, resetting",e),await GM_setValue("history","[]"),[]}}async function c(e){const n=await l();n.unshift(e),n.length>100&&n.pop(),await GM_setValue("history",JSON.stringify(n))}async function d(){try{const e=await GM_getValue("historyDays",i.z.historyDays),n=parseInt(e);return isNaN(n)||n<1||n>365?(console.warn("Invalid historyDays value, using default:",e),await p(i.z.historyDays),i.z.historyDays):n}catch(e){return console.error("Failed to get historyDays setting:",e),i.z.historyDays}}async function p(e){try{const n=parseInt(e);if(isNaN(n)||n<1||n>365)throw new Error(`Invalid historyDays value: ${e}. Must be between 1 and 365.`);return await GM_setValue("historyDays",n),!0}catch(e){throw console.error("Failed to set historyDays:",e),e}}async function m(){try{const e=await l(),n=await d(),t=new Date;return t.setDate(t.getDate()-n),e.filter(e=>new Date(e.date)>t)}catch(e){return console.error("Failed to get filtered history:",e),await l()}}async function g(){try{const e=await l(),n=await d(),t=new Date;t.setDate(t.getDate()-n);const i=e.filter(e=>new Date(e.date)>t),a=e.length-i.length;return a>0&&await GM_setValue("history",JSON.stringify(i)),a}catch(e){throw console.error("Failed to clean old history:",e),e}}async function u(e=null){try{const n=await l(),t=await d(),i=new Date;i.setDate(i.getDate()-t);const o=n.filter(e=>new Date(e.date)>i),r=n.length-o.length,s=await async function(e,n=null){const t=e.filter(e=>e.url&&!e.url.startsWith("data:")&&!e.url.startsWith("blob:")).map(e=>e.url);if(0===t.length)return{filteredHistory:e,expiredLinksCount:0,totalLinksChecked:0,results:[]};const i=await async function(e,n=null,t=5e3){const i=[],o=e.length;for(let r=0;r<e.length;r+=3){const s=e.slice(r,r+3).map(async(e,n)=>{const i=await a(e,t);return i.url=e,i}),l=await Promise.all(s);i.push(...l),n&&n({current:Math.min(r+3,o),total:o,completed:i.length,failed:i.filter(e=>!e.isAccessible).length}),r+3<e.length&&await new Promise(e=>setTimeout(e,100))}return i}(t,n),o=i.filter(e=>!e.isAccessible).map(e=>e.url);return{filteredHistory:e.filter(e=>!(e.url&&!e.url.startsWith("data:")&&!e.url.startsWith("blob:")&&o.includes(e.url))),expiredLinksCount:o.length,totalLinksChecked:t.length,results:i}}(o,e),c=s.expiredLinksCount,p=s.filteredHistory,m=r+c;return m>0&&await GM_setValue("history",JSON.stringify(p)),{totalRemoved:m,oldEntriesRemoved:r,expiredLinksRemoved:c,totalLinksChecked:s.totalLinksChecked,finalHistoryCount:p.length}}catch(e){throw console.error("Failed to clean history with enhanced method:",e),e}}},753:(e,n,t)=>{t.d(n,{z:()=>i});const i={selectedProvider:"Pollinations",loggingEnabled:!1,mainPromptStyle:"None",subPromptStyle:"none",customStyleEnabled:!1,customStyleText:"",enhancementEnabled:!1,enhancementProvider:"gemini",enhancementApiKey:"",enhancementModel:"models/gemini-2.5-pro",enhancementTemplate:"Extract visual elements from this text and craft a concise, image-ready prompt as a flowing paragraph. Focus on: clear subjects, setting and environment, lighting/mood/color palette, and artistic style/composition/framing. Omit narrative, dialogue, text overlays, and non-visual details. Use vivid, concrete descriptors separated by commas or short phrases. End with quality boosters such as highly detailed, sharp focus, high resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene and mood, then add style and technical details.",enhancementTemplateSelected:"standard",enhancementOverrideProvider:!1,enhancementLastStatus:"disabled",enhancementMaxRetriesPerModel:2,enhancementRetryDelay:1e3,enhancementModelsFallback:["models/gemini-2.5-pro","models/gemini-flash-latest","models/gemini-flash-lite-latest","models/gemini-2.5-flash","models/gemini-2.5-flash-lite"],enhancementLogLevel:"info",enhancementAlwaysFallback:!0,enhancementPresets:{standard:{name:"Standard Enhancement",description:"Default enhancement that improves prompt quality",template:'Extract visual elements from this text and craft a concise image generation prompt as a flowing paragraph. Focus on: characters and their appearances/actions/expressions, setting and environment, lighting/mood/color palette, artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, specific descriptors separated by commas or short phrases for clarity. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:'},safety:{name:"Safety Enhancement",description:"Enhances prompts while removing harmful or inappropriate content",template:'Extract visual elements from this text and craft a safe, concise image generation prompt as a flowing paragraph while removing harmful, inappropriate, or policy-violating elements. Focus on: positive and suitable characters and their appropriate appearances/actions/expressions, safe setting and environment, wholesome lighting/mood/color palette, appropriate artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, specific descriptors separated by commas or short phrases for clarity. End with safety-focused quality boosters like "appropriate content, family-friendly, positive imagery, safe, well-balanced, detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with safe core subjects, layer in safe scene/mood, then appropriate style/technicals:'},artistic:{name:"Artistic Enhancement",description:"Focuses on artistic and creative elements",template:'Extract visual elements from this text and craft an artistic image generation prompt as a flowing paragraph with emphasis on creative elements and visual aesthetics. Focus on: characters and their creative appearances/actions/expressions with artistic flair, artistic setting and environment, vibrant lighting/mood/color palette, artistic style/composition/framing with emphasis on artistic techniques. Omit narrative, dialogue, text, or non-visual details. Use vivid, artistic descriptors separated by commas or short phrases for clarity. End with artistic quality boosters like "artistic masterpiece, creative composition, vibrant colors, detailed artwork, museum quality, fine art, highly detailed, sharp focus, 8K resolution. Generated Prompt Structure: Start with artistic core subjects, layer in creative scene/mood, then artistic style/technicals:'},technical:{name:"Technical Enhancement",description:"Emphasizes technical accuracy and detail",template:'Extract visual elements from this text and craft a technically-precise image generation prompt as a flowing paragraph with emphasis on technical accuracy and realistic elements. Focus on: characters with technically accurate appearances/actions/expressions, realistic setting and environment, precise lighting/mood/color palette, technical artistic style/composition/framing with photorealistic qualities. Omit narrative, dialogue, text, or non-visual details. Use precise, technical descriptors separated by commas or short phrases for clarity. End with technical quality boosters like "photorealistic, technical precision, accurate details, high resolution, professional photography, sharp focus, 8K detail, masterpiece. Generated Prompt Structure: Start with technically accurate core subjects, layer in realistic scene/mood, then technical style/technicals:'},character:{name:"Character Enhancement",description:"Focuses on character development and description",template:'Extract visual elements from this text and craft a character-focused image generation prompt as a flowing paragraph with emphasis on character details and development. Focus on: detailed character appearances/actions/expressions with rich personality traits, character-centric setting and environment, character-appropriate lighting/mood/color palette, character-driven artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, character-specific descriptors separated by commas or short phrases for clarity. End with character-focused quality boosters like "detailed character, expressive features, well-defined personality, professional portrait, masterpiece character study, highly detailed, sharp focus, 8K resolution. Generated Prompt Structure: Start with compelling core characters, layer in character-appropriate scene/mood, then character-focused style/technicals:'},environment:{name:"Environment Enhancement",description:"Enhances environmental and setting descriptions",template:'Extract visual elements from this text and craft an environment-focused image generation prompt as a flowing paragraph with emphasis on immersive setting details. Focus on: characters within richly described environment and setting, atmospheric surrounding environment with detailed lighting/mood/color palette, environmental artistic style/composition/framing with emphasis on spatial relationships. Omit narrative, dialogue, text, or non-visual details. Use vivid, environmental descriptors separated by commas or short phrases for clarity. End with environmental quality boosters like "immersive environment, detailed background, atmospheric lighting, cinematic composition, 8K environmental detail, masterpiece. Generated Prompt Structure: Start with environment-centric subjects, layer in detailed scene/mood, then environmental style/technicals:'},composition:{name:"Composition Enhancement",description:"Focuses on composition and visual structure",template:'Extract visual elements from this text and craft a composition-focused image generation prompt as a flowing paragraph with emphasis on visual structure and framing. Focus on: characters with composition-aware appearances/actions/expressions, well-composed setting and environment, strategically lit lighting/mood/color palette, composition-driven artistic style/composition/framing with photographic techniques. Omit narrative, dialogue, text, or non-visual details. Use vivid, compositional descriptors separated by commas or short phrases for clarity. End with compositional quality boosters like "excellent composition, balanced framing, visual impact, professional photography, cinematic quality, masterpiece composition, highly detailed, sharp focus, 8K resolution. Generated Prompt Structure: Start with compositionally strong core subjects, layer in balanced scene/mood, then composition-focused style/technicals:'},clean:{name:"Clean Enhancement",description:"Removes potentially harmful or inappropriate elements",template:'Extract visual elements from this text and craft a clean, family-friendly image generation prompt as a flowing paragraph while removing harmful, inappropriate, or problematic elements. Focus on: positive, appropriate characters and their wholesome appearances/actions/expressions, safe, family-friendly setting and environment, positive lighting/mood/color palette, appropriate artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use positive, clean descriptors separated by commas or short phrases for clarity. End with clean quality boosters like "appropriate content, family-friendly, positive imagery, clean composition, well-balanced, detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with clean core subjects, layer in positive scene/mood, then appropriate style/technicals:'}},enableNegPrompt:!0,globalNegPrompt:"ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality",googleApiKey:"",model:"imagen-4.0-generate-001",numberOfImages:1,imageSize:"1024",aspectRatio:"1:1",personGeneration:"allow_adult",aiHordeApiKey:"0000000000",aiHordeModel:"AlbedoBase XL (SDXL)",aiHordeSampler:"k_dpmpp_2m",aiHordeSteps:25,aiHordeCfgScale:7,aiHordeWidth:512,aiHordeHeight:512,aiHordePostProcessing:[],aiHordeSeed:"",pollinationsModel:"flux",pollinationsWidth:512,pollinationsHeight:512,pollinationsSeed:"",pollinationsEnhance:!0,pollinationsNologo:!1,pollinationsPrivate:!1,pollinationsSafe:!0,pollinationsToken:"",openAICompatProfiles:{},openAICompatActiveProfileUrl:"",openAICompatModelManualInput:!1,historyDays:30}},754:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"/* === Base Components === */\n.nig-button {\n    position: absolute;\n    z-index: 99998;\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    box-shadow: var(--nig-shadow-md);\n    display: none;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-normal);\n    transform: translateY(0);\n}\n.nig-button:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-lg);\n}\n.nig-button:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n/* === Modal Components === */\n.nig-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(8px);\n    z-index: 99999;\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    padding: var(--nig-space-lg);\n}\n\n.nig-modal-content {\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-2xl);\n    border-radius: var(--nig-radius-xl);\n    box-shadow: var(--nig-shadow-xl);\n    width: 100%;\n    max-width: 900px;\n    max-height: 90vh;\n    overflow-y: auto;\n    position: relative;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    border: 1px solid var(--nig-color-border);\n    animation: nig-modal-appear 0.2s ease-out;\n}\n\n@keyframes nig-modal-appear {\n    from {\n        opacity: 0;\n        transform: scale(0.95) translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1) translateY(0);\n    }\n}\n\n.nig-modal-content ul {\n}\n\n/* History list alignment fix - remove excessive padding for history results */\n#nig-history-list {\n}\n\n.nig-modal-content li {\n    margin-bottom: var(--nig-space-md);\n}\n\n.nig-close-btn {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 10;\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 300;\n    cursor: pointer;\n    color: var(--nig-color-text-muted);\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: var(--nig-radius-md);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-close-btn:hover {\n    color: var(--nig-color-text-primary);\n    background: var(--nig-color-bg-tertiary);\n}\n\n.nig-modal-content h2 {\n    margin-top: 0;\n    border-bottom: 1px solid var(--nig-color-border);\n    padding-bottom: var(--nig-space-lg);\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 600;\n    letter-spacing: -0.025em;\n}\n\n/* === Form Elements === */\n.nig-form-group {\n    margin-bottom: var(--nig-space-xl);\n}\n\n.nig-form-group label {\n    display: block;\n    margin-bottom: var(--nig-space-sm);\n    font-weight: 500;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-form-group small.nig-hint {\n    color: var(--nig-color-text-muted);\n    font-weight: normal;\n    display: block;\n    margin-top: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-sm);\n    min-height: 1.2em;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n}\n\n.nig-form-group input,\n.nig-form-group select,\n.nig-form-group textarea {\n    width: 100%;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-fast);\n    outline: none;\n}\n\n.nig-form-group input:focus,\n.nig-form-group select:focus,\n.nig-form-group textarea:focus {\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n    background: var(--nig-color-bg-elevated);\n}\n\n.nig-form-group select:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n.nig-form-group textarea {\n    resize: vertical;\n    min-height: 80px;\n    line-height: 1.5;\n}\n\n.nig-form-group-inline {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-lg);\n    align-items: end;\n}\n\n.nig-form-group-inline label {\n    margin-bottom: var(--nig-space-sm);\n}\n\n.nig-checkbox-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--nig-space-lg);\n}\n\n.nig-checkbox-group label {\n    display: flex;\n    align-items: center;\n    margin-right: 0;\n    font-weight: normal;\n    cursor: pointer;\n    color: var(--nig-color-text-secondary);\n}\n\n.nig-checkbox-group input {\n    width: auto;\n    margin-right: var(--nig-space-sm);\n    margin-bottom: 0;\n    transform: scale(1.1);\n}\n\n/* === Button Components === */\n.nig-save-btn {\n    background: var(--nig-color-accent-success);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-save-btn:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-fetch-models-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: 0;\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-primary);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-fetch-models-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-delete-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: 0;\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-error);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-delete-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n.nig-history-cleanup-btn {\n    background: var(--nig-color-accent-error);\n    color: white;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-history-cleanup-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n.nig-retry-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-retry-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-override-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n     padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    align-self: flex-start;\n}\n\n.nig-override-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-test-enhancement-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    width: 100%;\n    justify-content: center;\n}\n\n.nig-test-enhancement-btn:hover:not(:disabled) {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-test-enhancement-btn:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n    transform: none;\n}\n\n.nig-template-btn {\n    background: var(--nig-color-bg-elevated);\n    border: 1px solid var(--nig-color-border);\n    color: var(--nig-color-text-secondary);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    cursor: pointer;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-template-btn:hover {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border-color: var(--nig-color-accent-primary);\n}\n\n/* === Button Footer === */\n.nig-button-footer {\n    margin-top: var(--nig-space-3xl);\n    padding-top: var(--nig-space-xl);\n    border-top: 1px solid var(--nig-color-border);\n    text-align: center;\n}",""]);const s=r},784:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"/* === Tab System === */\n.nig-tabs {\n    display: flex;\n    border-bottom: 1px solid var(--nig-color-border);\n    margin-bottom: var(--nig-space-xl);\n    overflow-x: auto;\n    scrollbar-width: none;\n    -ms-overflow-style: none;\n}\n\n.nig-tabs::-webkit-scrollbar {\n    display: none;\n}\n\n.nig-tab {\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    cursor: pointer;\n    border-radius: var(--nig-radius-md) var(--nig-radius-md) 0 0;\n    background: transparent;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-fast);\n    white-space: nowrap;\n    border: 1px solid transparent;\n    border-bottom: none;\n}\n\n.nig-tab:hover {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n}\n\n.nig-tab.active {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    border: 1px solid var(--nig-color-border);\n    border-bottom: 1px solid var(--nig-color-bg-tertiary);\n    box-shadow: 0 -2px 0 var(--nig-color-accent-primary) inset;\n}\n\n.nig-tab-content {\n    display: none;\n    animation: nig-content-fade 0.2s ease-out;\n}\n\n.nig-tab-content.active {\n    display: block;\n}\n\n@keyframes nig-content-fade {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n/* === Image Gallery === */\n.nig-image-gallery {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-image-container {\n    position: relative;\n    border-radius: var(--nig-radius-lg);\n    overflow: hidden;\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-image-container:hover {\n    box-shadow: var(--nig-shadow-lg);\n    transform: translateY(-2px);\n}\n\n.nig-image-container img {\n    width: 100%;\n    height: auto;\n    display: block;\n    transition: transform var(--nig-transition-slow);\n}\n\n.nig-image-container:hover img {\n    transform: scale(1.02);\n}\n\n.nig-image-actions {\n    position: absolute;\n    top: var(--nig-space-md);\n    right: var(--nig-space-md);\n    display: flex;\n    gap: var(--nig-space-sm);\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(10px);\n    padding: var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    opacity: 0;\n    transition: opacity var(--nig-transition-normal);\n}\n\n.nig-image-container:hover .nig-image-actions {\n    opacity: 1;\n}\n\n.nig-image-actions button {\n    background: rgba(0, 0, 0, 0.8);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    width: 36px;\n    height: 36px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: var(--nig-font-size-base);\n    color: white;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-image-actions button:hover {\n    background: white;\n    transform: scale(1.1);\n}\n\n/* === URL Link Button Styling === */\n.nig-image-actions button[title=\"Open Image URL\"] {\n    background: rgba(99, 102, 241, 0.9);\n}\n\n.nig-image-actions button[title=\"Open Image URL\"]:hover {\n    background: var(--nig-color-accent-primary);\n}\n\n/* === History System === */\n.nig-history-list {\n    list-style: none;\n    padding: 0;\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.nig-history-item {\n    background: var(--nig-color-bg-tertiary);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-md);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-history-item:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-history-item small {\n    display: block;\n    color: var(--nig-color-text-muted);\n    margin-bottom: var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-history-item a {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    word-break: break-all;\n    font-weight: 500;\n    transition: color var(--nig-transition-fast);\n}\n\n/* History prompt: use up to 2 lines, full width, then ellipsis */\n.nig-history-prompt {\n    margin-bottom: var(--nig-space-xs);\n    font-size: var(--nig-font-size-sm);\n    color: var(--nig-color-text-primary);\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    word-break: break-word;\n    line-height: 1.4;\n}\n\n.nig-history-prompt-empty {\n    color: var(--nig-color-text-muted);\n    font-style: italic;\n}\n\n.nig-history-item a:hover {\n    color: var(--nig-color-hover-primary);\n}\n\n/* === Panel Configuration Grid Layout === */\n.nig-config-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-config-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-provider-container {\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-provider-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-provider-header h3 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-provider-header p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-provider-controls {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-provider-settings {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-provider-settings:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-form-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n/* === Styling Tab Layout === */\n.nig-styling-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-styling-intro {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-styling-intro p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.6;\n}\n\n.nig-style-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-style-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-section-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-section-header h4 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n/* === History Tab Layout === */\n.nig-history-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-history-cleanup {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-cleanup-info h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-cleanup-info p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-cleanup-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-md);\n}\n\n.nig-cleanup-controls label {\n    color: var(--nig-color-text-primary);\n    font-weight: 500;\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-cleanup-controls input[type=\"number\"] {\n    width: 80px;\n    padding: var(--nig-space-sm);\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    color: var(--nig-color-text-primary);\n}\n\n/* === Provider Priority Info === */\n.nig-provider-priority-info {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-accent-warning);\n    border-radius: var(--nig-radius-lg);\n     padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-md);\n}\n\n.nig-priority-header {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    color: var(--nig-color-accent-warning);\n    font-weight: 600;\n    font-size: var(--nig-font-size-sm);\n}\n\n/* === Enhancement Preview Layout === */\n.nig-enhancement-preview {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-top: var(--nig-space-lg);\n}\n\n.nig-preview-container {\n    display: grid;\n    grid-template-columns: 1fr auto 1fr;\n    gap: var(--nig-space-lg);\n    align-items: start;\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-preview-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-sm);\n}\n\n.nig-preview-section h5 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.025em;\n}\n\n.nig-preview-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--nig-color-accent-primary);\n    padding: var(--nig-space-sm);\n}\n\n.nig-prompt-display {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md);\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n    color: var(--nig-color-text-secondary);\n    max-height: 120px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    white-space: pre-wrap;\n}\n\n/* === Prompt Container === */\n.nig-prompt-container {\n    background: var(--nig-color-bg-tertiary);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-lg);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n    overflow: hidden;\n}\n\n.nig-prompt-header {\n    padding: var(--nig-space-lg);\n    cursor: pointer;\n    font-weight: 500;\n    display: flex;\n    align-items: center;\n    user-select: none;\n    color: var(--nig-color-text-primary);\n    transition: all var(--nig-transition-fast);\n    position: relative;\n    z-index: 1;\n}\n\n.nig-prompt-header:hover {\n    color: var(--nig-color-accent-primary);\n    background: var(--nig-color-bg-primary);\n}\n\n.nig-prompt-header::before {\n    content: '▸';\n    margin-right: var(--nig-space-md);\n    transition: all var(--nig-transition-normal);\n    color: var(--nig-color-text-muted);\n    font-size: 14px;\n    display: inline-block;\n}\n\n.nig-prompt-container.expanded .nig-prompt-header::before {\n    transform: rotate(90deg);\n    color: var(--nig-color-accent-primary);\n}\n\n.nig-prompt-text {\n    max-height: 0;\n    opacity: 0;\n    overflow: hidden;\n    padding: 0 var(--nig-space-lg);\n    border-top: 1px solid transparent;\n    word-break: break-word;\n    color: var(--nig-color-text-secondary);\n    line-height: 1.6;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-prompt-container.expanded .nig-prompt-text {\n    max-height: 300px;\n    opacity: 1;\n    padding: var(--nig-space-lg);\n    border-top-color: var(--nig-color-border);\n}\n\n@keyframes nig-expand {\n    from {\n        opacity: 0;\n        max-height: 0;\n        transform: translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        max-height: 300px;\n        transform: translateY(0);\n    }\n}\n\n/* === Additional Layout Utilities === */\n.nig-provider-settings {\n    display: none;\n}\n\n.nig-api-prompt-link {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-api-prompt-link:hover {\n    color: var(--nig-color-hover-primary);\n    text-decoration: underline;\n}\n/* Override for History Tab Cleaner number input width on mobile.\n   Ensures #nig-history-clean-days remains compact even if external CSS applies width: 100%. */\n@media (max-width: 767px) {\n  .nig-history-cleanup input[type=\"number\"]#nig-history-clean-days {\n    width: 80px;\n  }\n}",""]);const s=r},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var i="";t.supports&&(i+="@supports (".concat(t.supports,") {")),t.media&&(i+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(i+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),i+=t.css,a&&(i+="}"),t.media&&(i+="}"),t.supports&&(i+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(i,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}},867:(e,n,t)=>{t.d(n,{v:()=>a,y:()=>o});let i=null;function a(){i||(i=document.createElement("div"),i.id="nig-status-widget",i.className="nig-status-widget",i.innerHTML='<div class="nig-status-icon"></div><span class="nig-status-text"></span>',document.body.appendChild(i))}function o(e,n,t=null){if(!i)return;if(i.classList.remove("loading","success","error"),i.onclick=t,"hidden"===e)return void(i.style.display="none");i.style.display="flex",i.querySelector(".nig-status-text").textContent=n,i.classList.add(e);const a=i.querySelector(".nig-status-icon");a.innerHTML="","success"===e?a.innerHTML="✅":"error"===e&&(a.innerHTML="❌")}}},n={};function t(i){var a=n[i];if(void 0!==a)return a.exports;var o=n[i]={id:i,exports:{}};return e[i](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var i=t(72),a=t.n(i),o=t(825),r=t.n(o),s=t(659),l=t.n(s),c=t(56),d=t.n(c),p=t(540),m=t.n(p),g=t(113),u=t.n(g),h=t(249),y={};y.styleTagTransform=u(),y.setAttributes=d(),y.insert=l().bind(null,"head"),y.domAPI=r(),y.insertStyleElement=m(),a()(h.A,y),h.A&&h.A.locals&&h.A.locals;var v=t(103),f=t(715);function b(e,n="api"){if(!function(e){return!(!e||"string"!=typeof e||0===e.trim().length||e.length>32e3)}(e))return e||"";const t=e,i=function(e){return e&&"string"==typeof e?e.replace(/\n{3,}/g,"\n\n").replace(/^\n+|\n+$/g,"").trim():e}(e);return t!==i&&function(e,n,t){"undefined"!=typeof window&&window.console&&console.log(`[PROMPT-CLEANING] [${t}]`,{originalLength:e?.length||0,cleanedLength:n?.length||0,wasCleaned:e!==n,originalPreview:e?.substring(0,100)+(e?.length>100?"...":""),cleanedPreview:n?.substring(0,100)+(n?.length>100?"...":"")})}(t,i,n),i}function w(e,n){(0,v.MD)("ENHANCEMENT","Checking provider priority for enhancement",{provider:e,config:n});const t=(()=>{if("Pollinations"===e){const t=n.pollinationsEnhance;return(0,v.fH)("ENHANCEMENT",`Provider ${e} has built-in enhancement: ${t}`),t}return(0,v.fH)("ENHANCEMENT",`Provider ${e} does not have built-in enhancement`),!1})();return(0,v.MD)("ENHANCEMENT","Provider priority decision completed",{shouldUseProviderEnhancement:t,willUseExternalAI:n.enhancementEnabled&&n.enhancementApiKey&&(!t||n.enhancementOverrideProvider)}),t}async function x(e,n){const t=Date.now(),{enhancementApiKey:i,enhancementModel:a,enhancementTemplate:o,enhancementTemplateSelected:r,mainPromptStyle:s,subPromptStyle:l,customStyleEnabled:c,customStyleText:d,enhancementMaxRetriesPerModel:p=2,enhancementRetryDelay:m=1e3,enhancementModelsFallback:g=["models/gemini-2.5-pro","models/gemini-flash-latest","models/gemini-flash-lite-latest","models/gemini-2.5-flash","models/gemini-2.5-flash-lite"],enhancementLogLevel:u="info",enhancementAlwaysFallback:h=!0}=n,y=c&&d&&d.trim().length>0?[`The user has explicitly chosen this style: "${d.trim()}".`,"You MUST preserve and honor this exact style and aesthetic.",'Do NOT replace it with "photorealistic", "professional photography", or any other conflicting medium unless the user text itself asks for that.',"All enhancements must be consistent with this declared style."].join(" "):s&&"None"!==s?l&&"none"!==l?[`The user has selected main style "${s}" and sub-style "${l}".`,"You MUST preserve and honor these styles as the primary aesthetic.","Do NOT override them with photorealistic/technical photography language unless these styles explicitly imply it.","All enhancements must be consistent with these selected styles."].join(" "):[`The user has selected main style "${s}".`,"You MUST preserve and honor this style as the primary aesthetic.","Do NOT override it with photorealistic/technical photography language unless this style explicitly implies it.","All enhancements must be consistent with this selected style."].join(" "):"",f=[(o&&o.trim().length>0?o.trim():(n.enhancementTemplate||"").trim())||"Extract visual, image-ready elements from the text without changing its intended style.",y].filter(Boolean).join(" ");if(!i)throw new Error("Gemini API key is required for prompt enhancement.");const b=[a,...g.filter(e=>e!==a)];(0,v.fH)("ENHANCEMENT","Starting robust prompt enhancement with Gemini AI",{originalLength:e.length,primaryModel:a,fallbackModels:g,totalModels:b.length,maxRetriesPerModel:p,apiKeyPresent:!!i});let w=null;for(let n=0;n<b.length;n++){const a=b[n],o=a.startsWith("models/")?a.substring(7):a,r=0===n;(0,v.fH)("ENHANCEMENT",`Attempting enhancement with model: ${o}`,{modelIndex:n+1,totalModels:b.length,isPrimaryModel:r,modelName:o});let s=0;for(;s<p;){s++;try{const a=await E(e,o,f,i,r),l=Date.now()-t;return(0,v.fH)("ENHANCEMENT","Prompt enhancement successful",{model:o,attempts:s,duration:l,totalModelsTried:n+1}),a}catch(e){w=e,(0,v.vV)("ENHANCEMENT",`Enhancement failed for model ${o} (attempt ${s}/${p})`,{model:o,attemptNumber:s,error:e.message,isPrimaryModel:r}),s<p&&((0,v.fH)("ENHANCEMENT",`Retrying model ${o} after delay`,{retryDelay:m,nextAttempt:s+1}),await I(m))}}(0,v.JE)("ENHANCEMENT",`Exhausted retries for model ${o}, switching to next model`,{model:o,attemptsMade:s,maxRetries:p,nextModelIndex:n+1,remainingModels:b.length-n-1})}const x=Date.now()-t;if((0,v.vV)("ENHANCEMENT","All models and retries exhausted for prompt enhancement",{totalModelsTried:b.length,duration:x,lastError:w?.message,originalPrompt:e.substring(0,100)+(e.length>100?"...":"")}),h){const n=function(e){let n=e;const t=["highly detailed","sharp focus","8K resolution","masterpiece"];return t.some(e=>n.toLowerCase().includes(e.toLowerCase()))||(n+=", "+t.join(", ")),n=n.replace(/,+/g,",").replace(/,\s*$/,""),n}(e);return(0,v.fH)("ENHANCEMENT","Providing basic enhancement fallback",{fallbackType:"basic_enhancement",originalLength:e.length,fallbackLength:n.length}),n}throw new Error(`All enhancement models failed. Last error: ${w?.message||"Unknown error"}`)}async function E(e,n,t,i,a,o,r){const s=b(e,"gemini_enhancement"),l={contents:[{parts:[{text:t?`${t}\n\nOriginal prompt: "${s}"\n\nEnhanced prompt:`:`Convert this text into a focused visual description for image generation... \n\n"${s}"\n\nEnhanced version:`}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:65536}},c=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${i}`;return new Promise((e,n)=>{const t=a?45e3:3e4;GM_xmlhttpRequest({method:"POST",url:c,headers:{"Content-Type":"application/json"},data:JSON.stringify(l),timeout:t,onload:t=>{try{if(!t.responseText)throw new Error("Empty response received from Gemini API");const n=JSON.parse(t.responseText);if(n.error)throw new Error(n.error.message||"Gemini API error");if(!n.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("No enhancement result received from Gemini API");{const t=n.candidates[0].content.parts[0].text.trim().replace(/^["']|["']$/g,"");e(t)}}catch(e){n(e)}},onerror:e=>{n(new Error("Network error during enhancement request."))},ontimeout:()=>{n(new Error(`Enhancement request timed out after ${t/1e3} seconds.`))}})})}function I(e){return new Promise(n=>setTimeout(n,e))}var k=t(168);function A(e,n,t,i,{onSuccess:a,onFailure:o,updateStatus:r}){const s=Date.now()-t;(0,v.MD)("AIHORDE","Checking AI Horde generation status",{generationId:e,elapsedTimeMs:s,promptPreview:n.substring(0,100)+(n.length>100?"...":"")}),GM_xmlhttpRequest({method:"GET",url:`https://aihorde.net/api/v2/generate/status/${e}`,onload:l=>{try{const c=JSON.parse(l.responseText);if((0,v.MD)("AIHORDE","AI Horde status response received",{generationId:e,responseData:c,isDone:c.done,queuePosition:c.queue_position,processing:c.processing,waitTime:c.wait_time}),c.done){const s=Date.now()-t;if((0,v.fH)("AIHORDE","AI Horde generation completed successfully",{generationId:e,imagesGenerated:c.generations?c.generations.length:0,totalElapsedTime:s}),!c.generations||0===c.generations.length)return(0,v.vV)("AIHORDE","Generation completed but no images returned",{generationId:e,data:c}),void o("Generation completed but no images were returned",n,"AIHorde");r("Completed!");const l=c.generations.map(e=>e.img);a(l,n,"AIHorde",i)}else{let l="Waiting for worker...";if(c.queue_position>0)l=`Queue: ${c.queue_position}. Est: ${c.wait_time}s.`,(0,v.fH)("AIHORDE","AI Horde generation waiting in queue",{generationId:e,queuePosition:c.queue_position,estimatedWaitTime:c.wait_time,statusText:l});else if(c.processing>0){const n=Math.floor(s/1e3),t=Math.floor(n/60),i=n%60,a=t>0?`${t}:${i.toString().padStart(2,"0")}`:`${i}s`;l=`AI Horde: Generating... (${a})`,(0,v.fH)("AIHORDE","AI Horde generation actively processing",{generationId:e,processingWorkers:c.processing,elapsedTime:a,statusText:l})}else(0,v.fH)("AIHORDE","AI Horde generation waiting for worker",{generationId:e,statusText:l});(0,v.MD)("AIHORDE","Calling updateStatus callback",{generationId:e,statusText:l,elapsedTimeMs:s}),r(l),setTimeout(()=>A(e,n,t,i,{onSuccess:a,onFailure:o,updateStatus:r}),5e3)}}catch(t){(0,v.vV)("AIHORDE","Error checking AI Horde status",{generationId:e,error:t.message,responseText:l.responseText}),o(`Error checking status: ${t.message}`,n,"AIHorde")}},onerror:t=>{(0,v.vV)("AIHORDE","Failed to get status from AI Horde",{generationId:e,error:t}),o("Failed to get status from AI Horde.",n,"AIHorde")}})}async function S(e,{onSuccess:n,onFailure:t,updateStatus:i}){const a=await(0,f.zj)(),{aiHordeApiKey:o,aiHordeModel:r,aiHordeSampler:s,aiHordeCfgScale:l,aiHordeSteps:c,aiHordeWidth:d,aiHordeHeight:p,aiHordeSeed:m,aiHordePostProcessing:g,enableNegPrompt:u,globalNegPrompt:h}=a,y=b(e,"aihorde_api_positive_only"),w=!!u,x=(h||"").trim(),E=w&&x.length>0;(0,v.fH)("AIHORDE","Starting AI Horde generation",{promptConstructionPath:"AIHorde: positive_only + separate_negative_field",positivePromptLength:y.length,positivePromptPreview:y.substring(0,200)+(y.length>200?"...":""),model:r,apiKeyProvided:!!o,enableNegPrompt:w,hasNegativePromptText:E,negativePromptLength:E?x.length:0});const I={sampler_name:s,cfg_scale:parseFloat(l),steps:parseInt(c,10),width:parseInt(d,10),height:parseInt(p,10)};m&&(I.seed=m),g.length>0&&(I.post_processing=g);const S={prompt:y,params:I,models:[r]};E&&(S.negative_prompt=x),(0,v.MD)("AIHORDE","Sending generation request to AI Horde",{url:"https://aihorde.net/api/v2/generate/async",model:r,params:I,usesNegativePromptField:!!S.negative_prompt,negativePromptLength:S.negative_prompt?S.negative_prompt.length:0,negativePromptPreview:S.negative_prompt?S.negative_prompt.substring(0,200)+(S.negative_prompt.length>200?"...":""):null}),i("Requesting..."),GM_xmlhttpRequest({method:"POST",url:"https://aihorde.net/api/v2/generate/async",headers:{"Content-Type":"application/json",apikey:o||"0000000000"},data:JSON.stringify(S),onload:a=>{try{const o=JSON.parse(a.responseText);if((0,v.MD)("AIHORDE","AI Horde API response received",{status:a.status,hasGenerationId:!!o.id,message:o.message,error:o.error}),!o.id){if(o.message&&o.message.toLowerCase().includes("model"))return(0,v.vV)("AIHORDE","Model error from AI Horde API",{error:o.message,willRefreshModels:!0}),t(`Model error: ${o.message}. Refreshing model list.`,e,"AIHorde"),void(0,k.WN)("aiHorde");throw(0,v.vV)("AIHORDE","Failed to initiate generation",{error:o.message||"Unknown error",responseData:o}),new Error(o.message||"Failed to initiate generation.")}(0,v.fH)("AIHORDE","AI Horde generation request accepted",{generationId:o.id,model:r}),i("Waiting for status..."),A(o.id,e,Date.now(),r,{onSuccess:n,onFailure:t,updateStatus:i})}catch(n){(0,v.vV)("AIHORDE","Error processing AI Horde response",{error:n.message,responseText:a.responseText}),t(n.message,e,"AIHorde")}},onerror:n=>{(0,v.vV)("AIHORDE","Network error during AI Horde request",{error:n}),t(JSON.stringify(n),e,"AIHorde")}})}var P=t(867),C=t(642);let T=null,M=()=>{},H=()=>{};function N(){T||(T=document.createElement("div"),T.id="nig-error-modal",T.className="nig-modal-overlay",T.style.display="none",T.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Generation Failed</h2>\n            <p>The image could not be generated. Please review the reason below and adjust your prompt if necessary.</p>\n            <p><strong>Reason:</strong></p>\n            <div id="nig-error-reason"></div>\n            <p><strong>Your Prompt:</strong></p>\n            <textarea id="nig-error-prompt" class="nig-error-prompt"></textarea>\n            <div class="nig-form-group" style="margin-top: 15px;">\n                <label for="nig-retry-provider-select">Retry with Provider:</label>\n                <select id="nig-retry-provider-select"></select>\n            </div>\n            <div id="nig-error-actions" class="nig-error-actions"></div>\n        </div>',document.body.appendChild(T),T.querySelector(".nig-close-btn").addEventListener("click",()=>L()))}function L(){T&&(T.style.display="none"),"function"==typeof H&&H()}let R=null,O=null;var B=t(753);const z=[{name:"None",description:"No additional styling will be added to your prompt.",subStyles:[]},{name:"Anime",description:"Blends Japanese animation with global twists. Sub-styles often mix eras, genres, or crossovers for dynamic outputs.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Anime style, ...").'},{name:"Studio Ghibli-Inspired",description:"Whimsical, nature-focused fantasy with soft lines and emotional depth.",value:"Studio Ghibli style, "},{name:"Cyberpunk Anime",description:"Neon-lit dystopias with high-tech mechs and gritty urban vibes.",value:"Cyberpunk anime style, "},{name:"Semi-Realistic Anime",description:"Blends lifelike proportions with expressive anime eyes and shading.",value:"Semi-realistic anime style, "},{name:"Mecha",description:"Giant robots and mechanical suits in epic battles.",value:"Mecha anime style, "},{name:"Dynamic Action",description:"High-energy movements with power effects and intense expressions.",value:"Dynamic action anime style, "},{name:"Soft Romantic",description:"Emotional interactions with gentle colors and sparkling accents.",value:"Soft romantic anime style, "},{name:"Dark Fantasy Anime",description:"Grim, horror-tinged worlds with demons and shadows.",value:"Dark fantasy anime style, "},{name:"Retro 80s Anime",description:"Vintage cel-shaded look with bold lines and synth vibes.",value:"80s retro anime style, "},{name:"Portal Fantasy",description:"World-crossing elements with magical adaptations and RPG motifs.",value:"Portal fantasy anime style, "},{name:"Slice-of-Life",description:"Everyday moments with relatable characters and cozy vibes.",value:"Slice-of-life anime style, "},{name:"Serialized Narrative",description:"Panel-like compositions for ongoing story flows.",value:"Serialized narrative anime style, "},{name:"Group Dynamic",description:"Interactions among multiple characters with balanced focus.",value:"Group dynamic anime style, "}]},{name:"Realism/Photorealism",description:"Excels in portraits and scenes mimicking photography, with sub-styles varying by subject or technique.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Realism/Photorealism style, ...").'},{name:"Hyperrealism",description:"Ultra-detailed, almost tangible textures and lighting.",value:"Hyperrealistic, "},{name:"Cinematic Realism",description:"Film-like depth with dramatic angles and color grading.",value:"Cinematic realism, "},{name:"Portrait Photorealism",description:"Human faces with natural skin, eyes, and expressions.",value:"Portrait photorealism, "},{name:"Architectural Realism",description:"Precise building renders with environmental details.",value:"Architectural realism, "},{name:"Nature Photorealism",description:"Verdant landscapes with dew and foliage intricacies.",value:"Nature photorealism, "},{name:"Close-Up Detail",description:"Intimate views highlighting textures and fine elements.",value:"Close-up realistic style, "},{name:"Historical Realism",description:"Period-accurate clothing and settings with grit.",value:"Historical realism, "},{name:"Urban Realism",description:"Bustling city life with crowds and neon realism.",value:"Urban realism, "},{name:"Stylized Realism",description:"Subtle artistic tweaks on photoreal bases.",value:"Stylized realism, "},{name:"Documentary Style",description:"Raw, unpolished scenes like news photography.",value:"Documentary photo style, "},{name:"Object Focus Realism",description:"Clear, highlighted items with neutral lighting.",value:"Object-focused realism, "},{name:"Wildlife Realism",description:"Animals in habitats with fur and feather fidelity.",value:"Wildlife realism, "},{name:"Detailed Portrait",description:"Lifelike faces with expressive features.",value:"Detailed portrait realism, "},{name:"Environmental Immersion",description:"Rich settings enveloping subjects.",value:"Environmental immersion realism, "}]},{name:"Fantasy",description:"Epic worlds of magic and myth, with sub-styles spanning tones from whimsical to grim.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Fantasy style, ...").'},{name:"High Fantasy",description:"Medieval realms with elves, dragons, and quests.",value:"High fantasy art, "},{name:"Dark Fantasy",description:"Grimdark horror with undead and moral ambiguity.",value:"Dark fantasy art, "},{name:"Urban Fantasy",description:"Magic in modern cities, like hidden witches.",value:"Urban fantasy art, "},{name:"Steampunk Fantasy",description:"Victorian tech with gears and airships.",value:"Steampunk fantasy style, "},{name:"Fairy Tale",description:"Whimsical tales with enchanted woods and creatures.",value:"Fairy tale illustration style, "},{name:"Heroic Adventure",description:"Bold explorers with raw magic and ancient relics.",value:"Heroic adventure fantasy art, "},{name:"Creature Emphasis",description:"Fantastical beings in natural or enchanted environments.",value:"Creature-focused fantasy art, "},{name:"Ethereal Grace",description:"Elegant figures in luminous, forested settings.",value:"Ethereal grace fantasy style, "},{name:"Rugged Craftsmanship",description:"Stout builders in forged, underground realms.",value:"Rugged craftsmanship fantasy style, "},{name:"Gothic Fantasy",description:"Haunted castles with vampires and storms.",value:"Gothic fantasy art, "},{name:"Beast Majesty",description:"Powerful scaled creatures in dramatic poses.",value:"Majestic beast fantasy art, "},{name:"Celestial Fantasy",description:"Starry realms with gods and floating islands.",value:"Celestial fantasy art, "},{name:"Oriental Myth",description:"Asian folklore elements with harmonious nature.",value:"Oriental myth fantasy style, "},{name:"Treasure Hunt Vibe",description:"Exploratory scenes with hidden wonders.",value:"Treasure hunt fantasy art, "}]},{name:"Sci-Fi",description:"Futuristic visions from gritty cyber worlds to cosmic explorations.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Sci-Fi style, ...").'},{name:"Cyberpunk",description:"Neon dystopias with hackers and megacorps.",value:"Cyberpunk style, "},{name:"Retro-Futurism",description:"1950s optimism with ray guns and chrome.",value:"Retro-futurism, "},{name:"Biopunk",description:"Organic tech with genetic mutations.",value:"Biopunk sci-fi style, "},{name:"Interstellar Epic",description:"Vast cosmic tales with diverse species and ships.",value:"Interstellar epic sci-fi art, "},{name:"Mechanical Suit",description:"Armored machines in high-tech conflicts.",value:"Mechanical suit sci-fi style, "},{name:"Post-Human",description:"Cyborgs and AI in evolved societies.",value:"Post-human sci-fi art, "},{name:"Hard Sci-Fi",description:"Physics-based realism with tech schematics.",value:"Hard sci-fi illustration, "},{name:"Dieselpunk",description:"1930s grit with riveted machines.",value:"Dieselpunk style, "},{name:"Astro-Mythology",description:"Space gods and cosmic myths.",value:"Astro-mythology art, "},{name:"Eco-Sci-Fi",description:"Post-apocalypse with bio-domes.",value:"Eco-sci-fi art, "},{name:"Survival Wasteland",description:"Harsh, ruined landscapes with resilient figures.",value:"Survival wasteland sci-fi style, "},{name:"Cosmic Discovery",description:"Unknown worlds with exploratory tech.",value:"Cosmic discovery sci-fi art, "}]},{name:"Retro/Vintage",description:"Nostalgic aesthetics from bygone eras, revived with AI flair.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Retro/Vintage style, ...").'},{name:"Art Deco",description:"Geometric luxury with gold and symmetry.",value:"Art Deco style, "},{name:"Art Nouveau",description:"Flowing organic lines and floral motifs.",value:"Art Nouveau style, "},{name:"Vintage Poster",description:"Bold typography and illustrative ads.",value:"Vintage poster style, "},{name:"Chromolithography",description:"Vibrant, printed color layers from 1900s.",value:"Chromolithography, "},{name:"Baroque",description:"Ornate drama with rich drapery.",value:"Baroque painting style, "},{name:"Ukiyo-e",description:"Japanese woodblock prints with flat colors.",value:"Ukiyo-e style, "},{name:"1950s Retro",description:"Atomic age optimism with pastels.",value:"1950s retro style, "},{name:"Playful Figure",description:"Charming, stylized poses with vintage flair.",value:"Playful vintage figure style, "},{name:"Edwardian",description:"Lacy elegance with soft pastels.",value:"Edwardian era style, "},{name:"Mid-Century Modern",description:"Clean lines and bold geometrics.",value:"Mid-century modern style, "},{name:"Ink Scroll",description:"Brush-like lines evoking ancient manuscripts.",value:"Ink scroll vintage style, "}]},{name:"Surrealism",description:"Dreamlike distortions challenging reality, inspired by masters.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Surrealism style, ...").'},{name:"Fluid Distortion",description:"Melting forms and impossible blends.",value:"Fluid distortion surrealism, "},{name:"Paradoxical Objects",description:"Everyday items in illogical arrangements.",value:"Paradoxical object surrealism, "},{name:"Ernst Collage Surreal",description:"Layered fragments for uncanny narratives.",value:"Ernst collage surrealism, "},{name:"Kahlo Autobiographical",description:"Personal symbolism with thorny motifs.",value:"Frida Kahlo style surrealism, "},{name:"Biomorphic Surreal",description:"Organic, creature-like hybrids.",value:"Biomorphic surrealism, "},{name:"Dreamlike Landscapes",description:"Floating islands and inverted gravity.",value:"Dreamlike surreal landscape, "},{name:"Freudian Symbolic",description:"Subconscious icons like eyes and stairs.",value:"Freudian symbolic surrealism, "},{name:"Pop Surrealism",description:"Whimsical grotesquery with candy colors.",value:"Pop surrealism, lowbrow art, "},{name:"Hyper-Surreal",description:"Exaggerated distortions in vivid detail.",value:"Hyper-surrealism, "},{name:"Eco-Surreal",description:"Nature twisted with human elements.",value:"Eco-surrealism, "},{name:"Mechanical Surreal",description:"Machines fused with flesh.",value:"Mechanical surrealism, "},{name:"Inner Vision",description:"Symbolic inner thoughts with blended realities.",value:"Inner vision surrealism, "}]},{name:"Cartoon/Illustration",description:"Exaggerated, narrative-driven visuals for fun and storytelling.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Cartoon/Illustration style, ...").'},{name:"Pixar 3D",description:"Polished, expressive CG with emotional arcs.",value:"Pixar 3D animation style, "},{name:"Disney Classic",description:"Hand-drawn whimsy with fluid animation.",value:"Classic Disney animation style, "},{name:"DreamWorks",description:"Edgy humor with detailed backgrounds.",value:"DreamWorks animation style, "},{name:"Adventure Time",description:"Surreal candy lands with bold shapes.",value:"Adventure Time cartoon style, "},{name:"Simpsons",description:"Yellow-skinned satire with clean outlines.",value:"The Simpsons cartoon style, "},{name:"Rick and Morty",description:"Sci-fi absurdity with warped perspectives.",value:"Rick and Morty cartoon style, "},{name:"Narrative Panel",description:"Sequential art with shaded storytelling.",value:"Narrative panel illustration style, "},{name:"Whimsical Illustration",description:"Gentle, colorful drawings for light-hearted scenes.",value:"Whimsical illustration style, "},{name:"Webtoon",description:"Vertical scroll with vibrant digital ink.",value:"Webtoon style, "},{name:"Manhua Flow",description:"Dynamic lines and vibrant digital shading.",value:"Manhua flow illustration style, "},{name:"Cover Art Focus",description:"Striking compositions for thematic highlights.",value:"Cover art illustration, "}]},{name:"Traditional Painting",description:"Emulates historical mediums like oils and watercolors for timeless appeal.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Traditional Painting style, ...").'},{name:"Impressionism",description:"Loose brushstrokes capturing light moments.",value:"Impressionist painting, "},{name:"Renaissance",description:"Balanced compositions with chiaroscuro.",value:"Renaissance painting style, "},{name:"Oil Painting",description:"Rich, layered textures with glazing.",value:"Oil painting, "},{name:"Watercolor",description:"Translucent washes for ethereal softness.",value:"Watercolor painting, "},{name:"Baroque",description:"Dramatic tenebrism and opulent details.",value:"Baroque painting, "},{name:"Romanticism",description:"Emotional storms and heroic figures.",value:"Romanticism painting, "},{name:"Pointillism",description:"Dot-based color mixing for vibrancy.",value:"Pointillism style, "},{name:"Fresco",description:"Mural-like with aged plaster effects.",value:"Fresco painting style, "},{name:"Encaustic",description:"Waxy, heated layers for luminous depth.",value:"Encaustic painting, "},{name:"Acrylic",description:"Bold, matte finishes with quick drying.",value:"Acrylic painting, "},{name:"Gouache",description:"Opaque vibrancy like matte poster paint.",value:"Gouache painting, "},{name:"Sumi-e",description:"Minimalist ink washes for Zen simplicity.",value:"Sumi-e ink wash painting, "},{name:"Oriental Brushwork",description:"Minimalist inks for balanced compositions.",value:"Oriental brushwork style, "},{name:"Era Line Art",description:"Detailed etchings for historical depth.",value:"Era line art traditional, "}]},{name:"Digital Art",description:"Modern, tech-infused creations from pixels to vectors.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Digital Art style, ...").'},{name:"Vector Illustration",description:"Scalable, flat colors with clean paths.",value:"Vector illustration, "},{name:"Blended Landscape",description:"Layered digital environments for immersive backdrops.",value:"Blended digital landscape, "},{name:"Neon Glow",description:"Vibrant outlines with electric luminescence.",value:"Neon glow digital art, "},{name:"Holographic",description:"Shimmering, 3D projections with refractions.",value:"Holographic style, "},{name:"World-Building Sketch",description:"Conceptual layers for expansive scenes.",value:"World-building digital sketch, "},{name:"Community Render",description:"Polished digital interpretations of characters.",value:"Community render digital style, "}]},{name:"Wuxia/Xianxia",description:"Eastern-inspired martial and spiritual themes with energy flows, ancient motifs, and harmonious or intense atmospheres.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Wuxia/Xianxia style, ...").'},{name:"Qi Energy Flow",description:"Subtle auras and internal power visualizations.",value:"Qi energy flow style, "},{name:"Martial Grace",description:"Fluid poses and disciplined movements.",value:"Martial grace style, "},{name:"Spiritual Realm",description:"Misty, elevated worlds with ethereal elements.",value:"Spiritual realm style, "},{name:"Ancient Sect Aesthetic",description:"Traditional architecture and robed figures.",value:"Ancient sect aesthetic, "},{name:"Demonic Shadow",description:"Darkened energies and mysterious silhouettes.",value:"Demonic shadow style, "},{name:"Dynasty Elegance",description:"Silk textures and jade accents in historical tones.",value:"Dynasty elegance style, "}]},{name:"Romance",description:"Tender or passionate human connections with soft lighting, expressions, and atmospheric details.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Romance style, ...").'},{name:"Gentle Intimacy",description:"Close, affectionate moments with warm hues.",value:"Gentle intimacy romance style, "},{name:"Urban Affection",description:"Modern settings with subtle romantic gestures.",value:"Urban affection style, "},{name:"Enchanted Bond",description:"Magical elements enhancing emotional ties.",value:"Enchanted bond romance style, "},{name:"Tension Build",description:"Subtle conflicts leading to connection.",value:"Tension build romance style, "},{name:"Blushing Softness",description:"Delicate emotions with pastel accents.",value:"Blushing softness style, "},{name:"Melancholic Yearning",description:"Poignant separations with evocative moods.",value:"Melancholic yearning romance art, "}]}];var F=t(322);function G(e){const n=document.getElementById("nig-enhancement-settings");n&&(e?n.classList.remove("disabled"):n.classList.add("disabled"))}function D(e,n){const t=n.enhancementEnabled,i=n.enhancementApiKey&&n.enhancementApiKey.trim().length>0,a=w(e,n),o=document.getElementById("nig-provider-priority-info"),r=document.getElementById("nig-status-indicator"),s=document.getElementById("nig-status-text"),l=document.getElementById("nig-override-provider");t&&a&&!n.enhancementOverrideProvider?(o.style.display="block",r.className="nig-status-indicator provider-active",s.textContent="Provider Enhancement Active",l&&(l.style.display="inline-block")):(o.style.display="none",t&&i?(r.className="nig-status-indicator external-active",s.textContent="External AI Enhancement Active"):t?(r.className="nig-status-indicator disabled",s.textContent="Enhancement Enabled (No API Key)"):(r.className="nig-status-indicator disabled",s.textContent="Enhancement Disabled"),l&&(l.style.display="none"))}async function _(e){await async function(e){const n=document.getElementById("nig-enhancement-template-select"),t=document.getElementById("nig-enhancement-template"),i=B.z.enhancementPresets||{},a=e.enhancementTemplateSelected,o="string"==typeof e.enhancementTemplate?e.enhancementTemplate:"";let r="standard";if("custom"===a||i[a])r=a;else if(o){let e=null;for(const[n,t]of Object.entries(i))if(t&&"object"==typeof t&&t.template===o){e=n;break}r=e||"custom"}if(n.value=r,"custom"===r)t.value=o||"",t.disabled=!1;else{const e=i[r];e?(t.value=e.template,t.disabled=!0):(t.value=o||"",t.disabled=!1,n.value="custom")}}(e),G(e.enhancementEnabled),D(e.selectedProvider,e),e.enhancementApiKey.trim().length>0&&(document.getElementById("nig-enhancement-preview").style.display="block")}var q=t(189);function U(){const e=document.getElementById("nig-provider").value;document.querySelectorAll(".nig-provider-settings").forEach(e=>e.style.display="none");const n=document.getElementById(`nig-provider-${e}`);n&&(n.style.display="block")}function $(e){const n=document.getElementById("nig-sub-style"),t=document.getElementById("nig-main-style-desc"),i=document.getElementById("nig-sub-style-desc"),a=z.find(n=>n.name===e);t.textContent=a?a.description:"",n.innerHTML="",a&&a.subStyles.length>0?(n.disabled=!1,a.subStyles.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.name,n.appendChild(t)}),n.dispatchEvent(new Event("change"))):(n.disabled=!0,i.textContent="")}async function J(){const e=await f.zj();document.getElementById("nig-provider").value=e.selectedProvider;const n=document.getElementById("nig-main-style");n.innerHTML="",z.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,n.appendChild(t)}),n.value=e.mainPromptStyle,$(e.mainPromptStyle),document.getElementById("nig-sub-style").value=e.subPromptStyle,document.getElementById("nig-sub-style").dispatchEvent(new Event("change"));const t=document.getElementById("nig-custom-style-enable"),i=document.getElementById("nig-custom-style-text");t.checked=e.customStyleEnabled,i.value=e.customStyleText,i.disabled=!e.customStyleEnabled,document.getElementById("nig-enhancement-enabled").checked=e.enhancementEnabled,document.getElementById("nig-gemini-api-key").value=e.enhancementApiKey,document.getElementById("nig-enhancement-model").value=e.enhancementModel,document.getElementById("nig-enable-neg-prompt").checked=e.enableNegPrompt,document.getElementById("nig-global-neg-prompt").value=e.globalNegPrompt;const a=await f.Iy();document.getElementById("nig-history-clean-days").value=a,U()}async function j(){const e=await f.zj(),n=JSON.stringify(e,null,2),t=`wtr-lab-image-generator-config-${(new Date).toISOString().split("T")[0]}.json`;F.P(t,n,"application/json")}async function W(e){const n=e.target.files[0];if(n)try{const e=await n.text(),t=JSON.parse(e);if(!t||"object"!=typeof t||Array.isArray(t))throw new Error("Invalid configuration format: root must be an object.");if(confirm("This will overwrite all current settings. Continue?")){const e=function(e={}){try{let n=e;if(n&&"object"==typeof n&&!Array.isArray(n)&&n.config&&"object"==typeof n.config&&!Array.isArray(n.config)&&(n=n.config),!n||"object"!=typeof n||Array.isArray(n))return v.vV("CONFIG_IMPORT","Invalid configuration format after normalization; using DEFAULTS",{importedType:typeof n}),{...B.z};const t={...B.z},i=e=>"string"==typeof e&&e.trim().length>0;if(Object.assign(t,n),"enhancementTemplateSelected"in n){const e=t.enhancementTemplateSelected,n=B.z.enhancementPresets||{};e&&("custom"===e||n[e])||(t.enhancementTemplateSelected=B.z.enhancementTemplateSelected||"standard")}else{const e=n.enhancementTemplate;let i=null;if(e&&"string"==typeof e&&B.z.enhancementPresets)for(const[n,t]of Object.entries(B.z.enhancementPresets))if(t&&"object"==typeof t&&t.template===e){i=n;break}t.enhancementTemplateSelected=i||"custom"}const a=(e,n)=>"number"==typeof e&&!isNaN(e)&&e>=0?e:n,o=(e,n)=>Array.isArray(e)?e:n,r=(e,n)=>["debug","info","warn","error"].includes(e)?e:n;t.enhancementMaxRetriesPerModel=a(n.enhancementMaxRetriesPerModel,B.z.enhancementMaxRetriesPerModel),t.enhancementRetryDelay=a(n.enhancementRetryDelay,B.z.enhancementRetryDelay),t.enhancementModelsFallback=o(n.enhancementModelsFallback,B.z.enhancementModelsFallback),t.enhancementLogLevel=r(n.enhancementLogLevel,B.z.enhancementLogLevel),"boolean"==typeof n.enhancementAlwaysFallback?t.enhancementAlwaysFallback=n.enhancementAlwaysFallback:t.enhancementAlwaysFallback=B.z.enhancementAlwaysFallback,n.enhancementPresets&&"object"==typeof n.enhancementPresets||(t.enhancementPresets=B.z.enhancementPresets);const s=e=>{const n=["standard","safety","artistic","technical","character","custom"];if("string"==typeof e&&e.trim().length>0){const t=e.trim();if(n.includes(t))return t;switch(t){case"clean":return"safety";case"environment":return"standard";case"composition":return"technical"}}return B.z.enhancementTemplateSelected||"standard"};if(t.enhancementTemplateSelected=s(t.enhancementTemplateSelected||n.enhancementTemplateSelected),"historyDays"in n){const e=parseInt(n.historyDays,10);isNaN(e)||e<1||e>365?t.historyDays=B.z.historyDays??30:t.historyDays=e}else t.historyDays=B.z.historyDays??30;if(i(n.aiHordeApiKey)&&(t.aiHordeApiKey=n.aiHordeApiKey),i(n.pollinationsToken)&&(t.pollinationsToken=n.pollinationsToken),i(n.enhancementApiKey)&&(t.enhancementApiKey=n.enhancementApiKey),i(n.googleApiKey)&&(t.googleApiKey=n.googleApiKey),n.openAICompatProfiles&&"object"==typeof n.openAICompatProfiles){const e={};for(const[t,a]of Object.entries(n.openAICompatProfiles))if(a&&"object"==typeof a){const n={...a};i(a.apiKey)&&(n.apiKey=a.apiKey),e[t]=n}t.openAICompatProfiles=e}else B.z.openAICompatProfiles&&(t.openAICompatProfiles=B.z.openAICompatProfiles);i(n.openAICompatActiveProfileUrl)?t.openAICompatActiveProfileUrl=n.openAICompatActiveProfileUrl:t.openAICompatActiveProfileUrl=B.z.openAICompatActiveProfileUrl,"boolean"==typeof n.openAICompatModelManualInput?t.openAICompatModelManualInput=n.openAICompatModelManualInput:"boolean"!=typeof t.openAICompatModelManualInput&&(t.openAICompatModelManualInput=B.z.openAICompatModelManualInput);const l=["aiHordeApiKey","pollinationsToken","enhancementApiKey","googleApiKey"];for(const e of l)i(n[e])&&!i(t[e])&&(t[e]=n[e]);return t}catch(n){v.vV("CONFIG_IMPORT","Failed to normalize imported config",{error:n.message});try{const n=e&&"object"==typeof e&&!Array.isArray(e)?e:{};return{...B.z,...n}}catch{return{...B.z}}}}(t);try{await Promise.all(Object.keys(e).map(n=>f.yJ(n,e[n])));const n=await f.zj();try{await J()}catch(e){v.vV("CONFIG_IMPORT","Failed to update core configuration form after import",{error:e?.message||e})}try{await(0,q.populateProviderForms)(n)}catch(e){v.vV("CONFIG_IMPORT","Failed to update provider configuration forms after import",{error:e?.message||e})}try{await _(n)}catch(e){v.vV("CONFIG_IMPORT","Failed to update enhancement settings after import",{error:e?.message||e})}try{D(n.selectedProvider||B.z.selectedProvider,n)}catch(e){v.vV("CONFIG_IMPORT","Failed to update enhancement UI state after import",{error:e?.message||e})}alert("Configuration imported successfully! All visible settings have been updated.")}catch(e){v.vV("CONFIG_IMPORT","Failed during configuration import application",{error:e?.message||e}),alert(`Configuration import failed while applying settings. Your previous configuration is still in effect. Details: ${e?.message||e}`)}}}catch(e){v.vV("CONFIG_IMPORT","Failed to import configuration",{error:e?.message||e}),alert(`Failed to import configuration: ${e?.message||e}`)}finally{e.target.value=""}}async function K(){const e=document.getElementById("nig-history-list"),n=await f.A5();e.innerHTML="",0!==n.length?n.forEach(n=>{const i=document.createElement("li");i.className="nig-history-item";const a="string"==typeof n.prompt||n&&"object"==typeof n&&"string"==typeof n.prompt?n.prompt:"",o=n&&n.provider?`<strong>${n.provider}</strong>`:"",r=n&&n.model?`(${n.model})`:"",s=`<div class="nig-history-meta"><small>${new Date(n.date).toLocaleString()} - ${o} ${r}</small></div>`,l=a?`<div class="nig-history-prompt" title="${a.replace(/"/g,'"')}">${a}</div>`:'<div class="nig-history-prompt nig-history-prompt-empty">No prompt available</div>';i.innerHTML=`\n            ${s}\n            ${l}\n        `;const c=document.createElement("a");c.href="#",c.textContent="View Generated Image",c.addEventListener("click",e=>{e.preventDefault(),Promise.resolve().then(t.bind(t,642)).then(e=>{"function"==typeof e.show&&e.show([n.url],a||"No prompt available",n.provider,n.model)})}),i.appendChild(c),e.appendChild(i)}):e.innerHTML="<li>No history yet.</li>"}async function V(){const e=document.getElementById("nig-history-clean-days").value,n=parseInt(e);if(isNaN(n)||n<1||n>365)return void alert("Please enter a valid number of days (1-365).");const t=document.getElementById("nig-history-clean-btn");if(t){const e=t.innerHTML;t.disabled=!0,t.innerHTML="Cleaning...";try{await f.qH(n);const e=e=>{t.innerHTML=`<span class="material-symbols-outlined">cleaning_services</span> Cleaning... (${e.completed}/${e.total} links checked)`},i=await f.qg(e);let a="History cleaned successfully!\n\n";i.expiredLinksRemoved>0&&(a+=`• Removed ${i.expiredLinksRemoved} expired/broken image links\n`),i.oldEntriesRemoved>0&&(a+=`• Removed ${i.oldEntriesRemoved} old entries\n`),0===i.expiredLinksRemoved&&0===i.oldEntriesRemoved&&(a+="• No items needed to be removed"),i.totalLinksChecked>0&&(a+=`\n\nChecked ${i.totalLinksChecked} image links for validity.`),a+=`\n\nTotal removed: ${i.totalRemoved} items`,a+=`\nRemaining entries: ${i.finalHistoryCount}`,alert(a),await K()}catch(e){console.error("Failed to clean history:",e),alert("Failed to clean history. Please try again.")}finally{t.disabled=!1,t.innerHTML=e}}}async function Y(e){const n=parseInt(e.target.value);if(!isNaN(n)&&n>=1&&n<=365)try{await f.qH(n),console.log(`History days setting saved: ${n}`);const e=document.getElementById("nig-config-panel");e&&e.querySelector('.nig-tab[data-tab="history"]').classList.contains("active")&&await K()}catch(e){console.error("Failed to auto-save history days setting:",e)}}let Q=null,Z={};function X(){Q||(Q=function(){const e=document.createElement("div");return e.id="nig-config-panel",e.className="nig-modal-overlay",e.style.display="none",e.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Image Generator Configuration</h2>\n            <div class="nig-tabs">\n                <div class="nig-tab active" data-tab="config">Configuration</div>\n                <div class="nig-tab" data-tab="styling">Prompt Styling</div>\n                <div class="nig-tab" data-tab="history">History</div>\n                <div class="nig-tab" data-tab="utilities">Utilities</div>\n            </div>\n            <div id="nig-config-tab" class="nig-tab-content active">\n                <div class="nig-config-grid">\n                    <div class="nig-config-section">\n                        <div class="nig-form-group">\n                            <label for="nig-provider">Image Provider</label>\n                            <select id="nig-provider">\n                                <option value="Pollinations">Pollinations.ai (Free, Simple)</option>\n                                <option value="AIHorde">AI Horde (Free, Advanced)</option>\n                                <option value="OpenAICompat">OpenAI Compatible (Custom)</option>\n                                <option value="Google">Google Imagen (Requires Billed Account)</option>\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class="nig-provider-container">\n                        <div id="nig-provider-Pollinations" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3><img src="https://raw.githubusercontent.com/pollinations/pollinations/eea264f608e9393e69631eea5e00e9ecf6e1836e/shared/assets/logo.svg" alt="Pollinations" style="height: 20px; width: 20px; vertical-align: middle; margin-right: 8px;"> Pollinations.ai Settings</h3>\n                                <p>Fast, simple image generation with advanced model options</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-model">Model</label>\n                                <select id="nig-pollinations-model">\n                                    <option>Loading models...</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group nig-form-group-inline">\n                                <label>Dimensions (Width × Height)</label>\n                                <div>\n                                    <label for="nig-pollinations-width">Width</label>\n                                    <input type="number" id="nig-pollinations-width" min="64" max="2048" step="64">\n                                </div>\n                                <div>\n                                    <label for="nig-pollinations-height">Height</label>\n                                    <input type="number" id="nig-pollinations-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-seed">Seed (optional)</label>\n                                <input type="text" id="nig-pollinations-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Options</label>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-pollinations-enhance">Enhance Prompt</label>\n                                    <label><input type="checkbox" id="nig-pollinations-safe">Safe Mode (NSFW Filter)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-nologo">No Logo (Registered Users)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-private">Private (Won\'t appear in feed)</label>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-token">API Token (Optional)</label>\n                                <input type="password" id="nig-pollinations-token" placeholder="Enter token for premium models">\n                                <small class="nig-hint">Get a token from <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> for higher rate limits and access to restricted models.</small>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-AIHorde" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3><img src="https://stablehorde.net/assets/img/logo.png" alt="AI Horde" style="height: 20px; width: 20px; vertical-align: middle; margin-right: 8px;"> AI Horde Settings</h3>\n                                <p>Community-powered generation with extensive customization</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-api-key">AI Horde API Key</label>\n                                <input type="password" id="nig-horde-api-key" placeholder="Defaults to \'0000000000\'">\n                                <small>Use anonymous key or get your own from <a href="https://aihorde.net/" target="_blank" class="nig-api-prompt-link">AI Horde</a> for higher priority.</small>\n                            </div>\n                            <div class="nig-provider-controls">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-model">Model</label>\n                                    <select id="nig-horde-model">\n                                        <option>Loading models...</option>\n                                    </select>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-sampler">Sampler</label>\n                                    <select id="nig-horde-sampler">\n                                        <option value="k_dpmpp_2m">DPM++ 2M</option>\n                                        <option value="k_euler_a">Euler A</option>\n                                        <option value="k_euler">Euler</option>\n                                        <option value="k_lms">LMS</option>\n                                        <option value="k_heun">Heun</option>\n                                        <option value="k_dpm_2">DPM 2</option>\n                                        <option value="k_dpm_2_a">DPM 2 A</option>\n                                        <option value="k_dpmpp_2s_a">DPM++ 2S A</option>\n                                        <option value="k_dpmpp_sde">DPM++ SDE</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-steps">Steps</label>\n                                    <input type="number" id="nig-horde-steps" min="10" max="50" step="1">\n                                    <small class="nig-hint">More steps = more detail, but slower.</small>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-cfg">CFG Scale</label>\n                                    <input type="number" id="nig-horde-cfg" min="1" max="20" step="0.5">\n                                    <small class="nig-hint">How strictly to follow the prompt.</small>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-width">Width</label>\n                                    <input type="number" id="nig-horde-width" min="64" max="2048" step="64">\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-height">Height</label>\n                                    <input type="number" id="nig-horde-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-seed">Seed (optional)</label>\n                                <input type="text" id="nig-horde-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Post-Processing</label>\n                                <small class="nig-hint">Improves faces. Use only if generating people.</small>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" name="nig-horde-post" value="GFPGAN">GFPGAN</label>\n                                    <label><input type="checkbox" name="nig-horde-post" value="CodeFormers">CodeFormers</label>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-Google" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3><img src="https://upload.wikimedia.org/wikipedia/commons/1/1d/Google_Gemini_icon_2025.svg" alt="Google Imagen" style="height: 20px; width: 20px; vertical-align: middle; margin-right: 8px;"> Google Imagen Settings</h3>\n                                <p>High-quality generation powered by Google\'s advanced AI</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-google-api-key">Gemini API Key</label>\n                                <input type="password" id="nig-google-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-model">Imagen Model</label>\n                                <select id="nig-model">\n                                    <option value="imagen-4.0-generate-001">Imagen 4.0 Standard</option>\n                                    <option value="imagen-4.0-ultra-generate-001">Imagen 4.0 Ultra</option>\n                                    <option value="imagen-4.0-fast-generate-001">Imagen 4.0 Fast</option>\n                                    <option value="imagen-3.0-generate-002">Imagen 3.0 Standard</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-num-images">Number of Images (1-4)</label>\n                                <input type="number" id="nig-num-images" min="1" max="4" step="1">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-image-size">Image Size</label>\n                                <select id="nig-image-size">\n                                    <option value="1024">1K</option>\n                                    <option value="2048">2K</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-aspect-ratio">Aspect Ratio</label>\n                                <select id="nig-aspect-ratio">\n                                    <option value="1:1">1:1</option>\n                                    <option value="3:4">3:4</option>\n                                    <option value="4:3">4:3</option>\n                                    <option value="9:16">9:16</option>\n                                    <option value="16:9">16:9</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-person-gen">Person Generation</label>\n                                <select id="nig-person-gen">\n                                    <option value="dont_allow">Don\'t Allow</option>\n                                    <option value="allow_adult">Allow Adults</option>\n                                    <option value="allow_all">Allow All</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-OpenAICompat" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/openai.svg" alt="OpenAI" style="height: 20px; width: 20px; vertical-align: middle; margin-right: 8px;"> OpenAI Compatible Settings</h3>\n                                <p>Connect to any OpenAI-compatible API endpoint</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-profile-select">Saved Profiles</label>\n                                <div class="nig-form-group-inline">\n                                    <select id="nig-openai-compat-profile-select"></select>\n                                    <button id="nig-openai-compat-delete-profile" class="nig-delete-btn">Delete</button>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-base-url">Base URL</label>\n                                <input type="text" id="nig-openai-compat-base-url" placeholder="e.g., https://api.example.com/v1">\n                                <small class="nig-hint">For a list of free public providers, check out the <a href="https://github.com/zukixa/cool-ai-stuff" target="_blank" class="nig-api-prompt-link">cool-ai-stuff</a> repository.</small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-api-key">API Key</label>\n                                <input type="password" id="nig-openai-compat-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-model">Model</label>\n                                <div id="nig-openai-model-container-select">\n                                    <div class="nig-form-group-inline">\n                                        <select id="nig-openai-compat-model" style="width: 100%;">\n                                            <option>Enter URL/Key and fetch...</option>\n                                        </select>\n                                        <button id="nig-openai-compat-fetch-models" class="nig-fetch-models-btn">Fetch</button>\n                                    </div>\n                                    <small class=" nig-hint">If fetching fails or your model isn\'t listed, <a href="#" id="nig-openai-compat-switch-to-manual" class="nig-api-prompt-link">switch to manual input</a>.</small>\n                                </div>\n                                <div id="nig-openai-model-container-manual" style="display: none;">\n                                    <input type="text" id="nig-openai-compat-model-manual" placeholder="e.g., dall-e-3">\n                                    <small class=" nig-hint">Manually enter the model name. <a href="#" id="nig-openai-compat-switch-to-select" class="nig-api-prompt-link">Switch back to fetched list</a>.</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-styling-tab" class="nig-tab-content">\n                <div class="nig-styling-container">\n                    <div class="nig-styling-intro">\n                        <p>Select a style to automatically add it to the beginning of every prompt. This helps maintain a consistent look across all providers.</p>\n                    </div>\n\n                    <div class="nig-style-grid">\n                        <div class="nig-style-section">\n                            <div class="nig-form-group">\n                                <label for="nig-main-style">Main Style</label>\n                                <select id="nig-main-style"></select>\n                                <small id="nig-main-style-desc" class="nig-hint"></small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-sub-style">Sub-Style</label>\n                                <select id="nig-sub-style"></select>\n                                <small id="nig-sub-style-desc" class="nig-hint"></small>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>\n                                    <span class="material-symbols-outlined">auto_awesome</span>\n                                    AI Prompt Enhancement\n                                    <span class="nig-enhancement-status" id="nig-enhancement-status">\n                                        <span class="nig-status-indicator" id="nig-status-indicator"></span>\n                                        <span id="nig-status-text">Enhancement Disabled</span>\n                                    </span>\n                                </h4>\n                            </div>\n\n                            <div class="nig-enhancement-content">\n                                <div class="nig-form-group">\n                                    <div class="nig-checkbox-group">\n                                        <label><input type="checkbox" id="nig-enhancement-enabled">Enable AI Prompt Enhancement</label>\n                                    </div>\n                                    <small class="nig-hint">Uses AI to automatically enhance prompts for better results. Provider enhancement takes priority when available.</small>\n                                </div>\n\n                                <div class="nig-provider-priority-info" id="nig-provider-priority-info" style="display: none;">\n                                    <div class="nig-priority-header">\n                                        <span class="material-symbols-outlined">priority_high</span>\n                                        Provider Enhancement Active\n                                    </div>\n                                    <p id="nig-priority-message">Pollinations AI enhancement is enabled and will be used instead of external AI enhancement.</p>\n                                    <button class="nig-override-btn" id="nig-override-provider">Force Use External AI</button>\n                                </div>\n\n                                <div class="nig-enhancement-settings disabled" id="nig-enhancement-settings">\n                                    <div class="nig-form-group">\n                                        <label for="nig-gemini-api-key">Gemini API Key</label>\n                                        <input type="password" id="nig-gemini-api-key" placeholder="Enter your Google Gemini API key">\n                                        <small class="nig-hint">Get a free API key from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a></small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-model">Enhancement Model</label>\n                                        <select id="nig-enhancement-model">\n                                            <option value="models/gemini-2.5-pro">Gemini 2.5 Pro (High Quality)</option>\n                                            <option value="models/gemini-flash-latest">Gemini Flash Latest (Fast)</option>\n                                            <option value="models/gemini-flash-lite-latest">Gemini Flash Lite (Ultra Fast)</option>\n                                            <option value="models/gemini-2.5-flash">Gemini 2.5 Flash (Balanced)</option>\n                                            <option value="models/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Efficient)</option>\n                                        </select>\n                                        <small class="nig-hint">Choose model based on your needs: quality vs speed</small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-template">Custom Enhancement Prompt</label>\n                                        <div class="nig-enhancement-template-section">\n                                            <div class="nig-form-group">\n                                                <label for="nig-enhancement-template-select">Enhancement Template</label>\n                                                <select id="nig-enhancement-template-select">\n                                                    <option value="standard">Standard Enhancement - General-purpose, balanced enhancement</option>\n                                                    <option value="safety">Safety Enhancement - Safe, policy-aligned enhancement</option>\n                                                    <option value="artistic">Artistic Enhancement - Emphasizes creative visual style</option>\n                                                    <option value="technical">Technical Enhancement - Emphasizes realism and technical detail</option>\n                                                    <option value="character">Character Enhancement - Focuses on character detail and personality</option>\n                                                    <option value="custom">Custom (unsaved)</option>\n                                                </select>\n                                                <small class="nig-hint">\n                                                    Choose a curated enhancement preset or use Custom for ad-hoc instructions.\n                                                    Legacy presets are still supported for existing configurations and will map safely to the closest available option.\n                                                </small>\n                                            </div>\n                                            <textarea id="nig-enhancement-template" rows="3" placeholder="Enter enhancement instructions or leave empty to rely on the selected preset."></textarea>\n                                            <div class="nig-form-group-inline">\n                                                <button class="nig-template-btn" id="nig-template-reset">Reset to Selected Preset</button>\n                                                <button class="nig-template-btn" id="nig-template-example">Load Example</button>\n                                            </div>\n                                            <small class="nig-hint">Customize how the AI enhances prompts. If left blank, the selected preset behavior is used.</small>\n                                        </div>\n                                    </div>\n\n                                    <div class="nig-enhancement-preview" id="nig-enhancement-preview" style="display: none;">\n                                        <div class="nig-preview-container">\n                                            <div class="nig-preview-section">\n                                                <h5>Original Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-original-prompt"></div>\n                                            </div>\n                                            <div class="nig-preview-arrow">\n                                                <span class="material-symbols-outlined">arrow_forward</span>\n                                            </div>\n                                            <div class="nig-preview-section">\n                                                <h5>Enhanced Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-enhanced-prompt"></div>\n                                            </div>\n                                        </div>\n                                        <button class="nig-test-enhancement-btn" id="nig-test-enhancement">\n                                            <span class="material-symbols-outlined">auto_awesome</span>\n                                            Test Enhancement\n                                        </button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Custom Style</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-custom-style-enable">Enable Custom Style</label>\n                                </div>\n                                <small class="nig-hint">Overrides the Main/Sub-style dropdowns with your own text.</small>\n                                <textarea id="nig-custom-style-text" placeholder="e.g., In the style of Van Gogh, oil painting, ..."></textarea>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Negative Prompting (Global)</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-enable-neg-prompt">Enable Negative Prompting</label>\n                                </div>\n                                <small class="nig-hint">This negative prompt will be applied to all providers when enabled.</small>\n                                <textarea id="nig-global-neg-prompt" placeholder="e.g., ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality"></textarea>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-history-tab" class="nig-tab-content">\n                <div class="nig-history-container">\n                    <div class="nig-history-cleanup">\n                        <div class="nig-cleanup-info">\n                            <h4>History Management</h4>\n                            <p>Clean up old history entries to free up space and improve performance.</p>\n                        </div>\n                        <div class="nig-cleanup-controls">\n                            <label>Delete history older than</label>\n                            <input type="number" id="nig-history-clean-days" min="1" max="365" value="30">\n                            <label>days</label>\n                            <button id="nig-history-clean-btn" class="nig-history-cleanup-btn">\n                                <span class="material-symbols-outlined">cleaning_services</span>\n                                Clean\n                            </button>\n                        </div>\n                    </div>\n                    <ul id="nig-history-list" class="nig-history-list"></ul>\n                </div>\n            </div>\n\n            <div id="nig-utilities-tab" class="nig-tab-content">\n                <div class="nig-utilities-grid">\n                    <div class="nig-utility-card">\n                        <h4>Import/Export Settings</h4>\n                        <p>Backup and restore your configuration settings for seamless setup across different sessions or devices.</p>\n                        <div class="nig-form-group">\n                            <button id="nig-export-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-primary);">\n                                <span class="material-symbols-outlined">download</span>\n                                Download Configuration\n                            </button>\n                            <small class="nig-hint">Downloads the current configuration as a JSON file.</small>\n                        </div>\n                        <div class="nig-form-group">\n                            <label for="nig-import-file">Import Configuration</label>\n                            <input type="file" id="nig-import-file" accept=".json" style="border: 2px dashed var(--nig-color-border); background: var(--nig-color-bg-primary);">\n                            <small class=" nig-hint">Uploading a JSON file will overwrite all current settings.</small>\n                        </div>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <h4>Cache Management</h4>\n                        <p>Clear cached model lists and force fresh data fetching for accurate, up-to-date information.</p>\n                        <button id="nig-clear-cache-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-error);">\n                            <span class="material-symbols-outlined">clear_all</span>\n                            Clear Cached Models\n                        </button>\n                        <small class="nig-hint">Removes all cached model lists forcing a fresh fetch.</small>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <div class="nig-card-header">\n                            <div class="nig-card-title">\n                                <h4>Debug Console & Logs</h4>\n                                <p>Enable detailed console logging and view enhancement operation logs to troubleshoot issues and monitor system behavior during development.</p>\n                            </div>\n                        </div>\n\n                        <div class="nig-card-actions">\n                            <button id="nig-toggle-logging-btn" class="nig-btn-primary">\n                                <span class="material-symbols-outlined">bug_report</span>\n                                Toggle Console Logging & Enhancement Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-secondary-actions">\n                            <button id="nig-view-enhancement-logs-btn" class="nig-btn-secondary">\n                                <span class="material-symbols-outlined">list</span>\n                                View Enhancement Logs\n                            </button>\n                            <button id="nig-clear-enhancement-logs-btn" class="nig-btn-secondary nig-btn-error">\n                                <span class="material-symbols-outlined">clear_all</span>\n                                Clear Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-footer">\n                            <small class="nig-hint">Toggles detailed console logging and provides access to enhancement operation logs.</small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class="nig-button-footer">\n                <button id="nig-save-btn" class="nig-save-btn">Save Configuration</button>\n            </div>\n        </div>\n    ',e}(),document.body.appendChild(Q),Q.querySelector(".nig-close-btn").addEventListener("click",()=>Q.style.display="none"),Q.querySelector("#nig-save-btn").addEventListener("click",ne),function(e){e.querySelectorAll(".nig-tab").forEach(n=>{n.addEventListener("click",async()=>{e.querySelectorAll(".nig-tab, .nig-tab-content").forEach(e=>e.classList.remove("active")),n.classList.add("active"),e.querySelector(`#nig-${n.dataset.tab}-tab`).classList.add("active"),"history"===n.dataset.tab?(await K(),e.querySelector("#nig-save-btn").style.display="none"):e.querySelector("#nig-save-btn").style.display="block"})})}(Q),function(e){e.querySelector("#nig-provider").addEventListener("change",e=>{U()})}(Q),function(e){e.querySelector("#nig-openai-compat-fetch-models").addEventListener("click",()=>{q.VM()}),e.querySelector("#nig-openai-compat-profile-select").addEventListener("change",q.tH),e.querySelector("#nig-openai-compat-delete-profile").addEventListener("click",q.CB),e.querySelector("#nig-openai-compat-switch-to-manual").addEventListener("click",e=>{e.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}),e.querySelector("#nig-openai-compat-switch-to-select").addEventListener("click",e=>{e.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none"})}(Q),function(e){e.querySelector("#nig-export-btn").addEventListener("click",j),e.querySelector("#nig-import-file").addEventListener("change",W),e.querySelector("#nig-history-clean-btn").addEventListener("click",V),e.querySelector("#nig-history-clean-days").addEventListener("change",Y),e.querySelector("#nig-clear-cache-btn").addEventListener("click",()=>k.WN())}(Q),function(e){e.querySelector("#nig-toggle-logging-btn").addEventListener("click",async()=>{const e=!await f.Ct("loggingEnabled");await f.yJ("loggingEnabled",e),await v.RJ(),await v.xx(),alert(`Debug Console & Enhancement Logs are now ${e?"ENABLED":"DISABLED"}.`)}),e.querySelector("#nig-view-enhancement-logs-btn").addEventListener("click",async()=>{const e=await v.$f();if(0===e.length)return void alert("No enhancement logs found. Enhancement logging is disabled or no enhancement operations have been performed yet.");const n=document.createElement("div");n.className="nig-modal-overlay",n.innerHTML='\n            <div class="nig-modal-content">\n                <span class="nig-close-btn">&times;</span>\n                <h2>Enhancement Operation Logs</h2>\n                <p>Detailed logs of prompt enhancement operations with timestamps and performance data.</p>\n                <div style="max-height: 400px; overflow-y: auto; background: var(--nig-color-bg-tertiary); border-radius: var(--nig-radius-md); padding: var(--nig-space-lg); margin: var(--nig-space-lg) 0;">\n                    <div id="nig-enhancement-logs-display"></div>\n                </div>\n            </div>\n        ',document.body.appendChild(n);const t=n.querySelector("#nig-enhancement-logs-display");e.slice(0,50).forEach(e=>{const n=new Date(e.timestamp||e.time).toLocaleString(),i={ERROR:"#ef4444",WARN:"#f59e0b",INFO:"#6366f1",DEBUG:"#8b5cf6"}[e.level?.toUpperCase()]||"#6366f1",a=document.createElement("div");a.style.cssText="\n                padding: var(--nig-space-sm) 0;\n                border-bottom: 1px solid var(--nig-color-border);\n                font-family: 'Fira Code', monospace;\n                font-size: var(--nig-font-size-xs);\n            ",a.innerHTML=`\n                <div style="display: flex; align-items: center; gap: var(--nig-space-sm); margin-bottom: var(--nig-space-xs);">\n                    <span style="color: ${i}; font-weight: 600;">[${e.level?.toUpperCase()||"INFO"}]</span>\n                    <span style="color: var(--nig-color-text-muted); font-size: var(--nig-font-size-xs);">${n}</span>\n                    <span style="color: var(--nig-color-accent-primary); font-weight: 500;">[${e.category||"LOG"}]</span>\n                </div>\n                <div style="color: var(--nig-color-text-primary); margin-bottom: var(--nig-space-xs);">${e.message||"No message"}</div>\n                ${e.data?`<pre style="color: var(--nig-color-text-secondary); font-size: var(--nig-font-size-xs); background: var(--nig-color-bg-primary); padding: var(--nig-space-sm); border-radius: var(--nig-radius-sm); margin: 0; overflow-x: auto;">${JSON.stringify(e.data,null,2)}</pre>`:""}\n            `,t.appendChild(a)}),n.querySelector(".nig-close-btn").addEventListener("click",()=>n.remove())}),e.querySelector("#nig-clear-enhancement-logs-btn").addEventListener("click",async()=>{const e=await v.$f();0!==e.length?confirm(`Are you sure you want to clear all ${e.length} enhancement logs? This action cannot be undone.`)&&(v.X(),alert("All enhancement logs have been cleared.")):alert("No enhancement logs to clear.")})}(Q),function(e){e.querySelector("#nig-main-style").addEventListener("change",e=>{$(e.target.value)}),e.querySelector("#nig-sub-style").addEventListener("change",()=>{const n=e.querySelector("#nig-sub-style").value,t=document.getElementById("nig-sub-style-desc"),i=z.find(n=>n.name===e.querySelector("#nig-main-style").value),a=i?i.subStyles.find(e=>e.value===n):null;t.textContent=a?a.description:""})}(Q),function(e){const n=e.querySelector("#nig-custom-style-enable"),t=e.querySelector("#nig-custom-style-text");n.addEventListener("change",()=>{t.disabled=!n.checked})}(Q),function(e){e.querySelector("#nig-provider").addEventListener("change",async e=>{D(e.target.value,await f.zj())})}(Q),function(e){const n=e.querySelector("#nig-enhancement-enabled"),t=e.querySelector("#nig-override-provider"),i=e.querySelector("#nig-enhancement-template-select"),a=e.querySelector("#nig-template-reset"),o=e.querySelector("#nig-template-example"),r=e.querySelector("#nig-test-enhancement"),s=e.querySelector("#nig-gemini-api-key");i.addEventListener("change",async n=>{const t=n.target.value,i=e.querySelector("#nig-enhancement-template"),a=B.z.enhancementPresets||{};if("custom"===t)i.disabled=!1,await f.yJ("enhancementTemplateSelected","custom");else{const e=a[t];e?(i.value=e.template,i.disabled=!0,await f.yJ("enhancementTemplate",e.template),await f.yJ("enhancementTemplateSelected",t)):(i.disabled=!1,await f.yJ("enhancementTemplateSelected","custom"))}}),a.addEventListener("click",async()=>{const n=i.value,t=e.querySelector("#nig-enhancement-template"),a=B.z.enhancementPresets||{};if("custom"!==n){const e=a[n];e&&(t.value=e.template,t.disabled=!0,await f.yJ("enhancementTemplate",e.template),await f.yJ("enhancementTemplateSelected",n))}else{const e=await f.zj(),n="string"==typeof e.enhancementTemplate?e.enhancementTemplate:"";t.value=n,t.disabled=!1,await f.yJ("enhancementTemplateSelected","custom")}}),o.addEventListener("click",async()=>{const n='Extract visual elements from this text and craft a concise image generation prompt as a flowing paragraph. Focus on: characters and their appearances/actions/expressions, setting and environment, lighting/mood/color palette, artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, specific descriptors separated by commas or short phrases for clarity. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:',t=e.querySelector("#nig-enhancement-template"),i=e.querySelector("#nig-enhancement-template-select");t.value=n,t.disabled=!1,i&&(i.value="custom"),await f.yJ("enhancementTemplate",n),await f.yJ("enhancementTemplateSelected","custom")}),n.addEventListener("change",async e=>{const n=e.target.checked,t=await f.zj();t.enhancementEnabled=n,await f.yJ("enhancementEnabled",n),G(n),D(document.getElementById("nig-provider").value,t)}),t.addEventListener("click",async()=>{const e=document.getElementById("nig-provider").value;await f.yJ("enhancementOverrideProvider",!0),D(e,await f.zj())}),s.addEventListener("input",async n=>{const t=n.target.value.trim().length>0;e.querySelector("#nig-enhancement-preview").style.display=t?"block":"none"});const l=e.querySelector("#nig-enhancement-template"),c=e.querySelector("#nig-enhancement-template-select");l&&l.addEventListener("input",async()=>{const e=l.value;await f.yJ("enhancementTemplate",e),await f.yJ("enhancementTemplateSelected","custom"),c&&"custom"!==c.value&&(c.value="custom")}),r.addEventListener("click",async()=>{const e=await f.zj();r.disabled=!0;const n=r.innerHTML;r.innerHTML='<span class="material-symbols-outlined">hourglass_empty</span>Testing...';try{const n=await async function(e,n){try{return{original:e,enhanced:await x(e,n)}}catch(e){throw new Error(`Enhancement failed: ${e.message}`)}}("A mystical warrior standing on a cliff overlooking a magical forest with glowing mushrooms and ethereal mist",e);document.getElementById("nig-original-prompt").textContent=n.original,document.getElementById("nig-enhanced-prompt").textContent=n.enhanced}catch(e){alert(`Enhancement test failed: ${e.message}`)}finally{r.disabled=!1,r.innerHTML=n}})}(Q))}async function ee(){Q||X(),Q.querySelectorAll(".nig-tab, .nig-tab-content").forEach(e=>e.classList.remove("active")),Q.querySelector('.nig-tab[data-tab="config"]').classList.add("active"),Q.querySelector("#nig-config-tab").classList.add("active"),Q.querySelector("#nig-save-btn").style.display="block";const e=await f.zj();await J(),await(0,q.populateProviderForms)(e),await _(e),Q.style.display="flex"}async function ne(){await async function(){await f.yJ("mainPromptStyle",document.getElementById("nig-main-style").value),await f.yJ("subPromptStyle",document.getElementById("nig-sub-style").value),await f.yJ("customStyleEnabled",document.getElementById("nig-custom-style-enable").checked),await f.yJ("customStyleText",document.getElementById("nig-custom-style-text").value.trim()),await f.yJ("enhancementEnabled",document.getElementById("nig-enhancement-enabled").checked),await f.yJ("enhancementApiKey",document.getElementById("nig-gemini-api-key").value.trim()),await f.yJ("enhancementModel",document.getElementById("nig-enhancement-model").value),await f.yJ("enhancementTemplate",document.getElementById("nig-enhancement-template").value.trim()),await f.yJ("enhancementTemplateSelected",document.getElementById("nig-enhancement-template-select").value),await f.yJ("enableNegPrompt",document.getElementById("nig-enable-neg-prompt").checked),await f.yJ("globalNegPrompt",document.getElementById("nig-global-neg-prompt").value.trim()),await f.yJ("selectedProvider",document.getElementById("nig-provider").value)}(),await async function(){await f.yJ("enhancementEnabled",document.getElementById("nig-enhancement-enabled").checked),await f.yJ("enhancementApiKey",document.getElementById("nig-gemini-api-key").value.trim()),await f.yJ("enhancementModel",document.getElementById("nig-enhancement-model").value),await f.yJ("enhancementTemplate",document.getElementById("nig-enhancement-template").value.trim()),await f.yJ("enhancementTemplateSelected",document.getElementById("nig-enhancement-template-select").value),await f.yJ("enhancementOverrideProvider",!1)}(),await(0,q.Yl)(),Z.onConfigSaved&&Z.onConfigSaved(),alert("Configuration saved!")}!function(){let e,n=[],t=[],i=[],a=!1,o="",r=0,s=!1,l="";function c(e,n,i,o,r=null){v.fH("GENERATION","Generation completed successfully",{provider:i,model:o,promptLength:n.length,promptPreview:n.substring(0,100)+(n.length>100?"...":""),imagesGenerated:e.length,hasPersistentUrls:!!r}),t.push({imageUrls:e,prompt:n,provider:i,model:o}),(r||e).forEach(e=>f.Pc({date:(new Date).toISOString(),prompt:n,url:e,provider:i,model:o})),a=!1,u(),h()}function d(e,t="Unknown",o,r=null,s=null){v.vV("GENERATION","Generation Failed",{prompt:t,provider:o,errorMessage:e,errorMetadata:s});let l=function(e,n=null,t=null){let i=String(e);const a=i.toLowerCase();if(a.includes("error code: 524")||a.includes("timed out")||a.includes("502 bad gateway")||a.includes("unable to reach the origin service"))return{message:"The generation service is temporarily unavailable or busy (e.g., 502 Bad Gateway). This is usually a temporary issue. Please try again in a few minutes.",retryable:!0};if("OpenAICompat"===n&&t?.includes("api.mnnai.ru"))try{if("Sorry, there's been some kind of mistake, please use a different model"===JSON.parse(i.substring(i.indexOf("{"))).error)return{message:"Temporary service error detected. The same prompt typically works on retry. This error will be automatically retried.",retryable:!0}}catch(e){}if(a.includes("unsafe content")||a.includes("safety system")||a.includes("moderation_blocked"))return{message:"The prompt was rejected by the safety system for containing potentially unsafe content.",retryable:!1};if("AIHorde"===n&&a.includes("no user matching sent api key"))return{message:"AIHorde API key validation failed. Please check your API key configuration and ensure you have registered at https://stablehorde.net/register. You can try a different provider or update your API key in settings.",retryable:!0,errorType:"api_key_validation",isNonRetryable:!1};if("OpenAICompat"===n){if(a.includes("invalid api key")||a.includes("authentication failed")||a.includes("unauthorized"))return{message:"Authentication failed. Please check your API key configuration and ensure it is valid for this OpenAI-compatible provider.",retryable:!1,errorType:"authentication",isNonRetryable:!0};if(a.includes("ip address mismatch"))return{message:"IP Address Mismatch: Your current IP doesn't match your account. Try the /user resetip command in the Discord server or upgrade to premium for multi-IP support.",retryable:!0,errorType:"ip_mismatch",isNonRetryable:!1,discordLink:"https://discord.gg/zukijourney",resetipCommand:"/user resetip"};if(a.includes("failed to convert image to base64")||a.includes("base64")||a.includes("image conversion"))return{message:"Image conversion failed. The provider returned image data that could not be properly converted. This may be a temporary issue with the provider.",retryable:!0,errorType:"image_conversion",isNonRetryable:!1};if(a.includes("html response instead of json")||a.includes("unexpected token '<'")||a.includes("received html"))return{message:"The API endpoint returned an HTML page instead of JSON data. This usually indicates endpoint configuration issues, authentication problems, or an invalid API endpoint URL. Please check your OpenAI-compatible provider configuration.",retryable:!1,errorType:"html_response",isNonRetryable:!0,endpointIssue:!0};if(a.includes("json parsing failed")||a.includes("malformed json")||a.includes("unexpected character at line 1 column 1"))return{message:"The API returned malformed or invalid JSON data. This may indicate server issues with the OpenAI-compatible provider. Please try again later or contact the provider support.",retryable:!0,errorType:"malformed_json",isNonRetryable:!1,serverIssue:!0};if(a.includes("json parse error")||a.includes("json parsing error")||a.includes("invalid json"))return{message:"JSON parsing failed for the API response. This may indicate server issues or malformed response from the OpenAI-compatible provider.",retryable:!0,errorType:"json_parse_error",isNonRetryable:!1}}try{const e=JSON.parse(i.substring(i.indexOf("{"))),n=e.message||(e.error?e.error.message:null)||JSON.stringify(e);return{message:"object"==typeof n?JSON.stringify(n):n,retryable:!1}}catch(e){return{message:i||"An unknown error occurred.",retryable:!1}}}(e,o,r);s&&(s.errorType&&(l.errorType=s.errorType),"boolean"==typeof s.isNonRetryable&&(l.retryable=!s.isNonRetryable,l.isNonRetryable=s.isNonRetryable)),i.push({reason:l,prompt:t,provider:o,providerProfileUrl:r}),p(),P.y("error","Generation Failed."),a=!1,u(),v.fH("GENERATION","Generation failed - waiting for user action",{errorQueueLength:i.length,generationQueueLength:n.length,willWaitForUser:!0,errorType:l.errorType||"unknown",isNonRetryable:l.isNonRetryable||!1})}function p(){if(s||0===i.length)return;const e=i.shift();s=!0,async function(e){T||N(),document.getElementById("nig-error-reason").textContent=e.reason.message;const n=document.getElementById("nig-error-prompt");n.value=e.prompt;const t=document.getElementById("nig-retry-provider-select");t.innerHTML="";const i=await(0,f.zj)();["Pollinations","AIHorde","Google"].forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}),Object.keys(i.openAICompatProfiles).forEach(e=>{const n=document.createElement("option");n.value=`OpenAICompat::${e}`,n.textContent=`OpenAI: ${e.replace("https://","").split("/")[0]}`,t.appendChild(n)});let a=e.provider;"OpenAICompat"===e.provider&&e.providerProfileUrl&&(a=`OpenAICompat::${e.providerProfileUrl}`),Array.from(t.options).some(e=>e.value===a)&&(t.value=a);const o=document.getElementById("nig-error-actions");o.innerHTML="";const r=e.reason.isNonRetryable||"authentication"===e.reason.errorType||!e.reason.retryable&&!e.reason.errorType,s=document.createElement("button");if(s.textContent="Retry Generation",s.className="nig-retry-btn",s.onclick=()=>{const e=n.value.trim();if(!e)return void alert("Prompt cannot be empty.");const i=t.value;let a,o;i.startsWith("OpenAICompat::")?(a="OpenAICompat",o=i.split("::")[1]):(a=i,o=null),M(e,a,o),L()},!r)if(e.reason.retryable)o.appendChild(s);else{const e=()=>{o.contains(s)||o.appendChild(s)};n.oninput=e,t.onchange=e}if("authentication"===e.reason.errorType){const e=document.createElement("div");e.className="nig-auth-warning",e.style.cssText="color: #d63384; background-color: #f8d7da; border: 1px solid #f5c2c7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Authentication Issue:</strong> Please check your API key configuration in the settings before retrying.",o.appendChild(e)}if("api_key_validation"===e.reason.errorType){const e=document.createElement("div");e.className="nig-api-key-warning",e.style.cssText="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>API Key Issue:</strong> Please check your API key configuration and ensure you have registered with the provider. You can try a different provider or update your API key in settings.",o.appendChild(e)}if("image_conversion"===e.reason.errorType){const e=document.createElement("div");e.className="nig-conversion-info",e.style.cssText="color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Image Conversion Issue:</strong> This may be a temporary problem with the provider. You can try again or use a different provider.",o.appendChild(e)}if("ip_mismatch"===e.reason.errorType){const n=document.createElement("div");n.className="nig-ip-warning",n.style.cssText="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-top: 10px;";const t=e.reason.discordLink||"https://discord.gg/zukijourney",i=e.reason.resetipCommand||"/user resetip";n.innerHTML="<strong>IP Address Mismatch:</strong> Your current IP address doesn't match the one registered to your account.<br><br><strong>To resolve this:</strong><br>• Join the Discord server: <a href=\""+t+'" target="_blank" rel="noopener noreferrer" style="color: #856404; text-decoration: underline;">'+t+'</a><br>• Use the command: <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-family: monospace;">'+i+"</code><br>• Or upgrade to premium for multi-IP support<br><br><em>You can retry this generation after resetting your IP lock.</em>",o.appendChild(n)}if("html_response"===e.reason.errorType){const e=document.createElement("div");e.className="nig-html-warning",e.style.cssText="color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c2c7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Endpoint Configuration Issue:</strong> The API endpoint returned HTML instead of JSON, which usually indicates:<br>• Invalid or incorrect endpoint URL<br>• Authentication problems<br>• Endpoint not supporting image generation<br><br>Please check your OpenAI-compatible provider configuration in settings.",o.appendChild(e)}if("malformed_json"===e.reason.errorType){const e=document.createElement("div");e.className="nig-json-warning",e.style.cssText="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Server Response Issue:</strong> The API returned malformed JSON data. This is typically a temporary server issue with the provider. You can try again or use a different provider.",o.appendChild(e)}if("json_parse_error"===e.reason.errorType){const e=document.createElement("div");e.className="nig-parse-warning",e.style.cssText="color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>JSON Parsing Error:</strong> Unable to parse the API response. This may be a temporary issue with the provider. You can try again or switch to a different provider.",o.appendChild(e)}T.style.display="flex"}(e),v.fH("ERROR","Showing error modal to user",{errorReason:e.reason.message,provider:e.provider,remainingErrorQueue:i.length})}function m(){v.fH("ERROR","Error modal dismissed by user",{errorQueueLength:i.length,generationQueueLength:n.length,isGenerating:a}),s=!1,u(),n.length>0&&!a?(v.fH("ERROR","Resuming queue processing after error modal dismissal"),h()):v.fH("ERROR","No more items to process, queue paused")}function g(e,t,i=null){const o={basePositivePrompt:e,provider:t,providerProfileUrl:i};n.unshift(o),v.fH("GENERATION","Added retry generation to queue (LIFO - Priority)",{provider:t,basePositivePromptLength:e.length,queueLength:n.length,queuePosition:1,basePositivePromptPreview:e.substring(0,100)+(e.length>100?"...":"")}),a=!1,L(),s=!1,u(),h(),p()}function u(){if(v.MD("SYSTEM","Updating system status",{completedQueueLength:t.length,isGenerating:a,generationQueueLength:n.length,currentStatusText:o}),t.length>0){const e=1===t.length?"1 Image Ready!":`${t.length} Images Ready!`;P.y("success",`${e} Click to view.`,()=>{const e=t.shift();e&&C.show(e.imageUrls,e.prompt,e.provider,e.model),u()})}else if(a||n.length>0){const e=n.length>0?` (Queue: ${n.length})`:"";P.y("loading",`${o}${e}`)}else P.y("hidden","")}async function h(){if(a||0===n.length)return void v.MD("QUEUE","Queue processing skipped",{reason:a?"Currently generating":"Queue is empty",isGenerating:a,queueLength:n.length});a=!0;const e=n.shift();o="Requesting...";const t=e.provider,i=e.basePositivePrompt,r=b(i,"queue_dispatch"),s=i;v.fH("QUEUE","Starting queue processing",{provider:t,basePositivePromptLength:i.length,basePositivePromptPreview:i.substring(0,100)+(i.length>100?"...":""),remainingQueueLength:n.length,currentStatus:o}),u();const l={onSuccess:c,onFailure:d,onAuthFailure:(e,t)=>{var i,o,r;v.fH("AUTH","Authentication required",{provider:t,message:e}),i=e,o=t,r=g,document.getElementById("nig-pollinations-auth-prompt")||(O=document.createElement("div"),O.id="nig-pollinations-auth-prompt",O.className="nig-modal-overlay",O.innerHTML=`\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Authentication Required</h2>\n            <p>The Pollinations.ai model you selected requires authentication. You can get free access by registering.</p>\n            <p><strong>Error Message:</strong> <em>${i}</em></p>\n            <p>Please visit <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> to continue. You can either:</p>\n            <ul>\n                <li><strong>Register the Referrer:</strong> The easiest method. Just register the domain <code>wtr-lab.com</code>. This links your usage to your account without needing a token.</li>\n                <li><strong>Use a Token:</strong> Get an API token and enter it below.</li>\n            </ul>\n            <div class="nig-form-group">\n                <label for="nig-prompt-pollinations-token">Pollinations API Token</label>\n                <input type="password" id="nig-prompt-pollinations-token">\n            </div>\n            <button id="nig-prompt-save-token-btn" class="nig-save-btn">Save Token & Retry</button>\n        </div>`,document.body.appendChild(O),O.querySelector(".nig-close-btn").addEventListener("click",()=>O.remove()),O.querySelector("#nig-prompt-save-token-btn").addEventListener("click",async()=>{const e=O.querySelector("#nig-prompt-pollinations-token").value.trim();e?(await(0,f.yJ)("pollinationsToken",e),O.remove(),alert("Token saved. Retrying generation..."),r(o,"Pollinations")):alert("Token cannot be empty.")})),a=!1,P.y("error","Authentication needed."),u(),v.fH("AUTH","Queue paused due to authentication requirement",{generationQueueLength:n.length,willWaitForUser:!0})},updateStatus:t=>{o=t,v.MD("SYSTEM","Status updated by provider",{provider:e.provider,newStatusText:t,isGenerating:a,generationQueueLength:n.length}),u()}};switch(t){case"AIHorde":v.fH("QUEUE","Using AI Horde prompt construction path",{provider:"AIHorde",positivePromptLength:r.length,positivePromptPreview:r.substring(0,200)+(r.length>200?"...":"")}),v.MD("QUEUE","Dispatching to AIHorde provider with positive-only prompt",{provider:"AIHorde",prompt:r.substring(0,200)+(r.length>200?"...":"")}),S(r,l);break;case"Pollinations":case"Google":case"OpenAICompat":{const n="Pollinations"===t?"pollinations_inline_negative":"Google"===t?"google_inline_negative":"openai_compat_inline_negative";v.fH("QUEUE","Using non-AI Horde prompt construction path",{provider:t,basePositivePromptLength:r.length,basePositivePromptPreview:r.substring(0,200)+(r.length>200?"...":"")}),window.GM_getValue,Promise.resolve(),"Pollinations"===t?(v.MD("QUEUE","Dispatching to Pollinations provider",{prompt:r.substring(0,200)+(r.length>200?"...":""),path:n}),async function(e,{onSuccess:n,onFailure:t,onAuthFailure:i}){const a=await(0,f.zj)(),{pollinationsModel:o,pollinationsToken:r,pollinationsWidth:s,pollinationsHeight:l,pollinationsSeed:c,pollinationsEnhance:d,pollinationsSafe:p,pollinationsNologo:m,pollinationsPrivate:g,enableNegPrompt:u,globalNegPrompt:h}=a,y="string"==typeof e?e:"",v=!!u,w=(h||"").trim(),x=v&&w.length>0,E=b(x?`${y}, negative prompt: ${w}`:y,"pollinations_api_final"),I=o||"flux";console.log("[NIG-DEBUG] [POLLINATIONS] Model configuration:",{originalModel:o,finalModel:I}),console.log("[NIG-DEBUG] [POLLINATIONS] Prompt construction:",{path:"non-horde inline negative",basePositivePromptLength:y.length,hasNegativePrompt:x,enableNegPrompt:v,negativePromptLength:x?w.length:0,finalPromptLength:E.length,finalPromptPreview:E.substring(0,200)+(E.length>200?"...":"")});const A=new URLSearchParams;r&&A.append("token",r),I&&"flux"!==I&&A.append("model",I),s&&s>0&&A.append("width",s),l&&l>0&&A.append("height",l),c&&A.append("seed",c),d&&A.append("enhance","true"),p&&A.append("safe","true"),m&&A.append("nologo","true"),g&&A.append("private","true");const S=A.toString(),P=`https://image.pollinations.ai/prompt/${encodeURIComponent(E)}${S?"?"+S:""}`;GM_xmlhttpRequest({method:"GET",url:P,responseType:"blob",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async a=>{if(a.status>=200&&a.status<300){const e=URL.createObjectURL(a.response);n([e],E,"Pollinations",I,[P])}else{const n=await a.response.text();if(n.toLowerCase().includes("model not found"))return t(`Model error: ${n}. Refreshing model list.`,e,"Pollinations",I),void(0,k.WN)("pollinations");if(403===a.status&&n.includes("auth.pollinations.ai")||n.toLowerCase().includes("authentication")&&n.toLowerCase().includes("auth.pollinations.ai"))try{const t=JSON.parse(n);return void i(t.message||t.error||n,e)}catch(t){return void i(n,e)}t(`Error ${a.status}: ${n}`,e,"Pollinations",I)}},onerror:n=>t(JSON.stringify(n),e,"Pollinations",I)})}(r,l)):"Google"===t?(v.MD("QUEUE","Dispatching to Google provider",{prompt:r.substring(0,200)+(r.length>200?"...":""),path:n}),async function(e,{onSuccess:n,onFailure:t}){const i=await(0,f.zj)(),{model:a,googleApiKey:o,numberOfImages:r,aspectRatio:s,personGeneration:l,imageSize:c,enableNegPrompt:d,globalNegPrompt:p}=i,m="string"==typeof e?e:"",g=!!d,u=(p||"").trim(),h=g&&u.length>0,y=b(h?`${m}, negative prompt: ${u}`:m,"google_api_final");console.log("[NIG-DEBUG] [GOOGLE] Prompt construction:",{path:"non-horde inline negative",basePositivePromptLength:m.length,hasNegativePrompt:h,enableNegPrompt:g,negativePromptLength:h?u.length:0,finalPromptLength:y.length,finalPromptPreview:y.substring(0,200)+(y.length>200?"...":"")});const v=`https://generativelanguage.googleapis.com/v1beta/models/${a}:predict`,w={sampleCount:parseInt(r,10),aspectRatio:s,personGeneration:l};a.includes("fast")||(w.imageSize=parseInt(c,10)),GM_xmlhttpRequest({method:"POST",url:v,headers:{"x-goog-api-key":o,"Content-Type":"application/json"},data:JSON.stringify({instances:[{prompt:y}],parameters:w}),onload:i=>{try{const e=JSON.parse(i.responseText);if(e.error)throw new Error(JSON.stringify(e.error));const t=e.predictions.map(e=>`data:image/png;base64,${e.bytesB64Encoded}`);n(t,y,"Google",a)}catch(n){t(n.message,e,"Google")}},onerror:n=>t(JSON.stringify(n),e,"Google")})}(r,l)):"OpenAICompat"===t&&(v.MD("QUEUE","Dispatching to OpenAICompat provider",{prompt:r.substring(0,200)+(r.length>200?"...":""),providerProfileUrl:e.providerProfileUrl,path:n}),async function(e,n,{onSuccess:t,onFailure:i}){const a=await(0,f.zj)(),o=n||a.openAICompatActiveProfileUrl,r=a.openAICompatProfiles[o];if(!r)return void i(`No active or valid Openai Compatible profile found for URL: ${o}`,e,"OpenAICompat");const{enableNegPrompt:s,globalNegPrompt:l}=a,c="string"==typeof e?e:"",d=!!s,p=(l||"").trim(),m=d&&p.length>0,g=b(m?`${c}, negative prompt: ${p}`:c,"openai_api_final");console.log("[NIG-DEBUG] [OPENAI-COMPAT] Prompt construction:",{path:"non-horde inline negative",basePositivePromptLength:c.length,hasNegativePrompt:m,enableNegPrompt:d,negativePromptLength:m?p.length:0,finalPromptLength:g.length,finalPromptPreview:g.substring(0,200)+(g.length>200?"...":"")});const u=`${o}/images/generations`,h={model:r.model,prompt:g,n:1,size:"1024x1024",response_format:"b64_json"};GM_xmlhttpRequest({method:"POST",url:u,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},data:JSON.stringify(h),onload:n=>{try{const a=function(e,n){try{return JSON.parse(e)}catch(t){if(function(e){const n=e.trim().toLowerCase();return n.startsWith("<!doctype")||n.startsWith("<html")||n.includes("<!doctype")||n.includes("<html>")||n.startsWith("<!")||n.startsWith("<head>")||n.includes("<title>")}(e))throw{isHtmlResponse:!0,originalError:t,message:`Received HTML response instead of JSON from ${n}. This usually indicates endpoint configuration issues or authentication problems.`};const i=t.message.toLowerCase();if(i.includes("unexpected token '<'")&&e.trim().startsWith("<!"))throw{isHtmlResponse:!0,originalError:t,message:`Received HTML response instead of JSON from ${n}. This usually indicates endpoint configuration issues or authentication problems.`};if(i.includes("unexpected character at line 1 column 1"))throw{isMalformedJson:!0,originalError:t,message:`JSON parsing failed at the first character. This may indicate server issues or malformed response from ${n}`};throw{isJsonParseError:!0,originalError:t,message:`JSON parsing error: ${t.message}. This may indicate server issues or malformed response.`}}}(n.responseText,o);if(a?.Error&&a.Error.toLowerCase().includes("invalid api key"))return void i(a.Error,e,"OpenAICompat",o,{errorType:"authentication",isNonRetryable:!0});if(a?.Error&&a.Error.toLowerCase().includes("ip address mismatch"))return void i(a.Error,e,"OpenAICompat",o,{errorType:"ip_mismatch",isNonRetryable:!1,retryable:!0});if(!a?.data?.[0])throw new Error(JSON.stringify(a));try{const e=a.data.map(e=>{if(e.b64_json)try{if("string"==typeof e.b64_json&&e.b64_json.length>0)return`data:image/png;base64,${e.b64_json}`;throw new Error("Invalid base64 data")}catch(e){throw new Error(`Failed to convert image to base64: ${e.message}`)}else if(e.url)return e.url;return null}).filter(Boolean);if(!(e.length>0))throw new Error("API response did not contain usable image data.");t(e,g,"OpenAICompat",r.model)}catch(n){i(n.message,e,"OpenAICompat",o,{errorType:"image_conversion",isNonRetryable:!1})}}catch(n){n.isHtmlResponse?i(n.message,e,"OpenAICompat",o,{errorType:"html_response",isNonRetryable:!1,endpointIssue:!0}):n.isMalformedJson?i(n.message,e,"OpenAICompat",o,{errorType:"malformed_json",isNonRetryable:!1,serverIssue:!0}):n.isJsonParseError?i(n.message,e,"OpenAICompat",o,{errorType:"json_parse_error",isNonRetryable:!1}):i(n.message,e,"OpenAICompat",o)}},onerror:n=>i(JSON.stringify(n),e,"OpenAICompat",o)})}(r,e.providerProfileUrl,l));break}default:d(`Unknown provider: ${t}`,s,"System")}}async function y(){if(e.style.display="none",window.getSelection&&window.getSelection().removeAllRanges(),!l)return void v.JE("GENERATION","No text selected for generation");v.fH("GENERATION","User initiated image generation",{selectionLength:l.length,selectionPreview:l.substring(0,100)+(l.length>100?"...":"")});const t=await f.zj();if("Google"===t.selectedProvider&&!t.googleApiKey)return v.JE("GENERATION","Google provider selected but no API key provided"),void function(){if(document.getElementById("nig-google-api-prompt"))return;R=document.createElement("div"),R.id="nig-google-api-prompt",R.className="nig-modal-overlay",R.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Google API Key Required</h2>\n            <p>Please provide your Google AI Gemini API key. You can get one from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a>.</p>\n            <div class="nig-form-group">\n                <label for="nig-prompt-api-key">Gemini API Key</label>\n                <input type="password" id="nig-prompt-api-key">\n            </div>\n            <button id="nig-prompt-save-btn" class="nig-save-btn">Save Key</button>\n        </div>',document.body.appendChild(R);const e=()=>R.remove();R.querySelector(".nig-close-btn").addEventListener("click",e),R.querySelector("#nig-prompt-save-btn").addEventListener("click",async()=>{const n=R.querySelector("#nig-prompt-api-key").value.trim();n?(await(0,f.yJ)("googleApiKey",n),alert("API Key saved. You can now generate an image."),e()):alert("API Key cannot be empty.")})}();let i=l,o="";if(t.customStyleEnabled&&t.customStyleText?(o=t.customStyleText.trim(),o&&!o.endsWith(", ")&&(o+=", ")):"None"!==t.mainPromptStyle&&(o=t.subPromptStyle&&"none"!==t.subPromptStyle?t.subPromptStyle:`${t.mainPromptStyle} style, `),i=o+i,t.enhancementEnabled){const e=w(t.selectedProvider,t),n=(t.enhancementApiKey||"").trim().length>0;if((!e||t.enhancementOverrideProvider)&&n){r++;const e=r>1?` (Queue: ${r})`:"";P.y("loading",`Enhancing prompt...${e}`);try{const e=b(i,"enhancement_positive_only");i=await x(e,t),r=Math.max(0,r-1);const n=r>0?` (Queue: ${r})`:"";P.y("success",`Prompt enhanced!${n}`),setTimeout(()=>u(),2e3)}catch(e){r=Math.max(0,r-1);const n=r>0?` (Queue: ${r})`:"";v.vV("ENHANCEMENT","External AI enhancement failed, falling back to original",{error:e.message}),P.y("error",`Enhancement failed, using original prompt${n}`),setTimeout(()=>u(),3e3)}}}v.fH("GENERATION","Prompt preparation completed, adding to queue",{provider:t.selectedProvider,basePositivePromptLength:i.length,basePositivePromptPreview:i.substring(0,200)+(i.length>200?"...":""),queueSystem:"FIFO"}),function(e,t,i=null){n.push({basePositivePrompt:e,provider:t,providerProfileUrl:i}),v.fH("GENERATION","Added generation to queue (FIFO)",{provider:t,basePositivePromptLength:e.length,queueLength:n.length,queuePosition:n.length,basePositivePromptPreview:e.substring(0,100)+(e.length>100?"...":"")}),u(),a||h()}(i,t.selectedProvider,t.openAICompatActiveProfileUrl)}function E(){const n=window.getSelection();if(!n||0===n.rangeCount)return void(e&&(e.style.display="none"));const t=n.toString().trim();if(t.length>5){l=t;const i=n.getRangeAt(0).getClientRects();if(0===i.length)return void(e.style.display="none");const a=i[0];e.style.display="block";const o=e.offsetHeight||30;let r=window.scrollY+a.top-o-5;if(r<window.scrollY){const e=i[i.length-1];r=window.scrollY+e.bottom+5}e.style.top=`${r}px`,e.style.left=`${window.scrollX+a.left}px`}else e&&(e.style.display="none")}!async function(){await v.RJ();try{const e=await f.j5();e>0&&v.fH("INIT",`Cleaned ${e} old history entries on startup`)}catch(e){v.vV("INIT","Failed to clean old history entries on startup",{error:e.message})}const n=document.createElement("link");n.rel="stylesheet",n.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0",document.head.appendChild(n),e=document.createElement("button"),e.className="nig-button",e.innerHTML="🎨 Generate Image",e.addEventListener("click",y),document.body.appendChild(e),P.v(),C.v(),N(),X(),function({onRetry:e,onDismiss:n}){M=e,H=n}({onRetry:g,onDismiss:m}),document.addEventListener("mouseup",E),document.addEventListener("selectionchange",E),GM_registerMenuCommand("Image Generator Settings",ee),v.fH("INIT","WTR LAB Novel Image Generator initialized successfully",{config:await f.zj()})}()}()})();