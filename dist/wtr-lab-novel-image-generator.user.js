// ==UserScript==
// @name WTR LAB Novel Image Generator
// @description A powerful userscript to enhance web novel reading on WTR-LAB.COM. Select text to generate AI-powered images using multiple providers (Pollinations, AI Horde, Google Imagen, OpenAI). Features Gemini-enhanced prompts, 100+ art styles, a modern UI, history, and robust configuration options. Built with Webpack for modularity and maintainability.
// @version 5.7.1
// @author MasuRii
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect *
// @downloadURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_xmlhttpRequest
// @grant GM_registerMenuCommand
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @updateURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.meta.js
// ==/UserScript==

(()=>{"use strict";var n={56:(n,e,t)=>{n.exports=function(n){var e=t.nc;e&&n.setAttribute("nonce",e)}},72:n=>{var e=[];function t(n){for(var t=-1,i=0;i<e.length;i++)if(e[i].identifier===n){t=i;break}return t}function i(n,i){for(var o={},r=[],s=0;s<n.length;s++){var l=n[s],c=i.base?l[0]+i.base:l[0],d=o[c]||0,g="".concat(c," ").concat(d);o[c]=d+1;var p=t(g),m={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==p)e[p].references++,e[p].updater(m);else{var u=a(m,i);i.byIndex=s,e.splice(s,0,{identifier:g,updater:u,references:1})}r.push(g)}return r}function a(n,e){var t=e.domAPI(e);return t.update(n),function(e){if(e){if(e.css===n.css&&e.media===n.media&&e.sourceMap===n.sourceMap&&e.supports===n.supports&&e.layer===n.layer)return;t.update(n=e)}else t.remove()}}n.exports=function(n,a){var o=i(n=n||[],a=a||{});return function(n){n=n||[];for(var r=0;r<o.length;r++){var s=t(o[r]);e[s].references--}for(var l=i(n,a),c=0;c<o.length;c++){var d=t(o[c]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}o=l}}},113:n=>{n.exports=function(n,e){if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},249:(n,e,t)=>{t.d(e,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([n.id,"/* === CSS Custom Properties (Design Tokens) === */\n:root {\n    /* Color Palette - Modern Dark Theme */\n    --nig-color-bg-primary: #1a1a1e;\n    --nig-color-bg-secondary: #2d2d32;\n    --nig-color-bg-tertiary: #3a3a40;\n    --nig-color-bg-elevated: #404046;\n    --nig-color-text-primary: #f0f0f0;\n    --nig-color-text-secondary: #b4b4b8;\n    --nig-color-text-muted: #8a8a8e;\n    --nig-color-border: #55555a;\n    --nig-color-border-light: #6a6a6e;\n\n    /* Accent Colors */\n    --nig-color-accent-primary: #6366f1;\n    --nig-color-accent-secondary: #8b5cf6;\n    --nig-color-accent-success: #10b981;\n    --nig-color-accent-warning: #f59e0b;\n    --nig-color-accent-error: #ef4444;\n\n    /* Interactive States */\n    --nig-color-hover-primary: #5855eb;\n    --nig-color-hover-secondary: #7c3aed;\n    --nig-color-hover-success: #059669;\n    --nig-color-hover-error: #dc2626;\n\n    /* Spacing Scale */\n    --nig-space-xs: 0.25rem;\n    --nig-space-sm: 0.5rem;\n    --nig-space-md: 0.75rem;\n    --nig-space-lg: 1rem;\n    --nig-space-xl: 1.5rem;\n    --nig-space-2xl: 2rem;\n    --nig-space-3xl: 3rem;\n\n    /* Typography Scale */\n    --nig-font-size-xs: 0.75rem;\n    --nig-font-size-sm: 0.875rem;\n    --nig-font-size-base: 1rem;\n    --nig-font-size-lg: 1.125rem;\n    --nig-font-size-xl: 1.25rem;\n    --nig-font-size-2xl: 1.5rem;\n    --nig-font-size-3xl: 1.875rem;\n\n    /* Border Radius */\n    --nig-radius-sm: 0.375rem;\n    --nig-radius-md: 0.5rem;\n    --nig-radius-lg: 0.75rem;\n    --nig-radius-xl: 1rem;\n\n    /* Shadows */\n    --nig-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);\n    --nig-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);\n    --nig-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);\n    --nig-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);\n\n    /* Transitions */\n    --nig-transition-fast: 0.15s ease-out;\n    --nig-transition-normal: 0.2s ease-out;\n    --nig-transition-slow: 0.3s ease-out;\n\n    /* Breakpoints */\n    --nig-breakpoint-sm: 640px;\n    --nig-breakpoint-md: 768px;\n    --nig-breakpoint-lg: 1024px;\n    --nig-breakpoint-xl: 1280px;\n}\n\n/* === Base Components === */\n.nig-button {\n    position: absolute;\n    z-index: 99998;\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    box-shadow: var(--nig-shadow-md);\n    display: none;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-normal);\n    transform: translateY(0);\n}\n.nig-button:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-lg);\n}\n.nig-button:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(8px);\n    z-index: 99999;\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    padding: var(--nig-space-lg);\n}\n\n.nig-modal-content {\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-2xl);\n    border-radius: var(--nig-radius-xl);\n    box-shadow: var(--nig-shadow-xl);\n    width: 100%;\n    max-width: 900px;\n    max-height: 90vh;\n    overflow-y: auto;\n    position: relative;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    border: 1px solid var(--nig-color-border);\n    animation: nig-modal-appear 0.2s ease-out;\n}\n\n@keyframes nig-modal-appear {\n    from {\n        opacity: 0;\n        transform: scale(0.95) translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1) translateY(0);\n    }\n}\n\n.nig-modal-content ul {\n    padding-left: var(--nig-space-xl);\n}\n\n.nig-modal-content li {\n    margin-bottom: var(--nig-space-md);\n}\n\n.nig-close-btn {\n    position: absolute;\n    top: var(--nig-space-lg);\n    right: var(--nig-space-lg);\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 300;\n    cursor: pointer;\n    color: var(--nig-color-text-muted);\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: var(--nig-radius-md);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-close-btn:hover {\n    color: var(--nig-color-text-primary);\n    background: var(--nig-color-bg-tertiary);\n}\n\n.nig-modal-content h2 {\n    margin-top: 0;\n    border-bottom: 1px solid var(--nig-color-border);\n    padding-bottom: var(--nig-space-lg);\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 600;\n    letter-spacing: -0.025em;\n}\n\n/* === Form Elements === */\n.nig-form-group {\n    margin-bottom: var(--nig-space-xl);\n}\n\n.nig-form-group label {\n    display: block;\n    margin-bottom: var(--nig-space-sm);\n    font-weight: 500;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-form-group small.nig-hint {\n    color: var(--nig-color-text-muted);\n    font-weight: normal;\n    display: block;\n    margin-top: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-sm);\n    min-height: 1.2em;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n}\n\n.nig-form-group input,\n.nig-form-group select,\n.nig-form-group textarea {\n    width: 100%;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-fast);\n    outline: none;\n}\n\n.nig-form-group input:focus,\n.nig-form-group select:focus,\n.nig-form-group textarea:focus {\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n    background: var(--nig-color-bg-elevated);\n}\n\n.nig-form-group select:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n.nig-form-group textarea {\n    resize: vertical;\n    min-height: 80px;\n    line-height: 1.5;\n}\n\n.nig-form-group-inline {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-lg);\n    align-items: end;\n}\n\n.nig-form-group-inline label {\n    margin-bottom: var(--nig-space-sm);\n}\n\n.nig-checkbox-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--nig-space-lg);\n}\n\n.nig-checkbox-group label {\n    display: flex;\n    align-items: center;\n    margin-right: 0;\n    font-weight: normal;\n    cursor: pointer;\n    color: var(--nig-color-text-secondary);\n}\n\n.nig-checkbox-group input {\n    width: auto;\n    margin-right: var(--nig-space-sm);\n    margin-bottom: 0;\n    transform: scale(1.1);\n}\n\n/* === Buttons === */\n.nig-save-btn {\n    background: var(--nig-color-accent-success);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-save-btn:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-fetch-models-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: var(--nig-space-md);\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-primary);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-fetch-models-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-delete-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: var(--nig-space-md);\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-error);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-delete-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n.nig-history-cleanup-btn {\n    background: var(--nig-color-accent-error);\n    color: white;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-history-cleanup-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n/* === Tab System === */\n.nig-tabs {\n    display: flex;\n    border-bottom: 1px solid var(--nig-color-border);\n    margin-bottom: var(--nig-space-xl);\n    overflow-x: auto;\n    scrollbar-width: none;\n    -ms-overflow-style: none;\n}\n\n.nig-tabs::-webkit-scrollbar {\n    display: none;\n}\n\n.nig-tab {\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    cursor: pointer;\n    border-radius: var(--nig-radius-md) var(--nig-radius-md) 0 0;\n    background: transparent;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-fast);\n    white-space: nowrap;\n    border: 1px solid transparent;\n    border-bottom: none;\n}\n\n.nig-tab:hover {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n}\n\n.nig-tab.active {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    border: 1px solid var(--nig-color-border);\n    border-bottom: 1px solid var(--nig-color-bg-tertiary);\n    box-shadow: 0 -2px 0 var(--nig-color-accent-primary) inset;\n}\n\n.nig-tab-content {\n    display: none;\n    animation: nig-content-fade 0.2s ease-out;\n}\n\n.nig-tab-content.active {\n    display: block;\n}\n\n@keyframes nig-content-fade {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n/* === Modern Utilities Tab === */\n.nig-utilities-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-utility-card {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-utility-card:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-md);\n    transform: translateY(-2px);\n}\n\n.nig-utility-card h4 {\n    margin: 0 0 var(--nig-space-md) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-utility-card p {\n    margin: 0 0 var(--nig-space-lg) 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-utility-card .nig-save-btn {\n    width: 100%;\n    justify-content: center;\n}\n\n/* === Enhanced Utility Card Structure === */\n.nig-card-header {\n    display: flex;\n    align-items: flex-start;\n    gap: var(--nig-space-md);\n    margin-bottom: var(--nig-space-lg);\n}\n\n\n.nig-card-title {\n    flex: 1;\n    min-width: 0;\n}\n\n.nig-card-title h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    line-height: 1.3;\n}\n\n.nig-card-title p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-card-actions {\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-secondary-actions {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-footer {\n    padding-top: var(--nig-space-md);\n     border-top: 1px solid var(--nig-color-border);\n    margin-top: auto;\n}\n\n/* === Modern Button Variants === */\n.nig-btn-primary {\n    width: 100%;\n     background: var(--nig-color-accent-warning);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n}\n\n.nig-btn-primary:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-primary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-xs);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    min-height: 36px;\n}\n\n.nig-btn-secondary:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary.nig-btn-error {\n    background: var(--nig-color-accent-error);\n    color: white;\n}\n\n.nig-btn-secondary.nig-btn-error:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary .material-symbols-outlined {\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-btn-primary .material-symbols-outlined {\n    font-size: var(--nig-font-size-sm);\n}\n\n/* === History System === */\n.nig-history-list {\n    list-style: none;\n    padding: 0;\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.nig-history-item {\n    background: var(--nig-color-bg-tertiary);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-md);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-history-item:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-history-item small {\n    display: block;\n    color: var(--nig-color-text-muted);\n    margin-bottom: var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-history-item a {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    word-break: break-all;\n    font-weight: 500;\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-history-item a:hover {\n    color: var(--nig-color-hover-primary);\n}\n\n.nig-history-cleanup {\n    padding: var(--nig-space-lg);\n    background: var(--nig-color-bg-tertiary);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-xl);\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-lg);\n    border: 1px solid var(--nig-color-border);\n}\n\n.nig-history-cleanup input[type=\"number\"] {\n    width: 80px;\n    padding: var(--nig-space-sm);\n}\n\n/* === Image Gallery === */\n.nig-image-gallery {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-image-container {\n    position: relative;\n    border-radius: var(--nig-radius-lg);\n    overflow: hidden;\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-image-container:hover {\n    box-shadow: var(--nig-shadow-lg);\n    transform: translateY(-2px);\n}\n\n.nig-image-container img {\n    width: 100%;\n    height: auto;\n    display: block;\n    transition: transform var(--nig-transition-slow);\n}\n\n.nig-image-container:hover img {\n    transform: scale(1.02);\n}\n\n.nig-image-actions {\n    position: absolute;\n    top: var(--nig-space-md);\n    right: var(--nig-space-md);\n    display: flex;\n    gap: var(--nig-space-sm);\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(10px);\n    padding: var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    opacity: 0;\n    transition: opacity var(--nig-transition-normal);\n}\n\n.nig-image-container:hover .nig-image-actions {\n    opacity: 1;\n}\n\n.nig-image-actions button {\n    background: rgba(0, 0, 0, 0.8);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    width: 36px;\n    height: 36px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: var(--nig-font-size-base);\n    color: white;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-image-actions button:hover {\n    background: white;\n    transform: scale(1.1);\n}\n\n.material-symbols-outlined {\n    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n    font-size: 18px;\n}\n\n.nig-api-prompt-link {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-api-prompt-link:hover {\n    color: var(--nig-color-hover-primary);\n    text-decoration: underline;\n}\n\n.nig-provider-settings {\n    display: none;\n}\n\n/* === Prompt Container === */\n.nig-prompt-container {\n    background: var(--nig-color-bg-tertiary);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-lg);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-prompt-header {\n    padding: var(--nig-space-lg);\n    cursor: pointer;\n    font-weight: 500;\n    display: flex;\n    align-items: center;\n    user-select: none;\n    color: var(--nig-color-text-primary);\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-prompt-header:hover {\n    color: var(--nig-color-accent-primary);\n}\n\n.nig-prompt-header::before {\n    content: '▸';\n    margin-right: var(--nig-space-md);\n    transition: transform var(--nig-transition-normal);\n    color: var(--nig-color-text-muted);\n}\n\n.nig-prompt-container.expanded .nig-prompt-header::before {\n    transform: rotate(90deg);\n    color: var(--nig-color-accent-primary);\n}\n\n.nig-prompt-text {\n    display: none;\n    padding: 0 var(--nig-space-lg) var(--nig-space-lg) var(--nig-space-lg);\n    border-top: 1px solid var(--nig-color-border);\n    word-break: break-word;\n    color: var(--nig-color-text-secondary);\n    line-height: 1.6;\n}\n\n.nig-prompt-container.expanded .nig-prompt-text {\n    display: block;\n    animation: nig-expand 0.2s ease-out;\n}\n\n@keyframes nig-expand {\n    from {\n        opacity: 0;\n        max-height: 0;\n    }\n    to {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n/* === Button Footer === */\n.nig-button-footer {\n    margin-top: var(--nig-space-3xl);\n    padding-top: var(--nig-space-xl);\n    border-top: 1px solid var(--nig-color-border);\n    text-align: center;\n}\n\n/* === Status Widget === */\n.nig-status-widget {\n    position: fixed;\n    bottom: var(--nig-space-xl);\n    left: var(--nig-space-xl);\n    z-index: 100000;\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    border-radius: var(--nig-radius-lg);\n    box-shadow: var(--nig-shadow-xl);\n    display: none;\n    align-items: center;\n    gap: var(--nig-space-md);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    border: 1px solid var(--nig-color-border);\n    backdrop-filter: blur(10px);\n}\n\n.nig-status-icon {\n    width: 20px;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nig-status-widget.loading .nig-status-icon {\n    box-sizing: border-box;\n    border: 2px solid var(--nig-color-text-muted);\n    border-top-color: var(--nig-color-accent-primary);\n    border-radius: 50%;\n    animation: nig-spin 1s linear infinite;\n}\n\n.nig-status-widget.success {\n    background: var(--nig-color-accent-success);\n    color: white;\n    cursor: pointer;\n    border-color: var(--nig-color-accent-success);\n}\n\n.nig-status-widget.success:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-2px);\n    box-shadow: var(--nig-shadow-lg);\n}\n\n.nig-status-widget.error {\n    background: var(--nig-color-accent-error);\n    border-color: var(--nig-color-accent-error);\n}\n\n@keyframes nig-spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n/* === Error Modal === */\n#nig-error-reason {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-sm);\n    max-height: 150px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    white-space: pre-wrap;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-prompt {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-lg);\n    max-height: 200px;\n    overflow-y: auto;\n    word-break: break-word;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    width: 100%;\n    resize: vertical;\n    min-height: 80px;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-actions {\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-retry-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-retry-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n/* === Responsive Design === */\n\n/* Mobile First Base (up to 767px) */\n@media (max-width: 767px) {\n    .nig-modal-content {\n        margin: var(--nig-space-md);\n        padding: var(--nig-space-xl);\n        max-height: 95vh;\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-modal-overlay {\n        padding: var(--nig-space-sm);\n    }\n\n    .nig-button {\n        position: fixed;\n        bottom: var(--nig-space-3xl);\n        left: 50% !important;\n        transform: translateX(-50%);\n        top: auto !important;\n        padding: var(--nig-space-sm) var(--nig-space-lg);\n        font-size: var(--nig-font-size-sm);\n        z-index: 100001;\n        min-height: 44px; /* Touch target */\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-tabs {\n        margin: 0 calc(-1 * var(--nig-space-xl)) var(--nig-space-xl) calc(-1 * var(--nig-space-xl));\n        padding: 0 var(--nig-space-xl);\n    }\n\n    .nig-tab {\n        padding: var(--nig-space-md) var(--nig-space-lg);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-checkbox-group {\n        flex-direction: column;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-checkbox-group label {\n        justify-content: flex-start;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-utility-card {\n        padding: var(--nig-space-lg);\n    }\n\n    .nig-card-header {\n        flex-direction: column;\n        align-items: center;\n        text-align: center;\n        gap: var(--nig-space-sm);\n    }\n\n\n    .nig-card-secondary-actions {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-card-footer {\n        text-align: center;\n    }\n\n    .nig-history-cleanup {\n        flex-direction: column;\n        align-items: stretch;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-history-cleanup input[type=\"number\"] {\n        width: 100%;\n    }\n\n    .nig-status-widget {\n        bottom: var(--nig-space-lg);\n        left: var(--nig-space-md);\n        right: var(--nig-space-md);\n        padding: var(--nig-space-md);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-modal-content h2 {\n        font-size: var(--nig-font-size-xl);\n        padding-right: 48px; /* Space for close button */\n    }\n}\n\n/* Tablet (768px to 1023px) */\n@media (min-width: 768px) and (max-width: 1023px) {\n    .nig-modal-content {\n        max-width: 700px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n}\n\n/* Desktop (1024px and up) */\n@media (min-width: 1024px) {\n    .nig-modal-content {\n        max-width: 1000px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    }\n\n    /* Enhanced hover states for desktop */\n    .nig-tab:hover {\n        background: var(--nig-color-bg-tertiary);\n    }\n\n    .nig-history-item:hover {\n        transform: translateY(-1px);\n    }\n}\n\n/* Large Desktop (1280px and up) */\n@media (min-width: 1280px) {\n    .nig-modal-content {\n        max-width: 1200px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));\n    }\n}\n\n/* Print Styles */\n@media print {\n    .nig-modal-overlay,\n    .nig-status-widget,\n    .nig-button {\n        display: none !important;\n    }\n\n    .nig-modal-content {\n        box-shadow: none;\n        border: 1px solid #000;\n        background: white;\n        color: black;\n    }\n}\n\n/* High Contrast Mode Support */\n@media (prefers-contrast: high) {\n    :root {\n        --nig-color-bg-primary: #000000;\n        --nig-color-bg-secondary: #1a1a1a;\n        --nig-color-bg-tertiary: #2a2a2a;\n        --nig-color-text-primary: #ffffff;\n        --nig-color-border: #666666;\n    }\n}\n\n/* Reduced Motion Support */\n@media (prefers-reduced-motion: reduce) {\n    *,\n    *::before,\n    *::after {\n        animation-duration: 0.01ms !important;\n        animation-iteration-count: 1 !important;\n        transition-duration: 0.01ms !important;\n    }\n}\n\n/* === Panel Configuration Grid Layout === */\n.nig-config-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-config-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-provider-container {\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-provider-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-provider-header h3 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-provider-header p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-provider-controls {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-provider-settings {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-provider-settings:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-form-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n/* === Styling Tab Layout === */\n.nig-styling-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-styling-intro {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-styling-intro p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.6;\n}\n\n.nig-style-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-style-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-section-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-section-header h4 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n/* === History Tab Layout === */\n.nig-history-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-history-cleanup {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-cleanup-info h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-cleanup-info p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-cleanup-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-md);\n    flex-wrap: wrap;\n}\n\n.nig-cleanup-controls label {\n    color: var(--nig-color-text-primary);\n    font-weight: 500;\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-cleanup-controls input[type=\"number\"] {\n    width: 80px;\n    padding: var(--nig-space-sm);\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    color: var(--nig-color-text-primary);\n}\n\n/* === Enhancement Status & Priority Styles === */\n.nig-enhancement-status {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    margin-left: var(--nig-space-md);\n}\n\n.nig-enhancement-status.provider-priority {\n    background: var(--nig-color-accent-warning);\n    color: white;\n}\n\n.nig-enhancement-status.external-ai {\n    background: var(--nig-color-accent-primary);\n    color: white;\n}\n\n.nig-enhancement-status.disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n}\n\n.nig-status-indicator {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    background: #4af028;\n    opacity: 0.8;\n}\n\n.nig-provider-priority-info {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-accent-warning);\n    border-radius: var(--nig-radius-lg);\n     padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-md);\n}\n\n.nig-priority-header {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    color: var(--nig-color-accent-warning);\n    font-weight: 600;\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-override-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n     padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    align-self: flex-start;\n}\n\n.nig-override-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n/* === Enhancement Preview Styles === */\n.nig-enhancement-preview {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-top: var(--nig-space-lg);\n}\n\n.nig-preview-container {\n    display: grid;\n    grid-template-columns: 1fr auto 1fr;\n    gap: var(--nig-space-lg);\n    align-items: start;\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-preview-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-sm);\n}\n\n.nig-preview-section h5 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.025em;\n}\n\n.nig-preview-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--nig-color-accent-primary);\n    padding: var(--nig-space-sm);\n}\n\n.nig-prompt-display {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md);\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n    color: var(--nig-color-text-secondary);\n    max-height: 120px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    white-space: pre-wrap;\n}\n\n.nig-test-enhancement-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    width: 100%;\n    justify-content: center;\n}\n\n.nig-test-enhancement-btn:hover:not(:disabled) {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-test-enhancement-btn:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n    transform: none;\n}\n\n/* === Enhancement Settings States === */\n.nig-enhancement-settings {\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-enhancement-settings.disabled {\n    opacity: 0.5;\n    pointer-events: none;\n}\n\n.nig-enhancement-settings.disabled .nig-form-group input,\n.nig-enhancement-settings.disabled .nig-form-group select,\n.nig-enhancement-settings.disabled .nig-form-group textarea {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n/* === Template Button Styles === */\n.nig-template-btn {\n    background: var(--nig-color-bg-elevated);\n    border: 1px solid var(--nig-color-border);\n    color: var(--nig-color-text-secondary);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    cursor: pointer;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-template-btn:hover {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border-color: var(--nig-color-accent-primary);\n}\n\n/* === Mobile Enhancement Styles === */\n@media (max-width: 767px) {\n    .nig-preview-container {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-preview-arrow {\n        transform: rotate(90deg);\n        justify-self: center;\n    }\n\n    .nig-enhancement-status {\n        margin-left: 0;\n        margin-top: var(--nig-space-sm);\n        align-self: flex-start;\n    }\n}\n\n/* === Enhanced Responsive Grid === */\n@media (min-width: 768px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-cleanup-controls {\n        justify-content: flex-start;\n    }\n}\n\n@media (min-width: 1024px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-settings:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--nig-shadow-md);\n    }\n}\n\n@media (min-width: 1280px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-styling-container {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* === File Input Styling === */\ninput[type=\"file\"] {\n    border: 2px dashed var(--nig-color-border);\n    background: var(--nig-color-bg-primary);\n    padding: var(--nig-space-xl);\n    border-radius: var(--nig-radius-lg);\n    color: var(--nig-color-text-secondary);\n    transition: all var(--nig-transition-normal);\n    cursor: pointer;\n}\n\ninput[type=\"file\"]:hover {\n    border-color: var(--nig-color-accent-primary);\n    background: var(--nig-color-bg-elevated);\n}\n\ninput[type=\"file\"]:focus {\n    outline: none;\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n}",""]);const s=r},314:n=>{n.exports=function(n){var e=[];return e.toString=function(){return this.map(function(e){var t="",i=void 0!==e[5];return e[4]&&(t+="@supports (".concat(e[4],") {")),e[2]&&(t+="@media ".concat(e[2]," {")),i&&(t+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),t+=n(e),i&&(t+="}"),e[2]&&(t+="}"),e[4]&&(t+="}"),t}).join("")},e.i=function(n,t,i,a,o){"string"==typeof n&&(n=[[null,n,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<n.length;c++){var d=[].concat(n[c]);i&&r[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),e.push(d))}},e}},322:(n,e,t)=>{function i(n,e,t){const i=new Blob([e],{type:t}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function a(){return"WTR LAB Novel Image Generator".replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}t.d(e,{P:()=>i,t:()=>a})},540:n=>{n.exports=function(n){var e=document.createElement("style");return n.setAttributes(e,n.attributes),n.insert(e,n.options),e}},601:n=>{n.exports=function(n){return n[1]}},642:(n,e,t)=>{t.d(e,{WU:()=>o,vt:()=>a});var i=t(322);function a(){if(document.getElementById("nig-image-viewer"))return;const n=document.createElement("div");n.id="nig-image-viewer",n.className="nig-modal-overlay",n.style.display="none",n.innerHTML='\n\t\t<div class="nig-modal-content">\n\t\t\t<span class="nig-close-btn">&times;</span>\n\t\t\t<div id="nig-prompt-container" class="nig-prompt-container">\n\t\t\t\t<div class="nig-prompt-header"><span>Generated Image Prompt</span></div>\n\t\t\t\t<p id="nig-prompt-text" class="nig-prompt-text"></p>\n\t\t\t</div>\n\t\t\t<div id="nig-image-gallery" class="nig-image-gallery"></div>\n\t\t</div>',document.body.appendChild(n),n.querySelector(".nig-close-btn").addEventListener("click",()=>{n.style.display="none",Promise.resolve().then(t.bind(t,867)).then(n=>{n.updateSystemStatus})});const e=n.querySelector("#nig-prompt-container");e.addEventListener("click",()=>{e.classList.toggle("expanded")})}function o(n,e,t){document.getElementById("nig-image-viewer")||a();const o=document.getElementById("nig-image-viewer"),r=o.querySelector("#nig-image-gallery");r.innerHTML="";const s=o.querySelector("#nig-prompt-container");o.querySelector("#nig-prompt-text").textContent=e,s.classList.remove("expanded");const l="Pollinations"===t||"OpenAICompat"===t?"jpg":"png";n.forEach((n,t)=>{const a=document.createElement("div");a.className="nig-image-container";const o=document.createElement("img");o.src=n;const s=document.createElement("div");s.className="nig-image-actions";const c=document.createElement("button");c.innerHTML='<span class="material-symbols-outlined">download</span>',c.title="Download",c.onclick=()=>{const a=document.createElement("a");a.href=n;const o=(0,i.t)(),r=e.substring(0,20).replace(/\s/g,"_");a.download=`${o}_${r}_${t}.${l}`,a.click()};const d=document.createElement("button");d.innerHTML='<span class="material-symbols-outlined">fullscreen</span>',d.title="Fullscreen",d.onclick=()=>{o.requestFullscreen&&o.requestFullscreen()},s.appendChild(c),s.appendChild(d),a.appendChild(o),a.appendChild(s),r.appendChild(a)}),o.style.display="flex"}},659:n=>{var e={};n.exports=function(n,t){var i=function(n){if(void 0===e[n]){var t=document.querySelector(n);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(n){t=null}e[n]=t}return e[n]}(n);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(t)}},825:n=>{n.exports=function(n){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=n.insertStyleElement(n);return{update:function(t){!function(n,e,t){var i="";t.supports&&(i+="@supports (".concat(t.supports,") {")),t.media&&(i+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(i+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),i+=t.css,a&&(i+="}"),t.media&&(i+="}"),t.supports&&(i+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),e.styleTagTransform(i,n,e.options)}(e,n,t)},remove:function(){!function(n){if(null===n.parentNode)return!1;n.parentNode.removeChild(n)}(e)}}}},867:(n,e,t)=>{t.d(e,{v:()=>a,y:()=>o});let i=null;function a(){i||(i=document.createElement("div"),i.id="nig-status-widget",i.className="nig-status-widget",i.innerHTML='<div class="nig-status-icon"></div><span class="nig-status-text"></span>',document.body.appendChild(i))}function o(n,e,t=null){if(!i)return;if(i.classList.remove("loading","success","error"),i.onclick=t,"hidden"===n)return void(i.style.display="none");i.style.display="flex",i.querySelector(".nig-status-text").textContent=e,i.classList.add(n);const a=i.querySelector(".nig-status-icon");a.innerHTML="","success"===n?a.innerHTML="✅":"error"===n&&(a.innerHTML="❌")}}},e={};function t(i){var a=e[i];if(void 0!==a)return a.exports;var o=e[i]={id:i,exports:{}};return n[i](o,o.exports,t),o.exports}t.n=n=>{var e=n&&n.__esModule?()=>n.default:()=>n;return t.d(e,{a:e}),e},t.d=(n,e)=>{for(var i in e)t.o(e,i)&&!t.o(n,i)&&Object.defineProperty(n,i,{enumerable:!0,get:e[i]})},t.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),t.nc=void 0;var i=t(72),a=t.n(i),o=t(825),r=t.n(o),s=t(659),l=t.n(s),c=t(56),d=t.n(c),g=t(540),p=t.n(g),m=t(113),u=t.n(m),v=t(249),h={};h.styleTagTransform=u(),h.setAttributes=d(),h.insert=l().bind(null,"head"),h.domAPI=r(),h.insertStyleElement=p(),a()(v.A,h),v.A&&v.A.locals&&v.A.locals;const y={selectedProvider:"Pollinations",loggingEnabled:!1,mainPromptStyle:"None",subPromptStyle:"none",customStyleEnabled:!1,customStyleText:"",enhancementEnabled:!1,enhancementProvider:"gemini",enhancementApiKey:"",enhancementModel:"models/gemini-2.5-pro",enhancementTemplate:'Convert this text into a focused visual description for image generation. Extract key visual elements (characters, setting, mood, style) and describe them as a direct prompt without narrative elements, dialogue, or markdown formatting. Keep it concise and focused on what can be visually rendered. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:',enhancementOverrideProvider:!1,enhancementLastStatus:"disabled",enableNegPrompt:!0,globalNegPrompt:"ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality",googleApiKey:"",model:"imagen-4.0-generate-001",numberOfImages:1,imageSize:"1024",aspectRatio:"1:1",personGeneration:"allow_adult",aiHordeApiKey:"0000000000",aiHordeModel:"AlbedoBase XL (SDXL)",aiHordeSampler:"k_dpmpp_2m",aiHordeSteps:25,aiHordeCfgScale:7,aiHordeWidth:512,aiHordeHeight:512,aiHordePostProcessing:[],aiHordeSeed:"",pollinationsModel:"flux",pollinationsWidth:512,pollinationsHeight:512,pollinationsSeed:"",pollinationsEnhance:!0,pollinationsNologo:!1,pollinationsPrivate:!1,pollinationsSafe:!0,pollinationsToken:"",openAICompatProfiles:{},openAICompatActiveProfileUrl:"",openAICompatModelManualInput:!1};async function f(n){return await GM_getValue(n,y[n])}async function b(){const n={};for(const e in y)n[e]=await GM_getValue(e,y[e]);return n}async function w(n,e){await GM_setValue(n,e)}async function x(){try{const n=await GM_getValue("history","[]");return"string"==typeof n&&n.trim()?JSON.parse(n):Array.isArray(n)?n:[]}catch(n){return console.error("Failed to parse history data, resetting",n),await GM_setValue("history","[]"),[]}}let E=!1,k=[];async function S(){E=await f("loggingEnabled")}function I(n,e,t,i=null){if(!E)return;const a={timestamp:(new Date).toISOString(),level:n,category:e,message:t,data:i},o=`[NIG-${n.toUpperCase()}]`,r=`[${e}]`,s={error:"color: #ef4444",warn:"color: #f59e0b",debug:"color: #8b5cf6",info:"color: #6366f1"}[n];i?console.log(`%c${o}`,s,r,t,i):console.log(`%c${o}`,s,r,t),"ENHANCEMENT"===e&&(k.unshift(a),k.length>50&&(k=k.slice(0,50)),GM_setValue("enhancementLogHistory",JSON.stringify(k.slice(0,20))))}const A=(n,e,t)=>I("info",n,e,t),C=(n,e,t)=>I("debug",n,e,t),P=(n,e,t)=>I("warn",n,e,t),M=(n,e,t)=>I("error",n,e,t);async function N(){try{const n=await GM_getValue("enhancementLogHistory","[]");k="string"==typeof n&&n.trim()?JSON.parse(n):Array.isArray(n)?n:[],C("LOG",`Loaded ${k.length} enhancement log entries from storage`)}catch(n){M("LOG","Failed to load enhancement log history",n),k=[];try{await GM_setValue("enhancementLogHistory","[]")}catch(n){M("LOG","Failed to clear corrupted enhancement log history",n)}}}async function L(){return await N(),k}function T(n,e){C("ENHANCEMENT","Checking provider priority for enhancement",{provider:n,config:e});const t=(()=>{if("Pollinations"===n){const t=e.pollinationsEnhance;return A("ENHANCEMENT",`Provider ${n} has built-in enhancement: ${t}`),t}return A("ENHANCEMENT",`Provider ${n} does not have built-in enhancement`),!1})();return C("ENHANCEMENT","Provider priority decision completed",{shouldUseProviderEnhancement:t,willUseExternalAI:e.enhancementEnabled&&e.enhancementApiKey&&(!t||e.enhancementOverrideProvider)}),t}async function B(n,e){const t=Date.now(),{enhancementApiKey:i,enhancementModel:a,enhancementTemplate:o}=e,r=a.startsWith("models/")?a.substring(7):a;if(!r)throw new Error("Model name processing resulted in an empty or invalid model name.");if(A("ENHANCEMENT","Starting prompt enhancement with Gemini AI",{originalLength:n.length,model:r,apiKeyPresent:!!i}),!i)throw new Error("Gemini API key is required for prompt enhancement.");const s={contents:[{parts:[{text:o?`${o}\n\nOriginal prompt: "${n}"\n\nEnhanced prompt:`:`Convert this text into a focused visual description for image generation... \n\n"${n}"\n\nEnhanced version:`}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:65536}},l=`https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent?key=${i}`;return new Promise((n,e)=>{GM_xmlhttpRequest({method:"POST",url:l,headers:{"Content-Type":"application/json"},data:JSON.stringify(s),timeout:45e3,onload:i=>{try{if(!i.responseText)throw new Error("Empty response received from Gemini API");const e=JSON.parse(i.responseText);if(e.error)throw new Error(e.error.message||"Gemini API error");if(!e.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("No enhancement result received from Gemini API");{const i=e.candidates[0].content.parts[0].text.trim().replace(/^["']|["']$/g,"");A("ENHANCEMENT","Prompt enhancement successful",{duration:Date.now()-t}),n(i)}}catch(n){M("ENHANCEMENT","Enhancement processing error",{error:n.message,responseText:i.responseText}),e(n)}},onerror:n=>{M("ENHANCEMENT","Network error during enhancement",{error:n}),e(new Error("Network error during enhancement request."))},ontimeout:()=>{M("ENHANCEMENT","Enhancement request timed out."),e(new Error("Enhancement request timed out after 45 seconds."))}})})}async function H(){try{const n=await GM_getValue("cachedModels","{}");return"string"==typeof n&&n.trim()?JSON.parse(n):"object"==typeof n&&null!==n?n:{}}catch(n){return I("error","CACHE","Failed to parse cached models data, resetting cache",{error:n.message}),await GM_setValue("cachedModels","{}"),{}}}async function O(n){try{return(await H())[n]||null}catch(e){return I("error","CACHE",`Failed to get cached models for ${n}`,{error:e.message}),null}}async function G(n,e){try{const t=await H();t[n]=e,await GM_setValue("cachedModels",JSON.stringify(t)),I("info","CACHE",`Cached models for ${n}`)}catch(t){I("error","CACHE","Failed to cache models",{provider:n,error:t.message}),await GM_setValue("cachedModels","{}");try{cache[n]=e,await GM_setValue("cachedModels",JSON.stringify(cache)),I("info","CACHE",`Cached models for ${n} after cache reset`)}catch(e){I("error","CACHE","Failed to cache models even after reset",{provider:n,error:e.message})}}}async function F(n=null){try{if(n){const e=await H();delete e[n],await GM_setValue("cachedModels",JSON.stringify(e)),A("CACHE",`Cleared cached models for ${n}.`)}else await async function(){try{let n={};try{const e=await GM_getValue("openAICompatProfiles","{}");"string"==typeof e&&e.trim()?n=JSON.parse(e):"object"==typeof e&&null!==e&&(n=e)}catch(n){return void I("error","CACHE","Failed to get OpenAI profiles for cache clearing",{error:n.message})}for(const e of Object.keys(n)){const n=`openAICompatModels_${e}`;await GM_setValue(n,"[]")}A("CACHE","Cleared cached models for all OpenAI compatible providers.")}catch(n){I("error","CACHE","Failed to clear OpenAI compatible model caches",{error:n.message})}}(),await GM_setValue("cachedModels","{}"),A("CACHE","Cleared all cached models and reset OpenAI Compatible model selections."),alert("All cached models have been cleared. They will be re-fetched when you next open the settings.")}catch(e){I("error","CACHE","Failed to clear cached models",{provider:n,error:e.message});try{await GM_setValue("cachedModels","{}"),I("info","CACHE","Force reset cache data as fallback")}catch(n){I("error","CACHE","Failed to force reset cache",{error:n.message})}}}function R(n,e,t,i,{onSuccess:a,onFailure:o,updateStatus:r}){Date.now()-t>3e5?o("Timed out after 5 minutes.",e,"AIHorde"):GM_xmlhttpRequest({method:"GET",url:`https://aihorde.net/api/v2/generate/status/${n}`,onload:s=>{try{const l=JSON.parse(s.responseText);if(l.done){const n=l.generations.map(n=>n.img);a(n,e,"AIHorde",i)}else{let s="Waiting for worker...";l.queue_position>0?s=`Queue: ${l.queue_position}. Est: ${l.wait_time}s.`:l.processing>0&&(s="Generating..."),r(s),setTimeout(()=>R(n,e,t,i,{onSuccess:a,onFailure:o,updateStatus:r}),5e3)}}catch(n){o(`Error checking status: ${n.message}`,e,"AIHorde")}},onerror:()=>o("Failed to get status from AI Horde.",e,"AIHorde")})}async function z(n,{onSuccess:e,onFailure:t,updateStatus:i}){const a=await b(),{aiHordeApiKey:o,aiHordeModel:r,aiHordeSampler:s,aiHordeCfgScale:l,aiHordeSteps:c,aiHordeWidth:d,aiHordeHeight:g,aiHordeSeed:p,aiHordePostProcessing:m,enableNegPrompt:u,globalNegPrompt:v}=a,h={sampler_name:s,cfg_scale:parseFloat(l),steps:parseInt(c,10),width:parseInt(d,10),height:parseInt(g,10)};p&&(h.seed=p),m.length>0&&(h.post_processing=m);const y={prompt:n,params:h,models:[r]};u&&v&&(y.negative_prompt=v),GM_xmlhttpRequest({method:"POST",url:"https://aihorde.net/api/v2/generate/async",headers:{"Content-Type":"application/json",apikey:o||"0000000000"},data:JSON.stringify(y),onload:a=>{try{const o=JSON.parse(a.responseText);if(!o.id){if(o.message&&o.message.toLowerCase().includes("model"))return t(`Model error: ${o.message}. Refreshing model list.`,n,"AIHorde"),void F("aiHorde");throw new Error(o.message||"Failed to initiate generation.")}R(o.id,n,Date.now(),r,{onSuccess:e,onFailure:t,updateStatus:i})}catch(e){t(e.message,n,"AIHorde")}},onerror:e=>t(JSON.stringify(e),n,"AIHorde")})}var q=t(867),_=t(642);let D=null,U=()=>{},$=()=>{};function K(){D||(D=document.createElement("div"),D.id="nig-error-modal",D.className="nig-modal-overlay",D.style.display="none",D.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Generation Failed</h2>\n            <p>The image could not be generated. Please review the reason below and adjust your prompt if necessary.</p>\n            <p><strong>Reason:</strong></p>\n            <div id="nig-error-reason"></div>\n            <p><strong>Your Prompt:</strong></p>\n            <textarea id="nig-error-prompt" class="nig-error-prompt"></textarea>\n            <div class="nig-form-group" style="margin-top: 15px;">\n                <label for="nig-retry-provider-select">Retry with Provider:</label>\n                <select id="nig-retry-provider-select"></select>\n            </div>\n            <div id="nig-error-actions" class="nig-error-actions"></div>\n        </div>',document.body.appendChild(D),D.querySelector(".nig-close-btn").addEventListener("click",()=>W()))}function W(){D&&(D.style.display="none"),"function"==typeof $&&$()}let j=null,V=null;const J=[{name:"None",description:"No additional styling will be added to your prompt.",subStyles:[]},{name:"Anime",description:"Blends Japanese animation with global twists. Sub-styles often mix eras, genres, or crossovers for dynamic outputs.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Anime style, ...").'},{name:"Studio Ghibli-Inspired",description:"Whimsical, nature-focused fantasy with soft lines and emotional depth.",value:"Studio Ghibli style, "},{name:"Cyberpunk Anime",description:"Neon-lit dystopias with high-tech mechs and gritty urban vibes.",value:"Cyberpunk anime style, "},{name:"Semi-Realistic Anime",description:"Blends lifelike proportions with expressive anime eyes and shading.",value:"Semi-realistic anime style, "},{name:"Mecha",description:"Giant robots and mechanical suits in epic battles.",value:"Mecha anime style, "},{name:"Dynamic Action",description:"High-energy movements with power effects and intense expressions.",value:"Dynamic action anime style, "},{name:"Soft Romantic",description:"Emotional interactions with gentle colors and sparkling accents.",value:"Soft romantic anime style, "},{name:"Dark Fantasy Anime",description:"Grim, horror-tinged worlds with demons and shadows.",value:"Dark fantasy anime style, "},{name:"Retro 80s Anime",description:"Vintage cel-shaded look with bold lines and synth vibes.",value:"80s retro anime style, "},{name:"Portal Fantasy",description:"World-crossing elements with magical adaptations and RPG motifs.",value:"Portal fantasy anime style, "},{name:"Slice-of-Life",description:"Everyday moments with relatable characters and cozy vibes.",value:"Slice-of-life anime style, "},{name:"Serialized Narrative",description:"Panel-like compositions for ongoing story flows.",value:"Serialized narrative anime style, "},{name:"Group Dynamic",description:"Interactions among multiple characters with balanced focus.",value:"Group dynamic anime style, "}]},{name:"Realism/Photorealism",description:"Excels in portraits and scenes mimicking photography, with sub-styles varying by subject or technique.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Realism/Photorealism style, ...").'},{name:"Hyperrealism",description:"Ultra-detailed, almost tangible textures and lighting.",value:"Hyperrealistic, "},{name:"Cinematic Realism",description:"Film-like depth with dramatic angles and color grading.",value:"Cinematic realism, "},{name:"Portrait Photorealism",description:"Human faces with natural skin, eyes, and expressions.",value:"Portrait photorealism, "},{name:"Architectural Realism",description:"Precise building renders with environmental details.",value:"Architectural realism, "},{name:"Nature Photorealism",description:"Verdant landscapes with dew and foliage intricacies.",value:"Nature photorealism, "},{name:"Close-Up Detail",description:"Intimate views highlighting textures and fine elements.",value:"Close-up realistic style, "},{name:"Historical Realism",description:"Period-accurate clothing and settings with grit.",value:"Historical realism, "},{name:"Urban Realism",description:"Bustling city life with crowds and neon realism.",value:"Urban realism, "},{name:"Stylized Realism",description:"Subtle artistic tweaks on photoreal bases.",value:"Stylized realism, "},{name:"Documentary Style",description:"Raw, unpolished scenes like news photography.",value:"Documentary photo style, "},{name:"Object Focus Realism",description:"Clear, highlighted items with neutral lighting.",value:"Object-focused realism, "},{name:"Wildlife Realism",description:"Animals in habitats with fur and feather fidelity.",value:"Wildlife realism, "},{name:"Detailed Portrait",description:"Lifelike faces with expressive features.",value:"Detailed portrait realism, "},{name:"Environmental Immersion",description:"Rich settings enveloping subjects.",value:"Environmental immersion realism, "}]},{name:"Fantasy",description:"Epic worlds of magic and myth, with sub-styles spanning tones from whimsical to grim.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Fantasy style, ...").'},{name:"High Fantasy",description:"Medieval realms with elves, dragons, and quests.",value:"High fantasy art, "},{name:"Dark Fantasy",description:"Grimdark horror with undead and moral ambiguity.",value:"Dark fantasy art, "},{name:"Urban Fantasy",description:"Magic in modern cities, like hidden witches.",value:"Urban fantasy art, "},{name:"Steampunk Fantasy",description:"Victorian tech with gears and airships.",value:"Steampunk fantasy style, "},{name:"Fairy Tale",description:"Whimsical tales with enchanted woods and creatures.",value:"Fairy tale illustration style, "},{name:"Heroic Adventure",description:"Bold explorers with raw magic and ancient relics.",value:"Heroic adventure fantasy art, "},{name:"Creature Emphasis",description:"Fantastical beings in natural or enchanted environments.",value:"Creature-focused fantasy art, "},{name:"Ethereal Grace",description:"Elegant figures in luminous, forested settings.",value:"Ethereal grace fantasy style, "},{name:"Rugged Craftsmanship",description:"Stout builders in forged, underground realms.",value:"Rugged craftsmanship fantasy style, "},{name:"Gothic Fantasy",description:"Haunted castles with vampires and storms.",value:"Gothic fantasy art, "},{name:"Beast Majesty",description:"Powerful scaled creatures in dramatic poses.",value:"Majestic beast fantasy art, "},{name:"Celestial Fantasy",description:"Starry realms with gods and floating islands.",value:"Celestial fantasy art, "},{name:"Oriental Myth",description:"Asian folklore elements with harmonious nature.",value:"Oriental myth fantasy style, "},{name:"Treasure Hunt Vibe",description:"Exploratory scenes with hidden wonders.",value:"Treasure hunt fantasy art, "}]},{name:"Sci-Fi",description:"Futuristic visions from gritty cyber worlds to cosmic explorations.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Sci-Fi style, ...").'},{name:"Cyberpunk",description:"Neon dystopias with hackers and megacorps.",value:"Cyberpunk style, "},{name:"Retro-Futurism",description:"1950s optimism with ray guns and chrome.",value:"Retro-futurism, "},{name:"Biopunk",description:"Organic tech with genetic mutations.",value:"Biopunk sci-fi style, "},{name:"Interstellar Epic",description:"Vast cosmic tales with diverse species and ships.",value:"Interstellar epic sci-fi art, "},{name:"Mechanical Suit",description:"Armored machines in high-tech conflicts.",value:"Mechanical suit sci-fi style, "},{name:"Post-Human",description:"Cyborgs and AI in evolved societies.",value:"Post-human sci-fi art, "},{name:"Hard Sci-Fi",description:"Physics-based realism with tech schematics.",value:"Hard sci-fi illustration, "},{name:"Dieselpunk",description:"1930s grit with riveted machines.",value:"Dieselpunk style, "},{name:"Astro-Mythology",description:"Space gods and cosmic myths.",value:"Astro-mythology art, "},{name:"Eco-Sci-Fi",description:"Post-apocalypse with bio-domes.",value:"Eco-sci-fi art, "},{name:"Survival Wasteland",description:"Harsh, ruined landscapes with resilient figures.",value:"Survival wasteland sci-fi style, "},{name:"Cosmic Discovery",description:"Unknown worlds with exploratory tech.",value:"Cosmic discovery sci-fi art, "}]},{name:"Retro/Vintage",description:"Nostalgic aesthetics from bygone eras, revived with AI flair.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Retro/Vintage style, ...").'},{name:"Art Deco",description:"Geometric luxury with gold and symmetry.",value:"Art Deco style, "},{name:"Art Nouveau",description:"Flowing organic lines and floral motifs.",value:"Art Nouveau style, "},{name:"Vintage Poster",description:"Bold typography and illustrative ads.",value:"Vintage poster style, "},{name:"Chromolithography",description:"Vibrant, printed color layers from 1900s.",value:"Chromolithography, "},{name:"Baroque",description:"Ornate drama with rich drapery.",value:"Baroque painting style, "},{name:"Ukiyo-e",description:"Japanese woodblock prints with flat colors.",value:"Ukiyo-e style, "},{name:"1950s Retro",description:"Atomic age optimism with pastels.",value:"1950s retro style, "},{name:"Playful Figure",description:"Charming, stylized poses with vintage flair.",value:"Playful vintage figure style, "},{name:"Edwardian",description:"Lacy elegance with soft pastels.",value:"Edwardian era style, "},{name:"Mid-Century Modern",description:"Clean lines and bold geometrics.",value:"Mid-century modern style, "},{name:"Ink Scroll",description:"Brush-like lines evoking ancient manuscripts.",value:"Ink scroll vintage style, "}]},{name:"Surrealism",description:"Dreamlike distortions challenging reality, inspired by masters.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Surrealism style, ...").'},{name:"Fluid Distortion",description:"Melting forms and impossible blends.",value:"Fluid distortion surrealism, "},{name:"Paradoxical Objects",description:"Everyday items in illogical arrangements.",value:"Paradoxical object surrealism, "},{name:"Ernst Collage Surreal",description:"Layered fragments for uncanny narratives.",value:"Ernst collage surrealism, "},{name:"Kahlo Autobiographical",description:"Personal symbolism with thorny motifs.",value:"Frida Kahlo style surrealism, "},{name:"Biomorphic Surreal",description:"Organic, creature-like hybrids.",value:"Biomorphic surrealism, "},{name:"Dreamlike Landscapes",description:"Floating islands and inverted gravity.",value:"Dreamlike surreal landscape, "},{name:"Freudian Symbolic",description:"Subconscious icons like eyes and stairs.",value:"Freudian symbolic surrealism, "},{name:"Pop Surrealism",description:"Whimsical grotesquery with candy colors.",value:"Pop surrealism, lowbrow art, "},{name:"Hyper-Surreal",description:"Exaggerated distortions in vivid detail.",value:"Hyper-surrealism, "},{name:"Eco-Surreal",description:"Nature twisted with human elements.",value:"Eco-surrealism, "},{name:"Mechanical Surreal",description:"Machines fused with flesh.",value:"Mechanical surrealism, "},{name:"Inner Vision",description:"Symbolic inner thoughts with blended realities.",value:"Inner vision surrealism, "}]},{name:"Cartoon/Illustration",description:"Exaggerated, narrative-driven visuals for fun and storytelling.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Cartoon/Illustration style, ...").'},{name:"Pixar 3D",description:"Polished, expressive CG with emotional arcs.",value:"Pixar 3D animation style, "},{name:"Disney Classic",description:"Hand-drawn whimsy with fluid animation.",value:"Classic Disney animation style, "},{name:"DreamWorks",description:"Edgy humor with detailed backgrounds.",value:"DreamWorks animation style, "},{name:"Adventure Time",description:"Surreal candy lands with bold shapes.",value:"Adventure Time cartoon style, "},{name:"Simpsons",description:"Yellow-skinned satire with clean outlines.",value:"The Simpsons cartoon style, "},{name:"Rick and Morty",description:"Sci-fi absurdity with warped perspectives.",value:"Rick and Morty cartoon style, "},{name:"Narrative Panel",description:"Sequential art with shaded storytelling.",value:"Narrative panel illustration style, "},{name:"Whimsical Illustration",description:"Gentle, colorful drawings for light-hearted scenes.",value:"Whimsical illustration style, "},{name:"Webtoon",description:"Vertical scroll with vibrant digital ink.",value:"Webtoon style, "},{name:"Manhua Flow",description:"Dynamic lines and vibrant digital shading.",value:"Manhua flow illustration style, "},{name:"Cover Art Focus",description:"Striking compositions for thematic highlights.",value:"Cover art illustration, "}]},{name:"Traditional Painting",description:"Emulates historical mediums like oils and watercolors for timeless appeal.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Traditional Painting style, ...").'},{name:"Impressionism",description:"Loose brushstrokes capturing light moments.",value:"Impressionist painting, "},{name:"Renaissance",description:"Balanced compositions with chiaroscuro.",value:"Renaissance painting style, "},{name:"Oil Painting",description:"Rich, layered textures with glazing.",value:"Oil painting, "},{name:"Watercolor",description:"Translucent washes for ethereal softness.",value:"Watercolor painting, "},{name:"Baroque",description:"Dramatic tenebrism and opulent details.",value:"Baroque painting, "},{name:"Romanticism",description:"Emotional storms and heroic figures.",value:"Romanticism painting, "},{name:"Pointillism",description:"Dot-based color mixing for vibrancy.",value:"Pointillism style, "},{name:"Fresco",description:"Mural-like with aged plaster effects.",value:"Fresco painting style, "},{name:"Encaustic",description:"Waxy, heated layers for luminous depth.",value:"Encaustic painting, "},{name:"Acrylic",description:"Bold, matte finishes with quick drying.",value:"Acrylic painting, "},{name:"Gouache",description:"Opaque vibrancy like matte poster paint.",value:"Gouache painting, "},{name:"Sumi-e",description:"Minimalist ink washes for Zen simplicity.",value:"Sumi-e ink wash painting, "},{name:"Oriental Brushwork",description:"Minimalist inks for balanced compositions.",value:"Oriental brushwork style, "},{name:"Era Line Art",description:"Detailed etchings for historical depth.",value:"Era line art traditional, "}]},{name:"Digital Art",description:"Modern, tech-infused creations from pixels to vectors.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Digital Art style, ...").'},{name:"Vector Illustration",description:"Scalable, flat colors with clean paths.",value:"Vector illustration, "},{name:"Blended Landscape",description:"Layered digital environments for immersive backdrops.",value:"Blended digital landscape, "},{name:"Neon Glow",description:"Vibrant outlines with electric luminescence.",value:"Neon glow digital art, "},{name:"Holographic",description:"Shimmering, 3D projections with refractions.",value:"Holographic style, "},{name:"World-Building Sketch",description:"Conceptual layers for expansive scenes.",value:"World-building digital sketch, "},{name:"Community Render",description:"Polished digital interpretations of characters.",value:"Community render digital style, "}]},{name:"Wuxia/Xianxia",description:"Eastern-inspired martial and spiritual themes with energy flows, ancient motifs, and harmonious or intense atmospheres.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Wuxia/Xianxia style, ...").'},{name:"Qi Energy Flow",description:"Subtle auras and internal power visualizations.",value:"Qi energy flow style, "},{name:"Martial Grace",description:"Fluid poses and disciplined movements.",value:"Martial grace style, "},{name:"Spiritual Realm",description:"Misty, elevated worlds with ethereal elements.",value:"Spiritual realm style, "},{name:"Ancient Sect Aesthetic",description:"Traditional architecture and robed figures.",value:"Ancient sect aesthetic, "},{name:"Demonic Shadow",description:"Darkened energies and mysterious silhouettes.",value:"Demonic shadow style, "},{name:"Dynasty Elegance",description:"Silk textures and jade accents in historical tones.",value:"Dynasty elegance style, "}]},{name:"Romance",description:"Tender or passionate human connections with soft lighting, expressions, and atmospheric details.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Romance style, ...").'},{name:"Gentle Intimacy",description:"Close, affectionate moments with warm hues.",value:"Gentle intimacy romance style, "},{name:"Urban Affection",description:"Modern settings with subtle romantic gestures.",value:"Urban affection style, "},{name:"Enchanted Bond",description:"Magical elements enhancing emotional ties.",value:"Enchanted bond romance style, "},{name:"Tension Build",description:"Subtle conflicts leading to connection.",value:"Tension build romance style, "},{name:"Blushing Softness",description:"Delicate emotions with pastel accents.",value:"Blushing softness style, "},{name:"Melancholic Yearning",description:"Poignant separations with evocative moods.",value:"Melancholic yearning romance art, "}]}],Y=[{name:"Deliberate",desc:"Versatile, high-quality realism and detail."},{name:"Anything Diffusion",desc:"Anime-style specialist."},{name:"ICBINP - I Can't Believe It's Not Photography",desc:"Photorealistic focus; excels in lifelike portraits."},{name:"stable_diffusion",desc:"The classic base model; reliable all-rounder."},{name:"AlbedoBase XL (SDXL)",desc:"SDXL variant; strong for high-res, detailed scenes."},{name:"Nova Anime XL",desc:"Anime and illustration; vibrant, dynamic characters."},{name:"Dreamshaper",desc:"Creative and dreamy outputs; good for artistic concepts."},{name:"Hentai Diffusion",desc:"NSFW/anime erotica specialist."},{name:"CyberRealistic Pony",desc:"Realistic with a cyberpunk twist."},{name:"Flux.1-Schnell fp8 (Compact)",desc:"Newer, fast-generation model for quick results."}];var Q=t(322);let X=null;function Z(){const n=document.getElementById("nig-provider").value;document.querySelectorAll(".nig-provider-settings").forEach(n=>n.style.display="none");const e=document.getElementById(`nig-provider-${n}`);e&&(e.style.display="block")}function nn(n){const e=document.getElementById("nig-sub-style"),t=document.getElementById("nig-main-style-desc"),i=document.getElementById("nig-sub-style-desc"),a=J.find(e=>e.name===n);t.textContent=a?a.description:"",e.innerHTML="",a&&a.subStyles.length>0?(e.disabled=!1,a.subStyles.forEach(n=>{const t=document.createElement("option");t.value=n.value,t.textContent=n.name,e.appendChild(t)}),e.dispatchEvent(new Event("change"))):(e.disabled=!0,i.textContent="")}function en(n){const e=document.getElementById("nig-enhancement-settings");e&&(n?e.classList.remove("disabled"):e.classList.add("disabled"))}function tn(n,e){const t=e.enhancementEnabled,i=e.enhancementApiKey&&e.enhancementApiKey.trim().length>0,a=T(n,e),o=document.getElementById("nig-provider-priority-info"),r=document.getElementById("nig-status-indicator"),s=document.getElementById("nig-status-text"),l=document.getElementById("nig-override-provider");t&&a&&!e.enhancementOverrideProvider?(o.style.display="block",r.className="nig-status-indicator provider-active",s.textContent="Provider Enhancement Active",l&&(l.style.display="inline-block")):(o.style.display="none",t&&i?(r.className="nig-status-indicator external-active",s.textContent="External AI Enhancement Active"):t?(r.className="nig-status-indicator disabled",s.textContent="Enhancement Enabled (No API Key)"):(r.className="nig-status-indicator disabled",s.textContent="Enhancement Disabled"),l&&(l.style.display="none"))}async function an(){const n=await b();document.getElementById("nig-provider").value=n.selectedProvider;const e=document.getElementById("nig-main-style");e.innerHTML="",J.forEach(n=>{const t=document.createElement("option");t.value=n.name,t.textContent=n.name,e.appendChild(t)}),e.value=n.mainPromptStyle,nn(n.mainPromptStyle),document.getElementById("nig-sub-style").value=n.subPromptStyle,document.getElementById("nig-sub-style").dispatchEvent(new Event("change"));const t=document.getElementById("nig-custom-style-enable"),i=document.getElementById("nig-custom-style-text");t.checked=n.customStyleEnabled,i.value=n.customStyleText,i.disabled=!n.customStyleEnabled,document.getElementById("nig-enhancement-enabled").checked=n.enhancementEnabled,document.getElementById("nig-gemini-api-key").value=n.enhancementApiKey,document.getElementById("nig-enhancement-model").value=n.enhancementModel,document.getElementById("nig-enhancement-template").value=n.enhancementTemplate,en(n.enhancementEnabled),tn(n.selectedProvider,n),n.enhancementApiKey.trim().length>0&&(document.getElementById("nig-enhancement-preview").style.display="block"),document.getElementById("nig-enable-neg-prompt").checked=n.enableNegPrompt,document.getElementById("nig-global-neg-prompt").value=n.globalNegPrompt,document.getElementById("nig-pollinations-width").value=n.pollinationsWidth,document.getElementById("nig-pollinations-height").value=n.pollinationsHeight,document.getElementById("nig-pollinations-seed").value=n.pollinationsSeed,document.getElementById("nig-pollinations-enhance").checked=n.pollinationsEnhance,document.getElementById("nig-pollinations-safe").checked=n.pollinationsSafe,document.getElementById("nig-pollinations-nologo").checked=n.pollinationsNologo,document.getElementById("nig-pollinations-private").checked=n.pollinationsPrivate,document.getElementById("nig-pollinations-token").value=n.pollinationsToken,async function(n){const e=document.getElementById("nig-pollinations-model");e.innerHTML="<option>Loading models...</option>";try{const t=await O("pollinations");if(t&&t.length>0)return A("CACHE","Loading Pollinations models from cache"),void rn(e,t,n)}catch(n){M("CACHE","Failed to get cached Pollinations models",{error:n.message})}A("NETWORK","Fetching Pollinations models from API"),GM_xmlhttpRequest({method:"GET",url:"https://image.pollinations.ai/models",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async t=>{try{const i=JSON.parse(t.responseText);await G("pollinations",i),A("NETWORK","Fetched and cached Pollinations models",{count:i.length}),rn(e,i,n)}catch(n){M("NETWORK","Failed to parse Pollinations models",{error:n.message}),e.innerHTML="<option>flux</option>",e.value="flux"}},onerror:n=>{M("NETWORK","Failed to fetch Pollinations models",{error:n}),e.innerHTML="<option>flux</option>",e.value="flux"}})}(n.pollinationsModel),document.getElementById("nig-horde-api-key").value=n.aiHordeApiKey,document.getElementById("nig-horde-sampler").value=n.aiHordeSampler,document.getElementById("nig-horde-steps").value=n.aiHordeSteps,document.getElementById("nig-horde-cfg").value=n.aiHordeCfgScale,document.getElementById("nig-horde-width").value=n.aiHordeWidth,document.getElementById("nig-horde-height").value=n.aiHordeHeight,document.getElementById("nig-horde-seed").value=n.aiHordeSeed,document.querySelectorAll('input[name="nig-horde-post"]').forEach(e=>{e.checked=n.aiHordePostProcessing.includes(e.value)}),async function(n){const e=document.getElementById("nig-horde-model");e.innerHTML="<option>Loading models...</option>";try{const t=await O("aiHorde");if(t&&t.length>0)return A("CACHE","Loading AI Horde models from cache"),void sn(e,t,n)}catch(n){M("CACHE","Failed to get cached AI Horde models",{error:n.message})}A("NETWORK","Fetching AI Horde models from API"),GM_xmlhttpRequest({method:"GET",url:"https://aihorde.net/api/v2/status/models?type=image",onload:async t=>{try{const i=JSON.parse(t.responseText);await G("aiHorde",i),A("NETWORK","Fetched and cached AI Horde models",{count:i.length}),sn(e,i,n)}catch(n){M("NETWORK","Failed to parse AI Horde models",{error:n.message}),e.innerHTML="<option>Stable Diffusion</option>",e.value="Stable Diffusion"}},onerror:n=>{M("NETWORK","Failed to fetch AI Horde models",{error:n}),e.innerHTML="<option>Stable Diffusion</option>",e.value="Stable Diffusion"}})}(n.aiHordeModel),document.getElementById("nig-google-api-key").value=n.googleApiKey,document.getElementById("nig-model").value=n.model,document.getElementById("nig-num-images").value=n.numberOfImages,document.getElementById("nig-image-size").value=n.imageSize,document.getElementById("nig-aspect-ratio").value=n.aspectRatio,document.getElementById("nig-person-gen").value=n.personGeneration,await dn(),n.openAICompatModelManualInput?(document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"):(document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none"),Z()}async function on(){await w("mainPromptStyle",document.getElementById("nig-main-style").value),await w("subPromptStyle",document.getElementById("nig-sub-style").value),await w("customStyleEnabled",document.getElementById("nig-custom-style-enable").checked),await w("customStyleText",document.getElementById("nig-custom-style-text").value.trim()),await w("enhancementEnabled",document.getElementById("nig-enhancement-enabled").checked),await w("enhancementApiKey",document.getElementById("nig-gemini-api-key").value.trim()),await w("enhancementModel",document.getElementById("nig-enhancement-model").value),await w("enhancementTemplate",document.getElementById("nig-enhancement-template").value.trim()),await w("enableNegPrompt",document.getElementById("nig-enable-neg-prompt").checked),await w("globalNegPrompt",document.getElementById("nig-global-neg-prompt").value.trim()),await w("selectedProvider",document.getElementById("nig-provider").value),await w("pollinationsModel",document.getElementById("nig-pollinations-model").value),await w("pollinationsWidth",document.getElementById("nig-pollinations-width").value),await w("pollinationsHeight",document.getElementById("nig-pollinations-height").value),await w("pollinationsSeed",document.getElementById("nig-pollinations-seed").value.trim()),await w("pollinationsEnhance",document.getElementById("nig-pollinations-enhance").checked),await w("pollinationsSafe",document.getElementById("nig-pollinations-safe").checked),await w("pollinationsNologo",document.getElementById("nig-pollinations-nologo").checked),await w("pollinationsPrivate",document.getElementById("nig-pollinations-private").checked),await w("pollinationsToken",document.getElementById("nig-pollinations-token").value.trim()),await w("aiHordeApiKey",document.getElementById("nig-horde-api-key").value.trim()||"0000000000"),await w("aiHordeModel",document.getElementById("nig-horde-model").value),await w("aiHordeSampler",document.getElementById("nig-horde-sampler").value),await w("aiHordeSteps",document.getElementById("nig-horde-steps").value),await w("aiHordeCfgScale",document.getElementById("nig-horde-cfg").value),await w("aiHordeWidth",document.getElementById("nig-horde-width").value),await w("aiHordeHeight",document.getElementById("nig-horde-height").value),await w("aiHordeSeed",document.getElementById("nig-horde-seed").value.trim());const n=Array.from(document.querySelectorAll('input[name="nig-horde-post"]:checked')).map(n=>n.value);await w("aiHordePostProcessing",n),await w("googleApiKey",document.getElementById("nig-google-api-key").value.trim()),await w("model",document.getElementById("nig-model").value),await w("numberOfImages",document.getElementById("nig-num-images").value),await w("imageSize",document.getElementById("nig-image-size").value),await w("aspectRatio",document.getElementById("nig-aspect-ratio").value),await w("personGeneration",document.getElementById("nig-person-gen").value);const e=document.getElementById("nig-openai-compat-base-url").value.trim();if(e){const n=await f("openAICompatProfiles"),t="none"!==document.getElementById("nig-openai-model-container-manual").style.display,i=t?document.getElementById("nig-openai-compat-model-manual").value.trim():document.getElementById("nig-openai-compat-model").value;n[e]={apiKey:document.getElementById("nig-openai-compat-api-key").value.trim(),model:i},await w("openAICompatProfiles",n),await w("openAICompatActiveProfileUrl",e),await w("openAICompatModelManualInput",t)}alert("Configuration saved!")}function rn(n,e,t){n.innerHTML="",e.forEach(e=>{const t=document.createElement("option");t.value=e;let i=e;"gptimage"===e?i+=" (Recommended: Quality)":"flux"===e&&(i+=" (Default: Speed)"),t.textContent=i,n.appendChild(t)}),e.includes(t)?n.value=t:n.value="flux"}function sn(n,e,t){n.innerHTML="";const i=new Map(e.map(n=>[n.name,n])),a=new Set(Y.map(n=>n.name)),o=document.createElement("optgroup");o.label="Top 10 Popular Models";const r=document.createElement("optgroup");r.label="Other Models",Y.forEach(n=>{if(i.has(n.name)){const e=i.get(n.name),t=document.createElement("option");t.value=n.name,t.textContent=`${n.name} - ${n.desc} (${e.count} workers)`,o.appendChild(t)}}),e.filter(n=>!a.has(n.name)).sort((n,e)=>e.count-n.count).forEach(n=>{const e=document.createElement("option");e.value=n.name,e.textContent=`${n.name} (${n.count} workers)`,r.appendChild(e)}),n.appendChild(o),n.appendChild(r),Array.from(n.options).some(n=>n.value===t)?n.value=t:n.value=e[0]?.name||"Stable Diffusion"}function ln(n){return"boolean"==typeof n.is_free?n.is_free:"boolean"==typeof n.premium_model?!n.premium_model:!(!Array.isArray(n.tiers)||!n.tiers.includes("Free"))}function cn(n,e,t){n.innerHTML="";const i=document.createElement("optgroup");i.label="Free Models";const a=document.createElement("optgroup");a.label="Paid Models",e.forEach(n=>{const e=document.createElement("option");e.value=n.id,e.textContent=n.id,ln(n)?i.appendChild(e):a.appendChild(e)}),i.childElementCount>0&&n.appendChild(i),a.childElementCount>0&&n.appendChild(a),e.some(n=>n.id===t)&&(n.value=t)}async function dn(){const n=document.getElementById("nig-openai-compat-profile-select"),e=await b(),t=e.openAICompatProfiles||{},i=e.openAICompatActiveProfileUrl;n.innerHTML="",Object.keys(t).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)});const a=document.createElement("option");a.value="__new__",a.textContent="— Add or Edit Profile —",n.appendChild(a),i&&t[i]?n.value=i:n.value="__new__",gn()}async function gn(){const n=document.getElementById("nig-openai-compat-profile-select"),e=await b(),t=e.openAICompatProfiles||{},i=n.value;if(i&&t[i]){const n=t[i];document.getElementById("nig-openai-compat-base-url").value=i,document.getElementById("nig-openai-compat-api-key").value=n.apiKey,e.openAICompatModelManualInput?document.getElementById("nig-openai-compat-model-manual").value=n.model:(document.getElementById("nig-openai-compat-model").value=n.model,async function(n,e){const t=document.getElementById("nig-openai-compat-model"),i=await async function(n){try{const e=`openAICompatModels_${n}`,t=await GM_getValue(e,"[]");return"string"==typeof t&&t.trim()?JSON.parse(t):Array.isArray(t)?t:[]}catch(e){return I("error","CACHE","Failed to parse OpenAI compatible models cache",{profileUrl:n,error:e.message}),[]}}(n);i&&i.length>0?cn(t,i,e):t.innerHTML="<option>No cached models. Click Fetch to get models.</option>"}(i,n.model))}else document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>"}async function pn(){const n=document.getElementById("nig-openai-compat-profile-select").value;if("__new__"!==n){if(confirm(`Delete profile for "${n}"?`)){const e=(await b()).openAICompatProfiles||{};delete e[n],await w("openAICompatProfiles",e),document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>",document.getElementById("nig-openai-compat-model-manual").value="",await dn()}}else alert("You can't delete the 'Add New' option.")}async function mn(){const n=await b(),e=JSON.stringify(n,null,2),t=`wtr-lab-image-generator-config-${(new Date).toISOString().split("T")[0]}.json`;Q.P(t,e,"application/json")}async function un(n){const e=n.target.files[0];if(e){try{const n=await e.text(),t=JSON.parse(n);confirm("This will overwrite all current settings. Continue?")&&(Object.keys(t).forEach(n=>{w(n,t[n])}),alert("Configuration imported successfully!"),await an())}catch(n){alert(`Failed to import configuration: ${n.message}`)}n.target.value=""}}async function vn(){const n=document.getElementById("nig-history-list"),e=await x();n.innerHTML="",0!==e.length?e.forEach(e=>{const i=document.createElement("li");i.className="nig-history-item";const a=e.provider?`<strong>${e.provider}</strong>`:"",o=e.model?`(${e.model})`:"";i.innerHTML=`<small>${new Date(e.date).toLocaleString()} - ${a} ${o}</small>\n                      <small><em>${e.prompt.substring(0,70)}...</em></small>`;const r=document.createElement("a");r.href="#",r.textContent="View Generated Image",r.addEventListener("click",n=>{n.preventDefault(),e.url&&e.url.startsWith("data:image")?Promise.resolve().then(t.bind(t,642)).then(n=>{"function"==typeof n.showImageViewer&&n.showImageViewer([e.url],e.prompt,e.provider)}):window.open(e.url,"_blank")}),i.appendChild(r),n.appendChild(i)}):n.innerHTML="<li>No history yet.</li>"}async function hn(){const n=parseInt(document.getElementById("nig-history-clean-days").value),e=new Date;e.setDate(e.getDate()-n);const t=await x(),i=t.filter(n=>new Date(n.date)>e);confirm(`Delete ${t.length-i.length} entries older than ${n} days?`)&&(await w("generationHistory",i),await vn(),alert("History cleaned successfully!"))}function yn(){if(X)return;X=document.createElement("div"),X.id="nig-config-panel",X.className="nig-modal-overlay",X.style.display="none",X.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Image Generator Configuration</h2>\n            <div class="nig-tabs">\n                <div class="nig-tab active" data-tab="config">Configuration</div>\n                <div class="nig-tab" data-tab="styling">Prompt Styling</div>\n                <div class="nig-tab" data-tab="history">History</div>\n                <div class="nig-tab" data-tab="utilities">Utilities</div>\n            </div>\n            <div id="nig-config-tab" class="nig-tab-content active">\n                <div class="nig-config-grid">\n                    <div class="nig-config-section">\n                        <div class="nig-form-group">\n                            <label for="nig-provider">Image Provider</label>\n                            <select id="nig-provider">\n                                <option value="Pollinations">🌱 Pollinations.ai (Free, Simple)</option>\n                                <option value="AIHorde">🤖 AI Horde (Free, Advanced)</option>\n                                <option value="OpenAICompat">🔌 OpenAI Compatible (Custom)</option>\n                                <option value="Google">🖼️ Google Imagen (Requires Billed Account)</option>\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class="nig-provider-container">\n                        <div id="nig-provider-Pollinations" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>🌱 Pollinations.ai Settings</h3>\n                                <p>Fast, simple image generation with advanced model options</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-model">Model</label>\n                                <select id="nig-pollinations-model">\n                                    <option>Loading models...</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group-inline">\n                                <div>\n                                    <label for="nig-pollinations-width">Width</label>\n                                    <input type="number" id="nig-pollinations-width" min="64" max="2048" step="64">\n                                </div>\n                                <div>\n                                    <label for="nig-pollinations-height">Height</label>\n                                    <input type="number" id="nig-pollinations-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-seed">Seed (optional)</label>\n                                <input type="text" id="nig-pollinations-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Options</label>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-pollinations-enhance">Enhance Prompt</label>\n                                    <label><input type="checkbox" id="nig-pollinations-safe">Safe Mode (NSFW Filter)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-nologo">No Logo (Registered Users)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-private">Private (Won\'t appear in feed)</label>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-token">API Token (Optional)</label>\n                                <input type="password" id="nig-pollinations-token" placeholder="Enter token for premium models">\n                                <small class="nig-hint">Get a token from <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> for higher rate limits and access to restricted models.</small>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-AIHorde" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>🤖 AI Horde Settings</h3>\n                                <p>Community-powered generation with extensive customization</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-api-key">AI Horde API Key</label>\n                                <input type="password" id="nig-horde-api-key" placeholder="Defaults to \'0000000000\'">\n                                <small>Use anonymous key or get your own from <a href="https://aihorde.net/" target="_blank" class="nig-api-prompt-link">AI Horde</a> for higher priority.</small>\n                            </div>\n                            <div class="nig-provider-controls">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-model">Model</label>\n                                    <select id="nig-horde-model">\n                                        <option>Loading models...</option>\n                                    </select>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-sampler">Sampler</label>\n                                    <select id="nig-horde-sampler">\n                                        <option value="k_dpmpp_2m">DPM++ 2M</option>\n                                        <option value="k_euler_a">Euler A</option>\n                                        <option value="k_euler">Euler</option>\n                                        <option value="k_lms">LMS</option>\n                                        <option value="k_heun">Heun</option>\n                                        <option value="k_dpm_2">DPM 2</option>\n                                        <option value="k_dpm_2_a">DPM 2 A</option>\n                                        <option value="k_dpmpp_2s_a">DPM++ 2S A</option>\n                                        <option value="k_dpmpp_sde">DPM++ SDE</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-steps">Steps</label>\n                                    <input type="number" id="nig-horde-steps" min="10" max="50" step="1">\n                                    <small class="nig-hint">More steps = more detail, but slower.</small>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-cfg">CFG Scale</label>\n                                    <input type="number" id="nig-horde-cfg" min="1" max="20" step="0.5">\n                                    <small class="nig-hint">How strictly to follow the prompt.</small>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-width">Width</label>\n                                    <input type="number" id="nig-horde-width" min="64" max="2048" step="64">\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-height">Height</label>\n                                    <input type="number" id="nig-horde-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-seed">Seed (optional)</label>\n                                <input type="text" id="nig-horde-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Post-Processing</label>\n                                <small class="nig-hint">Improves faces. Use only if generating people.</small>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" name="nig-horde-post" value="GFPGAN">GFPGAN</label>\n                                    <label><input type="checkbox" name="nig-horde-post" value="CodeFormers">CodeFormers</label>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-Google" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>🖼️ Google Imagen Settings</h3>\n                                <p>High-quality generation powered by Google\'s advanced AI</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-google-api-key">Gemini API Key</label>\n                                <input type="password" id="nig-google-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-model">Imagen Model</label>\n                                <select id="nig-model">\n                                    <option value="imagen-4.0-generate-001">Imagen 4.0 Standard</option>\n                                    <option value="imagen-4.0-ultra-generate-001">Imagen 4.0 Ultra</option>\n                                    <option value="imagen-4.0-fast-generate-001">Imagen 4.0 Fast</option>\n                                    <option value="imagen-3.0-generate-002">Imagen 3.0 Standard</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-num-images">Number of Images (1-4)</label>\n                                <input type="number" id="nig-num-images" min="1" max="4" step="1">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-image-size">Image Size</label>\n                                <select id="nig-image-size">\n                                    <option value="1024">1K</option>\n                                    <option value="2048">2K</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-aspect-ratio">Aspect Ratio</label>\n                                <select id="nig-aspect-ratio">\n                                    <option value="1:1">1:1</option>\n                                    <option value="3:4">3:4</option>\n                                    <option value="4:3">4:3</option>\n                                    <option value="9:16">9:16</option>\n                                    <option value="16:9">16:9</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-person-gen">Person Generation</label>\n                                <select id="nig-person-gen">\n                                    <option value="dont_allow">Don\'t Allow</option>\n                                    <option value="allow_adult">Allow Adults</option>\n                                    <option value="allow_all">Allow All</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-OpenAICompat" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>🔌 OpenAI Compatible Settings</h3>\n                                <p>Connect to any OpenAI-compatible API endpoint</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-profile-select">Saved Profiles</label>\n                                <div class="nig-form-group-inline">\n                                    <select id="nig-openai-compat-profile-select"></select>\n                                    <button id="nig-openai-compat-delete-profile" class="nig-delete-btn">Delete</button>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-base-url">Base URL</label>\n                                <input type="text" id="nig-openai-compat-base-url" placeholder="e.g., https://api.example.com/v1">\n                                <small class="nig-hint">For a list of free public providers, check out the <a href="https://github.com/zukixa/cool-ai-stuff" target="_blank" class="nig-api-prompt-link">cool-ai-stuff</a> repository.</small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-api-key">API Key</label>\n                                <input type="password" id="nig-openai-compat-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-model">Model</label>\n                                <div id="nig-openai-model-container-select">\n                                    <div class="nig-form-group-inline">\n                                        <select id="nig-openai-compat-model" style="width: 100%;">\n                                            <option>Enter URL/Key and fetch...</option>\n                                        </select>\n                                        <button id="nig-openai-compat-fetch-models" class="nig-fetch-models-btn">Fetch</button>\n                                    </div>\n                                    <small class=" nig-hint">If fetching fails or your model isn\'t listed, <a href="#" id="nig-openai-compat-switch-to-manual" class="nig-api-prompt-link">switch to manual input</a>.</small>\n                                </div>\n                                <div id="nig-openai-model-container-manual" style="display: none;">\n                                    <input type="text" id="nig-openai-compat-model-manual" placeholder="e.g., dall-e-3">\n                                    <small class=" nig-hint">Manually enter the model name. <a href="#" id="nig-openai-compat-switch-to-select" class="nig-api-prompt-link">Switch back to fetched list</a>.</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-styling-tab" class="nig-tab-content">\n                <div class="nig-styling-container">\n                    <div class="nig-styling-intro">\n                        <p>Select a style to automatically add it to the beginning of every prompt. This helps maintain a consistent look across all providers.</p>\n                    </div>\n\n                    <div class="nig-style-grid">\n                        <div class="nig-style-section">\n                            <div class="nig-form-group">\n                                <label for="nig-main-style">Main Style</label>\n                                <select id="nig-main-style"></select>\n                                <small id="nig-main-style-desc" class="nig-hint"></small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-sub-style">Sub-Style</label>\n                                <select id="nig-sub-style"></select>\n                                <small id="nig-sub-style-desc" class="nig-hint"></small>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>\n                                    <span class="material-symbols-outlined">auto_awesome</span>\n                                    AI Prompt Enhancement\n                                    <span class="nig-enhancement-status" id="nig-enhancement-status">\n                                        <span class="nig-status-indicator" id="nig-status-indicator"></span>\n                                        <span id="nig-status-text">Enhancement Disabled</span>\n                                    </span>\n                                </h4>\n                            </div>\n\n                            <div class="nig-enhancement-content">\n                                <div class="nig-form-group">\n                                    <div class="nig-checkbox-group">\n                                        <label><input type="checkbox" id="nig-enhancement-enabled">Enable AI Prompt Enhancement</label>\n                                    </div>\n                                    <small class="nig-hint">Uses AI to automatically enhance prompts for better results. Provider enhancement takes priority when available.</small>\n                                </div>\n\n                                <div class="nig-provider-priority-info" id="nig-provider-priority-info" style="display: none;">\n                                    <div class="nig-priority-header">\n                                        <span class="material-symbols-outlined">priority_high</span>\n                                        Provider Enhancement Active\n                                    </div>\n                                    <p id="nig-priority-message">Pollinations AI enhancement is enabled and will be used instead of external AI enhancement.</p>\n                                    <button class="nig-override-btn" id="nig-override-provider">Force Use External AI</button>\n                                </div>\n\n                                <div class="nig-enhancement-settings disabled" id="nig-enhancement-settings">\n                                    <div class="nig-form-group">\n                                        <label for="nig-gemini-api-key">Gemini API Key</label>\n                                        <input type="password" id="nig-gemini-api-key" placeholder="Enter your Google Gemini API key">\n                                        <small class="nig-hint">Get a free API key from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a></small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-model">Enhancement Model</label>\n                                        <select id="nig-enhancement-model">\n                                            <option value="models/gemini-2.5-pro">Gemini 2.5 Pro (High Quality)</option>\n                                            <option value="models/gemini-flash-latest">Gemini Flash Latest (Fast)</option>\n                                            <option value="models/gemini-flash-lite-latest">Gemini Flash Lite (Ultra Fast)</option>\n                                            <option value="models/gemini-2.5-flash">Gemini 2.5 Flash (Balanced)</option>\n                                            <option value="models/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Efficient)</option>\n                                        </select>\n                                        <small class="nig-hint">Choose model based on your needs: quality vs speed</small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-template">Custom Enhancement Template</label>\n                                        <textarea id="nig-enhancement-template" rows="3" placeholder="Enter custom enhancement instructions..."></textarea>\n                                        <div class="nig-form-group-inline">\n                                            <button class="nig-template-btn" id="nig-template-default">Reset to Default</button>\n                                            <button class="nig-template-btn" id="nig-template-example">Load Example</button>\n                                        </div>\n                                        <small class="nig-hint">Customize how the AI enhances prompts. Leave empty for intelligent enhancement.</small>\n                                    </div>\n\n                                    <div class="nig-enhancement-preview" id="nig-enhancement-preview" style="display: none;">\n                                        <div class="nig-preview-container">\n                                            <div class="nig-preview-section">\n                                                <h5>Original Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-original-prompt"></div>\n                                            </div>\n                                            <div class="nig-preview-arrow">\n                                                <span class="material-symbols-outlined">arrow_forward</span>\n                                            </div>\n                                            <div class="nig-preview-section">\n                                                <h5>Enhanced Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-enhanced-prompt"></div>\n                                            </div>\n                                        </div>\n                                        <button class="nig-test-enhancement-btn" id="nig-test-enhancement">\n                                            <span class="material-symbols-outlined">auto_awesome</span>\n                                            Test Enhancement\n                                        </button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Custom Style</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-custom-style-enable">Enable Custom Style</label>\n                                </div>\n                                <small class="nig-hint">Overrides the Main/Sub-style dropdowns with your own text.</small>\n                                <textarea id="nig-custom-style-text" placeholder="e.g., In the style of Van Gogh, oil painting, ..."></textarea>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Negative Prompting (Global)</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-enable-neg-prompt">Enable Negative Prompting</label>\n                                </div>\n                                <small class="nig-hint">This negative prompt will be applied to all providers when enabled.</small>\n                                <textarea id="nig-global-neg-prompt" placeholder="e.g., ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality"></textarea>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-history-tab" class="nig-tab-content">\n                <div class="nig-history-container">\n                    <div class="nig-history-cleanup">\n                        <div class="nig-cleanup-info">\n                            <h4>History Management</h4>\n                            <p>Clean up old history entries to free up space and improve performance.</p>\n                        </div>\n                        <div class="nig-cleanup-controls">\n                            <label>Delete history older than</label>\n                            <input type="number" id="nig-history-clean-days" min="1" max="365" value="30">\n                            <label>days</label>\n                            <button id="nig-history-clean-btn" class="nig-history-cleanup-btn">\n                                <span class="material-symbols-outlined">cleaning_services</span>\n                                Clean\n                            </button>\n                        </div>\n                    </div>\n                    <ul id="nig-history-list" class="nig-history-list"></ul>\n                </div>\n            </div>\n\n            <div id="nig-utilities-tab" class="nig-tab-content">\n                <div class="nig-utilities-grid">\n                    <div class="nig-utility-card">\n                        <h4>Import/Export Settings</h4>\n                        <p>Backup and restore your configuration settings for seamless setup across different sessions or devices.</p>\n                        <div class="nig-form-group">\n                            <button id="nig-export-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-primary);">\n                                <span class="material-symbols-outlined">download</span>\n                                Download Configuration\n                            </button>\n                            <small class="nig-hint">Downloads the current configuration as a JSON file.</small>\n                        </div>\n                        <div class="nig-form-group">\n                            <label for="nig-import-file">Import Configuration</label>\n                            <input type="file" id="nig-import-file" accept=".json" style="border: 2px dashed var(--nig-color-border); background: var(--nig-color-bg-primary);">\n                            <small class=" nig-hint">Uploading a JSON file will overwrite all current settings.</small>\n                        </div>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <h4>Cache Management</h4>\n                        <p>Clear cached model lists and force fresh data fetching for accurate, up-to-date information.</p>\n                        <button id="nig-clear-cache-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-error);">\n                            <span class="material-symbols-outlined">clear_all</span>\n                            Clear Cached Models\n                        </button>\n                        <small class="nig-hint">Removes all cached model lists forcing a fresh fetch.</small>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <div class="nig-card-header">\n                            <div class="nig-card-title">\n                                <h4>Debug Console & Logs</h4>\n                                <p>Enable detailed console logging and view enhancement operation logs to troubleshoot issues and monitor system behavior during development.</p>\n                            </div>\n                        </div>\n\n                        <div class="nig-card-actions">\n                            <button id="nig-toggle-logging-btn" class="nig-btn-primary">\n                                <span class="material-symbols-outlined">bug_report</span>\n                                Toggle Console Logging & Enhancement Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-secondary-actions">\n                            <button id="nig-view-enhancement-logs-btn" class="nig-btn-secondary">\n                                <span class="material-symbols-outlined">list</span>\n                                View Enhancement Logs\n                            </button>\n                            <button id="nig-clear-enhancement-logs-btn" class="nig-btn-secondary nig-btn-error">\n                                <span class="material-symbols-outlined">clear_all</span>\n                                Clear Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-footer">\n                            <small class="nig-hint">Toggles detailed console logging and provides access to enhancement operation logs.</small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class="nig-button-footer">\n                <button id="nig-save-btn" class="nig-save-btn">Save Configuration</button>\n            </div>\n        </div>\n    ',document.body.appendChild(X),X.querySelector(".nig-close-btn").addEventListener("click",()=>X.style.display="none"),X.querySelector("#nig-save-btn").addEventListener("click",on),X.querySelectorAll(".nig-tab").forEach(n=>{n.addEventListener("click",async()=>{X.querySelectorAll(".nig-tab, .nig-tab-content").forEach(n=>n.classList.remove("active")),n.classList.add("active"),X.querySelector(`#nig-${n.dataset.tab}-tab`).classList.add("active"),"history"===n.dataset.tab?(await vn(),X.querySelector("#nig-save-btn").style.display="none"):X.querySelector("#nig-save-btn").style.display="block"})}),X.querySelector("#nig-provider").addEventListener("change",Z),X.querySelector("#nig-openai-compat-fetch-models").addEventListener("click",()=>async function(n){const e=document.getElementById("nig-openai-compat-base-url").value.trim(),t=document.getElementById("nig-openai-compat-api-key").value.trim();if(!e)return void alert("Please enter a Base URL first.");const i=document.getElementById("nig-openai-compat-model");i.innerHTML="<option>Fetching models...</option>",A("NETWORK",`Fetching OpenAI compatible models from ${e}`),GM_xmlhttpRequest({method:"GET",url:`${e}/models`,headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},onload:async t=>{try{const a=JSON.parse(t.responseText);if(!a.data||!Array.isArray(a.data))throw new Error("Invalid model list format received.");let o=[];if(o=a.data.some(n=>n.endpoint||n.endpoints)?a.data.filter(n=>"/v1/images/generations"===n.endpoint||n.endpoints?.includes("/v1/images/generations")):a.data.some(n=>"images.generations"===n.type)?a.data.filter(n=>"images.generations"===n.type):a.data.filter(n=>{const e=n.id.toLowerCase();return e.includes("dall-e")||e.includes("dalle")||e.includes("image")||e.includes("midjourney")||e.includes("stable diffusion")||e.includes("flux")||e.includes("imagen")}),o.sort((n,e)=>{const t=ln(n),i=ln(e);return t&&!i?-1:!t&&i?1:n.id.localeCompare(e.id)}),0===o.length)throw new Error("No image generation models found. This provider may not support image generation.");cn(i,o,n),await async function(n,e){try{const t=`openAICompatModels_${n}`;await GM_setValue(t,JSON.stringify(e)),I("info","CACHE",`Cached models for OpenAI compatible provider: ${n}`)}catch(e){I("error","CACHE","Failed to cache OpenAI compatible models",{profileUrl:n,error:e.message})}}(e,o),A("NETWORK",`Successfully fetched and cached ${o.length} models for ${e}`)}catch(n){M("NETWORK","Failed to parse OpenAI compatible models",{error:n.message}),i.innerHTML="<option>Failed to fetch models</option>",alert(`Failed to fetch models. Check the Base URL and API Key. You can enter the model name manually. Error: ${n.message}`),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}},onerror:n=>{M("NETWORK","Failed to fetch OpenAI compatible models",{error:n}),i.innerHTML="<option>Failed to fetch models</option>",alert("Failed to fetch models. Check your network connection and the Base URL. Switching to manual input."),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}})}()),X.querySelector("#nig-openai-compat-profile-select").addEventListener("change",gn),X.querySelector("#nig-openai-compat-delete-profile").addEventListener("click",pn),X.querySelector("#nig-openai-compat-switch-to-manual").addEventListener("click",n=>{n.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}),X.querySelector("#nig-openai-compat-switch-to-select").addEventListener("click",n=>{n.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none"}),X.querySelector("#nig-export-btn").addEventListener("click",mn),X.querySelector("#nig-import-file").addEventListener("change",un),X.querySelector("#nig-history-clean-btn").addEventListener("click",hn),X.querySelector("#nig-clear-cache-btn").addEventListener("click",()=>F()),X.querySelector("#nig-toggle-logging-btn").addEventListener("click",async()=>{const n=!await f("loggingEnabled");await w("loggingEnabled",n),await S(),await N(),alert(`Debug Console & Enhancement Logs are now ${n?"ENABLED":"DISABLED"}.`)}),X.querySelector("#nig-view-enhancement-logs-btn").addEventListener("click",async()=>{const n=await L();if(0===n.length)return void alert("No enhancement logs found. Enhancement logging is disabled or no enhancement operations have been performed yet.");const e=document.createElement("div");e.className="nig-modal-overlay",e.innerHTML='\n            <div class="nig-modal-content">\n                <span class="nig-close-btn">&times;</span>\n                <h2>Enhancement Operation Logs</h2>\n                <p>Detailed logs of prompt enhancement operations with timestamps and performance data.</p>\n                <div style="max-height: 400px; overflow-y: auto; background: var(--nig-color-bg-tertiary); border-radius: var(--nig-radius-md); padding: var(--nig-space-lg); margin: var(--nig-space-lg) 0;">\n                    <div id="nig-enhancement-logs-display"></div>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=e.querySelector("#nig-enhancement-logs-display");n.slice(0,50).forEach(n=>{const e=document.createElement("div");e.style.cssText="padding: var(--nig-space-sm) 0; border-bottom: 1px solid var(--nig-color-border); font-family: monospace; font-size: var(--nig-font-size-xs);",e.innerHTML=`<div>[${n.level}] ${n.time} [${n.category}] ${n.message}</div>`,t.appendChild(e)}),e.querySelector(".nig-close-btn").addEventListener("click",()=>e.remove())}),X.querySelector("#nig-clear-enhancement-logs-btn").addEventListener("click",async()=>{const n=await L();0!==n.length?confirm(`Are you sure you want to clear all ${n.length} enhancement logs? This action cannot be undone.`)&&(k=[],GM_setValue("enhancementLogHistory","[]"),A("LOG","Enhancement logs cleared by user"),alert("All enhancement logs have been cleared.")):alert("No enhancement logs to clear.")}),X.querySelector("#nig-main-style").addEventListener("change",n=>nn(n.target.value)),X.querySelector("#nig-sub-style").addEventListener("change",()=>{const n=X.querySelector("#nig-sub-style").value,e=document.getElementById("nig-sub-style-desc"),t=J.find(n=>n.name===X.querySelector("#nig-main-style").value),i=t?t.subStyles.find(e=>e.value===n):null;e.textContent=i?i.description:""});const n=X.querySelector("#nig-custom-style-enable"),e=X.querySelector("#nig-custom-style-text");n.addEventListener("change",()=>{e.disabled=!n.checked});const t=X.querySelector("#nig-enhancement-enabled"),i=(X.querySelector("#nig-enhancement-settings"),X.querySelector("#nig-override-provider")),a=X.querySelector("#nig-template-default"),o=X.querySelector("#nig-template-example"),r=X.querySelector("#nig-test-enhancement"),s=X.querySelector("#nig-gemini-api-key");t.addEventListener("change",async n=>{const e=n.target.checked,t=await b();t.enhancementEnabled=e,await w("enhancementEnabled",e),en(e),tn(document.getElementById("nig-provider").value,t)}),i.addEventListener("click",async()=>{const n=document.getElementById("nig-provider").value;await w("enhancementOverrideProvider",!0),tn(n,await b())}),a.addEventListener("click",async()=>{const n='Convert this text into a focused visual description for image generation. Extract key visual elements (characters, setting, mood, style) and describe them as a direct prompt without narrative elements, dialogue, or markdown formatting. Keep it concise and focused on what can be visually rendered. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:';X.querySelector("#nig-enhancement-template").value=n,await w("enhancementTemplate",n)}),o.addEventListener("click",async()=>{const n='Extract visual elements from this text and craft a concise image generation prompt as a flowing paragraph. Focus on: characters and their appearances/actions/expressions, setting and environment, lighting/mood/color palette, artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, specific descriptors separated by commas or short phrases for clarity. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:';X.querySelector("#nig-enhancement-template").value=n,await w("enhancementTemplate",n)}),s.addEventListener("input",async n=>{const e=n.target.value.trim().length>0;X.querySelector("#nig-enhancement-preview").style.display=e?"block":"none"}),r.addEventListener("click",async()=>{const n=await b();r.disabled=!0;const e=r.innerHTML;r.innerHTML='<span class="material-symbols-outlined">hourglass_empty</span>Testing...';try{const e=await async function(n,e){try{return{original:n,enhanced:await B(n,e)}}catch(n){throw new Error(`Enhancement failed: ${n.message}`)}}("A mystical warrior standing on a cliff overlooking a magical forest with glowing mushrooms and ethereal mist",n);document.getElementById("nig-original-prompt").textContent=e.original,document.getElementById("nig-enhanced-prompt").textContent=e.enhanced}catch(n){alert(`Enhancement test failed: ${n.message}`)}finally{r.disabled=!1,r.innerHTML=e}}),X.querySelector("#nig-provider").addEventListener("change",async n=>{tn(n.target.value,await b())})}async function fn(){X||yn(),X.querySelectorAll(".nig-tab, .nig-tab-content").forEach(n=>n.classList.remove("active")),X.querySelector('.nig-tab[data-tab="config"]').classList.add("active"),X.querySelector("#nig-config-tab").classList.add("active"),X.querySelector("#nig-save-btn").style.display="block",await an(),X.style.display="flex"}!function(){let n,e=[],t=[],i=[],a=!1,o="",r=!1,s="";function l(n,e,i,o,r=null){A("GENERATION","Generation completed successfully",{provider:i,model:o,promptLength:e.length,promptPreview:e.substring(0,100)+(e.length>100?"...":""),imagesGenerated:n.length,hasPersistentUrls:!!r}),t.push({imageUrls:n,prompt:e,provider:i}),(r||n).forEach(n=>async function(n){const e=await x();e.unshift(n),e.length>100&&e.pop(),await GM_setValue("history",JSON.stringify(e))}({date:(new Date).toISOString(),prompt:e,url:n,provider:i,model:o})),a=!1,m(),u()}function c(n,t="Unknown",o,r=null){M("GENERATION","Generation Failed",{prompt:t,provider:o,errorMessage:n});const s=function(n,e=null,t=null){let i=String(n);const a=i.toLowerCase();if(a.includes("error code: 524")||a.includes("timed out")||a.includes("502 bad gateway")||a.includes("unable to reach the origin service"))return{message:"The generation service is temporarily unavailable or busy (e.g., 502 Bad Gateway). This is usually a temporary issue. Please try again in a few minutes.",retryable:!0};if("OpenAICompat"===e&&t?.includes("api.mnnai.ru"))try{if("Sorry, there's been some kind of mistake, please use a different model"===JSON.parse(i.substring(i.indexOf("{"))).error)return{message:"Temporary service error detected. The same prompt typically works on retry. This error will be automatically retried.",retryable:!0}}catch(n){}if(a.includes("unsafe content")||a.includes("safety system")||a.includes("moderation_blocked"))return{message:"The prompt was rejected by the safety system for containing potentially unsafe content.",retryable:!1};try{const n=JSON.parse(i.substring(i.indexOf("{"))),e=n.message||(n.error?n.error.message:null)||JSON.stringify(n);return{message:"object"==typeof e?JSON.stringify(e):e,retryable:!1}}catch(n){return{message:i||"An unknown error occurred.",retryable:!1}}}(n,o,r);i.push({reason:s,prompt:t,provider:o,providerProfileUrl:r}),d(),q.y("error","Generation Failed."),a=!1,m(),A("GENERATION","Generation failed - waiting for user action",{errorQueueLength:i.length,generationQueueLength:e.length,willWaitForUser:!0})}function d(){if(r||0===i.length)return;const n=i.shift();r=!0,async function(n){D||K(),document.getElementById("nig-error-reason").textContent=n.reason.message;const e=document.getElementById("nig-error-prompt");e.value=n.prompt;const t=document.getElementById("nig-retry-provider-select");t.innerHTML="";const i=await b();["Pollinations","AIHorde","Google"].forEach(n=>{const e=document.createElement("option");e.value=n,e.textContent=n,t.appendChild(e)}),Object.keys(i.openAICompatProfiles).forEach(n=>{const e=document.createElement("option");e.value=`OpenAICompat::${n}`,e.textContent=`OpenAI: ${n.replace("https://","").split("/")[0]}`,t.appendChild(e)});let a=n.provider;"OpenAICompat"===n.provider&&n.providerProfileUrl&&(a=`OpenAICompat::${n.providerProfileUrl}`),Array.from(t.options).some(n=>n.value===a)&&(t.value=a);const o=document.getElementById("nig-error-actions");o.innerHTML="";const r=document.createElement("button");if(r.textContent="Retry Generation",r.className="nig-retry-btn",r.onclick=()=>{const n=e.value.trim();if(!n)return void alert("Prompt cannot be empty.");const i=t.value;let a,o;i.startsWith("OpenAICompat::")?(a="OpenAICompat",o=i.split("::")[1]):(a=i,o=null),U(n,a,o),W()},n.reason.retryable)o.appendChild(r);else{const n=()=>{o.contains(r)||o.appendChild(r)};e.oninput=n,t.onchange=n}D.style.display="flex"}(n),A("ERROR","Showing error modal to user",{errorReason:n.reason.message,provider:n.provider,remainingErrorQueue:i.length})}function g(){A("ERROR","Error modal dismissed by user",{errorQueueLength:i.length,generationQueueLength:e.length,isGenerating:a}),r=!1,m(),e.length>0&&!a?(A("ERROR","Resuming queue processing after error modal dismissal"),u()):A("ERROR","No more items to process, queue paused")}function p(n,t,i=null){const o={prompt:n,provider:t,providerProfileUrl:i};e.unshift(o),A("GENERATION","Added retry generation to queue (LIFO - Priority)",{provider:t,promptLength:n.length,queueLength:e.length,queuePosition:1,promptPreview:n.substring(0,100)+(n.length>100?"...":"")}),a=!1,W(),r=!1,m(),u(),d()}function m(){if(C("SYSTEM","Updating system status",{completedQueueLength:t.length,isGenerating:a,generationQueueLength:e.length,currentStatusText:o}),t.length>0){const n=1===t.length?"1 Image Ready!":`${t.length} Images Ready!`;q.y("success",`${n} Click to view.`,()=>{const n=t.shift();n&&_.WU(n.imageUrls,n.prompt,n.provider),m()})}else if(a||e.length>0){const n=e.length>0?` (Queue: ${e.length})`:"";q.y("loading",`${o}${n}`)}else q.y("hidden","")}async function u(){if(a||0===e.length)return void C("QUEUE","Queue processing skipped",{reason:a?"Currently generating":"Queue is empty",isGenerating:a,queueLength:e.length});a=!0;const n=e.shift();o="Requesting...",A("QUEUE","Starting queue processing",{provider:n.provider,promptLength:n.prompt.length,promptPreview:n.prompt.substring(0,100)+(n.prompt.length>100?"...":""),remainingQueueLength:e.length,currentStatus:o}),m();const t={onSuccess:l,onFailure:c,onAuthFailure:(n,t)=>{var i,o,r;A("AUTH","Authentication required",{provider:t,message:n}),i=n,o=t,r=p,document.getElementById("nig-pollinations-auth-prompt")||(V=document.createElement("div"),V.id="nig-pollinations-auth-prompt",V.className="nig-modal-overlay",V.innerHTML=`\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Authentication Required</h2>\n            <p>The Pollinations.ai model you selected requires authentication. You can get free access by registering.</p>\n            <p><strong>Error Message:</strong> <em>${i}</em></p>\n            <p>Please visit <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> to continue. You can either:</p>\n            <ul>\n                <li><strong>Register the Referrer:</strong> The easiest method. Just register the domain <code>wtr-lab.com</code>. This links your usage to your account without needing a token.</li>\n                <li><strong>Use a Token:</strong> Get an API token and enter it below.</li>\n            </ul>\n            <div class="nig-form-group">\n                <label for="nig-prompt-pollinations-token">Pollinations API Token</label>\n                <input type="password" id="nig-prompt-pollinations-token">\n            </div>\n            <button id="nig-prompt-save-token-btn" class="nig-save-btn">Save Token & Retry</button>\n        </div>`,document.body.appendChild(V),V.querySelector(".nig-close-btn").addEventListener("click",()=>V.remove()),V.querySelector("#nig-prompt-save-token-btn").addEventListener("click",async()=>{const n=V.querySelector("#nig-prompt-pollinations-token").value.trim();n?(await w("pollinationsToken",n),V.remove(),alert("Token saved. Retrying generation..."),r(o,"Pollinations")):alert("Token cannot be empty.")})),a=!1,q.y("error","Authentication needed."),m(),A("AUTH","Queue paused due to authentication requirement",{generationQueueLength:e.length,willWaitForUser:!0})},updateStatus:n=>{o=n,m()}};switch(n.provider){case"Google":C("QUEUE","Dispatching to Google provider",{prompt:n.prompt.substring(0,50)+"..."}),async function(n,{onSuccess:e,onFailure:t}){const i=await b(),{model:a,googleApiKey:o,numberOfImages:r,aspectRatio:s,personGeneration:l,imageSize:c}=i,d=`https://generativelanguage.googleapis.com/v1beta/models/${a}:predict`,g={sampleCount:parseInt(r,10),aspectRatio:s,personGeneration:l};a.includes("fast")||(g.imageSize=parseInt(c,10)),GM_xmlhttpRequest({method:"POST",url:d,headers:{"x-goog-api-key":o,"Content-Type":"application/json"},data:JSON.stringify({instances:[{prompt:n}],parameters:g}),onload:i=>{try{const t=JSON.parse(i.responseText);if(t.error)throw new Error(JSON.stringify(t.error));const o=t.predictions.map(n=>`data:image/png;base64,${n.bytesB64Encoded}`);e(o,n,"Google",a)}catch(e){t(e.message,n,"Google")}},onerror:e=>t(JSON.stringify(e),n,"Google")})}(n.prompt,t);break;case"AIHorde":C("QUEUE","Dispatching to AIHorde provider",{prompt:n.prompt.substring(0,50)+"..."}),z(n.prompt,t);break;case"Pollinations":C("QUEUE","Dispatching to Pollinations provider",{prompt:n.prompt.substring(0,50)+"..."}),async function(n,{onSuccess:e,onFailure:t,onAuthFailure:i}){const a=await b(),{pollinationsModel:o,pollinationsToken:r,pollinationsWidth:s,pollinationsHeight:l,pollinationsSeed:c,pollinationsEnhance:d,pollinationsSafe:g,pollinationsNologo:p,pollinationsPrivate:m}=a,u=new URLSearchParams;r&&u.append("token",r),o&&"flux"!==o&&u.append("model",o),s&&1024!=s&&u.append("width",s),l&&1024!=l&&u.append("height",l),c&&u.append("seed",c),d&&u.append("enhance","true"),g&&u.append("safe","true"),p&&u.append("nologo","true"),m&&u.append("private","true");const v=u.toString(),h=`https://image.pollinations.ai/prompt/${encodeURIComponent(n)}${v?"?"+v:""}`;GM_xmlhttpRequest({method:"GET",url:h,responseType:"blob",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async a=>{if(a.status>=200&&a.status<300){const t=URL.createObjectURL(a.response);e([t],n,"Pollinations",o,[h])}else{const e=await a.response.text();if(e.toLowerCase().includes("model not found"))return t(`Model error: ${e}. Refreshing model list.`,n,"Pollinations"),void F("pollinations");if(403===a.status&&e.includes("auth.pollinations.ai"))return void i(JSON.parse(e).message,n);t(`Error ${a.status}: ${e}`,n,"Pollinations")}},onerror:e=>t(JSON.stringify(e),n,"Pollinations")})}(n.prompt,t);break;case"OpenAICompat":C("QUEUE","Dispatching to OpenAICompat provider",{prompt:n.prompt.substring(0,50)+"...",providerProfileUrl:n.providerProfileUrl}),async function(n,e,{onSuccess:t,onFailure:i}){const a=await b(),o=e||a.openAICompatActiveProfileUrl,r=a.openAICompatProfiles[o];if(!r)return void i(`No active or valid Openai Compatible profile found for URL: ${o}`,n,"OpenAICompat");const s=`${o}/images/generations`,l={model:r.model,prompt:n,n:1,size:"1024x1024",response_format:"b64_json"};GM_xmlhttpRequest({method:"POST",url:s,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},data:JSON.stringify(l),onload:e=>{try{const i=JSON.parse(e.responseText);if(!i?.data?.[0])throw new Error(JSON.stringify(i));{const e=i.data.map(n=>n.b64_json?`data:image/png;base64,${n.b64_json}`:n.url).filter(Boolean);if(!(e.length>0))throw new Error("API response did not contain usable image data.");t(e,n,"OpenAICompat",r.model)}}catch(e){i(e.message,n,"OpenAICompat",o)}},onerror:e=>i(JSON.stringify(e),n,"OpenAICompat",o)})}(n.prompt,n.providerProfileUrl,t);break;default:c(`Unknown provider: ${n.provider}`,n.prompt,"System")}}async function v(){if(n.style.display="none",window.getSelection&&window.getSelection().removeAllRanges(),!s)return void P("GENERATION","No text selected for generation");A("GENERATION","User initiated image generation",{selectionLength:s.length,selectionPreview:s.substring(0,100)+(s.length>100?"...":"")});const t=await b();if("Google"===t.selectedProvider&&!t.googleApiKey)return P("GENERATION","Google provider selected but no API key provided"),void function(){if(document.getElementById("nig-google-api-prompt"))return;j=document.createElement("div"),j.id="nig-google-api-prompt",j.className="nig-modal-overlay",j.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Google API Key Required</h2>\n            <p>Please provide your Google AI Gemini API key. You can get one from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a>.</p>\n            <div class="nig-form-group">\n                <label for="nig-prompt-api-key">Gemini API Key</label>\n                <input type="password" id="nig-prompt-api-key">\n            </div>\n            <button id="nig-prompt-save-btn" class="nig-save-btn">Save Key</button>\n        </div>',document.body.appendChild(j);const n=()=>j.remove();j.querySelector(".nig-close-btn").addEventListener("click",n),j.querySelector("#nig-prompt-save-btn").addEventListener("click",async()=>{const e=j.querySelector("#nig-prompt-api-key").value.trim();e?(await w("googleApiKey",e),alert("API Key saved. You can now generate an image."),n()):alert("API Key cannot be empty.")})}();let i=s,a="";if(t.customStyleEnabled&&t.customStyleText?(a=t.customStyleText.trim(),a&&!a.endsWith(", ")&&(a+=", ")):"None"!==t.mainPromptStyle&&(a=t.subPromptStyle&&"none"!==t.subPromptStyle?t.subPromptStyle:`${t.mainPromptStyle} style, `),i=a+i,t.enhancementEnabled){const n=T(t.selectedProvider,t),e=t.enhancementApiKey.trim().length>0;if((!n||t.enhancementOverrideProvider)&&e){q.y("loading","Enhancing prompt...");try{i=await B(i,t),q.y("success","Prompt enhanced!"),setTimeout(()=>m(),2e3)}catch(n){M("ENHANCEMENT","External AI enhancement failed, falling back to original",{error:n.message}),q.y("error","Enhancement failed, using original prompt"),setTimeout(()=>m(),3e3)}}}t.enableNegPrompt&&t.globalNegPrompt&&"AIHorde"!==t.selectedProvider&&(i+=`, negative prompt: ${t.globalNegPrompt}`,C("GENERATION","Global negative prompt applied",{negativePrompt:t.globalNegPrompt,originalLength:i.length-t.globalNegPrompt.length-18,finalLength:i.length})),A("GENERATION","Prompt preparation completed, adding to queue",{provider:t.selectedProvider,finalPromptLength:i.length,promptPreview:i.substring(0,100)+(i.length>100?"...":""),queueSystem:"FIFO"}),function(n,t,i=null){const a={prompt:n,provider:t,providerProfileUrl:i};e.push(a),A("GENERATION","Added generation to queue (FIFO)",{provider:t,promptLength:n.length,queueLength:e.length,queuePosition:e.length,promptPreview:n.substring(0,100)+(n.length>100?"...":"")}),m(),u()}(i,t.selectedProvider,t.openAICompatActiveProfileUrl)}function h(){const e=window.getSelection();if(!e||0===e.rangeCount)return void(n&&(n.style.display="none"));const t=e.toString().trim();if(t.length>5){s=t;const i=e.getRangeAt(0).getClientRects();if(0===i.length)return void(n.style.display="none");const a=i[0];n.style.display="block";const o=n.offsetHeight||30;let r=window.scrollY+a.top-o-5;if(r<window.scrollY){const n=i[i.length-1];r=window.scrollY+n.bottom+5}n.style.top=`${r}px`,n.style.left=`${window.scrollX+a.left}px`}else n&&(n.style.display="none")}!async function(){await S();const e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0",document.head.appendChild(e),n=document.createElement("button"),n.className="nig-button",n.innerHTML="🎨 Generate Image",n.addEventListener("click",v),document.body.appendChild(n),q.v(),_.vt(),K(),yn(),function({onRetry:n,onDismiss:e}){U=n,$=e}({onRetry:p,onDismiss:g}),document.addEventListener("mouseup",h),document.addEventListener("selectionchange",h),GM_registerMenuCommand("Image Generator Settings",fn),A("INIT","WTR LAB Novel Image Generator initialized successfully",{config:await b()})}()}()})();