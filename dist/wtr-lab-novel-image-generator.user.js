// ==UserScript==
// @name WTR LAB Novel Image Generator
// @description A powerful userscript to enhance web novel reading on WTR-LAB.COM. Select text to generate AI-powered images using multiple providers (Pollinations, AI Horde, Google Imagen, OpenAI). Features Gemini-enhanced prompts, 100+ art styles, a modern UI, history, and robust configuration options. Built with Webpack for modularity and maintainability.
// @version 6.0.0
// @author MasuRii
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect *
// @downloadURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_xmlhttpRequest
// @grant GM_registerMenuCommand
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @updateURL https://update.greasyfork.org/scripts/553073/WTR%20LAB%20Novel%20Image%20Generator.meta.js
// ==/UserScript==

(()=>{"use strict";var e={56:(e,n,t)=>{e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72:e=>{var n=[];function t(e){for(var t=-1,i=0;i<n.length;i++)if(n[i].identifier===e){t=i;break}return t}function i(e,i){for(var o={},r=[],s=0;s<e.length;s++){var l=e[s],c=i.base?l[0]+i.base:l[0],d=o[c]||0,g="".concat(c," ").concat(d);o[c]=d+1;var p=t(g),m={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==p)n[p].references++,n[p].updater(m);else{var u=a(m,i);i.byIndex=s,n.splice(s,0,{identifier:g,updater:u,references:1})}r.push(g)}return r}function a(e,n){var t=n.domAPI(n);return t.update(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,a){var o=i(e=e||[],a=a||{});return function(e){e=e||[];for(var r=0;r<o.length;r++){var s=t(o[r]);n[s].references--}for(var l=i(e,a),c=0;c<o.length;c++){var d=t(o[c]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}o=l}}},113:e=>{e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},249:(e,n,t)=>{t.d(n,{A:()=>s});var i=t(601),a=t.n(i),o=t(314),r=t.n(o)()(a());r.push([e.id,"/* === CSS Custom Properties (Design Tokens) === */\n:root {\n    /* Color Palette - Modern Dark Theme */\n    --nig-color-bg-primary: #1a1a1e;\n    --nig-color-bg-secondary: #2d2d32;\n    --nig-color-bg-tertiary: #3a3a40;\n    --nig-color-bg-elevated: #404046;\n    --nig-color-text-primary: #f0f0f0;\n    --nig-color-text-secondary: #b4b4b8;\n    --nig-color-text-muted: #8a8a8e;\n    --nig-color-border: #55555a;\n    --nig-color-border-light: #6a6a6e;\n\n    /* Accent Colors */\n    --nig-color-accent-primary: #6366f1;\n    --nig-color-accent-secondary: #8b5cf6;\n    --nig-color-accent-success: #10b981;\n    --nig-color-accent-warning: #f59e0b;\n    --nig-color-accent-error: #ef4444;\n\n    /* Interactive States */\n    --nig-color-hover-primary: #5855eb;\n    --nig-color-hover-secondary: #7c3aed;\n    --nig-color-hover-success: #059669;\n    --nig-color-hover-error: #dc2626;\n\n    /* Spacing Scale */\n    --nig-space-xs: 0.25rem;\n    --nig-space-sm: 0.5rem;\n    --nig-space-md: 0.75rem;\n    --nig-space-lg: 1rem;\n    --nig-space-xl: 1.5rem;\n    --nig-space-2xl: 2rem;\n    --nig-space-3xl: 3rem;\n\n    /* Typography Scale */\n    --nig-font-size-xs: 0.75rem;\n    --nig-font-size-sm: 0.875rem;\n    --nig-font-size-base: 1rem;\n    --nig-font-size-lg: 1.125rem;\n    --nig-font-size-xl: 1.25rem;\n    --nig-font-size-2xl: 1.5rem;\n    --nig-font-size-3xl: 1.875rem;\n\n    /* Border Radius */\n    --nig-radius-sm: 0.375rem;\n    --nig-radius-md: 0.5rem;\n    --nig-radius-lg: 0.75rem;\n    --nig-radius-xl: 1rem;\n\n    /* Shadows */\n    --nig-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);\n    --nig-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);\n    --nig-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);\n    --nig-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);\n\n    /* Transitions */\n    --nig-transition-fast: 0.15s ease-out;\n    --nig-transition-normal: 0.2s ease-out;\n    --nig-transition-slow: 0.3s ease-out;\n\n    /* Breakpoints */\n    --nig-breakpoint-sm: 640px;\n    --nig-breakpoint-md: 768px;\n    --nig-breakpoint-lg: 1024px;\n    --nig-breakpoint-xl: 1280px;\n}\n\n/* === Base Components === */\n.nig-button {\n    position: absolute;\n    z-index: 99998;\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    box-shadow: var(--nig-shadow-md);\n    display: none;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-normal);\n    transform: translateY(0);\n}\n.nig-button:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-lg);\n}\n.nig-button:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(8px);\n    z-index: 99999;\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    padding: var(--nig-space-lg);\n}\n\n.nig-modal-content {\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-2xl);\n    border-radius: var(--nig-radius-xl);\n    box-shadow: var(--nig-shadow-xl);\n    width: 100%;\n    max-width: 900px;\n    max-height: 90vh;\n    overflow-y: auto;\n    position: relative;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    border: 1px solid var(--nig-color-border);\n    animation: nig-modal-appear 0.2s ease-out;\n}\n\n@keyframes nig-modal-appear {\n    from {\n        opacity: 0;\n        transform: scale(0.95) translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1) translateY(0);\n    }\n}\n\n.nig-modal-content ul {\n    padding-left: var(--nig-space-xl);\n}\n\n/* History list alignment fix - remove excessive padding for history results */\n#nig-history-list {\n    padding-left: var(--nig-space-sm);\n}\n\n.nig-modal-content li {\n    margin-bottom: var(--nig-space-md);\n}\n\n.nig-close-btn {\n    position: absolute;\n    top: var(--nig-space-lg);\n    right: var(--nig-space-lg);\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 300;\n    cursor: pointer;\n    color: var(--nig-color-text-muted);\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: var(--nig-radius-md);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-close-btn:hover {\n    color: var(--nig-color-text-primary);\n    background: var(--nig-color-bg-tertiary);\n}\n\n.nig-modal-content h2 {\n    margin-top: 0;\n    border-bottom: 1px solid var(--nig-color-border);\n    padding-bottom: var(--nig-space-lg);\n    font-size: var(--nig-font-size-2xl);\n    font-weight: 600;\n    letter-spacing: -0.025em;\n}\n\n/* === Form Elements === */\n.nig-form-group {\n    margin-bottom: var(--nig-space-xl);\n}\n\n.nig-form-group label {\n    display: block;\n    margin-bottom: var(--nig-space-sm);\n    font-weight: 500;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-form-group small.nig-hint {\n    color: var(--nig-color-text-muted);\n    font-weight: normal;\n    display: block;\n    margin-top: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-sm);\n    min-height: 1.2em;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n}\n\n.nig-form-group input,\n.nig-form-group select,\n.nig-form-group textarea {\n    width: 100%;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    transition: all var(--nig-transition-fast);\n    outline: none;\n}\n\n.nig-form-group input:focus,\n.nig-form-group select:focus,\n.nig-form-group textarea:focus {\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n    background: var(--nig-color-bg-elevated);\n}\n\n.nig-form-group select:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n.nig-form-group textarea {\n    resize: vertical;\n    min-height: 80px;\n    line-height: 1.5;\n}\n\n.nig-form-group-inline {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-lg);\n    align-items: end;\n}\n\n.nig-form-group-inline label {\n    margin-bottom: var(--nig-space-sm);\n}\n\n.nig-checkbox-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--nig-space-lg);\n}\n\n.nig-checkbox-group label {\n    display: flex;\n    align-items: center;\n    margin-right: 0;\n    font-weight: normal;\n    cursor: pointer;\n    color: var(--nig-color-text-secondary);\n}\n\n.nig-checkbox-group input {\n    width: auto;\n    margin-right: var(--nig-space-sm);\n    margin-bottom: 0;\n    transform: scale(1.1);\n}\n\n/* === Buttons === */\n.nig-save-btn {\n    background: var(--nig-color-accent-success);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-save-btn:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-fetch-models-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: 0;\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-primary);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-fetch-models-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-delete-btn {\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    margin-left: 0;\n    border-radius: var(--nig-radius-md);\n    border: 1px solid var(--nig-color-border);\n    background: var(--nig-color-accent-error);\n    color: white;\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-delete-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n.nig-history-cleanup-btn {\n    background: var(--nig-color-accent-error);\n    color: white;\n    padding: var(--nig-space-sm) var(--nig-space-md);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-history-cleanup-btn:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n}\n\n/* === Tab System === */\n.nig-tabs {\n    display: flex;\n    border-bottom: 1px solid var(--nig-color-border);\n    margin-bottom: var(--nig-space-xl);\n    overflow-x: auto;\n    scrollbar-width: none;\n    -ms-overflow-style: none;\n}\n\n.nig-tabs::-webkit-scrollbar {\n    display: none;\n}\n\n.nig-tab {\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    cursor: pointer;\n    border-radius: var(--nig-radius-md) var(--nig-radius-md) 0 0;\n    background: transparent;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-fast);\n    white-space: nowrap;\n    border: 1px solid transparent;\n    border-bottom: none;\n}\n\n.nig-tab:hover {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n}\n\n.nig-tab.active {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-primary);\n    border: 1px solid var(--nig-color-border);\n    border-bottom: 1px solid var(--nig-color-bg-tertiary);\n    box-shadow: 0 -2px 0 var(--nig-color-accent-primary) inset;\n}\n\n.nig-tab-content {\n    display: none;\n    animation: nig-content-fade 0.2s ease-out;\n}\n\n.nig-tab-content.active {\n    display: block;\n}\n\n@keyframes nig-content-fade {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n/* === Modern Utilities Tab === */\n.nig-utilities-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-utility-card {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-utility-card:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-md);\n    transform: translateY(-2px);\n}\n\n.nig-utility-card h4 {\n    margin: 0 0 var(--nig-space-md) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-utility-card p {\n    margin: 0 0 var(--nig-space-lg) 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-utility-card .nig-save-btn {\n    width: 100%;\n    justify-content: center;\n}\n\n/* === Enhanced Utility Card Structure === */\n.nig-card-header {\n    display: flex;\n    align-items: flex-start;\n    gap: var(--nig-space-md);\n    margin-bottom: var(--nig-space-lg);\n}\n\n\n.nig-card-title {\n    flex: 1;\n    min-width: 0;\n}\n\n.nig-card-title h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    line-height: 1.3;\n}\n\n.nig-card-title p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-card-actions {\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-secondary-actions {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--nig-space-sm);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-card-footer {\n    padding-top: var(--nig-space-md);\n     border-top: 1px solid var(--nig-color-border);\n    margin-top: auto;\n}\n\n/* === Modern Button Variants === */\n.nig-btn-primary {\n    width: 100%;\n     background: var(--nig-color-accent-warning);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-sm);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n}\n\n.nig-btn-primary:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-primary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--nig-space-xs);\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    min-height: 36px;\n}\n\n.nig-btn-secondary:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary:active {\n    transform: translateY(0);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-btn-secondary.nig-btn-error {\n    background: var(--nig-color-accent-error);\n    color: white;\n}\n\n.nig-btn-secondary.nig-btn-error:hover {\n    background: var(--nig-color-hover-error);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n.nig-btn-secondary .material-symbols-outlined {\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-btn-primary .material-symbols-outlined {\n    font-size: var(--nig-font-size-sm);\n}\n\n/* === History System === */\n.nig-history-list {\n    list-style: none;\n    padding: 0;\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.nig-history-item {\n    background: var(--nig-color-bg-tertiary);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-md);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-history-item:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-history-item small {\n    display: block;\n    color: var(--nig-color-text-muted);\n    margin-bottom: var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n}\n\n.nig-history-item a {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    word-break: break-all;\n    font-weight: 500;\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-history-item a:hover {\n    color: var(--nig-color-hover-primary);\n}\n\n.nig-history-cleanup {\n    padding: var(--nig-space-lg);\n    background: var(--nig-color-bg-tertiary);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-xl);\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-lg);\n    border: 1px solid var(--nig-color-border);\n}\n\n.nig-history-cleanup input[type=\"number\"] {\n    width: 80px;\n    padding: var(--nig-space-sm);\n}\n\n/* === Image Gallery === */\n.nig-image-gallery {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: var(--nig-space-xl);\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-image-container {\n    position: relative;\n    border-radius: var(--nig-radius-lg);\n    overflow: hidden;\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-image-container:hover {\n    box-shadow: var(--nig-shadow-lg);\n    transform: translateY(-2px);\n}\n\n.nig-image-container img {\n    width: 100%;\n    height: auto;\n    display: block;\n    transition: transform var(--nig-transition-slow);\n}\n\n.nig-image-container:hover img {\n    transform: scale(1.02);\n}\n\n.nig-image-actions {\n    position: absolute;\n    top: var(--nig-space-md);\n    right: var(--nig-space-md);\n    display: flex;\n    gap: var(--nig-space-sm);\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(10px);\n    padding: var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    opacity: 0;\n    transition: opacity var(--nig-transition-normal);\n}\n\n.nig-image-container:hover .nig-image-actions {\n    opacity: 1;\n}\n\n.nig-image-actions button {\n    background: rgba(0, 0, 0, 0.8);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    width: 36px;\n    height: 36px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: var(--nig-font-size-base);\n    color: white;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-image-actions button:hover {\n    background: white;\n    transform: scale(1.1);\n}\n\n/* === Image Loading States === */\n.nig-image-loading {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(2px);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10;\n}\n\n.nig-spinner {\n    width: 32px;\n    height: 32px;\n    border: 3px solid rgba(255, 255, 255, 0.3);\n    border-top: 3px solid white;\n    border-radius: 50%;\n    animation: nig-spin 1s linear infinite;\n}\n\n@keyframes nig-spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n/* === URL Link Button Styling === */\n.nig-image-actions button[title=\"Open Image URL\"] {\n    background: rgba(99, 102, 241, 0.9);\n}\n\n.nig-image-actions button[title=\"Open Image URL\"]:hover {\n    background: var(--nig-color-accent-primary);\n}\n\n.material-symbols-outlined {\n    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n    font-size: 18px;\n}\n\n.nig-api-prompt-link {\n    color: var(--nig-color-accent-primary);\n    text-decoration: none;\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-api-prompt-link:hover {\n    color: var(--nig-color-hover-primary);\n    text-decoration: underline;\n}\n\n.nig-provider-settings {\n    display: none;\n}\n\n/* === Prompt Container === */\n.nig-prompt-container {\n    background: var(--nig-color-bg-tertiary);\n    border-radius: var(--nig-radius-md);\n    margin-bottom: var(--nig-space-lg);\n    border: 1px solid var(--nig-color-border);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-prompt-header {\n    padding: var(--nig-space-lg);\n    cursor: pointer;\n    font-weight: 500;\n    display: flex;\n    align-items: center;\n    user-select: none;\n    color: var(--nig-color-text-primary);\n    transition: color var(--nig-transition-fast);\n}\n\n.nig-prompt-header:hover {\n    color: var(--nig-color-accent-primary);\n}\n\n.nig-prompt-header::before {\n    content: 'â–¸';\n    margin-right: var(--nig-space-md);\n    transition: transform var(--nig-transition-normal);\n    color: var(--nig-color-text-muted);\n}\n\n.nig-prompt-container.expanded .nig-prompt-header::before {\n    transform: rotate(90deg);\n    color: var(--nig-color-accent-primary);\n}\n\n.nig-prompt-text {\n    display: none;\n    padding: 0 var(--nig-space-lg) var(--nig-space-lg) var(--nig-space-lg);\n    border-top: 1px solid var(--nig-color-border);\n    word-break: break-word;\n    color: var(--nig-color-text-secondary);\n    line-height: 1.6;\n}\n\n.nig-prompt-container.expanded .nig-prompt-text {\n    display: block;\n    animation: nig-expand 0.2s ease-out;\n}\n\n@keyframes nig-expand {\n    from {\n        opacity: 0;\n        max-height: 0;\n    }\n    to {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n/* === Button Footer === */\n.nig-button-footer {\n    margin-top: var(--nig-space-3xl);\n    padding-top: var(--nig-space-xl);\n    border-top: 1px solid var(--nig-color-border);\n    text-align: center;\n}\n\n/* === Status Widget === */\n.nig-status-widget {\n    position: fixed;\n    bottom: var(--nig-space-xl);\n    left: var(--nig-space-xl);\n    z-index: 100000;\n    background: var(--nig-color-bg-secondary);\n    color: var(--nig-color-text-primary);\n    padding: var(--nig-space-md) var(--nig-space-lg);\n    border-radius: var(--nig-radius-lg);\n    box-shadow: var(--nig-shadow-xl);\n    display: none;\n    align-items: center;\n    gap: var(--nig-space-md);\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    font-size: var(--nig-font-size-sm);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    border: 1px solid var(--nig-color-border);\n    backdrop-filter: blur(10px);\n}\n\n.nig-status-icon {\n    width: 20px;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nig-status-widget.loading .nig-status-icon {\n    box-sizing: border-box;\n    border: 2px solid var(--nig-color-text-muted);\n    border-top-color: var(--nig-color-accent-primary);\n    border-radius: 50%;\n    animation: nig-spin 1s linear infinite;\n}\n\n.nig-status-widget.success {\n    background: var(--nig-color-accent-success);\n    color: white;\n    cursor: pointer;\n    border-color: var(--nig-color-accent-success);\n}\n\n.nig-status-widget.success:hover {\n    background: var(--nig-color-hover-success);\n    transform: translateY(-2px);\n    box-shadow: var(--nig-shadow-lg);\n}\n\n.nig-status-widget.error {\n    background: var(--nig-color-accent-error);\n    border-color: var(--nig-color-accent-error);\n}\n\n@keyframes nig-spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n/* === Error Modal === */\n#nig-error-reason {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-sm);\n    max-height: 150px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    white-space: pre-wrap;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-prompt {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    padding: var(--nig-space-lg);\n    border-radius: var(--nig-radius-md);\n    margin-top: var(--nig-space-lg);\n    max-height: 200px;\n    overflow-y: auto;\n    word-break: break-word;\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    width: 100%;\n    resize: vertical;\n    min-height: 80px;\n    color: var(--nig-color-text-primary);\n    line-height: 1.5;\n}\n\n.nig-error-actions {\n    margin-top: var(--nig-space-xl);\n}\n\n.nig-retry-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    padding: var(--nig-space-md) var(--nig-space-xl);\n    border: none;\n    border-radius: var(--nig-radius-md);\n    cursor: pointer;\n    font-size: var(--nig-font-size-base);\n    font-weight: 500;\n    transition: all var(--nig-transition-normal);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-retry-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n    box-shadow: var(--nig-shadow-md);\n}\n\n/* === Responsive Design === */\n\n/* Mobile First Base (up to 767px) */\n@media (max-width: 767px) {\n    .nig-modal-content {\n        margin: var(--nig-space-md);\n        padding: var(--nig-space-xl);\n        max-height: 95vh;\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-modal-overlay {\n        padding: var(--nig-space-sm);\n    }\n\n    .nig-button {\n        position: fixed;\n        bottom: var(--nig-space-3xl);\n        left: 50% !important;\n        transform: translateX(-50%);\n        top: auto !important;\n        padding: var(--nig-space-sm) var(--nig-space-lg);\n        font-size: var(--nig-font-size-sm);\n        z-index: 100001;\n        min-height: 44px; /* Touch target */\n        border-radius: var(--nig-radius-lg);\n    }\n\n    .nig-tabs {\n        margin: 0 calc(-1 * var(--nig-space-xl)) var(--nig-space-xl) calc(-1 * var(--nig-space-xl));\n        padding: 0 var(--nig-space-xl);\n    }\n\n    .nig-tab {\n        padding: var(--nig-space-md) var(--nig-space-lg);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-checkbox-group {\n        flex-direction: column;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-checkbox-group label {\n        justify-content: flex-start;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-utility-card {\n        padding: var(--nig-space-lg);\n    }\n\n    .nig-card-header {\n        flex-direction: column;\n        align-items: center;\n        text-align: center;\n        gap: var(--nig-space-sm);\n    }\n\n\n    .nig-card-secondary-actions {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-sm);\n    }\n\n    .nig-card-footer {\n        text-align: center;\n    }\n\n    .nig-history-cleanup {\n        flex-direction: column;\n        align-items: stretch;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-history-cleanup input[type=\"number\"] {\n        width: 100%;\n    }\n\n    .nig-status-widget {\n        bottom: var(--nig-space-lg);\n        left: var(--nig-space-md);\n        right: var(--nig-space-md);\n        padding: var(--nig-space-md);\n        font-size: var(--nig-font-size-xs);\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-lg);\n    }\n\n    .nig-modal-content h2 {\n        font-size: var(--nig-font-size-xl);\n        padding-right: 48px; /* Space for close button */\n    }\n}\n\n/* Tablet (768px to 1023px) */\n@media (min-width: 768px) and (max-width: 1023px) {\n    .nig-modal-content {\n        max-width: 700px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n}\n\n/* Desktop (1024px and up) */\n@media (min-width: 1024px) {\n    .nig-modal-content {\n        max-width: 1000px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));\n    }\n\n    .nig-image-gallery {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-form-group-inline {\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    }\n\n    /* Enhanced hover states for desktop */\n    .nig-tab:hover {\n        background: var(--nig-color-bg-tertiary);\n    }\n\n    .nig-history-item:hover {\n        transform: translateY(-1px);\n    }\n}\n\n/* Large Desktop (1280px and up) */\n@media (min-width: 1280px) {\n    .nig-modal-content {\n        max-width: 1200px;\n    }\n\n    .nig-utilities-grid {\n        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));\n    }\n}\n\n/* Print Styles */\n@media print {\n    .nig-modal-overlay,\n    .nig-status-widget,\n    .nig-button {\n        display: none !important;\n    }\n\n    .nig-modal-content {\n        box-shadow: none;\n        border: 1px solid #000;\n        background: white;\n        color: black;\n    }\n}\n\n/* High Contrast Mode Support */\n@media (prefers-contrast: high) {\n    :root {\n        --nig-color-bg-primary: #000000;\n        --nig-color-bg-secondary: #1a1a1a;\n        --nig-color-bg-tertiary: #2a2a2a;\n        --nig-color-text-primary: #ffffff;\n        --nig-color-border: #666666;\n    }\n}\n\n/* Reduced Motion Support */\n@media (prefers-reduced-motion: reduce) {\n    *,\n    *::before,\n    *::after {\n        animation-duration: 0.01ms !important;\n        animation-iteration-count: 1 !important;\n        transition-duration: 0.01ms !important;\n    }\n}\n\n/* === Panel Configuration Grid Layout === */\n.nig-config-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-config-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-provider-container {\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-provider-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-provider-header h3 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n}\n\n.nig-provider-header p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-provider-controls {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-provider-settings {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-provider-settings:hover {\n    border-color: var(--nig-color-border-light);\n    box-shadow: var(--nig-shadow-sm);\n}\n\n.nig-form-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n/* === Styling Tab Layout === */\n.nig-styling-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-styling-intro {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-styling-intro p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.6;\n}\n\n.nig-style-grid {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--nig-space-xl);\n}\n\n.nig-style-section {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n}\n\n.nig-section-header {\n    margin-bottom: var(--nig-space-lg);\n    padding-bottom: var(--nig-space-lg);\n    border-bottom: 1px solid var(--nig-color-border);\n}\n\n.nig-section-header h4 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n/* === History Tab Layout === */\n.nig-history-container {\n    display: grid;\n    gap: var(--nig-space-xl);\n}\n\n.nig-history-cleanup {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-xl);\n    display: grid;\n    gap: var(--nig-space-lg);\n}\n\n.nig-cleanup-info h4 {\n    margin: 0 0 var(--nig-space-sm) 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-lg);\n    font-weight: 600;\n}\n\n.nig-cleanup-info p {\n    margin: 0;\n    color: var(--nig-color-text-secondary);\n    font-size: var(--nig-font-size-sm);\n    line-height: 1.5;\n}\n\n.nig-cleanup-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-md);\n    flex-wrap: wrap;\n}\n\n.nig-cleanup-controls label {\n    color: var(--nig-color-text-primary);\n    font-weight: 500;\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-cleanup-controls input[type=\"number\"] {\n    width: 80px;\n    padding: var(--nig-space-sm);\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    color: var(--nig-color-text-primary);\n}\n\n/* === Enhancement Status & Priority Styles === */\n.nig-enhancement-status {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    border-radius: var(--nig-radius-md);\n    font-size: var(--nig-font-size-xs);\n    font-weight: 500;\n    margin-left: var(--nig-space-md);\n}\n\n.nig-enhancement-status.provider-priority {\n    background: var(--nig-color-accent-warning);\n    color: white;\n}\n\n.nig-enhancement-status.external-ai {\n    background: var(--nig-color-accent-primary);\n    color: white;\n}\n\n.nig-enhancement-status.disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n}\n\n.nig-status-indicator {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    background: #4af028;\n    opacity: 0.8;\n}\n\n.nig-provider-priority-info {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-accent-warning);\n    border-radius: var(--nig-radius-lg);\n     padding: var(--nig-space-lg);\n    margin-bottom: var(--nig-space-lg);\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-md);\n}\n\n.nig-priority-header {\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    color: var(--nig-color-accent-warning);\n    font-weight: 600;\n    font-size: var(--nig-font-size-sm);\n}\n\n.nig-override-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n     padding: var(--nig-space-sm) var(--nig-space-md);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    align-self: flex-start;\n}\n\n.nig-override-btn:hover {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n/* === Enhancement Preview Styles === */\n.nig-enhancement-preview {\n    background: var(--nig-color-bg-primary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-lg);\n    padding: var(--nig-space-lg);\n    margin-top: var(--nig-space-lg);\n}\n\n.nig-preview-container {\n    display: grid;\n    grid-template-columns: 1fr auto 1fr;\n    gap: var(--nig-space-lg);\n    align-items: start;\n    margin-bottom: var(--nig-space-lg);\n}\n\n.nig-preview-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--nig-space-sm);\n}\n\n.nig-preview-section h5 {\n    margin: 0;\n    color: var(--nig-color-text-primary);\n    font-size: var(--nig-font-size-sm);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.025em;\n}\n\n.nig-preview-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--nig-color-accent-primary);\n    padding: var(--nig-space-sm);\n}\n\n.nig-prompt-display {\n    background: var(--nig-color-bg-tertiary);\n    border: 1px solid var(--nig-color-border);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-md);\n    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;\n    font-size: var(--nig-font-size-xs);\n    line-height: 1.4;\n    color: var(--nig-color-text-secondary);\n    max-height: 120px;\n    overflow-y: auto;\n    word-wrap: break-word;\n    white-space: pre-wrap;\n}\n\n.nig-test-enhancement-btn {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border: none;\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-sm) var(--nig-space-lg);\n    font-size: var(--nig-font-size-sm);\n    cursor: pointer;\n    transition: all var(--nig-transition-normal);\n    display: flex;\n    align-items: center;\n    gap: var(--nig-space-sm);\n    width: 100%;\n    justify-content: center;\n}\n\n.nig-test-enhancement-btn:hover:not(:disabled) {\n    background: var(--nig-color-hover-primary);\n    transform: translateY(-1px);\n}\n\n.nig-test-enhancement-btn:disabled {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n    transform: none;\n}\n\n/* === Enhancement Settings States === */\n.nig-enhancement-settings {\n    transition: all var(--nig-transition-normal);\n}\n\n.nig-enhancement-settings.disabled {\n    opacity: 0.5;\n    pointer-events: none;\n}\n\n.nig-enhancement-settings.disabled .nig-form-group input,\n.nig-enhancement-settings.disabled .nig-form-group select,\n.nig-enhancement-settings.disabled .nig-form-group textarea {\n    background: var(--nig-color-bg-tertiary);\n    color: var(--nig-color-text-muted);\n    cursor: not-allowed;\n}\n\n/* === Template Button Styles === */\n.nig-template-btn {\n    background: var(--nig-color-bg-elevated);\n    border: 1px solid var(--nig-color-border);\n    color: var(--nig-color-text-secondary);\n    border-radius: var(--nig-radius-md);\n    padding: var(--nig-space-xs) var(--nig-space-sm);\n    font-size: var(--nig-font-size-xs);\n    cursor: pointer;\n    transition: all var(--nig-transition-fast);\n}\n\n.nig-template-btn:hover {\n    background: var(--nig-color-accent-primary);\n    color: white;\n    border-color: var(--nig-color-accent-primary);\n}\n\n/* === Mobile Enhancement Styles === */\n@media (max-width: 767px) {\n    .nig-preview-container {\n        grid-template-columns: 1fr;\n        gap: var(--nig-space-md);\n    }\n\n    .nig-preview-arrow {\n        transform: rotate(90deg);\n        justify-self: center;\n    }\n\n    .nig-enhancement-status {\n        margin-left: 0;\n        margin-top: var(--nig-space-sm);\n        align-self: flex-start;\n    }\n}\n\n/* === Enhanced Responsive Grid === */\n@media (min-width: 768px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-cleanup-controls {\n        justify-content: flex-start;\n    }\n}\n\n@media (min-width: 1024px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    }\n\n    .nig-form-grid {\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-settings:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--nig-shadow-md);\n    }\n}\n\n@media (min-width: 1280px) {\n    .nig-config-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-provider-controls {\n        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    }\n\n    .nig-style-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .nig-styling-container {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* === File Input Styling === */\ninput[type=\"file\"] {\n    border: 2px dashed var(--nig-color-border);\n    background: var(--nig-color-bg-primary);\n    padding: var(--nig-space-xl);\n    border-radius: var(--nig-radius-lg);\n    color: var(--nig-color-text-secondary);\n    transition: all var(--nig-transition-normal);\n    cursor: pointer;\n}\n\ninput[type=\"file\"]:hover {\n    border-color: var(--nig-color-accent-primary);\n    background: var(--nig-color-bg-elevated);\n}\n\ninput[type=\"file\"]:focus {\n    outline: none;\n    border-color: var(--nig-color-accent-primary);\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n}",""]);const s=r},314:e=>{e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var t="",i=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),i&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),i&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t}).join("")},n.i=function(e,t,i,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);i&&r[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),n.push(d))}},n}},322:(e,n,t)=>{function i(e,n,t){const i=new Blob([n],{type:t}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function a(){return"WTR LAB Novel Image Generator".replace(/[^\w\s-]/g,"").replace(/\s+/g,"_")}t.d(n,{P:()=>i,t:()=>a})},540:e=>{e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},601:e=>{e.exports=function(e){return e[1]}},642:(e,n,t)=>{t.d(n,{show:()=>r,v:()=>o});var i=t(322);function a(e){return e.startsWith("data:")}function o(){if(document.getElementById("nig-image-viewer"))return;const e=document.createElement("div");e.id="nig-image-viewer",e.className="nig-modal-overlay",e.style.display="none",e.innerHTML='\n\t\t<div class="nig-modal-content">\n\t\t\t<span class="nig-close-btn">&times;</span>\n\t\t\t<div id="nig-prompt-container" class="nig-prompt-container">\n\t\t\t\t<div class="nig-prompt-header"><span>Generated Image Prompt</span></div>\n\t\t\t\t<p id="nig-prompt-text" class="nig-prompt-text"></p>\n\t\t\t</div>\n\t\t\t<div id="nig-image-gallery" class="nig-image-gallery"></div>\n\t\t</div>',document.body.appendChild(e),e.querySelector(".nig-close-btn").addEventListener("click",()=>{e.style.display="none",Promise.resolve().then(t.bind(t,867)).then(e=>{e.updateSystemStatus})});const n=e.querySelector("#nig-prompt-container");n.addEventListener("click",()=>{n.classList.toggle("expanded")})}function r(e,n,t){document.getElementById("nig-image-viewer")||o();const r=document.getElementById("nig-image-viewer"),s=r.querySelector("#nig-image-gallery");s.innerHTML="";const l=r.querySelector("#nig-prompt-container");r.querySelector("#nig-prompt-text").textContent=n,l.classList.remove("expanded");const c="Pollinations"===t||"OpenAICompat"===t?"jpg":"png";e.forEach((e,t)=>{const o=document.createElement("div");o.className="nig-image-container";const r=document.createElement("img");if(r.src=e,!a(e)){r.loading="lazy",r.alt="Generated image",r.onerror=()=>{r.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+",r.alt="Image not available"};const e=document.createElement("div");e.className="nig-image-loading",e.innerHTML='<div class="nig-spinner"></div>',o.appendChild(e),r.onload=()=>{e.remove()}}const l=document.createElement("div");l.className="nig-image-actions";const d=document.createElement("button");d.innerHTML='<span class="material-symbols-outlined">download</span>',d.title="Download Image",d.onclick=()=>{const a=document.createElement("a");a.href=e;const o=(0,i.t)(),r=n.substring(0,20).replace(/\s/g,"_");a.download=`${o}_${r}_${t}.${c}`,a.click()};const g=document.createElement("button");g.innerHTML='<span class="material-symbols-outlined">fullscreen</span>',g.title="View Fullscreen",g.onclick=()=>{r.requestFullscreen&&r.requestFullscreen()};const p=document.createElement("button");!a(e)&&function(e){try{return new URL(e),!0}catch{return!1}}(e)&&(p.innerHTML='<span class="material-symbols-outlined">link</span>',p.title="Open Image URL",p.onclick=()=>{window.open(e,"_blank")},l.appendChild(p)),l.appendChild(d),l.appendChild(g),o.appendChild(r),o.appendChild(l),s.appendChild(o)}),r.style.display="flex"}},659:e=>{var n={};e.exports=function(e,t){var i=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var i="";t.supports&&(i+="@supports (".concat(t.supports,") {")),t.media&&(i+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(i+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),i+=t.css,a&&(i+="}"),t.media&&(i+="}"),t.supports&&(i+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(i,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}},867:(e,n,t)=>{t.d(n,{v:()=>a,y:()=>o});let i=null;function a(){i||(i=document.createElement("div"),i.id="nig-status-widget",i.className="nig-status-widget",i.innerHTML='<div class="nig-status-icon"></div><span class="nig-status-text"></span>',document.body.appendChild(i))}function o(e,n,t=null){if(!i)return;if(i.classList.remove("loading","success","error"),i.onclick=t,"hidden"===e)return void(i.style.display="none");i.style.display="flex",i.querySelector(".nig-status-text").textContent=n,i.classList.add(e);const a=i.querySelector(".nig-status-icon");a.innerHTML="","success"===e?a.innerHTML="âœ…":"error"===e&&(a.innerHTML="âŒ")}}},n={};function t(i){var a=n[i];if(void 0!==a)return a.exports;var o=n[i]={id:i,exports:{}};return e[i](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var i=t(72),a=t.n(i),o=t(825),r=t.n(o),s=t(659),l=t.n(s),c=t(56),d=t.n(c),g=t(540),p=t.n(g),m=t(113),u=t.n(m),h=t(249),v={};v.styleTagTransform=u(),v.setAttributes=d(),v.insert=l().bind(null,"head"),v.domAPI=r(),v.insertStyleElement=p(),a()(h.A,v),h.A&&h.A.locals&&h.A.locals;const y={selectedProvider:"Pollinations",loggingEnabled:!1,providerLogos:{Pollinations:{url:"https://raw.githubusercontent.com/pollinations/pollinations/eea264f608e9393e69631eea5e00e9ecf6e1836e/shared/assets/logo.svg",alt:"Pollinations.ai Logo"},AIHorde:{url:"https://stablehorde.net/assets/img/logo.png",alt:"AI Horde Logo"},OpenAICompat:{url:"https://openai.com/favicon.svg",alt:"OpenAI Compatible Logo"},Google:{url:"https://upload.wikimedia.org/wikipedia/commons/1/1d/Google_Gemini_icon_2025.svg",alt:"Google Gemini Logo"}},mainPromptStyle:"None",subPromptStyle:"none",customStyleEnabled:!1,customStyleText:"",enhancementEnabled:!1,enhancementProvider:"gemini",enhancementApiKey:"",enhancementModel:"models/gemini-2.5-pro",enhancementTemplate:'Convert this text into a focused visual description for image generation. Extract key visual elements (characters, setting, mood, style) and describe them as a direct prompt without narrative elements, dialogue, or markdown formatting. Keep it concise and focused on what can be visually rendered. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:',enhancementTemplateSelected:"standard",enhancementOverrideProvider:!1,enhancementLastStatus:"disabled",enhancementMaxRetriesPerModel:2,enhancementRetryDelay:1e3,enhancementModelsFallback:["models/gemini-2.5-pro","models/gemini-flash-latest","models/gemini-flash-lite-latest","models/gemini-2.5-flash","models/gemini-2.5-flash-lite"],enhancementLogLevel:"info",enhancementAlwaysFallback:!0,enhancementPresets:{standard:{name:"Standard Enhancement",description:"Default enhancement that improves prompt quality",template:'Convert this text into a focused visual description for image generation. Extract key visual elements (characters, setting, mood, style) and describe them as a direct prompt without narrative elements, dialogue, or markdown formatting. Keep it concise and focused on what can be visually rendered. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:'},safety:{name:"Safety Enhancement",description:"Enhances prompts while removing harmful or inappropriate content",template:'Enhance this prompt for image generation while ensuring content safety. Remove any harmful, inappropriate, or policy-violating elements. Focus on extracting positive, creative, and suitable visual elements. Transform the text into a clear, detailed visual description that promotes safe and appropriate imagery. Structure: subjects, setting, mood, style with safety-focused quality boosters like "safe content, appropriate, well-composed, detailed, sharp focus, 8K resolution, masterpiece":'},artistic:{name:"Artistic Enhancement",description:"Focuses on artistic and creative elements",template:'Transform this text into an artistic prompt for image generation. Emphasize creative elements, artistic techniques, visual aesthetics, and stylistic choices. Focus on artistic expression, color theory, composition, and visual appeal. Extract key artistic elements and describe them with rich, descriptive language that enhances creative vision. End with artistic quality boosters like "artistic masterpiece, creative composition, vibrant colors, detailed artwork, museum quality, fine art":'},technical:{name:"Technical Enhancement",description:"Emphasizes technical accuracy and detail",template:'Convert this text into a technically-focused image generation prompt. Emphasize technical accuracy, precise details, realistic elements, and measurable characteristics. Focus on technical specifications, realistic proportions, accurate details, and photographic quality. Structure the prompt with technical precision, ending with technical quality boosters like "photorealistic, technical precision, accurate details, high resolution, professional photography, sharp focus, 8K detail":'},character:{name:"Character Enhancement",description:"Focuses on character development and description",template:'Enhance this prompt by focusing on character development and description. Extract and elaborate on character details including appearance, expression, pose, clothing, age, and personality traits visible in the visual. Describe characters with rich detail, appropriate emotions, and engaging presentation. Focus on what makes the character compelling and well-defined. End with character-focused quality boosters like "detailed character, expressive features, well-defined personality, professional portrait, masterpiece character study":'},environment:{name:"Environment Enhancement",description:"Enhances environmental and setting descriptions",template:'Transform this prompt by emphasizing environmental and setting details. Focus on the surrounding environment, atmosphere, lighting, weather, architecture, nature, and spatial relationships. Describe the setting with immersive detail, creating a vivid sense of place and mood. Emphasize environmental storytelling and atmospheric elements. End with environmental quality boosters like "immersive environment, detailed background, atmospheric lighting, cinematic composition, 8K environmental detail":'},composition:{name:"Composition Enhancement",description:"Focuses on composition and visual structure",template:'Enhance this prompt by focusing on visual composition and structure. Emphasize framing, rule of thirds, leading lines, depth of field, visual balance, and photographic techniques. Describe how elements are arranged within the frame and their visual relationships. Focus on creating strong visual impact through careful composition. End with compositional quality boosters like "excellent composition, balanced framing, visual impact, professional photography, cinematic quality, masterpiece composition":'},clean:{name:"Clean Enhancement",description:"Removes potentially harmful or inappropriate elements",template:'Clean and enhance this prompt for appropriate image generation. Remove any potentially harmful, inappropriate, or problematic elements while preserving the core creative intent. Focus on family-friendly, positive, and suitable visual content. Transform the text into a clear, wholesome prompt that promotes appropriate imagery. Structure with positive, safe content and clean quality boosters like "appropriate content, family-friendly, positive imagery, clean composition, well-balanced, detailed, sharp focus":'}},enableNegPrompt:!0,globalNegPrompt:"ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality",googleApiKey:"",model:"imagen-4.0-generate-001",numberOfImages:1,imageSize:"1024",aspectRatio:"1:1",personGeneration:"allow_adult",aiHordeApiKey:"0000000000",aiHordeModel:"AlbedoBase XL (SDXL)",aiHordeSampler:"k_dpmpp_2m",aiHordeSteps:25,aiHordeCfgScale:7,aiHordeWidth:512,aiHordeHeight:512,aiHordePostProcessing:[],aiHordeSeed:"",pollinationsModel:"flux",pollinationsWidth:512,pollinationsHeight:512,pollinationsSeed:"",pollinationsEnhance:!0,pollinationsNologo:!1,pollinationsPrivate:!1,pollinationsSafe:!0,pollinationsToken:"",openAICompatProfiles:{},openAICompatActiveProfileUrl:"",openAICompatModelManualInput:!1,historyDays:30};async function f(e){return await GM_getValue(e,y[e])}async function b(){const e={};for(const n in y)e[n]=await GM_getValue(n,y[n]);return e}async function w(e,n){await GM_setValue(e,n)}async function x(){try{const e=await GM_getValue("history","[]");return"string"==typeof e&&e.trim()?JSON.parse(e):Array.isArray(e)?e:[]}catch(e){return console.error("Failed to parse history data, resetting",e),await GM_setValue("history","[]"),[]}}async function E(){try{const e=await GM_getValue("historyDays",y.historyDays),n=parseInt(e);return isNaN(n)||n<1||n>365?(console.warn("Invalid historyDays value, using default:",e),await I(y.historyDays),y.historyDays):n}catch(e){return console.error("Failed to get historyDays setting:",e),y.historyDays}}async function I(e){try{const n=parseInt(e);if(isNaN(n)||n<1||n>365)throw new Error(`Invalid historyDays value: ${e}. Must be between 1 and 365.`);return await GM_setValue("historyDays",n),!0}catch(e){throw console.error("Failed to set historyDays:",e),e}}async function k(){try{const e=await x(),n=await E(),t=new Date;t.setDate(t.getDate()-n);const i=e.filter(e=>new Date(e.date)>t),a=e.length-i.length;return a>0&&await GM_setValue("history",JSON.stringify(i)),a}catch(e){throw console.error("Failed to clean old history:",e),e}}let S=!1,A=[];async function C(){S=await f("loggingEnabled")}function P(e,n,t,i=null){if(!S)return;const a={timestamp:(new Date).toISOString(),level:e,category:n,message:t,data:i},o=`[NIG-${e.toUpperCase()}]`,r=`[${n}]`,s={error:"color: #ef4444",warn:"color: #f59e0b",debug:"color: #8b5cf6",info:"color: #6366f1"}[e];i?console.log(`%c${o}`,s,r,t,i):console.log(`%c${o}`,s,r,t),"ENHANCEMENT"===n&&(A.unshift(a),A.length>50&&(A=A.slice(0,50)),GM_setValue("enhancementLogHistory",JSON.stringify(A.slice(0,20))))}const T=(e,n,t)=>P("info",e,n,t),N=(e,n,t)=>P("debug",e,n,t),M=(e,n,t)=>P("warn",e,n,t),L=(e,n,t)=>P("error",e,n,t);async function H(){try{const e=await GM_getValue("enhancementLogHistory","[]");A="string"==typeof e&&e.trim()?JSON.parse(e):Array.isArray(e)?e:[],N("LOG",`Loaded ${A.length} enhancement log entries from storage`)}catch(e){L("LOG","Failed to load enhancement log history",e),A=[];try{await GM_setValue("enhancementLogHistory","[]")}catch(e){L("LOG","Failed to clear corrupted enhancement log history",e)}}}async function R(){return await H(),A}function O(e){return!(!e||"string"!=typeof e||0===e.trim().length||e.length>32e3)}function B(e,n="api"){if(!O(e))return e||"";const t=e,i=function(e){return e&&"string"==typeof e?e.replace(/\n{3,}/g,"\n\n").replace(/^\n+|\n+$/g,"").trim():e}(e);return t!==i&&function(e,n,t){"undefined"!=typeof window&&window.console&&console.log(`[PROMPT-CLEANING] [${t}]`,{originalLength:e?.length||0,cleanedLength:n?.length||0,wasCleaned:e!==n,originalPreview:e?.substring(0,100)+(e?.length>100?"...":""),cleanedPreview:n?.substring(0,100)+(n?.length>100?"...":"")})}(t,i,n),i}function G(e){return O(e)?function(e){return e&&"string"==typeof e?e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n\n").trim():e}(e):e||""}function F(e,n){N("ENHANCEMENT","Checking provider priority for enhancement",{provider:e,config:n});const t=(()=>{if("Pollinations"===e){const t=n.pollinationsEnhance;return T("ENHANCEMENT",`Provider ${e} has built-in enhancement: ${t}`),t}return T("ENHANCEMENT",`Provider ${e} does not have built-in enhancement`),!1})();return N("ENHANCEMENT","Provider priority decision completed",{shouldUseProviderEnhancement:t,willUseExternalAI:n.enhancementEnabled&&n.enhancementApiKey&&(!t||n.enhancementOverrideProvider)}),t}async function D(e,n){const t=Date.now(),{enhancementApiKey:i,enhancementModel:a,enhancementTemplate:o,enhancementMaxRetriesPerModel:r=2,enhancementRetryDelay:s=1e3,enhancementModelsFallback:l=["models/gemini-2.5-pro","models/gemini-flash-latest","models/gemini-flash-lite-latest","models/gemini-2.5-flash","models/gemini-2.5-flash-lite"],enhancementLogLevel:c="info",enhancementAlwaysFallback:d=!0}=n;if(!i)throw new Error("Gemini API key is required for prompt enhancement.");const g=[a,...l.filter(e=>e!==a)];T("ENHANCEMENT","Starting robust prompt enhancement with Gemini AI",{originalLength:e.length,primaryModel:a,fallbackModels:l,totalModels:g.length,maxRetriesPerModel:r,apiKeyPresent:!!i});let p=null;for(let n=0;n<g.length;n++){const a=g[n],l=a.startsWith("models/")?a.substring(7):a,c=0===n;T("ENHANCEMENT",`Attempting enhancement with model: ${l}`,{modelIndex:n+1,totalModels:g.length,isPrimaryModel:c,modelName:l});let d=0;for(;d<r;){d++;try{const a=await z(e,l,o,i,c),r=Date.now()-t;return T("ENHANCEMENT","Prompt enhancement successful",{model:l,attempts:d,duration:r,totalModelsTried:n+1}),a}catch(e){p=e,L("ENHANCEMENT",`Enhancement failed for model ${l} (attempt ${d}/${r})`,{model:l,attemptNumber:d,error:e.message,isPrimaryModel:c}),d<r&&(T("ENHANCEMENT",`Retrying model ${l} after delay`,{retryDelay:s,nextAttempt:d+1}),await _(s))}}logWarn("ENHANCEMENT",`Exhausted retries for model ${l}, switching to next model`,{model:l,attemptsMade:d,maxRetries:r,nextModelIndex:n+1,remainingModels:g.length-n-1})}const m=Date.now()-t;if(L("ENHANCEMENT","All models and retries exhausted for prompt enhancement",{totalModelsTried:g.length,duration:m,lastError:p?.message,originalPrompt:e.substring(0,100)+(e.length>100?"...":"")}),d){const n=function(e){let n=e;const t=["highly detailed","sharp focus","8K resolution","masterpiece"];return t.some(e=>n.toLowerCase().includes(e.toLowerCase()))||(n+=", "+t.join(", ")),n=n.replace(/,+/g,",").replace(/,\s*$/,""),n}(e);return T("ENHANCEMENT","Providing basic enhancement fallback",{fallbackType:"basic_enhancement",originalLength:e.length,fallbackLength:n.length}),n}throw new Error(`All enhancement models failed. Last error: ${p?.message||"Unknown error"}`)}async function z(e,n,t,i,a,o,r){const s=B(e,"gemini_enhancement"),l={contents:[{parts:[{text:t?`${t}\n\nOriginal prompt: "${s}"\n\nEnhanced prompt:`:`Convert this text into a focused visual description for image generation... \n\n"${s}"\n\nEnhanced version:`}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:65536}},c=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${i}`;return new Promise((e,n)=>{const t=a?45e3:3e4;GM_xmlhttpRequest({method:"POST",url:c,headers:{"Content-Type":"application/json"},data:JSON.stringify(l),timeout:t,onload:t=>{try{if(!t.responseText)throw new Error("Empty response received from Gemini API");const n=JSON.parse(t.responseText);if(n.error)throw new Error(n.error.message||"Gemini API error");if(!n.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("No enhancement result received from Gemini API");{const t=n.candidates[0].content.parts[0].text.trim().replace(/^["']|["']$/g,"");e(t)}}catch(e){n(e)}},onerror:e=>{n(new Error("Network error during enhancement request."))},ontimeout:()=>{n(new Error(`Enhancement request timed out after ${t/1e3} seconds.`))}})})}function _(e){return new Promise(n=>setTimeout(n,e))}async function q(){try{const e=await GM_getValue("cachedModels","{}");return"string"==typeof e&&e.trim()?JSON.parse(e):"object"==typeof e&&null!==e?e:{}}catch(e){return P("error","CACHE","Failed to parse cached models data, resetting cache",{error:e.message}),await GM_setValue("cachedModels","{}"),{}}}async function U(e){try{return(await q())[e]||null}catch(n){return P("error","CACHE",`Failed to get cached models for ${e}`,{error:n.message}),null}}async function $(e,n){try{const t=await q();t[e]=n,await GM_setValue("cachedModels",JSON.stringify(t)),P("info","CACHE",`Cached models for ${e}`)}catch(t){P("error","CACHE","Failed to cache models",{provider:e,error:t.message}),await GM_setValue("cachedModels","{}");try{cache[e]=n,await GM_setValue("cachedModels",JSON.stringify(cache)),P("info","CACHE",`Cached models for ${e} after cache reset`)}catch(n){P("error","CACHE","Failed to cache models even after reset",{provider:e,error:n.message})}}}async function j(e=null){try{if(e){const n=await q();delete n[e],await GM_setValue("cachedModels",JSON.stringify(n)),T("CACHE",`Cleared cached models for ${e}.`)}else await async function(){try{let e={};try{const n=await GM_getValue("openAICompatProfiles","{}");"string"==typeof n&&n.trim()?e=JSON.parse(n):"object"==typeof n&&null!==n&&(e=n)}catch(e){return void P("error","CACHE","Failed to get OpenAI profiles for cache clearing",{error:e.message})}for(const n of Object.keys(e)){const e=`openAICompatModels_${n}`;await GM_setValue(e,"[]")}T("CACHE","Cleared cached models for all OpenAI compatible providers.")}catch(e){P("error","CACHE","Failed to clear OpenAI compatible model caches",{error:e.message})}}(),await GM_setValue("cachedModels","{}"),T("CACHE","Cleared all cached models and reset OpenAI Compatible model selections."),alert("All cached models have been cleared. They will be re-fetched when you next open the settings.")}catch(n){P("error","CACHE","Failed to clear cached models",{provider:e,error:n.message});try{await GM_setValue("cachedModels","{}"),P("info","CACHE","Force reset cache data as fallback")}catch(e){P("error","CACHE","Failed to force reset cache",{error:e.message})}}}function W(e,n,t,i,{onSuccess:a,onFailure:o,updateStatus:r}){const s=Date.now()-t;N("AIHORDE","Checking AI Horde generation status",{generationId:e,elapsedTimeMs:s,promptPreview:n.substring(0,100)+(n.length>100?"...":"")}),GM_xmlhttpRequest({method:"GET",url:`https://aihorde.net/api/v2/generate/status/${e}`,onload:l=>{try{const c=JSON.parse(l.responseText);if(N("AIHORDE","AI Horde status response received",{generationId:e,responseData:c,isDone:c.done,queuePosition:c.queue_position,processing:c.processing,waitTime:c.wait_time}),c.done){const s=Date.now()-t;if(T("AIHORDE","AI Horde generation completed successfully",{generationId:e,imagesGenerated:c.generations?c.generations.length:0,totalElapsedTime:s}),!c.generations||0===c.generations.length)return L("AIHORDE","Generation completed but no images returned",{generationId:e,data:c}),void o("Generation completed but no images were returned",n,"AIHorde");r("Completed!");const l=c.generations.map(e=>e.img);a(l,n,"AIHorde",i)}else{let l="Waiting for worker...";if(c.queue_position>0)l=`Queue: ${c.queue_position}. Est: ${c.wait_time}s.`,T("AIHORDE","AI Horde generation waiting in queue",{generationId:e,queuePosition:c.queue_position,estimatedWaitTime:c.wait_time,statusText:l});else if(c.processing>0){const n=Math.floor(s/1e3),t=Math.floor(n/60),i=n%60,a=t>0?`${t}:${i.toString().padStart(2,"0")}`:`${i}s`;l=`AI Horde: Generating... (${a})`,T("AIHORDE","AI Horde generation actively processing",{generationId:e,processingWorkers:c.processing,elapsedTime:a,statusText:l})}else T("AIHORDE","AI Horde generation waiting for worker",{generationId:e,statusText:l});N("AIHORDE","Calling updateStatus callback",{generationId:e,statusText:l,elapsedTimeMs:s}),r(l),setTimeout(()=>W(e,n,t,i,{onSuccess:a,onFailure:o,updateStatus:r}),5e3)}}catch(t){L("AIHORDE","Error checking AI Horde status",{generationId:e,error:t.message,responseText:l.responseText}),o(`Error checking status: ${t.message}`,n,"AIHorde")}},onerror:t=>{L("AIHORDE","Failed to get status from AI Horde",{generationId:e,error:t}),o("Failed to get status from AI Horde.",n,"AIHorde")}})}async function K(e,{onSuccess:n,onFailure:t,updateStatus:i}){const a=await b(),{aiHordeApiKey:o,aiHordeModel:r,aiHordeSampler:s,aiHordeCfgScale:l,aiHordeSteps:c,aiHordeWidth:d,aiHordeHeight:g,aiHordeSeed:p,aiHordePostProcessing:m,enableNegPrompt:u,globalNegPrompt:h}=a,v=B(e,"aihorde_api");T("AIHORDE","Starting AI Horde generation",{promptLength:v.length,promptPreview:v.substring(0,100)+(v.length>100?"...":""),model:r,apiKeyProvided:!!o,hasNegativePrompt:u&&!!h});const y={sampler_name:s,cfg_scale:parseFloat(l),steps:parseInt(c,10),width:parseInt(d,10),height:parseInt(g,10)};p&&(y.seed=p),m.length>0&&(y.post_processing=m);const f={prompt:v,params:y,models:[r]};u&&h&&(f.negative_prompt=h),N("AIHORDE","Sending generation request to AI Horde",{url:"https://aihorde.net/api/v2/generate/async",model:r,params:y,hasNegativePrompt:!!f.negative_prompt}),i("Requesting..."),GM_xmlhttpRequest({method:"POST",url:"https://aihorde.net/api/v2/generate/async",headers:{"Content-Type":"application/json",apikey:o||"0000000000"},data:JSON.stringify(f),onload:a=>{try{const o=JSON.parse(a.responseText);if(N("AIHORDE","AI Horde API response received",{status:a.status,hasGenerationId:!!o.id,message:o.message,error:o.error}),!o.id){if(o.message&&o.message.toLowerCase().includes("model"))return L("AIHORDE","Model error from AI Horde API",{error:o.message,willRefreshModels:!0}),t(`Model error: ${o.message}. Refreshing model list.`,e,"AIHorde"),void j("aiHorde");throw L("AIHORDE","Failed to initiate generation",{error:o.message||"Unknown error",responseData:o}),new Error(o.message||"Failed to initiate generation.")}T("AIHORDE","AI Horde generation request accepted",{generationId:o.id,model:r}),i("Waiting for status..."),W(o.id,e,Date.now(),r,{onSuccess:n,onFailure:t,updateStatus:i})}catch(n){L("AIHORDE","Error processing AI Horde response",{error:n.message,responseText:a.responseText}),t(n.message,e,"AIHorde")}},onerror:n=>{L("AIHORDE","Network error during AI Horde request",{error:n}),t(JSON.stringify(n),e,"AIHorde")}})}var J=t(867),V=t(642);let Y=null,Q=()=>{},Z=()=>{};function X(){Y||(Y=document.createElement("div"),Y.id="nig-error-modal",Y.className="nig-modal-overlay",Y.style.display="none",Y.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Generation Failed</h2>\n            <p>The image could not be generated. Please review the reason below and adjust your prompt if necessary.</p>\n            <p><strong>Reason:</strong></p>\n            <div id="nig-error-reason"></div>\n            <p><strong>Your Prompt:</strong></p>\n            <textarea id="nig-error-prompt" class="nig-error-prompt"></textarea>\n            <div class="nig-form-group" style="margin-top: 15px;">\n                <label for="nig-retry-provider-select">Retry with Provider:</label>\n                <select id="nig-retry-provider-select"></select>\n            </div>\n            <div id="nig-error-actions" class="nig-error-actions"></div>\n        </div>',document.body.appendChild(Y),Y.querySelector(".nig-close-btn").addEventListener("click",()=>ee()))}function ee(){Y&&(Y.style.display="none"),"function"==typeof Z&&Z()}let ne=null,te=null;const ie=[{name:"None",description:"No additional styling will be added to your prompt.",subStyles:[]},{name:"Anime",description:"Blends Japanese animation with global twists. Sub-styles often mix eras, genres, or crossovers for dynamic outputs.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Anime style, ...").'},{name:"Studio Ghibli-Inspired",description:"Whimsical, nature-focused fantasy with soft lines and emotional depth.",value:"Studio Ghibli style, "},{name:"Cyberpunk Anime",description:"Neon-lit dystopias with high-tech mechs and gritty urban vibes.",value:"Cyberpunk anime style, "},{name:"Semi-Realistic Anime",description:"Blends lifelike proportions with expressive anime eyes and shading.",value:"Semi-realistic anime style, "},{name:"Mecha",description:"Giant robots and mechanical suits in epic battles.",value:"Mecha anime style, "},{name:"Dynamic Action",description:"High-energy movements with power effects and intense expressions.",value:"Dynamic action anime style, "},{name:"Soft Romantic",description:"Emotional interactions with gentle colors and sparkling accents.",value:"Soft romantic anime style, "},{name:"Dark Fantasy Anime",description:"Grim, horror-tinged worlds with demons and shadows.",value:"Dark fantasy anime style, "},{name:"Retro 80s Anime",description:"Vintage cel-shaded look with bold lines and synth vibes.",value:"80s retro anime style, "},{name:"Portal Fantasy",description:"World-crossing elements with magical adaptations and RPG motifs.",value:"Portal fantasy anime style, "},{name:"Slice-of-Life",description:"Everyday moments with relatable characters and cozy vibes.",value:"Slice-of-life anime style, "},{name:"Serialized Narrative",description:"Panel-like compositions for ongoing story flows.",value:"Serialized narrative anime style, "},{name:"Group Dynamic",description:"Interactions among multiple characters with balanced focus.",value:"Group dynamic anime style, "}]},{name:"Realism/Photorealism",description:"Excels in portraits and scenes mimicking photography, with sub-styles varying by subject or technique.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Realism/Photorealism style, ...").'},{name:"Hyperrealism",description:"Ultra-detailed, almost tangible textures and lighting.",value:"Hyperrealistic, "},{name:"Cinematic Realism",description:"Film-like depth with dramatic angles and color grading.",value:"Cinematic realism, "},{name:"Portrait Photorealism",description:"Human faces with natural skin, eyes, and expressions.",value:"Portrait photorealism, "},{name:"Architectural Realism",description:"Precise building renders with environmental details.",value:"Architectural realism, "},{name:"Nature Photorealism",description:"Verdant landscapes with dew and foliage intricacies.",value:"Nature photorealism, "},{name:"Close-Up Detail",description:"Intimate views highlighting textures and fine elements.",value:"Close-up realistic style, "},{name:"Historical Realism",description:"Period-accurate clothing and settings with grit.",value:"Historical realism, "},{name:"Urban Realism",description:"Bustling city life with crowds and neon realism.",value:"Urban realism, "},{name:"Stylized Realism",description:"Subtle artistic tweaks on photoreal bases.",value:"Stylized realism, "},{name:"Documentary Style",description:"Raw, unpolished scenes like news photography.",value:"Documentary photo style, "},{name:"Object Focus Realism",description:"Clear, highlighted items with neutral lighting.",value:"Object-focused realism, "},{name:"Wildlife Realism",description:"Animals in habitats with fur and feather fidelity.",value:"Wildlife realism, "},{name:"Detailed Portrait",description:"Lifelike faces with expressive features.",value:"Detailed portrait realism, "},{name:"Environmental Immersion",description:"Rich settings enveloping subjects.",value:"Environmental immersion realism, "}]},{name:"Fantasy",description:"Epic worlds of magic and myth, with sub-styles spanning tones from whimsical to grim.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Fantasy style, ...").'},{name:"High Fantasy",description:"Medieval realms with elves, dragons, and quests.",value:"High fantasy art, "},{name:"Dark Fantasy",description:"Grimdark horror with undead and moral ambiguity.",value:"Dark fantasy art, "},{name:"Urban Fantasy",description:"Magic in modern cities, like hidden witches.",value:"Urban fantasy art, "},{name:"Steampunk Fantasy",description:"Victorian tech with gears and airships.",value:"Steampunk fantasy style, "},{name:"Fairy Tale",description:"Whimsical tales with enchanted woods and creatures.",value:"Fairy tale illustration style, "},{name:"Heroic Adventure",description:"Bold explorers with raw magic and ancient relics.",value:"Heroic adventure fantasy art, "},{name:"Creature Emphasis",description:"Fantastical beings in natural or enchanted environments.",value:"Creature-focused fantasy art, "},{name:"Ethereal Grace",description:"Elegant figures in luminous, forested settings.",value:"Ethereal grace fantasy style, "},{name:"Rugged Craftsmanship",description:"Stout builders in forged, underground realms.",value:"Rugged craftsmanship fantasy style, "},{name:"Gothic Fantasy",description:"Haunted castles with vampires and storms.",value:"Gothic fantasy art, "},{name:"Beast Majesty",description:"Powerful scaled creatures in dramatic poses.",value:"Majestic beast fantasy art, "},{name:"Celestial Fantasy",description:"Starry realms with gods and floating islands.",value:"Celestial fantasy art, "},{name:"Oriental Myth",description:"Asian folklore elements with harmonious nature.",value:"Oriental myth fantasy style, "},{name:"Treasure Hunt Vibe",description:"Exploratory scenes with hidden wonders.",value:"Treasure hunt fantasy art, "}]},{name:"Sci-Fi",description:"Futuristic visions from gritty cyber worlds to cosmic explorations.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Sci-Fi style, ...").'},{name:"Cyberpunk",description:"Neon dystopias with hackers and megacorps.",value:"Cyberpunk style, "},{name:"Retro-Futurism",description:"1950s optimism with ray guns and chrome.",value:"Retro-futurism, "},{name:"Biopunk",description:"Organic tech with genetic mutations.",value:"Biopunk sci-fi style, "},{name:"Interstellar Epic",description:"Vast cosmic tales with diverse species and ships.",value:"Interstellar epic sci-fi art, "},{name:"Mechanical Suit",description:"Armored machines in high-tech conflicts.",value:"Mechanical suit sci-fi style, "},{name:"Post-Human",description:"Cyborgs and AI in evolved societies.",value:"Post-human sci-fi art, "},{name:"Hard Sci-Fi",description:"Physics-based realism with tech schematics.",value:"Hard sci-fi illustration, "},{name:"Dieselpunk",description:"1930s grit with riveted machines.",value:"Dieselpunk style, "},{name:"Astro-Mythology",description:"Space gods and cosmic myths.",value:"Astro-mythology art, "},{name:"Eco-Sci-Fi",description:"Post-apocalypse with bio-domes.",value:"Eco-sci-fi art, "},{name:"Survival Wasteland",description:"Harsh, ruined landscapes with resilient figures.",value:"Survival wasteland sci-fi style, "},{name:"Cosmic Discovery",description:"Unknown worlds with exploratory tech.",value:"Cosmic discovery sci-fi art, "}]},{name:"Retro/Vintage",description:"Nostalgic aesthetics from bygone eras, revived with AI flair.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Retro/Vintage style, ...").'},{name:"Art Deco",description:"Geometric luxury with gold and symmetry.",value:"Art Deco style, "},{name:"Art Nouveau",description:"Flowing organic lines and floral motifs.",value:"Art Nouveau style, "},{name:"Vintage Poster",description:"Bold typography and illustrative ads.",value:"Vintage poster style, "},{name:"Chromolithography",description:"Vibrant, printed color layers from 1900s.",value:"Chromolithography, "},{name:"Baroque",description:"Ornate drama with rich drapery.",value:"Baroque painting style, "},{name:"Ukiyo-e",description:"Japanese woodblock prints with flat colors.",value:"Ukiyo-e style, "},{name:"1950s Retro",description:"Atomic age optimism with pastels.",value:"1950s retro style, "},{name:"Playful Figure",description:"Charming, stylized poses with vintage flair.",value:"Playful vintage figure style, "},{name:"Edwardian",description:"Lacy elegance with soft pastels.",value:"Edwardian era style, "},{name:"Mid-Century Modern",description:"Clean lines and bold geometrics.",value:"Mid-century modern style, "},{name:"Ink Scroll",description:"Brush-like lines evoking ancient manuscripts.",value:"Ink scroll vintage style, "}]},{name:"Surrealism",description:"Dreamlike distortions challenging reality, inspired by masters.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Surrealism style, ...").'},{name:"Fluid Distortion",description:"Melting forms and impossible blends.",value:"Fluid distortion surrealism, "},{name:"Paradoxical Objects",description:"Everyday items in illogical arrangements.",value:"Paradoxical object surrealism, "},{name:"Ernst Collage Surreal",description:"Layered fragments for uncanny narratives.",value:"Ernst collage surrealism, "},{name:"Kahlo Autobiographical",description:"Personal symbolism with thorny motifs.",value:"Frida Kahlo style surrealism, "},{name:"Biomorphic Surreal",description:"Organic, creature-like hybrids.",value:"Biomorphic surrealism, "},{name:"Dreamlike Landscapes",description:"Floating islands and inverted gravity.",value:"Dreamlike surreal landscape, "},{name:"Freudian Symbolic",description:"Subconscious icons like eyes and stairs.",value:"Freudian symbolic surrealism, "},{name:"Pop Surrealism",description:"Whimsical grotesquery with candy colors.",value:"Pop surrealism, lowbrow art, "},{name:"Hyper-Surreal",description:"Exaggerated distortions in vivid detail.",value:"Hyper-surrealism, "},{name:"Eco-Surreal",description:"Nature twisted with human elements.",value:"Eco-surrealism, "},{name:"Mechanical Surreal",description:"Machines fused with flesh.",value:"Mechanical surrealism, "},{name:"Inner Vision",description:"Symbolic inner thoughts with blended realities.",value:"Inner vision surrealism, "}]},{name:"Cartoon/Illustration",description:"Exaggerated, narrative-driven visuals for fun and storytelling.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Cartoon/Illustration style, ...").'},{name:"Pixar 3D",description:"Polished, expressive CG with emotional arcs.",value:"Pixar 3D animation style, "},{name:"Disney Classic",description:"Hand-drawn whimsy with fluid animation.",value:"Classic Disney animation style, "},{name:"DreamWorks",description:"Edgy humor with detailed backgrounds.",value:"DreamWorks animation style, "},{name:"Adventure Time",description:"Surreal candy lands with bold shapes.",value:"Adventure Time cartoon style, "},{name:"Simpsons",description:"Yellow-skinned satire with clean outlines.",value:"The Simpsons cartoon style, "},{name:"Rick and Morty",description:"Sci-fi absurdity with warped perspectives.",value:"Rick and Morty cartoon style, "},{name:"Narrative Panel",description:"Sequential art with shaded storytelling.",value:"Narrative panel illustration style, "},{name:"Whimsical Illustration",description:"Gentle, colorful drawings for light-hearted scenes.",value:"Whimsical illustration style, "},{name:"Webtoon",description:"Vertical scroll with vibrant digital ink.",value:"Webtoon style, "},{name:"Manhua Flow",description:"Dynamic lines and vibrant digital shading.",value:"Manhua flow illustration style, "},{name:"Cover Art Focus",description:"Striking compositions for thematic highlights.",value:"Cover art illustration, "}]},{name:"Traditional Painting",description:"Emulates historical mediums like oils and watercolors for timeless appeal.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Traditional Painting style, ...").'},{name:"Impressionism",description:"Loose brushstrokes capturing light moments.",value:"Impressionist painting, "},{name:"Renaissance",description:"Balanced compositions with chiaroscuro.",value:"Renaissance painting style, "},{name:"Oil Painting",description:"Rich, layered textures with glazing.",value:"Oil painting, "},{name:"Watercolor",description:"Translucent washes for ethereal softness.",value:"Watercolor painting, "},{name:"Baroque",description:"Dramatic tenebrism and opulent details.",value:"Baroque painting, "},{name:"Romanticism",description:"Emotional storms and heroic figures.",value:"Romanticism painting, "},{name:"Pointillism",description:"Dot-based color mixing for vibrancy.",value:"Pointillism style, "},{name:"Fresco",description:"Mural-like with aged plaster effects.",value:"Fresco painting style, "},{name:"Encaustic",description:"Waxy, heated layers for luminous depth.",value:"Encaustic painting, "},{name:"Acrylic",description:"Bold, matte finishes with quick drying.",value:"Acrylic painting, "},{name:"Gouache",description:"Opaque vibrancy like matte poster paint.",value:"Gouache painting, "},{name:"Sumi-e",description:"Minimalist ink washes for Zen simplicity.",value:"Sumi-e ink wash painting, "},{name:"Oriental Brushwork",description:"Minimalist inks for balanced compositions.",value:"Oriental brushwork style, "},{name:"Era Line Art",description:"Detailed etchings for historical depth.",value:"Era line art traditional, "}]},{name:"Digital Art",description:"Modern, tech-infused creations from pixels to vectors.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Digital Art style, ...").'},{name:"Vector Illustration",description:"Scalable, flat colors with clean paths.",value:"Vector illustration, "},{name:"Blended Landscape",description:"Layered digital environments for immersive backdrops.",value:"Blended digital landscape, "},{name:"Neon Glow",description:"Vibrant outlines with electric luminescence.",value:"Neon glow digital art, "},{name:"Holographic",description:"Shimmering, 3D projections with refractions.",value:"Holographic style, "},{name:"World-Building Sketch",description:"Conceptual layers for expansive scenes.",value:"World-building digital sketch, "},{name:"Community Render",description:"Polished digital interpretations of characters.",value:"Community render digital style, "}]},{name:"Wuxia/Xianxia",description:"Eastern-inspired martial and spiritual themes with energy flows, ancient motifs, and harmonious or intense atmospheres.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Wuxia/Xianxia style, ...").'},{name:"Qi Energy Flow",description:"Subtle auras and internal power visualizations.",value:"Qi energy flow style, "},{name:"Martial Grace",description:"Fluid poses and disciplined movements.",value:"Martial grace style, "},{name:"Spiritual Realm",description:"Misty, elevated worlds with ethereal elements.",value:"Spiritual realm style, "},{name:"Ancient Sect Aesthetic",description:"Traditional architecture and robed figures.",value:"Ancient sect aesthetic, "},{name:"Demonic Shadow",description:"Darkened energies and mysterious silhouettes.",value:"Demonic shadow style, "},{name:"Dynasty Elegance",description:"Silk textures and jade accents in historical tones.",value:"Dynasty elegance style, "}]},{name:"Romance",description:"Tender or passionate human connections with soft lighting, expressions, and atmospheric details.",subStyles:[{name:"None",value:"none",description:'Use only the main style name as a prefix (e.g., "Romance style, ...").'},{name:"Gentle Intimacy",description:"Close, affectionate moments with warm hues.",value:"Gentle intimacy romance style, "},{name:"Urban Affection",description:"Modern settings with subtle romantic gestures.",value:"Urban affection style, "},{name:"Enchanted Bond",description:"Magical elements enhancing emotional ties.",value:"Enchanted bond romance style, "},{name:"Tension Build",description:"Subtle conflicts leading to connection.",value:"Tension build romance style, "},{name:"Blushing Softness",description:"Delicate emotions with pastel accents.",value:"Blushing softness style, "},{name:"Melancholic Yearning",description:"Poignant separations with evocative moods.",value:"Melancholic yearning romance art, "}]}],ae=[{name:"Deliberate",desc:"Versatile, high-quality realism and detail."},{name:"Anything Diffusion",desc:"Anime-style specialist."},{name:"ICBINP - I Can't Believe It's Not Photography",desc:"Photorealistic focus; excels in lifelike portraits."},{name:"stable_diffusion",desc:"The classic base model; reliable all-rounder."},{name:"AlbedoBase XL (SDXL)",desc:"SDXL variant; strong for high-res, detailed scenes."},{name:"Nova Anime XL",desc:"Anime and illustration; vibrant, dynamic characters."},{name:"Dreamshaper",desc:"Creative and dreamy outputs; good for artistic concepts."},{name:"Hentai Diffusion",desc:"NSFW/anime erotica specialist."},{name:"CyberRealistic Pony",desc:"Realistic with a cyberpunk twist."},{name:"Flux.1-Schnell fp8 (Compact)",desc:"Newer, fast-generation model for quick results."}];var oe=t(322);let re=null;function se(){const e=document.getElementById("nig-provider").value;document.querySelectorAll(".nig-provider-settings").forEach(e=>e.style.display="none");const n=document.getElementById(`nig-provider-${e}`);n&&(n.style.display="block")}function le(e){const n=document.getElementById("nig-sub-style"),t=document.getElementById("nig-main-style-desc"),i=document.getElementById("nig-sub-style-desc"),a=ie.find(n=>n.name===e);t.textContent=a?a.description:"",n.innerHTML="",a&&a.subStyles.length>0?(n.disabled=!1,a.subStyles.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.name,n.appendChild(t)}),n.dispatchEvent(new Event("change"))):(n.disabled=!0,i.textContent="")}function ce(e){const n=document.getElementById("nig-enhancement-settings");n&&(e?n.classList.remove("disabled"):n.classList.add("disabled"))}function de(e,n){const t=n.enhancementEnabled,i=n.enhancementApiKey&&n.enhancementApiKey.trim().length>0,a=F(e,n),o=document.getElementById("nig-provider-priority-info"),r=document.getElementById("nig-status-indicator"),s=document.getElementById("nig-status-text"),l=document.getElementById("nig-override-provider");t&&a&&!n.enhancementOverrideProvider?(o.style.display="block",r.className="nig-status-indicator provider-active",s.textContent="Provider Enhancement Active",l&&(l.style.display="inline-block")):(o.style.display="none",t&&i?(r.className="nig-status-indicator external-active",s.textContent="External AI Enhancement Active"):t?(r.className="nig-status-indicator disabled",s.textContent="Enhancement Enabled (No API Key)"):(r.className="nig-status-indicator disabled",s.textContent="Enhancement Disabled"),l&&(l.style.display="none"))}async function ge(){const e=await b();document.getElementById("nig-provider").value=e.selectedProvider;const n=document.getElementById("nig-main-style");n.innerHTML="",ie.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,n.appendChild(t)}),n.value=e.mainPromptStyle,le(e.mainPromptStyle),document.getElementById("nig-sub-style").value=e.subPromptStyle,document.getElementById("nig-sub-style").dispatchEvent(new Event("change"));const t=document.getElementById("nig-custom-style-enable"),i=document.getElementById("nig-custom-style-text");t.checked=e.customStyleEnabled,i.value=e.customStyleText,i.disabled=!e.customStyleEnabled,document.getElementById("nig-enhancement-enabled").checked=e.enhancementEnabled,document.getElementById("nig-gemini-api-key").value=e.enhancementApiKey,document.getElementById("nig-enhancement-model").value=e.enhancementModel,await async function(e){const n=document.getElementById("nig-enhancement-template-select"),t=document.getElementById("nig-enhancement-template");let i="standard";if(e.enhancementTemplateSelected)i=e.enhancementTemplateSelected;else for(const[n,t]of Object.entries(y.enhancementPresets))if(e.enhancementTemplate===t.template){i=n;break}if(n.value=i,"custom"===i)t.disabled=!1;else{const e=y.enhancementPresets[i];e&&(t.value=e.template,t.disabled=!0)}}(e),ce(e.enhancementEnabled),de(e.selectedProvider,e),e.enhancementApiKey.trim().length>0&&(document.getElementById("nig-enhancement-preview").style.display="block"),document.getElementById("nig-enable-neg-prompt").checked=e.enableNegPrompt,document.getElementById("nig-global-neg-prompt").value=e.globalNegPrompt,document.getElementById("nig-pollinations-width").value=e.pollinationsWidth,document.getElementById("nig-pollinations-height").value=e.pollinationsHeight,document.getElementById("nig-pollinations-seed").value=e.pollinationsSeed,document.getElementById("nig-pollinations-enhance").checked=e.pollinationsEnhance,document.getElementById("nig-pollinations-safe").checked=e.pollinationsSafe,document.getElementById("nig-pollinations-nologo").checked=e.pollinationsNologo,document.getElementById("nig-pollinations-private").checked=e.pollinationsPrivate,document.getElementById("nig-pollinations-token").value=e.pollinationsToken,async function(e){const n=document.getElementById("nig-pollinations-model");n.innerHTML="<option>Loading models...</option>";try{const t=await U("pollinations");if(t&&t.length>0)return T("CACHE","Loading Pollinations models from cache"),void me(n,t,e)}catch(e){L("CACHE","Failed to get cached Pollinations models",{error:e.message})}T("NETWORK","Fetching Pollinations models from API"),GM_xmlhttpRequest({method:"GET",url:"https://image.pollinations.ai/models",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async t=>{try{const i=JSON.parse(t.responseText);await $("pollinations",i),T("NETWORK","Fetched and cached Pollinations models",{count:i.length}),me(n,i,e)}catch(e){L("NETWORK","Failed to parse Pollinations models",{error:e.message}),n.innerHTML="<option>flux</option>",n.value="flux"}},onerror:e=>{L("NETWORK","Failed to fetch Pollinations models",{error:e}),n.innerHTML="<option>flux</option>",n.value="flux"}})}(e.pollinationsModel),document.getElementById("nig-horde-api-key").value=e.aiHordeApiKey,document.getElementById("nig-horde-sampler").value=e.aiHordeSampler,document.getElementById("nig-horde-steps").value=e.aiHordeSteps,document.getElementById("nig-horde-cfg").value=e.aiHordeCfgScale,document.getElementById("nig-horde-width").value=e.aiHordeWidth,document.getElementById("nig-horde-height").value=e.aiHordeHeight,document.getElementById("nig-horde-seed").value=e.aiHordeSeed,document.querySelectorAll('input[name="nig-horde-post"]').forEach(n=>{n.checked=e.aiHordePostProcessing.includes(n.value)}),async function(e){const n=document.getElementById("nig-horde-model");n.innerHTML="<option>Loading models...</option>";try{const t=await U("aiHorde");if(t&&t.length>0)return T("CACHE","Loading AI Horde models from cache"),void ue(n,t,e)}catch(e){L("CACHE","Failed to get cached AI Horde models",{error:e.message})}T("NETWORK","Fetching AI Horde models from API"),GM_xmlhttpRequest({method:"GET",url:"https://aihorde.net/api/v2/status/models?type=image",onload:async t=>{try{const i=JSON.parse(t.responseText);await $("aiHorde",i),T("NETWORK","Fetched and cached AI Horde models",{count:i.length}),ue(n,i,e)}catch(e){L("NETWORK","Failed to parse AI Horde models",{error:e.message}),n.innerHTML="<option>Stable Diffusion</option>",n.value="Stable Diffusion"}},onerror:e=>{L("NETWORK","Failed to fetch AI Horde models",{error:e}),n.innerHTML="<option>Stable Diffusion</option>",n.value="Stable Diffusion"}})}(e.aiHordeModel),document.getElementById("nig-google-api-key").value=e.googleApiKey,document.getElementById("nig-model").value=e.model,document.getElementById("nig-num-images").value=e.numberOfImages,document.getElementById("nig-image-size").value=e.imageSize,document.getElementById("nig-aspect-ratio").value=e.aspectRatio,document.getElementById("nig-person-gen").value=e.personGeneration,await ye(),e.openAICompatModelManualInput?(document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"):(document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none");const a=await E();document.getElementById("nig-history-clean-days").value=a,se()}async function pe(){await w("mainPromptStyle",document.getElementById("nig-main-style").value),await w("subPromptStyle",document.getElementById("nig-sub-style").value),await w("customStyleEnabled",document.getElementById("nig-custom-style-enable").checked),await w("customStyleText",document.getElementById("nig-custom-style-text").value.trim()),await w("enhancementEnabled",document.getElementById("nig-enhancement-enabled").checked),await w("enhancementApiKey",document.getElementById("nig-gemini-api-key").value.trim()),await w("enhancementModel",document.getElementById("nig-enhancement-model").value),await w("enhancementTemplate",document.getElementById("nig-enhancement-template").value.trim()),await w("enhancementTemplateSelected",document.getElementById("nig-enhancement-template-select").value),await w("enableNegPrompt",document.getElementById("nig-enable-neg-prompt").checked),await w("globalNegPrompt",document.getElementById("nig-global-neg-prompt").value.trim()),await w("selectedProvider",document.getElementById("nig-provider").value),await w("pollinationsModel",document.getElementById("nig-pollinations-model").value),await w("pollinationsWidth",document.getElementById("nig-pollinations-width").value),await w("pollinationsHeight",document.getElementById("nig-pollinations-height").value),await w("pollinationsSeed",document.getElementById("nig-pollinations-seed").value.trim()),await w("pollinationsEnhance",document.getElementById("nig-pollinations-enhance").checked),await w("pollinationsSafe",document.getElementById("nig-pollinations-safe").checked),await w("pollinationsNologo",document.getElementById("nig-pollinations-nologo").checked),await w("pollinationsPrivate",document.getElementById("nig-pollinations-private").checked),await w("pollinationsToken",document.getElementById("nig-pollinations-token").value.trim()),await w("aiHordeApiKey",document.getElementById("nig-horde-api-key").value.trim()||"0000000000"),await w("aiHordeModel",document.getElementById("nig-horde-model").value),await w("aiHordeSampler",document.getElementById("nig-horde-sampler").value),await w("aiHordeSteps",document.getElementById("nig-horde-steps").value),await w("aiHordeCfgScale",document.getElementById("nig-horde-cfg").value),await w("aiHordeWidth",document.getElementById("nig-horde-width").value),await w("aiHordeHeight",document.getElementById("nig-horde-height").value),await w("aiHordeSeed",document.getElementById("nig-horde-seed").value.trim());const e=Array.from(document.querySelectorAll('input[name="nig-horde-post"]:checked')).map(e=>e.value);await w("aiHordePostProcessing",e),await w("googleApiKey",document.getElementById("nig-google-api-key").value.trim()),await w("model",document.getElementById("nig-model").value),await w("numberOfImages",document.getElementById("nig-num-images").value),await w("imageSize",document.getElementById("nig-image-size").value),await w("aspectRatio",document.getElementById("nig-aspect-ratio").value),await w("personGeneration",document.getElementById("nig-person-gen").value);const n=document.getElementById("nig-openai-compat-base-url").value.trim();if(n){const e=await f("openAICompatProfiles"),t="none"!==document.getElementById("nig-openai-model-container-manual").style.display,i=t?document.getElementById("nig-openai-compat-model-manual").value.trim():document.getElementById("nig-openai-compat-model").value;e[n]={apiKey:document.getElementById("nig-openai-compat-api-key").value.trim(),model:i},await w("openAICompatProfiles",e),await w("openAICompatActiveProfileUrl",n),await w("openAICompatModelManualInput",t),await ye()}alert("Configuration saved!")}function me(e,n,t){e.innerHTML="",n.forEach(n=>{const t=document.createElement("option");t.value=n;let i=n;"gptimage"===n?i+=" (Recommended: Quality)":"flux"===n&&(i+=" (Default: Speed)"),t.textContent=i,e.appendChild(t)}),n.includes(t)?e.value=t:e.value="flux"}function ue(e,n,t){e.innerHTML="";const i=new Map(n.map(e=>[e.name,e])),a=new Set(ae.map(e=>e.name)),o=document.createElement("optgroup");o.label="Top 10 Popular Models";const r=document.createElement("optgroup");r.label="Other Models",ae.forEach(e=>{if(i.has(e.name)){const n=i.get(e.name),t=document.createElement("option");t.value=e.name,t.textContent=`${e.name} - ${e.desc} (${n.count} workers)`,o.appendChild(t)}}),n.filter(e=>!a.has(e.name)).sort((e,n)=>n.count-e.count).forEach(e=>{const n=document.createElement("option");n.value=e.name,n.textContent=`${e.name} (${e.count} workers)`,r.appendChild(n)}),e.appendChild(o),e.appendChild(r),Array.from(e.options).some(e=>e.value===t)?e.value=t:e.value=n[0]?.name||"Stable Diffusion"}function he(e){return"boolean"==typeof e.is_free?e.is_free:"boolean"==typeof e.premium_model?!e.premium_model:!(!Array.isArray(e.tiers)||!e.tiers.includes("Free"))}function ve(e,n,t){e.innerHTML="";const i=document.createElement("optgroup");i.label="Free Models";const a=document.createElement("optgroup");a.label="Paid Models",n.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.id,he(e)?i.appendChild(n):a.appendChild(n)}),i.childElementCount>0&&e.appendChild(i),a.childElementCount>0&&e.appendChild(a),n.some(e=>e.id===t)&&(e.value=t)}async function ye(){const e=document.getElementById("nig-openai-compat-profile-select"),n=await b(),t=n.openAICompatProfiles||{},i=n.openAICompatActiveProfileUrl;e.innerHTML="",Object.keys(t).forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)});const a=document.createElement("option");a.value="__new__",a.textContent="â€” Add or Edit Profile â€”",e.appendChild(a),i&&t[i]?e.value=i:e.value="__new__",fe()}async function fe(){const e=document.getElementById("nig-openai-compat-profile-select"),n=await b(),t=n.openAICompatProfiles||{},i=e.value;if(i&&t[i]){const e=t[i];document.getElementById("nig-openai-compat-base-url").value=i,document.getElementById("nig-openai-compat-api-key").value=e.apiKey,n.openAICompatModelManualInput?document.getElementById("nig-openai-compat-model-manual").value=e.model:(document.getElementById("nig-openai-compat-model").value=e.model,async function(e,n){const t=document.getElementById("nig-openai-compat-model"),i=await async function(e){try{const n=`openAICompatModels_${e}`,t=await GM_getValue(n,"[]");return"string"==typeof t&&t.trim()?JSON.parse(t):Array.isArray(t)?t:[]}catch(n){return P("error","CACHE","Failed to parse OpenAI compatible models cache",{profileUrl:e,error:n.message}),[]}}(e);i&&i.length>0?ve(t,i,n):t.innerHTML="<option>No cached models. Click Fetch to get models.</option>"}(i,e.model))}else document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>"}async function be(){const e=document.getElementById("nig-openai-compat-profile-select").value;if("__new__"!==e){if(confirm(`Delete profile for "${e}"?`)){const n=(await b()).openAICompatProfiles||{};delete n[e],await w("openAICompatProfiles",n),document.getElementById("nig-openai-compat-base-url").value="",document.getElementById("nig-openai-compat-api-key").value="",document.getElementById("nig-openai-compat-model").innerHTML="<option>Enter URL/Key and fetch...</option>",document.getElementById("nig-openai-compat-model-manual").value="",await ye()}}else alert("You can't delete the 'Add New' option.")}async function we(){const e=await b(),n=JSON.stringify(e,null,2),t=`wtr-lab-image-generator-config-${(new Date).toISOString().split("T")[0]}.json`;oe.P(t,n,"application/json")}async function xe(e){const n=e.target.files[0];if(n){try{const e=await n.text(),t=JSON.parse(e);confirm("This will overwrite all current settings. Continue?")&&(Object.keys(t).forEach(e=>{w(e,t[e])}),alert("Configuration imported successfully!"),await ge())}catch(e){alert(`Failed to import configuration: ${e.message}`)}e.target.value=""}}async function Ee(){const e=document.getElementById("nig-history-list"),n=await async function(){try{const e=await x(),n=await E(),t=new Date;return t.setDate(t.getDate()-n),e.filter(e=>new Date(e.date)>t)}catch(e){return console.error("Failed to get filtered history:",e),await x()}}();e.innerHTML="",0!==n.length?n.forEach(n=>{const i=document.createElement("li");i.className="nig-history-item";const a=n.provider?`<strong>${n.provider}</strong>`:"",o=n.model?`(${n.model})`:"";i.innerHTML=`<small>${new Date(n.date).toLocaleString()} - ${a} ${o}</small>\n                      <small><em>${n.prompt.substring(0,70)}...</em></small>`;const r=document.createElement("a");r.href="#",r.textContent="View Generated Image",r.addEventListener("click",e=>{e.preventDefault(),Promise.resolve().then(t.bind(t,642)).then(e=>{"function"==typeof e.show&&e.show([n.url],n.prompt,n.provider)})}),i.appendChild(r),e.appendChild(i)}):e.innerHTML="<li>No history yet.</li>"}async function Ie(){const e=document.getElementById("nig-history-clean-days").value,n=parseInt(e);if(isNaN(n)||n<1||n>365)alert("Please enter a valid number of days (1-365).");else try{await I(n);const e=await k();e>0?alert(`History cleaned successfully! Removed ${e} old entries.`):alert("History cleaned successfully! No old entries to remove."),await Ee()}catch(e){console.error("Failed to clean history:",e),alert("Failed to clean history. Please try again.")}}function ke(){if(re)return;re=document.createElement("div"),re.id="nig-config-panel",re.className="nig-modal-overlay",re.style.display="none",re.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Image Generator Configuration</h2>\n            <div class="nig-tabs">\n                <div class="nig-tab active" data-tab="config">Configuration</div>\n                <div class="nig-tab" data-tab="styling">Prompt Styling</div>\n                <div class="nig-tab" data-tab="history">History</div>\n                <div class="nig-tab" data-tab="utilities">Utilities</div>\n            </div>\n            <div id="nig-config-tab" class="nig-tab-content active">\n                <div class="nig-config-grid">\n                    <div class="nig-config-section">\n                        <div class="nig-form-group">\n                            <label for="nig-provider">Image Provider</label>\n                            <select id="nig-provider">\n                                <option value="Pollinations">Pollinations.ai (Free, Simple)</option>\n                                <option value="AIHorde">AI Horde (Free, Advanced)</option>\n                                <option value="OpenAICompat">OpenAI Compatible (Custom)</option>\n                                <option value="Google">Google Imagen (Requires Billed Account)</option>\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class="nig-provider-container">\n                        <div id="nig-provider-Pollinations" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>Pollinations.ai Settings</h3>\n                                <p>Fast, simple image generation with advanced model options</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-model">Model</label>\n                                <select id="nig-pollinations-model">\n                                    <option>Loading models...</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group-inline">\n                                <div>\n                                    <label for="nig-pollinations-width">Width</label>\n                                    <input type="number" id="nig-pollinations-width" min="64" max="2048" step="64">\n                                </div>\n                                <div>\n                                    <label for="nig-pollinations-height">Height</label>\n                                    <input type="number" id="nig-pollinations-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-seed">Seed (optional)</label>\n                                <input type="text" id="nig-pollinations-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Options</label>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-pollinations-enhance">Enhance Prompt</label>\n                                    <label><input type="checkbox" id="nig-pollinations-safe">Safe Mode (NSFW Filter)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-nologo">No Logo (Registered Users)</label>\n                                    <label><input type="checkbox" id="nig-pollinations-private">Private (Won\'t appear in feed)</label>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-pollinations-token">API Token (Optional)</label>\n                                <input type="password" id="nig-pollinations-token" placeholder="Enter token for premium models">\n                                <small class="nig-hint">Get a token from <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> for higher rate limits and access to restricted models.</small>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-AIHorde" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>AI Horde Settings</h3>\n                                <p>Community-powered generation with extensive customization</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-api-key">AI Horde API Key</label>\n                                <input type="password" id="nig-horde-api-key" placeholder="Defaults to \'0000000000\'">\n                                <small>Use anonymous key or get your own from <a href="https://aihorde.net/" target="_blank" class="nig-api-prompt-link">AI Horde</a> for higher priority.</small>\n                            </div>\n                            <div class="nig-provider-controls">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-model">Model</label>\n                                    <select id="nig-horde-model">\n                                        <option>Loading models...</option>\n                                    </select>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-sampler">Sampler</label>\n                                    <select id="nig-horde-sampler">\n                                        <option value="k_dpmpp_2m">DPM++ 2M</option>\n                                        <option value="k_euler_a">Euler A</option>\n                                        <option value="k_euler">Euler</option>\n                                        <option value="k_lms">LMS</option>\n                                        <option value="k_heun">Heun</option>\n                                        <option value="k_dpm_2">DPM 2</option>\n                                        <option value="k_dpm_2_a">DPM 2 A</option>\n                                        <option value="k_dpmpp_2s_a">DPM++ 2S A</option>\n                                        <option value="k_dpmpp_sde">DPM++ SDE</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-steps">Steps</label>\n                                    <input type="number" id="nig-horde-steps" min="10" max="50" step="1">\n                                    <small class="nig-hint">More steps = more detail, but slower.</small>\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-cfg">CFG Scale</label>\n                                    <input type="number" id="nig-horde-cfg" min="1" max="20" step="0.5">\n                                    <small class="nig-hint">How strictly to follow the prompt.</small>\n                                </div>\n                            </div>\n                            <div class="nig-form-grid">\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-width">Width</label>\n                                    <input type="number" id="nig-horde-width" min="64" max="2048" step="64">\n                                </div>\n                                <div class="nig-form-group">\n                                    <label for="nig-horde-height">Height</label>\n                                    <input type="number" id="nig-horde-height" min="64" max="2048" step="64">\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-horde-seed">Seed (optional)</label>\n                                <input type="text" id="nig-horde-seed" placeholder="Leave blank for random">\n                            </div>\n                            <div class="nig-form-group">\n                                <label>Post-Processing</label>\n                                <small class="nig-hint">Improves faces. Use only if generating people.</small>\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" name="nig-horde-post" value="GFPGAN">GFPGAN</label>\n                                    <label><input type="checkbox" name="nig-horde-post" value="CodeFormers">CodeFormers</label>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-Google" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>Google Imagen Settings</h3>\n                                <p>High-quality generation powered by Google\'s advanced AI</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-google-api-key">Gemini API Key</label>\n                                <input type="password" id="nig-google-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-model">Imagen Model</label>\n                                <select id="nig-model">\n                                    <option value="imagen-4.0-generate-001">Imagen 4.0 Standard</option>\n                                    <option value="imagen-4.0-ultra-generate-001">Imagen 4.0 Ultra</option>\n                                    <option value="imagen-4.0-fast-generate-001">Imagen 4.0 Fast</option>\n                                    <option value="imagen-3.0-generate-002">Imagen 3.0 Standard</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-num-images">Number of Images (1-4)</label>\n                                <input type="number" id="nig-num-images" min="1" max="4" step="1">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-image-size">Image Size</label>\n                                <select id="nig-image-size">\n                                    <option value="1024">1K</option>\n                                    <option value="2048">2K</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-aspect-ratio">Aspect Ratio</label>\n                                <select id="nig-aspect-ratio">\n                                    <option value="1:1">1:1</option>\n                                    <option value="3:4">3:4</option>\n                                    <option value="4:3">4:3</option>\n                                    <option value="9:16">9:16</option>\n                                    <option value="16:9">16:9</option>\n                                </select>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-person-gen">Person Generation</label>\n                                <select id="nig-person-gen">\n                                    <option value="dont_allow">Don\'t Allow</option>\n                                    <option value="allow_adult">Allow Adults</option>\n                                    <option value="allow_all">Allow All</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div id="nig-provider-OpenAICompat" class="nig-provider-settings">\n                            <div class="nig-provider-header">\n                                <h3>OpenAI Compatible Settings</h3>\n                                <p>Connect to any OpenAI-compatible API endpoint</p>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-profile-select">Saved Profiles</label>\n                                <div class="nig-form-group-inline">\n                                    <select id="nig-openai-compat-profile-select"></select>\n                                    <button id="nig-openai-compat-delete-profile" class="nig-delete-btn">Delete</button>\n                                </div>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-base-url">Base URL</label>\n                                <input type="text" id="nig-openai-compat-base-url" placeholder="e.g., https://api.example.com/v1">\n                                <small class="nig-hint">For a list of free public providers, check out the <a href="https://github.com/zukixa/cool-ai-stuff" target="_blank" class="nig-api-prompt-link">cool-ai-stuff</a> repository.</small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-api-key">API Key</label>\n                                <input type="password" id="nig-openai-compat-api-key">\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-openai-compat-model">Model</label>\n                                <div id="nig-openai-model-container-select">\n                                    <div class="nig-form-group-inline">\n                                        <select id="nig-openai-compat-model" style="width: 100%;">\n                                            <option>Enter URL/Key and fetch...</option>\n                                        </select>\n                                        <button id="nig-openai-compat-fetch-models" class="nig-fetch-models-btn">Fetch</button>\n                                    </div>\n                                    <small class=" nig-hint">If fetching fails or your model isn\'t listed, <a href="#" id="nig-openai-compat-switch-to-manual" class="nig-api-prompt-link">switch to manual input</a>.</small>\n                                </div>\n                                <div id="nig-openai-model-container-manual" style="display: none;">\n                                    <input type="text" id="nig-openai-compat-model-manual" placeholder="e.g., dall-e-3">\n                                    <small class=" nig-hint">Manually enter the model name. <a href="#" id="nig-openai-compat-switch-to-select" class="nig-api-prompt-link">Switch back to fetched list</a>.</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-styling-tab" class="nig-tab-content">\n                <div class="nig-styling-container">\n                    <div class="nig-styling-intro">\n                        <p>Select a style to automatically add it to the beginning of every prompt. This helps maintain a consistent look across all providers.</p>\n                    </div>\n\n                    <div class="nig-style-grid">\n                        <div class="nig-style-section">\n                            <div class="nig-form-group">\n                                <label for="nig-main-style">Main Style</label>\n                                <select id="nig-main-style"></select>\n                                <small id="nig-main-style-desc" class="nig-hint"></small>\n                            </div>\n                            <div class="nig-form-group">\n                                <label for="nig-sub-style">Sub-Style</label>\n                                <select id="nig-sub-style"></select>\n                                <small id="nig-sub-style-desc" class="nig-hint"></small>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>\n                                    <span class="material-symbols-outlined">auto_awesome</span>\n                                    AI Prompt Enhancement\n                                    <span class="nig-enhancement-status" id="nig-enhancement-status">\n                                        <span class="nig-status-indicator" id="nig-status-indicator"></span>\n                                        <span id="nig-status-text">Enhancement Disabled</span>\n                                    </span>\n                                </h4>\n                            </div>\n\n                            <div class="nig-enhancement-content">\n                                <div class="nig-form-group">\n                                    <div class="nig-checkbox-group">\n                                        <label><input type="checkbox" id="nig-enhancement-enabled">Enable AI Prompt Enhancement</label>\n                                    </div>\n                                    <small class="nig-hint">Uses AI to automatically enhance prompts for better results. Provider enhancement takes priority when available.</small>\n                                </div>\n\n                                <div class="nig-provider-priority-info" id="nig-provider-priority-info" style="display: none;">\n                                    <div class="nig-priority-header">\n                                        <span class="material-symbols-outlined">priority_high</span>\n                                        Provider Enhancement Active\n                                    </div>\n                                    <p id="nig-priority-message">Pollinations AI enhancement is enabled and will be used instead of external AI enhancement.</p>\n                                    <button class="nig-override-btn" id="nig-override-provider">Force Use External AI</button>\n                                </div>\n\n                                <div class="nig-enhancement-settings disabled" id="nig-enhancement-settings">\n                                    <div class="nig-form-group">\n                                        <label for="nig-gemini-api-key">Gemini API Key</label>\n                                        <input type="password" id="nig-gemini-api-key" placeholder="Enter your Google Gemini API key">\n                                        <small class="nig-hint">Get a free API key from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a></small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-model">Enhancement Model</label>\n                                        <select id="nig-enhancement-model">\n                                            <option value="models/gemini-2.5-pro">Gemini 2.5 Pro (High Quality)</option>\n                                            <option value="models/gemini-flash-latest">Gemini Flash Latest (Fast)</option>\n                                            <option value="models/gemini-flash-lite-latest">Gemini Flash Lite (Ultra Fast)</option>\n                                            <option value="models/gemini-2.5-flash">Gemini 2.5 Flash (Balanced)</option>\n                                            <option value="models/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Efficient)</option>\n                                        </select>\n                                        <small class="nig-hint">Choose model based on your needs: quality vs speed</small>\n                                    </div>\n\n                                    <div class="nig-form-group">\n                                        <label for="nig-enhancement-template">Custom Enhancement Prompt</label>\n                                        <div class="nig-enhancement-template-section">\n                                            <div class="nig-form-group">\n                                                <label for="nig-enhancement-template-select">Enhancement Template</label>\n                                                <select id="nig-enhancement-template-select">\n                                                    <option value="standard">Standard Enhancement - Default enhancement that improves prompt quality</option>\n                                                    <option value="safety">Safety Enhancement - Enhances prompts while removing harmful content</option>\n                                                    <option value="artistic">Artistic Enhancement - Focuses on artistic and creative elements</option>\n                                                    <option value="technical">Technical Enhancement - Emphasizes technical accuracy and detail</option>\n                                                    <option value="character">Character Enhancement - Focuses on character development</option>\n                                                    <option value="environment">Environment Enhancement - Enhances environmental descriptions</option>\n                                                    <option value="composition">Composition Enhancement - Focuses on composition and visual structure</option>\n                                                    <option value="clean">Clean Enhancement - Removes potentially harmful elements</option>\n                                                    <option value="custom">Custom Enhancement Prompt</option>\n                                                </select>\n                                                <small class="nig-hint">Choose a preset enhancement prompt or select \'Custom\' to create your own. Preset prompts include safety features to remove harmful content.</small>\n                                            </div>\n                                            <textarea id="nig-enhancement-template" rows="3" placeholder="Enter custom enhancement instructions..."></textarea>\n                                            <div class="nig-form-group-inline">\n                                                <button class="nig-template-btn" id="nig-template-reset">Reset to Preset</button>\n                                                <button class="nig-template-btn" id="nig-template-example">Load Example</button>\n                                            </div>\n                                            <small class="nig-hint">Customize how the AI enhances prompts. Leave empty for intelligent enhancement.</small>\n                                        </div>\n                                    </div>\n\n                                    <div class="nig-enhancement-preview" id="nig-enhancement-preview" style="display: none;">\n                                        <div class="nig-preview-container">\n                                            <div class="nig-preview-section">\n                                                <h5>Original Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-original-prompt"></div>\n                                            </div>\n                                            <div class="nig-preview-arrow">\n                                                <span class="material-symbols-outlined">arrow_forward</span>\n                                            </div>\n                                            <div class="nig-preview-section">\n                                                <h5>Enhanced Prompt</h5>\n                                                <div class="nig-prompt-display" id="nig-enhanced-prompt"></div>\n                                            </div>\n                                        </div>\n                                        <button class="nig-test-enhancement-btn" id="nig-test-enhancement">\n                                            <span class="material-symbols-outlined">auto_awesome</span>\n                                            Test Enhancement\n                                        </button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Custom Style</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-custom-style-enable">Enable Custom Style</label>\n                                </div>\n                                <small class="nig-hint">Overrides the Main/Sub-style dropdowns with your own text.</small>\n                                <textarea id="nig-custom-style-text" placeholder="e.g., In the style of Van Gogh, oil painting, ..."></textarea>\n                            </div>\n                        </div>\n\n                        <div class="nig-style-section">\n                            <div class="nig-section-header">\n                                <h4>Negative Prompting (Global)</h4>\n                            </div>\n                            <div class="nig-form-group">\n                                <div class="nig-checkbox-group">\n                                    <label><input type="checkbox" id="nig-enable-neg-prompt">Enable Negative Prompting</label>\n                                </div>\n                                <small class="nig-hint">This negative prompt will be applied to all providers when enabled.</small>\n                                <textarea id="nig-global-neg-prompt" placeholder="e.g., ugly, blurry, deformed, disfigured, poor details, bad anatomy, low quality"></textarea>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div id="nig-history-tab" class="nig-tab-content">\n                <div class="nig-history-container">\n                    <div class="nig-history-cleanup">\n                        <div class="nig-cleanup-info">\n                            <h4>History Management</h4>\n                            <p>Clean up old history entries to free up space and improve performance.</p>\n                        </div>\n                        <div class="nig-cleanup-controls">\n                            <label>Delete history older than</label>\n                            <input type="number" id="nig-history-clean-days" min="1" max="365" value="30">\n                            <label>days</label>\n                            <button id="nig-history-clean-btn" class="nig-history-cleanup-btn">\n                                <span class="material-symbols-outlined">cleaning_services</span>\n                                Clean\n                            </button>\n                        </div>\n                    </div>\n                    <ul id="nig-history-list" class="nig-history-list"></ul>\n                </div>\n            </div>\n\n            <div id="nig-utilities-tab" class="nig-tab-content">\n                <div class="nig-utilities-grid">\n                    <div class="nig-utility-card">\n                        <h4>Import/Export Settings</h4>\n                        <p>Backup and restore your configuration settings for seamless setup across different sessions or devices.</p>\n                        <div class="nig-form-group">\n                            <button id="nig-export-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-primary);">\n                                <span class="material-symbols-outlined">download</span>\n                                Download Configuration\n                            </button>\n                            <small class="nig-hint">Downloads the current configuration as a JSON file.</small>\n                        </div>\n                        <div class="nig-form-group">\n                            <label for="nig-import-file">Import Configuration</label>\n                            <input type="file" id="nig-import-file" accept=".json" style="border: 2px dashed var(--nig-color-border); background: var(--nig-color-bg-primary);">\n                            <small class=" nig-hint">Uploading a JSON file will overwrite all current settings.</small>\n                        </div>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <h4>Cache Management</h4>\n                        <p>Clear cached model lists and force fresh data fetching for accurate, up-to-date information.</p>\n                        <button id="nig-clear-cache-btn" class="nig-save-btn" style="background-color: var(--nig-color-accent-error);">\n                            <span class="material-symbols-outlined">clear_all</span>\n                            Clear Cached Models\n                        </button>\n                        <small class="nig-hint">Removes all cached model lists forcing a fresh fetch.</small>\n                    </div>\n\n                    <div class="nig-utility-card">\n                        <div class="nig-card-header">\n                            <div class="nig-card-title">\n                                <h4>Debug Console & Logs</h4>\n                                <p>Enable detailed console logging and view enhancement operation logs to troubleshoot issues and monitor system behavior during development.</p>\n                            </div>\n                        </div>\n\n                        <div class="nig-card-actions">\n                            <button id="nig-toggle-logging-btn" class="nig-btn-primary">\n                                <span class="material-symbols-outlined">bug_report</span>\n                                Toggle Console Logging & Enhancement Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-secondary-actions">\n                            <button id="nig-view-enhancement-logs-btn" class="nig-btn-secondary">\n                                <span class="material-symbols-outlined">list</span>\n                                View Enhancement Logs\n                            </button>\n                            <button id="nig-clear-enhancement-logs-btn" class="nig-btn-secondary nig-btn-error">\n                                <span class="material-symbols-outlined">clear_all</span>\n                                Clear Logs\n                            </button>\n                        </div>\n\n                        <div class="nig-card-footer">\n                            <small class="nig-hint">Toggles detailed console logging and provides access to enhancement operation logs.</small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div class="nig-button-footer">\n                <button id="nig-save-btn" class="nig-save-btn">Save Configuration</button>\n            </div>\n        </div>\n    ',document.body.appendChild(re),re.querySelector(".nig-close-btn").addEventListener("click",()=>re.style.display="none"),re.querySelector("#nig-save-btn").addEventListener("click",pe),re.querySelectorAll(".nig-tab").forEach(e=>{e.addEventListener("click",async()=>{re.querySelectorAll(".nig-tab, .nig-tab-content").forEach(e=>e.classList.remove("active")),e.classList.add("active"),re.querySelector(`#nig-${e.dataset.tab}-tab`).classList.add("active"),"history"===e.dataset.tab?(await Ee(),re.querySelector("#nig-save-btn").style.display="none"):re.querySelector("#nig-save-btn").style.display="block"})}),re.querySelector("#nig-provider").addEventListener("change",e=>{se()}),re.querySelector("#nig-openai-compat-fetch-models").addEventListener("click",()=>async function(e){const n=document.getElementById("nig-openai-compat-base-url").value.trim(),t=document.getElementById("nig-openai-compat-api-key").value.trim();if(!n)return void alert("Please enter a Base URL first.");const i=document.getElementById("nig-openai-compat-model");i.innerHTML="<option>Fetching models...</option>",T("NETWORK",`Fetching OpenAI compatible models from ${n}`),GM_xmlhttpRequest({method:"GET",url:`${n}/models`,headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},onload:async t=>{try{const a=JSON.parse(t.responseText);if(!a.data||!Array.isArray(a.data))throw new Error("Invalid model list format received.");let o=[];if(o=a.data.some(e=>e.endpoint||e.endpoints)?a.data.filter(e=>"/v1/images/generations"===e.endpoint||e.endpoints?.includes("/v1/images/generations")):a.data.some(e=>"images.generations"===e.type)?a.data.filter(e=>"images.generations"===e.type):a.data.filter(e=>{const n=e.id.toLowerCase();return n.includes("dall-e")||n.includes("dalle")||n.includes("image")||n.includes("midjourney")||n.includes("stable diffusion")||n.includes("flux")||n.includes("imagen")}),o.sort((e,n)=>{const t=he(e),i=he(n);return t&&!i?-1:!t&&i?1:e.id.localeCompare(n.id)}),0===o.length)throw new Error("No image generation models found. This provider may not support image generation.");ve(i,o,e),await async function(e,n){try{const t=`openAICompatModels_${e}`;await GM_setValue(t,JSON.stringify(n)),P("info","CACHE",`Cached models for OpenAI compatible provider: ${e}`)}catch(n){P("error","CACHE","Failed to cache OpenAI compatible models",{profileUrl:e,error:n.message})}}(n,o),T("NETWORK",`Successfully fetched and cached ${o.length} models for ${n}`)}catch(e){L("NETWORK","Failed to parse OpenAI compatible models",{error:e.message}),i.innerHTML="<option>Failed to fetch models</option>",alert(`Failed to fetch models. Check the Base URL and API Key. You can enter the model name manually. Error: ${e.message}`),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}},onerror:e=>{L("NETWORK","Failed to fetch OpenAI compatible models",{error:e}),i.innerHTML="<option>Failed to fetch models</option>",alert("Failed to fetch models. Check your network connection and the Base URL. Switching to manual input."),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}})}()),re.querySelector("#nig-openai-compat-profile-select").addEventListener("change",fe),re.querySelector("#nig-openai-compat-delete-profile").addEventListener("click",be),re.querySelector("#nig-openai-compat-switch-to-manual").addEventListener("click",e=>{e.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="none",document.getElementById("nig-openai-model-container-manual").style.display="block"}),re.querySelector("#nig-openai-compat-switch-to-select").addEventListener("click",e=>{e.preventDefault(),document.getElementById("nig-openai-model-container-select").style.display="block",document.getElementById("nig-openai-model-container-manual").style.display="none"}),re.querySelector("#nig-export-btn").addEventListener("click",we),re.querySelector("#nig-import-file").addEventListener("change",xe),re.querySelector("#nig-history-clean-btn").addEventListener("click",Ie),re.querySelector("#nig-history-clean-days").addEventListener("change",async e=>{const n=parseInt(e.target.value);if(!isNaN(n)&&n>=1&&n<=365)try{await I(n),console.log(`History days setting saved: ${n}`),re.querySelector('.nig-tab[data-tab="history"]').classList.contains("active")&&await Ee()}catch(e){console.error("Failed to auto-save history days setting:",e)}}),re.querySelector("#nig-clear-cache-btn").addEventListener("click",()=>j()),re.querySelector("#nig-toggle-logging-btn").addEventListener("click",async()=>{const e=!await f("loggingEnabled");await w("loggingEnabled",e),await C(),await H(),alert(`Debug Console & Enhancement Logs are now ${e?"ENABLED":"DISABLED"}.`)}),re.querySelector("#nig-view-enhancement-logs-btn").addEventListener("click",async()=>{const e=await R();if(0===e.length)return void alert("No enhancement logs found. Enhancement logging is disabled or no enhancement operations have been performed yet.");const n=document.createElement("div");n.className="nig-modal-overlay",n.innerHTML='\n            <div class="nig-modal-content">\n                <span class="nig-close-btn">&times;</span>\n                <h2>Enhancement Operation Logs</h2>\n                <p>Detailed logs of prompt enhancement operations with timestamps and performance data.</p>\n                <div style="max-height: 400px; overflow-y: auto; background: var(--nig-color-bg-tertiary); border-radius: var(--nig-radius-md); padding: var(--nig-space-lg); margin: var(--nig-space-lg) 0;">\n                    <div id="nig-enhancement-logs-display"></div>\n                </div>\n            </div>\n        ',document.body.appendChild(n);const t=n.querySelector("#nig-enhancement-logs-display");e.slice(0,50).forEach(e=>{const n=new Date(e.timestamp||e.time).toLocaleString(),i={ERROR:"#ef4444",WARN:"#f59e0b",INFO:"#6366f1",DEBUG:"#8b5cf6"}[e.level?.toUpperCase()]||"#6366f1",a=document.createElement("div");a.style.cssText="\n                padding: var(--nig-space-sm) 0;\n                border-bottom: 1px solid var(--nig-color-border);\n                font-family: 'Fira Code', monospace;\n                font-size: var(--nig-font-size-xs);\n            ",a.innerHTML=`\n                <div style="display: flex; align-items: center; gap: var(--nig-space-sm); margin-bottom: var(--nig-space-xs);">\n                    <span style="color: ${i}; font-weight: 600;">[${e.level?.toUpperCase()||"INFO"}]</span>\n                    <span style="color: var(--nig-color-text-muted); font-size: var(--nig-font-size-xs);">${n}</span>\n                    <span style="color: var(--nig-color-accent-primary); font-weight: 500;">[${e.category||"LOG"}]</span>\n                </div>\n                <div style="color: var(--nig-color-text-primary); margin-bottom: var(--nig-space-xs);">${e.message||"No message"}</div>\n                ${e.data?`<pre style="color: var(--nig-color-text-secondary); font-size: var(--nig-font-size-xs); background: var(--nig-color-bg-primary); padding: var(--nig-space-sm); border-radius: var(--nig-radius-sm); margin: 0; overflow-x: auto;">${JSON.stringify(e.data,null,2)}</pre>`:""}\n            `,t.appendChild(a)}),n.querySelector(".nig-close-btn").addEventListener("click",()=>n.remove())}),re.querySelector("#nig-clear-enhancement-logs-btn").addEventListener("click",async()=>{const e=await R();0!==e.length?confirm(`Are you sure you want to clear all ${e.length} enhancement logs? This action cannot be undone.`)&&(A=[],GM_setValue("enhancementLogHistory","[]"),T("LOG","Enhancement logs cleared by user"),alert("All enhancement logs have been cleared.")):alert("No enhancement logs to clear.")}),re.querySelector("#nig-main-style").addEventListener("change",e=>le(e.target.value)),re.querySelector("#nig-sub-style").addEventListener("change",()=>{const e=re.querySelector("#nig-sub-style").value,n=document.getElementById("nig-sub-style-desc"),t=ie.find(e=>e.name===re.querySelector("#nig-main-style").value),i=t?t.subStyles.find(n=>n.value===e):null;n.textContent=i?i.description:""});const e=re.querySelector("#nig-custom-style-enable"),n=re.querySelector("#nig-custom-style-text");e.addEventListener("change",()=>{n.disabled=!e.checked});const t=re.querySelector("#nig-enhancement-enabled"),i=(re.querySelector("#nig-enhancement-settings"),re.querySelector("#nig-override-provider")),a=re.querySelector("#nig-enhancement-template-select"),o=re.querySelector("#nig-template-reset"),r=re.querySelector("#nig-template-example"),s=re.querySelector("#nig-test-enhancement"),l=re.querySelector("#nig-gemini-api-key");a.addEventListener("change",async e=>{const n=e.target.value,t=re.querySelector("#nig-enhancement-template");if("custom"===n)t.disabled=!1;else{const e=y.enhancementPresets[n];e&&(t.value=e.template,t.disabled=!0,await w("enhancementTemplate",e.template))}await w("enhancementTemplateSelected",n)}),o.addEventListener("click",async()=>{const e=a.value,n=re.querySelector("#nig-enhancement-template");if("custom"!==e){const t=y.enhancementPresets[e];t&&(n.value=t.template,await w("enhancementTemplate",t.template))}}),r.addEventListener("click",async()=>{const e='Extract visual elements from this text and craft a concise image generation prompt as a flowing paragraph. Focus on: characters and their appearances/actions/expressions, setting and environment, lighting/mood/color palette, artistic style/composition/framing. Omit narrative, dialogue, text, or non-visual details. Use vivid, specific descriptors separated by commas or short phrases for clarity. End with quality boosters like "highly detailed, sharp focus, 8K resolution, masterpiece. Generated Prompt Structure: Start with core subjects, layer in scene/mood, then style/technicals:';re.querySelector("#nig-enhancement-template").value=e,await w("enhancementTemplate",e)}),t.addEventListener("change",async e=>{const n=e.target.checked,t=await b();t.enhancementEnabled=n,await w("enhancementEnabled",n),ce(n),de(document.getElementById("nig-provider").value,t)}),i.addEventListener("click",async()=>{const e=document.getElementById("nig-provider").value;await w("enhancementOverrideProvider",!0),de(e,await b())}),l.addEventListener("input",async e=>{const n=e.target.value.trim().length>0;re.querySelector("#nig-enhancement-preview").style.display=n?"block":"none"}),s.addEventListener("click",async()=>{const e=await b();s.disabled=!0;const n=s.innerHTML;s.innerHTML='<span class="material-symbols-outlined">hourglass_empty</span>Testing...';try{const n=await async function(e,n){try{return{original:e,enhanced:await D(e,n)}}catch(e){throw new Error(`Enhancement failed: ${e.message}`)}}("A mystical warrior standing on a cliff overlooking a magical forest with glowing mushrooms and ethereal mist",e);document.getElementById("nig-original-prompt").textContent=n.original,document.getElementById("nig-enhanced-prompt").textContent=n.enhanced}catch(e){alert(`Enhancement test failed: ${e.message}`)}finally{s.disabled=!1,s.innerHTML=n}}),re.querySelector("#nig-provider").addEventListener("change",async e=>{de(e.target.value,await b())})}async function Se(){re||ke(),re.querySelectorAll(".nig-tab, .nig-tab-content").forEach(e=>e.classList.remove("active")),re.querySelector('.nig-tab[data-tab="config"]').classList.add("active"),re.querySelector("#nig-config-tab").classList.add("active"),re.querySelector("#nig-save-btn").style.display="block",await ge(),re.style.display="flex"}!function(){let e,n=[],t=[],i=[],a=!1,o="",r=!1,s="";function l(e,n,i,o,r=null){T("GENERATION","Generation completed successfully",{provider:i,model:o,promptLength:n.length,promptPreview:n.substring(0,100)+(n.length>100?"...":""),imagesGenerated:e.length,hasPersistentUrls:!!r}),t.push({imageUrls:e,prompt:n,provider:i}),(r||e).forEach(e=>async function(e){const n=await x();n.unshift(e),n.length>100&&n.pop(),await GM_setValue("history",JSON.stringify(n))}({date:(new Date).toISOString(),prompt:n,url:e,provider:i,model:o})),a=!1,m(),u()}function c(e,t="Unknown",o,r=null,s=null){L("GENERATION","Generation Failed",{prompt:t,provider:o,errorMessage:e,errorMetadata:s});let l=function(e,n=null,t=null){let i=String(e);const a=i.toLowerCase();if(a.includes("error code: 524")||a.includes("timed out")||a.includes("502 bad gateway")||a.includes("unable to reach the origin service"))return{message:"The generation service is temporarily unavailable or busy (e.g., 502 Bad Gateway). This is usually a temporary issue. Please try again in a few minutes.",retryable:!0};if("OpenAICompat"===n&&t?.includes("api.mnnai.ru"))try{if("Sorry, there's been some kind of mistake, please use a different model"===JSON.parse(i.substring(i.indexOf("{"))).error)return{message:"Temporary service error detected. The same prompt typically works on retry. This error will be automatically retried.",retryable:!0}}catch(e){}if(a.includes("unsafe content")||a.includes("safety system")||a.includes("moderation_blocked"))return{message:"The prompt was rejected by the safety system for containing potentially unsafe content.",retryable:!1};if("OpenAICompat"===n){if(a.includes("invalid api key")||a.includes("authentication failed")||a.includes("unauthorized"))return{message:"Authentication failed. Please check your API key configuration and ensure it is valid for this OpenAI-compatible provider.",retryable:!1,errorType:"authentication",isNonRetryable:!0};if(a.includes("ip address mismatch"))return{message:"IP Address Mismatch: Your current IP doesn't match your account. Try the /user resetip command in the Discord server or upgrade to premium for multi-IP support.",retryable:!0,errorType:"ip_mismatch",isNonRetryable:!1,discordLink:"https://discord.gg/zukijourney",resetipCommand:"/user resetip"};if(a.includes("failed to convert image to base64")||a.includes("base64")||a.includes("image conversion"))return{message:"Image conversion failed. The provider returned image data that could not be properly converted. This may be a temporary issue with the provider.",retryable:!0,errorType:"image_conversion",isNonRetryable:!1};if(a.includes("html response instead of json")||a.includes("unexpected token '<'")||a.includes("received html"))return{message:"The API endpoint returned an HTML page instead of JSON data. This usually indicates endpoint configuration issues, authentication problems, or an invalid API endpoint URL. Please check your OpenAI-compatible provider configuration.",retryable:!1,errorType:"html_response",isNonRetryable:!0,endpointIssue:!0};if(a.includes("json parsing failed")||a.includes("malformed json")||a.includes("unexpected character at line 1 column 1"))return{message:"The API returned malformed or invalid JSON data. This may indicate server issues with the OpenAI-compatible provider. Please try again later or contact the provider support.",retryable:!0,errorType:"malformed_json",isNonRetryable:!1,serverIssue:!0};if(a.includes("json parse error")||a.includes("json parsing error")||a.includes("invalid json"))return{message:"JSON parsing failed for the API response. This may indicate server issues or malformed response from the OpenAI-compatible provider.",retryable:!0,errorType:"json_parse_error",isNonRetryable:!1}}try{const e=JSON.parse(i.substring(i.indexOf("{"))),n=e.message||(e.error?e.error.message:null)||JSON.stringify(e);return{message:"object"==typeof n?JSON.stringify(n):n,retryable:!1}}catch(e){return{message:i||"An unknown error occurred.",retryable:!1}}}(e,o,r);s&&(s.errorType&&(l.errorType=s.errorType),"boolean"==typeof s.isNonRetryable&&(l.retryable=!s.isNonRetryable,l.isNonRetryable=s.isNonRetryable)),i.push({reason:l,prompt:t,provider:o,providerProfileUrl:r}),d(),J.y("error","Generation Failed."),a=!1,m(),T("GENERATION","Generation failed - waiting for user action",{errorQueueLength:i.length,generationQueueLength:n.length,willWaitForUser:!0,errorType:l.errorType||"unknown",isNonRetryable:l.isNonRetryable||!1})}function d(){if(r||0===i.length)return;const e=i.shift();r=!0,async function(e){Y||X(),document.getElementById("nig-error-reason").textContent=e.reason.message;const n=document.getElementById("nig-error-prompt");n.value=e.prompt;const t=document.getElementById("nig-retry-provider-select");t.innerHTML="";const i=await b();["Pollinations","AIHorde","Google"].forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}),Object.keys(i.openAICompatProfiles).forEach(e=>{const n=document.createElement("option");n.value=`OpenAICompat::${e}`,n.textContent=`OpenAI: ${e.replace("https://","").split("/")[0]}`,t.appendChild(n)});let a=e.provider;"OpenAICompat"===e.provider&&e.providerProfileUrl&&(a=`OpenAICompat::${e.providerProfileUrl}`),Array.from(t.options).some(e=>e.value===a)&&(t.value=a);const o=document.getElementById("nig-error-actions");o.innerHTML="";const r=e.reason.isNonRetryable||"authentication"===e.reason.errorType||!e.reason.retryable&&!e.reason.errorType,s=document.createElement("button");if(s.textContent="Retry Generation",s.className="nig-retry-btn",s.onclick=()=>{const e=n.value.trim();if(!e)return void alert("Prompt cannot be empty.");const i=t.value;let a,o;i.startsWith("OpenAICompat::")?(a="OpenAICompat",o=i.split("::")[1]):(a=i,o=null),Q(e,a,o),ee()},!r)if(e.reason.retryable)o.appendChild(s);else{const e=()=>{o.contains(s)||o.appendChild(s)};n.oninput=e,t.onchange=e}if("authentication"===e.reason.errorType){const e=document.createElement("div");e.className="nig-auth-warning",e.style.cssText="color: #d63384; background-color: #f8d7da; border: 1px solid #f5c2c7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Authentication Issue:</strong> Please check your API key configuration in the settings before retrying.",o.appendChild(e)}if("image_conversion"===e.reason.errorType){const e=document.createElement("div");e.className="nig-conversion-info",e.style.cssText="color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Image Conversion Issue:</strong> This may be a temporary problem with the provider. You can try again or use a different provider.",o.appendChild(e)}if("ip_mismatch"===e.reason.errorType){const n=document.createElement("div");n.className="nig-ip-warning",n.style.cssText="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-top: 10px;";const t=e.reason.discordLink||"https://discord.gg/zukijourney",i=e.reason.resetipCommand||"/user resetip";n.innerHTML="<strong>IP Address Mismatch:</strong> Your current IP address doesn't match the one registered to your account.<br><br><strong>To resolve this:</strong><br>â€¢ Join the Discord server: <a href=\""+t+'" target="_blank" rel="noopener noreferrer" style="color: #856404; text-decoration: underline;">'+t+'</a><br>â€¢ Use the command: <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-family: monospace;">'+i+"</code><br>â€¢ Or upgrade to premium for multi-IP support<br><br><em>You can retry this generation after resetting your IP lock.</em>",o.appendChild(n)}if("html_response"===e.reason.errorType){const e=document.createElement("div");e.className="nig-html-warning",e.style.cssText="color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c2c7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Endpoint Configuration Issue:</strong> The API endpoint returned HTML instead of JSON, which usually indicates:<br>â€¢ Invalid or incorrect endpoint URL<br>â€¢ Authentication problems<br>â€¢ Endpoint not supporting image generation<br><br>Please check your OpenAI-compatible provider configuration in settings.",o.appendChild(e)}if("malformed_json"===e.reason.errorType){const e=document.createElement("div");e.className="nig-json-warning",e.style.cssText="color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>Server Response Issue:</strong> The API returned malformed JSON data. This is typically a temporary server issue with the provider. You can try again or use a different provider.",o.appendChild(e)}if("json_parse_error"===e.reason.errorType){const e=document.createElement("div");e.className="nig-parse-warning",e.style.cssText="color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin-top: 10px;",e.innerHTML="<strong>JSON Parsing Error:</strong> Unable to parse the API response. This may be a temporary issue with the provider. You can try again or switch to a different provider.",o.appendChild(e)}Y.style.display="flex"}(e),T("ERROR","Showing error modal to user",{errorReason:e.reason.message,provider:e.provider,remainingErrorQueue:i.length})}function g(){T("ERROR","Error modal dismissed by user",{errorQueueLength:i.length,generationQueueLength:n.length,isGenerating:a}),r=!1,m(),n.length>0&&!a?(T("ERROR","Resuming queue processing after error modal dismissal"),u()):T("ERROR","No more items to process, queue paused")}function p(e,t,i=null){const o=G(e),s={displayPrompt:o,apiPrompt:B(e,"retry"),provider:t,providerProfileUrl:i};n.unshift(s),T("GENERATION","Added retry generation to queue (LIFO - Priority)",{provider:t,promptLength:o.length,queueLength:n.length,queuePosition:1,promptPreview:o.substring(0,100)+(o.length>100?"...":"")}),a=!1,ee(),r=!1,m(),u(),d()}function m(){if(N("SYSTEM","Updating system status",{completedQueueLength:t.length,isGenerating:a,generationQueueLength:n.length,currentStatusText:o}),t.length>0){const e=1===t.length?"1 Image Ready!":`${t.length} Images Ready!`;J.y("success",`${e} Click to view.`,()=>{const e=t.shift();e&&V.show(e.imageUrls,e.prompt,e.provider),m()})}else if(a||n.length>0){const e=n.length>0?` (Queue: ${n.length})`:"";J.y("loading",`${o}${e}`)}else J.y("hidden","")}async function u(){if(a||0===n.length)return void N("QUEUE","Queue processing skipped",{reason:a?"Currently generating":"Queue is empty",isGenerating:a,queueLength:n.length});a=!0;const e=n.shift();o="Requesting...",T("QUEUE","Starting queue processing",{provider:e.provider,promptLength:e.displayPrompt.length,promptPreview:e.displayPrompt.substring(0,100)+(e.displayPrompt.length>100?"...":""),remainingQueueLength:n.length,currentStatus:o}),m();const t={onSuccess:l,onFailure:c,onAuthFailure:(e,t)=>{var i,o,r;T("AUTH","Authentication required",{provider:t,message:e}),i=e,o=t,r=p,document.getElementById("nig-pollinations-auth-prompt")||(te=document.createElement("div"),te.id="nig-pollinations-auth-prompt",te.className="nig-modal-overlay",te.innerHTML=`\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Authentication Required</h2>\n            <p>The Pollinations.ai model you selected requires authentication. You can get free access by registering.</p>\n            <p><strong>Error Message:</strong> <em>${i}</em></p>\n            <p>Please visit <a href="https://auth.pollinations.ai" target="_blank" class="nig-api-prompt-link">auth.pollinations.ai</a> to continue. You can either:</p>\n            <ul>\n                <li><strong>Register the Referrer:</strong> The easiest method. Just register the domain <code>wtr-lab.com</code>. This links your usage to your account without needing a token.</li>\n                <li><strong>Use a Token:</strong> Get an API token and enter it below.</li>\n            </ul>\n            <div class="nig-form-group">\n                <label for="nig-prompt-pollinations-token">Pollinations API Token</label>\n                <input type="password" id="nig-prompt-pollinations-token">\n            </div>\n            <button id="nig-prompt-save-token-btn" class="nig-save-btn">Save Token & Retry</button>\n        </div>`,document.body.appendChild(te),te.querySelector(".nig-close-btn").addEventListener("click",()=>te.remove()),te.querySelector("#nig-prompt-save-token-btn").addEventListener("click",async()=>{const e=te.querySelector("#nig-prompt-pollinations-token").value.trim();e?(await w("pollinationsToken",e),te.remove(),alert("Token saved. Retrying generation..."),r(o,"Pollinations")):alert("Token cannot be empty.")})),a=!1,J.y("error","Authentication needed."),m(),T("AUTH","Queue paused due to authentication requirement",{generationQueueLength:n.length,willWaitForUser:!0})},updateStatus:t=>{o=t,N("SYSTEM","Status updated by provider",{provider:e.provider,newStatusText:t,isGenerating:a,generationQueueLength:n.length}),m()}};switch(e.provider){case"Google":N("QUEUE","Dispatching to Google provider",{prompt:e.apiPrompt.substring(0,50)+"..."}),async function(e,{onSuccess:n,onFailure:t}){const i=await b(),{model:a,googleApiKey:o,numberOfImages:r,aspectRatio:s,personGeneration:l,imageSize:c}=i,d=B(e,"google_api"),g=`https://generativelanguage.googleapis.com/v1beta/models/${a}:predict`,p={sampleCount:parseInt(r,10),aspectRatio:s,personGeneration:l};a.includes("fast")||(p.imageSize=parseInt(c,10)),GM_xmlhttpRequest({method:"POST",url:g,headers:{"x-goog-api-key":o,"Content-Type":"application/json"},data:JSON.stringify({instances:[{prompt:d}],parameters:p}),onload:i=>{try{const t=JSON.parse(i.responseText);if(t.error)throw new Error(JSON.stringify(t.error));const o=t.predictions.map(e=>`data:image/png;base64,${e.bytesB64Encoded}`);n(o,e,"Google",a)}catch(n){t(n.message,e,"Google")}},onerror:n=>t(JSON.stringify(n),e,"Google")})}(e.apiPrompt,t);break;case"AIHorde":N("QUEUE","Dispatching to AIHorde provider",{prompt:e.apiPrompt.substring(0,50)+"..."}),K(e.apiPrompt,t);break;case"Pollinations":N("QUEUE","Dispatching to Pollinations provider",{prompt:e.apiPrompt.substring(0,50)+"..."}),async function(e,{onSuccess:n,onFailure:t,onAuthFailure:i}){const a=await b(),{pollinationsModel:o,pollinationsToken:r,pollinationsWidth:s,pollinationsHeight:l,pollinationsSeed:c,pollinationsEnhance:d,pollinationsSafe:g,pollinationsNologo:p,pollinationsPrivate:m}=a,u=B(e,"pollinations_api"),h=o||"flux";console.log("[NIG-DEBUG] [POLLINATIONS] Model configuration:",{originalModel:o,finalModel:h});const v=new URLSearchParams;r&&v.append("token",r),h&&"flux"!==h&&v.append("model",h),s&&s>0&&v.append("width",s),l&&l>0&&v.append("height",l),c&&v.append("seed",c),d&&v.append("enhance","true"),g&&v.append("safe","true"),p&&v.append("nologo","true"),m&&v.append("private","true");const y=v.toString(),f=`https://image.pollinations.ai/prompt/${encodeURIComponent(u)}${y?"?"+y:""}`;GM_xmlhttpRequest({method:"GET",url:f,responseType:"blob",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},onload:async a=>{if(a.status>=200&&a.status<300){const t=URL.createObjectURL(a.response);n([t],e,"Pollinations",h,[f])}else{const n=await a.response.text();if(n.toLowerCase().includes("model not found"))return t(`Model error: ${n}. Refreshing model list.`,e,"Pollinations",h),void j("pollinations");if(403===a.status&&n.includes("auth.pollinations.ai")||n.toLowerCase().includes("authentication")&&n.toLowerCase().includes("auth.pollinations.ai"))try{const t=JSON.parse(n);return void i(t.message||t.error||n,e)}catch(t){return void i(n,e)}t(`Error ${a.status}: ${n}`,e,"Pollinations",h)}},onerror:n=>t(JSON.stringify(n),e,"Pollinations",h)})}(e.apiPrompt,t);break;case"OpenAICompat":N("QUEUE","Dispatching to OpenAICompat provider",{prompt:e.apiPrompt.substring(0,50)+"...",providerProfileUrl:e.providerProfileUrl}),async function(e,n,{onSuccess:t,onFailure:i}){const a=await b(),o=n||a.openAICompatActiveProfileUrl,r=a.openAICompatProfiles[o];if(!r)return void i(`No active or valid Openai Compatible profile found for URL: ${o}`,e,"OpenAICompat");const s=B(e,"openai_api"),l=`${o}/images/generations`,c={model:r.model,prompt:s,n:1,size:"1024x1024",response_format:"b64_json"};GM_xmlhttpRequest({method:"POST",url:l,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},data:JSON.stringify(c),onload:n=>{try{const a=function(e,n){try{return JSON.parse(e)}catch(t){if(function(e){const n=e.trim().toLowerCase();return n.startsWith("<!doctype")||n.startsWith("<html")||n.includes("<!doctype")||n.includes("<html>")||n.startsWith("<!")||n.startsWith("<head>")||n.includes("<title>")}(e))throw{isHtmlResponse:!0,originalError:t,message:`Received HTML response instead of JSON from ${n}. This usually indicates endpoint configuration issues or authentication problems.`};const i=t.message.toLowerCase();if(i.includes("unexpected token '<'")&&e.trim().startsWith("<!"))throw{isHtmlResponse:!0,originalError:t,message:`Received HTML response instead of JSON from ${n}. This usually indicates endpoint configuration issues or authentication problems.`};if(i.includes("unexpected character at line 1 column 1"))throw{isMalformedJson:!0,originalError:t,message:`JSON parsing failed at the first character. This may indicate server issues or malformed response from ${n}`};throw{isJsonParseError:!0,originalError:t,message:`JSON parsing error: ${t.message}. This may indicate server issues or malformed response.`}}}(n.responseText,o);if(a?.Error&&a.Error.toLowerCase().includes("invalid api key"))return void i(a.Error,e,"OpenAICompat",o,{errorType:"authentication",isNonRetryable:!0});if(a?.Error&&a.Error.toLowerCase().includes("ip address mismatch"))return void i(a.Error,e,"OpenAICompat",o,{errorType:"ip_mismatch",isNonRetryable:!1,retryable:!0});if(!a?.data?.[0])throw new Error(JSON.stringify(a));try{const n=a.data.map(e=>{if(e.b64_json)try{if("string"==typeof e.b64_json&&e.b64_json.length>0)return`data:image/png;base64,${e.b64_json}`;throw new Error("Invalid base64 data")}catch(e){throw new Error(`Failed to convert image to base64: ${e.message}`)}else if(e.url)return e.url;return null}).filter(Boolean);if(!(n.length>0))throw new Error("API response did not contain usable image data.");t(n,e,"OpenAICompat",r.model)}catch(n){i(n.message,e,"OpenAICompat",o,{errorType:"image_conversion",isNonRetryable:!1})}}catch(n){n.isHtmlResponse?i(n.message,e,"OpenAICompat",o,{errorType:"html_response",isNonRetryable:!1,endpointIssue:!0}):n.isMalformedJson?i(n.message,e,"OpenAICompat",o,{errorType:"malformed_json",isNonRetryable:!1,serverIssue:!0}):n.isJsonParseError?i(n.message,e,"OpenAICompat",o,{errorType:"json_parse_error",isNonRetryable:!1}):i(n.message,e,"OpenAICompat",o)}},onerror:n=>i(JSON.stringify(n),e,"OpenAICompat",o)})}(e.apiPrompt,e.providerProfileUrl,t);break;default:c(`Unknown provider: ${e.provider}`,e.displayPrompt,"System")}}async function h(){if(e.style.display="none",window.getSelection&&window.getSelection().removeAllRanges(),!s)return void M("GENERATION","No text selected for generation");T("GENERATION","User initiated image generation",{selectionLength:s.length,selectionPreview:s.substring(0,100)+(s.length>100?"...":"")});const t=await b();if("Google"===t.selectedProvider&&!t.googleApiKey)return M("GENERATION","Google provider selected but no API key provided"),void function(){if(document.getElementById("nig-google-api-prompt"))return;ne=document.createElement("div"),ne.id="nig-google-api-prompt",ne.className="nig-modal-overlay",ne.innerHTML='\n        <div class="nig-modal-content">\n            <span class="nig-close-btn">&times;</span>\n            <h2>Google API Key Required</h2>\n            <p>Please provide your Google AI Gemini API key. You can get one from <a href="https://aistudio.google.com/api-keys" target="_blank" class="nig-api-prompt-link">Google AI Studio</a>.</p>\n            <div class="nig-form-group">\n                <label for="nig-prompt-api-key">Gemini API Key</label>\n                <input type="password" id="nig-prompt-api-key">\n            </div>\n            <button id="nig-prompt-save-btn" class="nig-save-btn">Save Key</button>\n        </div>',document.body.appendChild(ne);const e=()=>ne.remove();ne.querySelector(".nig-close-btn").addEventListener("click",e),ne.querySelector("#nig-prompt-save-btn").addEventListener("click",async()=>{const n=ne.querySelector("#nig-prompt-api-key").value.trim();n?(await w("googleApiKey",n),alert("API Key saved. You can now generate an image."),e()):alert("API Key cannot be empty.")})}();let i=s,o="";if(t.customStyleEnabled&&t.customStyleText?(o=t.customStyleText.trim(),o&&!o.endsWith(", ")&&(o+=", ")):"None"!==t.mainPromptStyle&&(o=t.subPromptStyle&&"none"!==t.subPromptStyle?t.subPromptStyle:`${t.mainPromptStyle} style, `),i=o+i,t.enhancementEnabled){const e=F(t.selectedProvider,t),n=t.enhancementApiKey.trim().length>0;if((!e||t.enhancementOverrideProvider)&&n){J.y("loading","Enhancing prompt...");try{const e=B(i,"enhancement");i=await D(e,t),J.y("success","Prompt enhanced!"),setTimeout(()=>m(),2e3)}catch(e){L("ENHANCEMENT","External AI enhancement failed, falling back to original",{error:e.message}),J.y("error","Enhancement failed, using original prompt"),setTimeout(()=>m(),3e3)}}}t.enableNegPrompt&&t.globalNegPrompt&&"AIHorde"!==t.selectedProvider&&(i+=`, negative prompt: ${t.globalNegPrompt}`,N("GENERATION","Global negative prompt applied",{negativePrompt:t.globalNegPrompt,originalLength:i.length-t.globalNegPrompt.length-18,finalLength:i.length})),T("GENERATION","Prompt preparation completed, adding to queue",{provider:t.selectedProvider,finalPromptLength:i.length,promptPreview:i.substring(0,100)+(i.length>100?"...":""),queueSystem:"FIFO"}),function(e,t,i=null){const o=G(e),r={displayPrompt:o,apiPrompt:B(e,"queue_add"),provider:t,providerProfileUrl:i};n.push(r),T("GENERATION","Added generation to queue (FIFO)",{provider:t,promptLength:o.length,queueLength:n.length,queuePosition:n.length,promptPreview:o.substring(0,100)+(o.length>100?"...":"")}),m(),a||u()}(i,t.selectedProvider,t.openAICompatActiveProfileUrl)}function v(){const n=window.getSelection();if(!n||0===n.rangeCount)return void(e&&(e.style.display="none"));const t=n.toString().trim();if(t.length>5){s=t;const i=n.getRangeAt(0).getClientRects();if(0===i.length)return void(e.style.display="none");const a=i[0];e.style.display="block";const o=e.offsetHeight||30;let r=window.scrollY+a.top-o-5;if(r<window.scrollY){const e=i[i.length-1];r=window.scrollY+e.bottom+5}e.style.top=`${r}px`,e.style.left=`${window.scrollX+a.left}px`}else e&&(e.style.display="none")}!async function(){await C();try{const e=await k();e>0&&T("INIT",`Cleaned ${e} old history entries on startup`)}catch(e){L("INIT","Failed to clean old history entries on startup",{error:e.message})}const n=document.createElement("link");n.rel="stylesheet",n.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0",document.head.appendChild(n),e=document.createElement("button"),e.className="nig-button",e.innerHTML="ðŸŽ¨ Generate Image",e.addEventListener("click",h),document.body.appendChild(e),J.v(),V.v(),X(),ke(),function({onRetry:e,onDismiss:n}){Q=e,Z=n}({onRetry:p,onDismiss:g}),document.addEventListener("mouseup",v),document.addEventListener("selectionchange",v),GM_registerMenuCommand("Image Generator Settings",Se),T("INIT","WTR LAB Novel Image Generator initialized successfully",{config:await b()})}()}()})();